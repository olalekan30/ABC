Wtf.TempEmpMaster=function(A){Wtf.form.Field.prototype.msgTarget="side",A.layout="fit";A.title="Employee Management";Wtf.TempEmpMaster.superclass.constructor.call(this,A)};Wtf.extend(Wtf.TempEmpMaster,Wtf.Panel,{showhide:function(C,D,E){C.setVisible(D);C.container.up("div.x-form-item").dom.style.display=E;var B=C.el.findParent("div.x-form-item",4,true);var A=B.first("label.x-form-item-label");A.dom.style.display=E},onRender:function(A){Wtf.TempEmpMaster.superclass.onRender.call(this,A);this.quickSearchEmpField.on("render",function(){this.quickSearchEmpField.el.dom.onkeyup=this.onKeyUpEvent.createDelegate(this)},this)},initComponent:function(C){Wtf.TempEmpMaster.superclass.initComponent.call(this,C);this.lastlimitoption=15;this.cnamedata=[["January"],["February"],["March"],["April"],["May"],["June"],["July"],["August"],["September"],["October"],["November"],["December"]];this.monthcombostore=new Wtf.data.SimpleStore({fields:[{name:"cname"}]});this.monthcombostore.loadData(this.cnamedata);this.MonthName=new Wtf.form.ComboBox({store:this.monthcombostore,displayField:"cname",mode:"local",scope:this,emptyText:"Select a Month",selectOnFocus:true,width:120,minWidth:110,height:200,triggerAction:"all",listeners:{scope:this,select:function(J,L,K){this.month=this.monthcombostore.getAt(K).get("cname")}}});this.usersRecG=new Wtf.data.Record.create([{name:"TempID"},{name:"id"},{name:"GroupName"},{name:"TempName"},{name:"payinterval"},{name:"effdate"}]);this.groupuserds=new Wtf.data.GroupingStore({url:"Payroll/Template/getPayProcessData.py",baseParams:{PayProc:"get"},reader:new Wtf.data.KwlJsonReader({root:"data",totalProperty:"totalcount"},this.usersRecG),autoLoad:false,sortInfo:{field:"TempName",direction:"DSC"},groupField:"GroupName"});this.paycyclerec=new Wtf.data.Record.create([{name:"TempID"},{name:"paycyclestart"},{name:"paycycleend"},{name:"paycycleactualend"},{name:"paycycleshowstart"},{name:"paycycleshowend"},{name:"paycycletemplate"}]);this.groupuserds.on("load",function(K,J,L){this.lastlimitoption=L.params.limit},this);this.emptempds=new Wtf.data.GroupingStore({url:"Payroll/Template/getuserpaycycle.py",reader:new Wtf.data.KwlJsonReader({root:"data",totalProperty:"totalcount"},this.paycyclerec)});this.on("render",function(){this.groupuserds.load({params:{start:0,limit:15}})});this.rowNo=new Wtf.grid.RowNumberer();this.paycyclesm=new Wtf.grid.CheckboxSelectionModel({singleSelect:true});this.selectionModel=new Wtf.grid.CheckboxSelectionModel({singleSelect:true,scope:this,listeners:{scope:this,selectionchange:function(O,L,K){if(this.selectionModel.getCount()==0){if(this.emptempdriven.getValue()){this.emptempds.removeAll();this.payintervalgrid.getView().emptyText=WtfGlobal.emptyGridRenderer("Select the Template.");this.payintervalgrid.getView().refresh();this.quickSearchEmpField.disable();this.dateComp.disable()}else{this.emptempds.removeAll();this.payintervalgrid.getView().emptyText=WtfGlobal.emptyGridRenderer("Select the Employee.");this.payintervalgrid.getView().refresh()}return }var M=O.grid;var J=M.view.getHeaderCell(1);var N=Wtf.fly(J).child(".x-grid3-hd-checker");if(O.getCount()===M.getStore().getCount()){N.addClass("x-grid3-hd-checker-on")}else{N.removeClass("x-grid3-hd-checker-on")}}}});this.gridcm=new Wtf.grid.ColumnModel([this.rowNo,this.selectionModel,{id:"GroupName",header:"Payroll Templates",width:10,sortable:true,hidden:true,dataIndex:"GroupName"},{header:"Payroll Templates",width:10,sortable:true,dataIndex:"TempName"},{header:"Pay Interval",width:10,sortable:true,dataIndex:"payinterval",renderer:function(J){if(J==1){return"Once a month"}else{if(J==3){return"Once a week"}else{if(J==2){return"Twice a month"}}}}},{header:"Pay Date",width:10,sortable:true,dataIndex:"effdate",renderer:function(L,J,K){if(K.get("payinterval")==3){if(L==1){return"Sunday"}else{if(L==2){return"Monday"}else{if(L==3){return"Tuesday"}else{if(L==4){return"Wednesday"}else{if(L==5){return"Thursday"}else{if(L==6){return"Friday"}else{if(L==7){return"Saturday"}}}}}}}}else{return L}}}],this);this.paycyclecm=new Wtf.grid.ColumnModel([this.rowNo,this.selectionModel,{header:"Pay Cycle Start",sortable:true,dataIndex:"paycycleshowstart"},{header:"Pay Cycle End",sortable:true,dataIndex:"paycycleshowend"},{header:"Template",sortable:true,dataIndex:"paycycletemplate"}],this);var D=[];this.grouptempgrid=new Wtf.KwlGridPanel({enableColumnHide:false,trackMouseOver:true,stripeRows:true,loadMask:true,searchLabel:" ",searchLabelSeparator:" ",searchEmptyText:"Search",searchField:"GroupName",serverSideSearch:true,view:new Wtf.grid.GroupingView({forceFit:true,showGroupName:false,groupTextTpl:"{text}",emptyText:WtfGlobal.emptyGridRenderer("No Template added till now")}),store:this.groupuserds,cm:this.gridcm,scope:this,border:true,sm:this.selectionModel});this.selectionModel.on("selectionchange",this.calculatepaycycle,this);this.payintervalgrid=new Wtf.grid.GridPanel({enableColumnHide:false,trackMouseOver:true,stripeRows:true,loadMask:true,view:new Wtf.grid.GroupingView({forceFit:true,showGroupName:false,groupTextTpl:"{text}",emptyText:WtfGlobal.emptyGridRenderer("No template assigned to this employee")}),store:this.emptempds,cm:this.paycyclecm,scope:this,border:true,sm:this.paycyclesm,tbar:D});this.paycyclesm.on("selectionchange",this.getemployees,this);var A=new Wtf.data.Record.create([{name:"name"},{name:"id"}]);this.emptempdriven=new Wtf.form.Radio({fieldLabel:"Template Driven",id:"tempdriven"+this.id,bodyStyle:"float:left",checked:true,name:"emptemp"});this.empdriven=new Wtf.form.Radio({fieldLabel:"Employee Driven",id:"empdriven"+this.id,bodyStyle:"float:left",name:"emptemp"});this.quickSearchEmpField=new Wtf.form.TextField({anchor:"99%",width:150,emptyText:"Search by Employee Name"});this.timer=new Wtf.util.DelayedTask(this.onKeyUpEvent),this.empdriven.on("check",function(K,J){if(J){this.getemployeelist();this.quickSearchEmpField.disable();this.dateComp.disable();this.grouptempgrid.getView().emptyText=WtfGlobal.emptyGridRenderer("No Employee added till now");this.paycyclecm.setHidden(4,false)}},this);this.emptempdriven.on("check",function(K,J){if(J){this.getTemplatelist();this.extrausergrid.hide();Wtf.getCmp("gridcontainerpanel").doLayout();Wtf.getCmp("as").doLayout();this.quickSearchEmpField.enable();this.dateComp.enable();this.grouptempgrid.getView().emptyText=WtfGlobal.emptyGridRenderer("No Template added till now");this.paycyclecm.setHidden(4,true)}},this);this.empdriven.on("check",function(K,J){if(this.empdriven.rendered&&this.emptempdriven.rendered){this.empdriven.onClick();this.emptempdriven.onClick();this.emptempds.removeAll();this.payintervalgrid.getView().emptyText=WtfGlobal.emptyGridRenderer("Select the Employee.");this.payintervalgrid.getView().refresh()}},this);this.emptempdriven.on("check",function(K,J){if(this.emptempdriven.rendered&&this.empdriven.rendered){this.emptempdriven.onClick();this.empdriven.onClick();this.emptempds.removeAll();this.payintervalgrid.getView().emptyText=WtfGlobal.emptyGridRenderer("Select the Template.");this.payintervalgrid.getView().refresh();this.quickSearchEmpField.disable();this.dateComp.disable()}},this);this.emptempfield=new Wtf.Panel({frame:false,border:false,layout:"column",items:[{frame:false,columnWidth:0.5,border:false,layout:"form",items:[this.emptempdriven]},{frame:false,border:false,columnWidth:0.5,layout:"form",items:[this.empdriven]}]});var G=new Wtf.data.Record.create([{name:"name"},{name:"id"}]);var B=new Wtf.data.ArrayReader({},G);var H=[["Once a month",1],["Once a week",3]];var F=new Wtf.data.Store({reader:B,data:H});this.payintervalCombo=new Wtf.form.ComboBox({fieldLabel:"Payment Interval",mode:"local",displayField:"name",valueField:"id",allowBlank:false,name:"payinterval",typeAhead:true,hiddenName:"payinterval",triggerAction:"all",store:F,listeners:{scope:this,select:function(){if(this.payintervalCombo.getValue()==1){this.showhide(this.datepicker,true,"block");this.showhide(this.daypicker,false,"none")}else{if(this.payintervalCombo.getValue()==3){this.showhide(this.datepicker,false,"none");this.showhide(this.daypicker,true,"block")}}}}});this.datestore=new Wtf.data.SimpleStore({fields:["id","name"],data:[["1","1st"],["2","2nd"],["3","3rd"],["4","4th"],["5","5th"],["6","6th"],["7","7th"],["8","8th"],["9","9th"],["10","10th"],["11","11th"],["12","12th"],["13","13th"],["14","14th"],["15","15th"],["16","16th"],["17","17th"],["18","18th"],["19","19th"],["20","20th"],["21","21th"],["22","22th"],["23","23th"],["24","24th"],["25","25th"],["26","26th"],["27","27th"],["28","28th"],["29","29th"],["30","30th"],["31","31th"]]});this.daystore=new Wtf.data.SimpleStore({fields:["id","name"],data:[["1","Sunday"],["2","Monday"],["3","Tuesday"],["4","Wednesday"],["5","Thursday"],["6","Friday"],["7","Saturday"]]});this.datepicker=new Wtf.form.ComboBox({fieldLabel:"Date",store:this.datestore,name:"date",displayField:"name",valueField:"id",mode:"local",triggerAction:"all",hidden:true,hideLabel:true});this.daypicker=new Wtf.form.ComboBox({fieldLabel:"Day",store:this.daystore,name:"date",displayField:"name",valueField:"id",mode:"local",triggerAction:"all",hidden:true,hideLabel:true});this.filternorth=new Wtf.Panel({layout:"form",labelWidth:120,bodyStyle:"padding:10px;",border:false,items:[this.emptempfield,this.datepicker,this.daypicker]});this.filterpanel=new Wtf.Panel({region:"west",width:400,layout:"border",bodyStyle:"background-color: rgb(241, 241, 241)",border:false,items:[{region:"north",layout:"fit",border:false,height:40,items:this.filternorth},{region:"center",layout:"fit",border:false,items:this.grouptempgrid},{region:"south",layout:"fit",border:false,split:true,height:350,items:this.payintervalgrid}]});this.interjobRecord=Wtf.data.Record.create([{name:"EName"},{name:"Wage"},{name:"AccNo"},{name:"Tax"},{name:"Deduc"},{name:"Salary"},{name:"FixedSal"},{name:"empid"},{name:"design"},{name:"tempid"},{name:"generated"},{name:"paycycleend"},{name:"mappingid"}]);this.empstore=new Wtf.data.Store({scope:this,id:"empStore",reader:new Wtf.data.KwlJsonReader({root:"data",totalProperty:"totalcount"},this.interjobRecord),url:"Emp/getEmpListPerGroupid.py"});this.emptempstore=new Wtf.data.Store({scope:this,id:"emptempStore",reader:new Wtf.data.KwlJsonReader({root:"data",totalProperty:"totalcount"},this.interjobRecord)});this.empstore.on("load",function(){if(msgFlag==1){WtfGlobal.closeProgressbar()}var K=Wtf.getCmp("gridcontainerpanel");if(this.empdriven.getValue()){this.emptempstore.removeAll();this.extrausergrid.show();K.doLayout();Wtf.getCmp("as").doLayout();for(var J=0;J<this.empstore.data.length;J++){if(this.empstore.getAt(J).data.empid==this.selectedEmp){}else{this.emptempstore.add(this.empstore.getAt(J));this.empstore.remove(this.empstore.getAt(J));J--}}}},this);this.empstore.on("loadexception",function(){if(msgFlag==1){WtfGlobal.closeProgressbar()}},this);this.empsm=new Wtf.grid.CheckboxSelectionModel({singleSelect:false,scope:this,listeners:{scope:this,rowselect:function(L,K,J){this.TempId=this.empstore.getAt(K).get("tempid");this.ename=this.empstore.getAt(K).get("EName");this.accno=this.empstore.getAt(K).get("AccNo");this.salary=this.empstore.getAt(K).get("Wage");this.tax=this.empstore.getAt(K).get("Tax");this.empid=this.empstore.getAt(K).get("empid");this.deduc=this.empstore.getAt(K).get("Deduc");this.currency=this.empstore.getAt(K).get("tempid");this.fixedsal=this.empstore.getAt(K).get("FixedSal");this.design=this.empstore.getAt(K).get("design");this.selectedEmpGrid=this.empgrid},rowdeselect:function(L,K,J){},selectionchange:function(O,L,K){var M=O.grid;var J=M.view.getHeaderCell(0);var N=Wtf.fly(J).child(".x-grid3-hd-checker");if(O.getCount()===M.getStore().getCount()){N.addClass("x-grid3-hd-checker-on")}else{N.removeClass("x-grid3-hd-checker-on")}}}});this.emptempsm=new Wtf.grid.CheckboxSelectionModel({singleSelect:false,scope:this,listeners:{scope:this,rowselect:function(L,K,J){this.TempId=this.emptempstore.getAt(K).get("tempid");this.ename=this.emptempstore.getAt(K).get("EName");this.accno=this.emptempstore.getAt(K).get("AccNo");this.salary=this.emptempstore.getAt(K).get("Wage");this.tax=this.emptempstore.getAt(K).get("Tax");this.empid=this.emptempstore.getAt(K).get("empid");this.deduc=this.emptempstore.getAt(K).get("Deduc");this.currency=this.emptempstore.getAt(K).get("tempid");this.fixedsal=this.emptempstore.getAt(K).get("FixedSal");this.design=this.emptempstore.getAt(K).get("design");this.selectedEmpGrid=this.extrausergrid},rowdeselect:function(L,K,J){},selectionchange:function(O,L,K){var M=O.grid;var J=M.view.getHeaderCell(0);var N=Wtf.fly(J).child(".x-grid3-hd-checker");if(O.getCount()===M.getStore().getCount()){N.addClass("x-grid3-hd-checker-on")}else{N.removeClass("x-grid3-hd-checker-on")}}}});this.cm=new Wtf.grid.ColumnModel([this.empsm,{header:"Employee Name",dataIndex:"EName",sortable:true,groupable:true},{header:"Earnings",dataIndex:"Wage",sortable:true,align:"right",groupable:true,renderer:function(J){if(J!=null){return('<div align="right" style="font-family:Lucida Sans Unicode;">'+WtfGlobal.currencyRenderer(parseFloat(J).toFixed(2))+"</div>")}}},{header:"Deductions",dataIndex:"Deduc",sortable:true,align:"right",groupable:true,renderer:function(J){if(J!=null){return('<div align="right" style="font-family:Lucida Sans Unicode;">'+WtfGlobal.currencyRenderer(parseFloat(J).toFixed(2))+"</div>")}}},{header:"Taxes",dataIndex:"Tax",sortable:true,align:"right",groupable:true,renderer:function(J){if(J!=null){return('<div align="right" style="font-family:Lucida Sans Unicode;">'+WtfGlobal.currencyRenderer(parseFloat(J).toFixed(2))+"</div>")}}},{header:"Net Pay",dataIndex:"Salary",scope:this,sortable:true,align:"right",groupable:true,renderer:function(J){if(J!=null){return('<div align="right" style="font-family:Lucida Sans Unicode;">'+WtfGlobal.currencyRenderer(parseFloat(J).toFixed(2))+"</div>")}}},{header:"Delete",width:7,align:"center",renderer:function(N,J,M,O,K,L){return"<div style='width:30px;' class='pwndCommon deletecolIcon' >&nbsp;</div>"}}]);this.fromdateempG=new Wtf.form.DateField({width:135,readOnly:true,emptyText:"From Date",format:"m/d/Y",value:new Date().add(Date.MONTH,+0).getFirstDateOfMonth(),maxValue:new Date().clearTime(true)});this.todateempG=new Wtf.form.DateField({width:135,readOnly:true,emptyText:"To Date",disabled:true,format:"m/d/Y",value:new Date().add(Date.MONTH,+0).getLastDateOfMonth()});this.dateComp=new Wtf.form.DateField({width:155,emptyText:"Select Date"});D.push(this.quickSearchEmpField,"-",this.dateComp);this.fromdateempG.on("change",function(){var J=new Date();J=this.fromdateempG.getValue();this.todateempG.setValue(J.add(Date.MONTH,+0).getLastDateOfMonth())},this);this.mypdf=new Wtf.Button({text:"Download Payslip",scope:this,disabled:true,iconCls:getButtonIconCls(Wtf.btype.downloadbutton),tooltip:"Download the payslip for reference and also view past payslips.",handler:function(){var K=this.selectedEmpGrid.getSelectionModel().getSelections();var J=K[0].get("EName")+"_"+this.paycyclestart+"";this.exportReport(1,"pdf",J,K[0].get("empid"),companyName,K);this.empid=null}});this.empsaldetails=new Wtf.Button({text:"Salary Details",scope:this,minWidth:90,disabled:true,iconCls:getButtonIconCls(Wtf.btype.reportbutton),tooltip:"Select an employee from the list and click to view the details related to salary.",handler:function(){this.arr=this.empgrid.getSelections();this.arrExtraUser=this.extrausergrid.getSelections();this.arr1=this.payintervalgrid.getSelections();if(this.arr.length==0&&this.arrExtraUser.length==0){calMsgBoxShow(21,0)}else{if(this.arr.length==0){var K=this.arrExtraUser}else{var K=this.arr}this.TempId=K[0].get("tempid");this.ename=K[0].get("EName");this.accno=K[0].get("AccNo");this.salary=K[0].get("Wage");this.tax=K[0].get("Tax");this.empid=K[0].get("empid");this.deduc=K[0].get("Deduc");this.currency=K[0].get("tempid");this.fixedsal=K[0].get("FixedSal");this.design=K[0].get("design");var L=K[0].get("generated");this.mainTabId=Wtf.getCmp("mainpayrolltab");var J=new Date(this.arr1[0].get("paycyclestart").replace(new RegExp("-","g"),"/"));var M=new Date(this.arr1[0].get("paycycleend").replace(new RegExp("-","g"),"/"));this.payslip=Wtf.getCmp(this.empid+"payslipTab"+J);if(this.payslip==null){this.payslip=new Wtf.EmpPayslip({layout:"fit",title:K[0].get("EName")+"'s Payslip",closable:true,border:false,iconCls:getTabIconCls(Wtf.etype.hrmsreport),id:this.empid+"payslipTab"+J,TempId:this.TempId,ename:this.ename,mappingid:K[0].get("mappingid"),accno:this.accno,salary:this.salary,tax:this.tax,empid:this.empid,deduc:this.deduc,cursymbol:this.currency,fixedsal:this.fixedsal,generated:L,design:this.design,stdate1:this.fromdateempG.getValue(),enddate1:this.todateempG.getValue(),stdate:new Date(this.arr1[0].get("paycyclestart").replace(new RegExp("-","g"),"/")),enddate:new Date(this.arr1[0].get("paycycleend").replace(new RegExp("-","g"),"/")),paycyclestart:this.paycyclestart,paycycleend:(K[0].get("paycycleend")=="")?this.paycycleend:K[0].get("paycycleend"),ischanged:(K[0].get("paycycleend")=="")?0:1});this.mainTabId.add(this.payslip);this.payslip.on("gridload",function(){calMsgBoxShow(202,4,true);this.empstore.load()},this)}this.mainTabId.setActiveTab(this.payslip);this.mainTabId.doLayout()}}});var I=[];I.push("->",this.mypdf,"-",this.empsaldetails);var E=[];E.push("->",this.gensalbtn=new Wtf.Button({text:"Generate Salary",tooltip:"Select a payroll template and generate the salary for the employee(s) falling under that designation.",scope:this,minWidth:100,disabled:true,iconCls:getButtonIconCls(Wtf.btype.assignbutton),handler:function(){this.arr=this.empgrid.getSelectionModel().getSelections();this.extraarr=this.extrausergrid.getSelectionModel().getSelections();var N="Pay Cycle end date does not match with the selcted Pay cycle for the following employee(s).<br><ol>";var M=false;var L=1;for(var K=0;K<this.arr.length;K++){if(this.arr[K].get("paycycleend")!=null&&this.arr[K].get("paycycleend")!=undefined&&this.arr[K].get("paycycleend")!=""){M=true;N+="<li><b>"+L+". "+this.arr[K].get("EName")+"</b>: Paycycle "+this.paycyclestart+" to "+this.arr[K].get("paycycleend")+"</li>";L++}}for(K=0;K<this.extraarr.length;K++){if(this.extraarr[K].get("paycycleend")!=null&&this.extraarr[K].get("paycycleend")!=undefined&&this.extraarr[K].get("paycycleend")!=""){M=true;N+="<li><b>"+L+". "+this.extraarr[K].get("EName")+"</b>: Paycycle "+this.paycyclestart+" to "+this.extraarr[K].get("paycycleend")+"</li>";L++}}N+="Do you want to continue?</ol>";if(M){Wtf.MessageBox.show({title:"Alert",msg:N,icon:Wtf.MessageBox.QUESTION,buttons:Wtf.MessageBox.YESNO,scope:this,width:600,fn:function(P){if(P=="no"){return }else{var O=new Wtf.leavem.LeaveAdjustWindow({title:"Unpaid leaves",height:400,width:450,modal:true,resizable:false,paycycleend:this.paycycleend,emptempstore:this.emptempstore,empstore:this.empstore,paycyclestart:this.paycyclestart,TempId:this.TempId,fromdateempG:this.fromdateempG,todateempG:this.todateempG,layout:"fit",iconCls:getTabIconCls(Wtf.etype.iconwin),bodyStyle:"background-color: #f1f1f1;",arr:this.arr,extraarr:this.extraarr});O.show()}}})}else{var J=new Wtf.leavem.LeaveAdjustWindow({title:"Unpaid leaves",height:400,width:450,modal:true,resizable:false,paycycleend:this.paycycleend,emptempstore:this.emptempstore,empstore:this.empstore,paycyclestart:this.paycyclestart,TempId:this.TempId,fromdateempG:this.fromdateempG,todateempG:this.todateempG,layout:"fit",iconCls:getTabIconCls(Wtf.etype.iconwin),bodyStyle:"background-color: #f1f1f1;",arr:this.arr,extraarr:this.extraarr});J.show()}}}));this.extrausergrid=new Wtf.grid.GridPanel({enableColumnHide:false,trackMouseOver:true,stripeRows:true,id:"incometaxgridpanel",region:"south",height:250,loadMask:true,displayInfo:true,searchField:"rate",viewConfig:{forceFit:true},store:this.emptempstore,cm:this.cm,border:true,sm:this.emptempsm,tbar:["Others Employee for the selected paycycle"]});this.empgrid=new Wtf.KwlGridPanel({border:true,region:"center",store:this.empstore,cm:this.cm,enableColumnHide:false,trackMouseOver:true,stripeRows:true,loadMask:true,displayInfo:true,searchLabel:" ",searchLabelSeparator:" ",searchEmptyText:"Search by Employee Name",searchField:"EName",serverSideSearch:true,paging:false,viewConfig:{forceFit:true,emptyText:WtfGlobal.emptyGridRenderer("Select the Pay Cycle...")},sm:this.empsm,width:700,tbar:E});this.gridcontainerpanel=new Wtf.Panel({region:"center",layout:"border",id:"gridcontainerpanel",bbar:I,items:[this.empgrid,this.extrausergrid]});this.extrausergrid.hide();this.empsm.on("selectionchange",function(){this.customEnableDisable(I,this.empgrid,[3],[]);this.customEnableDisable(E,this.empgrid,[],[1]);if(this.empsm.hasSelection()){var K=this.empsm.getSelections();var J=this.emptempsm.getSelections();if((K.length+J.length)>1){this.mypdf.disable()}else{if(K[0].get("generated")=="1"){this.mypdf.enable()}else{this.mypdf.disable()}}}else{this.mypdf.disable()}},this);this.emptempsm.on("selectionchange",function(){this.customEnableDisable(I,this.extrausergrid,[3],[]);this.customEnableDisable(E,this.extrausergrid,[],[1]);if(this.emptempsm.hasSelection()){var J=this.empsm.getSelections();var K=this.emptempsm.getSelections();if((K.length+J.length)>1){this.mypdf.disable()}else{if(K[0].get("generated")=="1"){this.mypdf.enable()}else{this.mypdf.disable()}}}else{this.mypdf.disable()}},this);this.empgrid.on("cellclick",this.deletePayslip,this);this.extrausergrid.on("cellclick",this.deletePayslip,this);this.MainDataEntryPanelT=new Wtf.Panel({title:this.tempName,border:false,layout:"border",bodyStyle:"background:white",scope:this,items:[this.filterpanel,this.gridcontainerpanel]});this.add(this.MainDataEntryPanelT);this.doLayout();this.on("activate",function(K,J){this.doLayout()});this.fromdateempG.on("change",function(){var J=this.grouptempgrid.getSelectionModel();if(J.hasSelection()){calMsgBoxShow(202,4,true);var K=J.getSelections();this.tempids=[];for(i=0;i<this.templates.length;i++){this.tempids.push(this.templates[i].get("TempID"))}this.empstore.baseParams={groupid:this.tempids,stdate:this.fromdateempG.getRawValue(),enddate:this.todateempG.getRawValue()};this.empstore.load()}},this);this.dateComp.on("change",function(){this.calculatepaycycle()},this)},customEnableDisable:function(B,E,A,D){var F=!(this.extrausergrid.getSelectionModel().hasSelection()||this.empgrid.getSelectionModel().hasSelection());var G=((this.extrausergrid.getSelectionModel().getCount()+this.empgrid.getSelectionModel().getCount())!=1);for(var C=0;C<D.length;C++){B[D[C]].setDisabled(F)}for(C=0;C<A.length;C++){B[A[C]].setDisabled(G)}},onKeyUpEvent:function(A){if(this.quickSearchEmpField.getValue()!=""){this.timer.cancel();this.timer.delay(1000,this.onKeyUpHandler,this)}},onKeyUpHandler:function(){var A=this.emptempds.getAt(0).data.paycyclestart;var B=this.grouptempgrid.getSelectionModel().getSelections();Wtf.Ajax.requestEx({url:"Emp/getEmpCycle.py",scope:this,method:"post",params:{cyclestartdate:A,cycleenddate:A,ss:this.quickSearchEmpField.getValue(),groupid:B[0].get("TempID")}},this,function(F){var G=F.effdate;if(G!=""){var C=new Date(G.replace(new RegExp("-","g"),"/"));for(var D=this.emptempds.data.length-1;D>=0;D--){var E=new Date(this.emptempds.getAt(D).data.paycyclestart.replace(new RegExp("-","g"),"/"));if(C<=E){this.paycyclesm.selectRow(D);break}}}},function(C){})},getempsalaries:function(){if(this.arr.length==0&&this.extraarr.length==0){calMsgBoxShow(19,0)}else{this.jsondata="";var B=0;for(i=0;i<this.arr.length;i++){var C=this.paycycleend;var A=0;if(this.arr[i].get("paycycleend")!=null&&this.arr[i].get("paycycleend")!=undefined&&this.arr[i].get("paycycleend")!=""){C=this.arr[i].get("paycycleend");A=1}this.jsondata+="{'EName':'"+this.arr[i].get("EName")+"',";this.jsondata+="'AccNo':'"+this.arr[i].get("AccNo")+"',";this.jsondata+="'Wage':'"+this.arr[i].get("Wage")+"',";this.jsondata+="'FixedSal':'"+this.arr[i].get("FixedSal")+"',";this.jsondata+="'Tax':'"+this.arr[i].get("Tax")+"',";this.jsondata+="'Deduc':'"+this.arr[i].get("Deduc")+"',";this.jsondata+="'mappingid':'"+this.arr[i].get("mappingid")+"',";this.jsondata+="'empid':'"+this.arr[i].get("empid")+"',";this.jsondata+="'design':'"+this.arr[i].get("design")+"',";this.jsondata+="'paycyclestart':'"+this.paycyclestart+"',";this.jsondata+="'paycycleend':'"+C+"',";this.jsondata+="'ischanged':'"+A+"',";this.jsondata+="'template':'"+this.arr[i].get("tempid")+"'},";if(this.arr[i].get("Salary")<0){B=1;break}}for(i=0;i<this.extraarr.length;i++){C=this.paycycleend;A=0;if(this.extraarr[i].get("paycycleend")!=null&&this.extraarr[i].get("paycycleend")!=undefined&&this.extraarr[i].get("paycycleend")!=""){C=this.extraarr[i].get("paycycleend");A=1}this.jsondata+="{'EName':'"+this.extraarr[i].get("EName")+"',";this.jsondata+="'AccNo':'"+this.extraarr[i].get("AccNo")+"',";this.jsondata+="'Wage':'"+this.extraarr[i].get("Wage")+"',";this.jsondata+="'FixedSal':'"+this.extraarr[i].get("FixedSal")+"',";this.jsondata+="'Tax':'"+this.extraarr[i].get("Tax")+"',";this.jsondata+="'Deduc':'"+this.extraarr[i].get("Deduc")+"',";this.jsondata+="'mappingid':'"+this.extraarr[i].get("mappingid")+"',";this.jsondata+="'empid':'"+this.extraarr[i].get("empid")+"',";this.jsondata+="'design':'"+this.extraarr[i].get("design")+"',";this.jsondata+="'paycyclestart':'"+this.paycyclestart+"',";this.jsondata+="'paycycleend':'"+C+"',";this.jsondata+="'ischanged':'"+A+"',";this.jsondata+="'template':'"+this.extraarr[i].get("tempid")+"'},";if(this.extraarr[i].get("Salary")<0){B=1;break}}this.trmLen1=this.jsondata.length-1;this.jsondata=this.jsondata.substr(0,this.trmLen1);if(B==0){calMsgBoxShow(202,4,true);Wtf.Ajax.requestEx({url:"Emp/setPayrollforTemp.py",scope:this,method:"post",params:{save:"true",saveType:"PayHistoryforTemp",jsondata:this.jsondata,TempId:this.TempId,stdate:this.fromdateempG.getRawValue(),enddate:this.todateempG.getRawValue(),action:1,paycyclestart:this.paycyclestart,paycycleend:this.paycycleend}},this,function(D){var E=D.value.toString();if(E=="success"){calMsgBoxShow(["Success",D.msg.toString()],0,false,250);this.emptempstore.removeAll();this.extrausergrid.selModel.clearSelections();this.empstore.load()}else{if(E=="failure"){Wtf.MessageBox.alert("Warning",D.msg.toString())}}},function(D){})}else{calMsgBoxShow(157,0)}}},getemployeelist:function(){this.groupuserds.proxy.conn.url="Payroll/Template/getuserlist.py";this.grouptempgrid.getColumnModel().setHidden(4,true);this.grouptempgrid.getColumnModel().setHidden(5,true);this.grouptempgrid.getColumnModel().setColumnHeader(3,"Employee Name");this.groupuserds.reload({params:{start:0,limit:this.lastlimitoption}})},getTemplatelist:function(){this.groupuserds.proxy.conn.url="Payroll/Template/getPayProcessData.py";this.grouptempgrid.getColumnModel().setHidden(4,false);this.grouptempgrid.getColumnModel().setHidden(5,false);this.grouptempgrid.getColumnModel().setColumnHeader(3,"Payroll Templates");this.groupuserds.reload({params:{start:0,limit:this.lastlimitoption}})},calculatepaycycle:function(){if(this.emptempdriven.getValue()&&this.selectionModel.getCount()>0){this.quickSearchEmpField.enable();this.dateComp.enable()}this.payintervalgrid.selModel.clearSelections();this.empstore.removeAll();this.emptempstore.removeAll();this.payintervalgrid.getView().emptyText=WtfGlobal.emptyGridRenderer("No template assigned to this employee");if(this.selectionModel.getSelections().length>0){if(this.emptempdriven.getValue()){var H=[];this.emptempds.removeAll();var G=this.selectionModel.getSelected();if(G.get("payinterval")==1){var D=G.get("effdate");if(this.dateComp.getValue()==""){var C=new Date()}else{var C=this.dateComp.getValue()}C=new Date(C.getMonth()+"/"+D+"/"+(C.getFullYear()));C=C.add(Date.MONTH,-5);for(var B=0;B<10;B++){C=C.add(Date.MONTH,1);var F=C.add(Date.MONTH,1);F=F.add(Date.DAY,-1);H.push(new this.paycyclerec({"paycyclestart":C.format("m-d-Y"),"paycycleactualend":F.format("m-d-Y"),"paycycleend":F.format("m-d-Y"),"TempID":G.get("TempID"),"paycycleshowstart":C.format(WtfGlobal.getDateFormat()),"paycycleshowend":F.format(WtfGlobal.getDateFormat())}))}this.emptempds.insert(0,H)}else{if(G.get("payinterval")==2){var D=G.get("effdate");if(this.dateComp.getValue()==""){var C=new Date()}else{var C=this.dateComp.getValue()}C=new Date(C.getMonth()+"/"+D+"/"+(C.getFullYear()));C=C.add(Date.MONTH,-3);for(var B=0;B<10;B++){if(new Date(C.getFullYear(),C.getMonth()+1,0).getDate()==31&&C.getDate()==16){C=C.add(Date.DAY,16)}else{C=C.add(Date.DAY,15)}if(new Date(C.getFullYear(),C.getMonth()+1,0).getDate()==31&&C.getDate()==16){var F=C.add(Date.DAY,16)}else{var F=C.add(Date.DAY,15)}F=F.add(Date.DAY,-1);H.push(new this.paycyclerec({"paycyclestart":C.format("m-d-Y"),"paycycleactualend":F.format("m-d-Y"),"paycycleend":F.format("m-d-Y"),"TempID":G.get("TempID"),"paycycleshowstart":C.format(WtfGlobal.getDateFormat()),"paycycleshowend":F.format(WtfGlobal.getDateFormat())}))}this.emptempds.insert(0,H)}else{if(G.get("payinterval")==3){var D=G.get("effdate")-1;if(this.dateComp.getValue()==""){var C=new Date()}else{var C=this.dateComp.getValue()}C=C.add(Date.MONTH,-1);var I=C.getDate();var E=C.getDay();var A=D-E;C.setDate(I+A);for(var B=0;B<10;B++){C=C.add(Date.DAY,7);var F=C.add(Date.DAY,7);F=F.add(Date.DAY,-1);H.push(new this.paycyclerec({"paycyclestart":C.format("m-d-Y"),"paycycleactualend":F.format("m-d-Y"),"paycycleend":F.format("m-d-Y"),"TempID":G.get("TempID"),"paycycleshowstart":C.format(WtfGlobal.getDateFormat()),"paycycleshowend":F.format(WtfGlobal.getDateFormat())}))}this.emptempds.insert(0,H)}}}}else{if(this.empdriven.getValue()){var G=this.selectionModel.getSelected();this.selectedEmp=G.get("id");this.emptempds.reload({params:{userid:G.get("id")}})}}}},getemployees:function(){if(this.grouptempgrid.selModel.getCount()>0){if(this.payintervalgrid.selModel.getCount()>0){this.empgrid.getView().emptyText=WtfGlobal.emptyGridRenderer("No employee assigned for the selected template for this duration");this.templates=this.payintervalgrid.selModel.getSelections();this.tempids=[];for(i=0;i<this.templates.length;i++){this.tempids.push(this.templates[i].get("TempID"))}this.paycyclestart="";this.paycycleend="";if(this.paycyclesm.getCount()>0){var A=this.paycyclesm.getSelected();this.paycyclestart=A.get("paycyclestart");this.paycycleend=A.get("paycycleend");this.paycycleactualend=A.get("paycycleactualend")}if(this.paycyclestart!=""&&this.paycycleend!=""){this.empstore.removeAll();this.emptempstore.removeAll();this.empstore.baseParams={groupid:this.tempids,stdate:this.fromdateempG.getRawValue(),enddate:this.todateempG.getRawValue(),paycyclestart:this.paycyclestart,paycycleend:this.paycycleend};this.empstore.load()}}else{this.empstore.removeAll();this.emptempstore.removeAll();this.empgrid.getView().emptyText=WtfGlobal.emptyGridRenderer("Select the Pay Cycle...");this.empgrid.getView().refresh()}}else{this.empgrid.getView().emptyText=WtfGlobal.emptyGridRenderer("Select the Pay Cycle...");this.empgrid.getView().refresh()}},exportReport:function(I,H,A,D,G,E){var J=this.paycycleend;if(E[0].get("paycycleend")!=null&&E[0].get("paycycleend")!=undefined&&E[0].get("paycycleend")!=""){J=E[0].get("paycycleend")}var F="";var C='{"data": []}';if(I==1){C='{"data": ["No","From", "To", "Duration", "Reason", "Type Of Leave", "Paid", "LPW", "Employee Signature", "Approver Signature", "Balance"]}'}var B="../../exportLeavePdfServlet.jsp?&flag="+I+"&colHeader="+C+"&userIDs="+F+"&reportname="+A+"&exporttype="+H+"&empid="+D+"&cname="+G+"&stdate="+this.paycyclestart+"&flagpdf=datewise&enddate="+J;setDldUrl(B)},deletePayslip:function(gd,ri,ci,e){if(ci==6){var rec=gd.getSelectionModel().getSelections();var created=rec[0].get("generated");var empid=rec[0].get("empid");var paycycleend=(rec[0].get("paycycleend")=="")?this.paycycleend:rec[0].get("paycycleend");Wtf.MessageBox.show({title:"Confirm",msg:" Are you sure you want to delete the salary details of the employee?",icon:Wtf.MessageBox.QUESTION,buttons:Wtf.MessageBox.YESNO,scope:this,fn:function(button){if(button=="no"){return }else{Wtf.Ajax.requestEx({url:"Emp/deletePayslipDetails.py",method:"post",params:{empid:empid,enddate:(this.empdriven.getValue())?this.paycycleactualend:this.paycycleend,startdate:this.paycyclestart}},this,function(response){var res=eval("("+response+")");var msg=res.msg;if(res.msg=="No salary details found for this duration."&&created=="1"&&!this.empdriven.getValue()){msg="Please delete payslip from Employee Driven."}Wtf.Msg.show({title:"Success",msg:""+msg+"",scope:this,width:300,buttons:Wtf.Msg.OK,fn:function(btn,value){this.mypdf.disable();calMsgBoxShow(202,4,true);this.emptempstore.removeAll();this.extrausergrid.selModel.clearSelections();this.empstore.load()},animEl:"elId",icon:Wtf.MessageBox.INFO})},function(req,res){calMsgBoxShow(27,1)})}}})}}});Wtf.leavem.LeaveAdjustWindow=function(A){Wtf.apply(this,A);Wtf.leavem.LeaveAdjustWindow.superclass.constructor.call(this,A)};Wtf.extend(Wtf.leavem.LeaveAdjustWindow,Wtf.Window,{initComponent:function(){Wtf.leavem.LeaveAdjustWindow.superclass.initComponent.call(this)},onRender:function(B){Wtf.leavem.LeaveAdjustWindow.superclass.onRender.call(this,B);this.createLeavetypeAdjGrid();var A=Array();this.adjLeavesPanel=new Wtf.Panel({frame:true,border:false,scope:this,layout:"fit",items:[{border:false,layout:"border",items:[{region:"north",height:80,border:false,bodyStyle:"background:white;border-bottom:1px solid #bfbfbf;",html:getTopHtml("Unpaid Leaves","Fill the no. of unpaid leaves for respective users")},{border:false,region:"center",bodyStyle:"background:#f1f1f1;font-size:10px;",layout:"fit",items:[this.typeGrid]}]}],buttonAlign:"right",buttons:[{text:"Submit",handler:function(){this.getempsalaries()},scope:this},{text:"Cancel",handler:function(){this.close()},scope:this}]});this.add(this.adjLeavesPanel)},getempsalaries:function(){if(this.arr.length==0&&this.extraarr.length==0){calMsgBoxShow(19,0)}else{this.jsondata="";var D=0;for(var B=0;B<this.arr.length;B++){var E=this.paycycleend;var A=0;if(this.arr[B].get("paycycleend")!=null&&this.arr[B].get("paycycleend")!=undefined&&this.arr[B].get("paycycleend")!=""){E=this.arr[B].get("paycycleend");A=1}this.jsondata+="{'EName':'"+this.arr[B].get("EName")+"',";this.jsondata+="'AccNo':'"+this.arr[B].get("AccNo")+"',";this.jsondata+="'Wage':'"+this.arr[B].get("Wage")+"',";this.jsondata+="'FixedSal':'"+this.arr[B].get("FixedSal")+"',";this.jsondata+="'Tax':'"+this.arr[B].get("Tax")+"',";this.jsondata+="'Deduc':'"+this.arr[B].get("Deduc")+"',";this.jsondata+="'mappingid':'"+this.arr[B].get("mappingid")+"',";this.jsondata+="'empid':'"+this.arr[B].get("empid")+"',";this.jsondata+="'design':'"+this.arr[B].get("design")+"',";this.jsondata+="'paycyclestart':'"+this.paycyclestart+"',";this.jsondata+="'paycycleend':'"+E+"',";this.jsondata+="'ischanged':'"+A+"',";if(this.arr[B].get("tempinterval")=="1"){if(this.LeavetypeAdjStore.getAt(B).data.leaveAdj>30){D=1;break}}else{if(this.arr[B].get("tempinterval")=="2"){if(this.LeavetypeAdjStore.getAt(B).data.leaveAdj>15){D=1;break}}else{if(this.arr[B].get("tempinterval")=="3"){if(this.LeavetypeAdjStore.getAt(B).data.leaveAdj>7){D=1;break}}}}this.jsondata+="'unpaidleaves':'"+this.LeavetypeAdjStore.getAt(B).data.leaveAdj+"',";this.jsondata+="'template':'"+this.arr[B].get("tempid")+"'},";if(this.arr[B].get("Salary")<0){D=1;break}}var C=this.arr.length;for(B=0;B<this.extraarr.length;B++){E=this.paycycleend;A=0;if(this.extraarr[B].get("paycycleend")!=null&&this.extraarr[B].get("paycycleend")!=undefined&&this.extraarr[B].get("paycycleend")!=""){E=this.extraarr[B].get("paycycleend");A=1}this.jsondata+="{'EName':'"+this.extraarr[B].get("EName")+"',";this.jsondata+="'AccNo':'"+this.extraarr[B].get("AccNo")+"',";this.jsondata+="'Wage':'"+this.extraarr[B].get("Wage")+"',";this.jsondata+="'FixedSal':'"+this.extraarr[B].get("FixedSal")+"',";this.jsondata+="'Tax':'"+this.extraarr[B].get("Tax")+"',";this.jsondata+="'Deduc':'"+this.extraarr[B].get("Deduc")+"',";this.jsondata+="'mappingid':'"+this.extraarr[B].get("mappingid")+"',";this.jsondata+="'empid':'"+this.extraarr[B].get("empid")+"',";this.jsondata+="'design':'"+this.extraarr[B].get("design")+"',";this.jsondata+="'paycyclestart':'"+this.paycyclestart+"',";this.jsondata+="'paycycleend':'"+E+"',";this.jsondata+="'ischanged':'"+A+"',";if(this.extraarr[B].get("tempinterval")=="1"){if(this.LeavetypeAdjStore.getAt(B).data.leaveAdj>30||this.LeavetypeAdjStore.getAt(B).data.leaveAdj<0){D=1;break}}else{if(this.extraarr[B].get("tempinterval")=="2"){if(this.LeavetypeAdjStore.getAt(B).data.leaveAdj>15){D=1;break}}else{if(this.extraarr[B].get("tempinterval")=="3"){if(this.LeavetypeAdjStore.getAt(B).data.leaveAdj>7){D=1;break}}}}this.jsondata+="'unpaidleaves':'"+this.LeavetypeAdjStore.getAt(C+B).data.leaveAdj+"',";this.jsondata+="'template':'"+this.extraarr[B].get("tempid")+"'},";if(this.extraarr[B].get("Salary")<0){D=1;break}}this.trmLen1=this.jsondata.length-1;this.jsondata=this.jsondata.substr(0,this.trmLen1);if(D==0){calMsgBoxShow(202,4,true);Wtf.Ajax.requestEx({url:"Emp/setPayrollforTemp.py",scope:this,method:"post",params:{save:"true",saveType:"PayHistoryforTemp",jsondata:this.jsondata,TempId:this.TempId,stdate:this.fromdateempG.getRawValue(),enddate:this.todateempG.getRawValue(),action:1,paycyclestart:this.paycyclestart,paycycleend:this.paycycleend}},this,function(F){var G=F.value.toString();if(G=="success"){calMsgBoxShow(["Success",F.msg.toString()],0,false,250);this.emptempstore.removeAll();Wtf.getCmp("incometaxgridpanel").selModel.clearSelections();this.empstore.load()}else{if(G=="failure"){Wtf.MessageBox.alert("Warning",F.msg.toString())}}this.close()},function(F){})}else{calMsgBoxShow(157,0)}}},createLeavetypeAdjGrid:function(){this.createLeavetypeAdjStore(this.leavetypeid,this.leavetype,this.leaveadj);this.LeavetypeAdjStore=new Wtf.data.SimpleStore({fields:["ename","leaveAdj"],data:this.storeData});this.cm=new Wtf.grid.ColumnModel([{header:"Employee Name",dataIndex:"ename"},{header:"Unpaid Leaves",dataIndex:"leaveAdj",align:"right",editor:new Wtf.form.NumberField({allowBlank:false,maxValue:30})}]);this.LeavetypeAdjStore.on("load",function(){Wtf.MsgClose()},this);this.LeavetypeAdjStore.on("beforeload",function(){msgBoxShow(35,4,5,true)},this);this.LeavetypeAdjStore.on("loadexception",function(){Wtf.MsgClose()},this);this.sm2=new Wtf.grid.RowSelectionModel({width:25,singleSelect:true});this.typeGrid=new Wtf.grid.EditorGridPanel({store:this.LeavetypeAdjStore,cm:this.cm,sm:this.sm2,loadMask:true,layout:"fit",viewConfig:{forceFit:true},clicksToEdit:1})},createLeavetypeAdjStore:function(F,E,B){var A=new Array();for(var C=0;C<this.arr.length;C++){var D=new Array();D.push(this.arr[C].data.EName);D.push(0);A.push(D)}for(var C=0;C<this.extraarr.length;C++){D=new Array();D.push(this.extraarr[C].data.EName);D.push(0);A.push(D)}this.storeData=A},submitLeaveAdj:function(B,A){var E=false;var D="{'root': [";for(var C=0;C<this.LeavetypeAdjStore.getCount();C++){var F=this.LeavetypeAdjStore.getAt(C);if(F.dirty){E=true;D+=this.getJsonFromRecord(F)+","}}if(E){D=D.substr(0,D.length-1)}D+="]}";Wtf.Ajax.requestEx({method:"POST",url:Wtf.req.leavejsp+"leavemanager.jsp?",params:{flag:23,jsondata:D,userid:this.userid}},this,function(G,H){this.gridstore.reload();this.close();msgBoxShow(["Success","Leave adjustment is done successfully"],1,1)},function(G,H){msgBoxShow(["Error","Problem occured while connecting to server"],0,1);this.close()})},getJsonFromRecord:function(A){var B='{"id":"'+A.data["id"]+'", "leavetype":"'+A.data["leavetype"]+'", "leaveadj": "'+A.data["leaveAdj"]+'"}';return B}});Wtf.GenSalaryReport=function(A){Wtf.GenSalaryReport.superclass.constructor.call(this,A);A.autoScroll=false;this.addEvents({"announce":true})};Wtf.extend(Wtf.GenSalaryReport,Wtf.Panel,{onRender:function(C){Wtf.GenSalaryReport.superclass.onRender.call(this,C);this.maxUsers=0;this.costPerUser=0;this.count=0;this.cnamedata=[["January","1"],["February","2"],["March","3"],["April","4"],["May","5"],["June","6"],["July","7"],["August","8"],["September","9"],["October","10"],["November","11"],["December","12"]];this.combostore=new Wtf.data.SimpleStore({fields:[{name:"cname"},{name:"mid"}]});this.combostore.loadData(this.cnamedata);this.TaxName=new Wtf.form.ComboBox({fieldLabel:"Customer Name",store:this.combostore,displayField:"cname",mode:"local",scope:this,emptyText:"Select a Month",selectOnFocus:true,width:120,height:200,triggerAction:"all",listeners:{scope:this,select:function(E,F,D){this.month=this.combostore.getAt(D).get("cname")}}});this.fromdaterep=new Wtf.form.DateField({width:155,id:"fromdaterep",scope:this,readOnly:true,emptyText:"From Date ",format:"m/d/Y",value:new Date().add(Date.MONTH,-1).getFirstDateOfMonth()});this.todaterep=new Wtf.form.DateField({width:155,readOnly:true,id:"todaterep",scope:this,emptyText:"To Date ",format:"m/d/Y",value:new Date().add(Date.MONTH,+1).getLastDateOfMonth()});this.usersRecS=new Wtf.data.Record.create([{name:"EName"},{name:"Wage"},{name:"AccNo"},{name:"month"},{name:"Tax"},{name:"Deduc"},{name:"Salary"},{name:"FixedSal"},{name:"empid"},{name:"design"},{name:"tempid"},{name:"tempname"},{name:"stdate",type:"date"},{name:"enddate",type:"date"}]);this.userstore=new Wtf.data.Store({reader:new Wtf.data.KwlJsonReader({root:"data",totalProperty:"totalcount"},this.usersRecS),url:Wtf.req.base+"PayrollHandler.jsp"});var B=this.fromdaterep.getValue().format("m/d/Y");var A=this.todaterep.getValue().format("m/d/Y");calMsgBoxShow(202,4,true);this.userstore.baseParams={type:"ReportPerMonth",stdate:B,enddate:A};this.userstore.load({params:{start:0,limit:15}});this.userstore.on("load",function(){if(msgFlag==1){WtfGlobal.closeProgressbar()}},this);this.selectionModel=new Wtf.grid.CheckboxSelectionModel();this.rowNo=new Wtf.grid.RowNumberer();this.selectionModel=new Wtf.grid.CheckboxSelectionModel();this.gridcmodel=new Wtf.grid.ColumnModel([this.rowNo,{header:"Employee Name",dataIndex:"EName",pdfwidth:60,sortable:true,groupable:true},{header:"Month",dataIndex:"month",align:"center",pdfwidth:60,sortable:true,groupable:true},{header:"Start date",dataIndex:"stdate",pdfwidth:60,align:"center",renderer:WtfGlobal.onlyDateRenderer,sortable:true,groupable:true},{header:"End date",dataIndex:"enddate",pdfwidth:60,align:"center",renderer:WtfGlobal.onlyDateRenderer,sortable:true,groupable:true},{header:"Earning",dataIndex:"Wage",sortable:true,align:"right",pdfwidth:60,groupable:true,renderer:function(D){if(D!=null){return('<div align="right">'+WtfGlobal.currencyRenderer(parseFloat(D).toFixed(2))+"</div>")}}},{header:"Taxes",dataIndex:"Tax",sortable:true,pdfwidth:60,align:"right",groupable:true,renderer:function(D){if(D!=null){return('<div align="right">'+WtfGlobal.currencyRenderer(parseFloat(D).toFixed(2))+"</div>")}}},{header:"Deductions",dataIndex:"Deduc",sortable:true,pdfwidth:65,align:"right",groupable:true,renderer:function(D){if(D!=null){return('<div align="right"">'+WtfGlobal.currencyRenderer(parseFloat(D).toFixed(2))+"</div>")}}},{header:"Net Pay",dataIndex:"Salary",scope:this,pdfwidth:60,align:"right",sortable:true,groupable:true,summaryType:"sum",summaryRenderer:WtfGlobal.currencySummaryRenderer,renderer:function(D){if(D!=null){return('<div align="right"">'+WtfGlobal.currencyRenderer(parseFloat(D).toFixed(2))+"</div>")}}},{header:"Template",dataIndex:"tempname",pdfwidth:60,align:"center",sortable:true,groupable:true}],this);this.summary=new Wtf.ux.grid.GridSummary();this.salusergrid=new Wtf.KwlGridPanel({enableColumnHide:false,trackMouseOver:true,autoScroll:false,stripeRows:true,plugins:[this.summary],searchLabel:" ",searchLabelSeparator:" ",displayInfo:true,loadMask:true,searchEmptyText:"Search by Employee Name",searchField:"EName",serverSideSearch:true,viewConfig:{forceFit:true,emptyText:WtfGlobal.emptyGridRenderer("No salary records till now")},store:this.userstore,cm:this.gridcmodel,region:"west",scope:this,width:400,id:"salusergrid",sm:new Wtf.grid.CheckboxSelectionModel({singleSelect:false,scope:this,listeners:{scope:this,rowselect:function(G,E,D){var F=this.salusergrid.getSelectionModel().getSelected().data;this.ename=F.EName;this.salary=F.Wage;this.fixedsal=F.FixedSal;this.tax=F.Tax;this.deduc=F.Deduc;this.empid=F.empid;this.design=F.design;this.TempId=F.tempid},rowdeselect:function(F,E,D){}}}),tbar:["-",new Wtf.Toolbar.Button({text:"Reset",scope:this,iconCls:"pwndRefresh",handler:function(){this.userstore.load({params:{start:0,limit:this.salusergrid.pag.pageSize}});Wtf.getCmp("Quick"+this.salusergrid.id).setValue("")}}),"-","Start date:",this.fromdaterep,"-","End date",this.todaterep,"-",{text:"Generate Salary Report",tooltip:"Select a start and an end date and generate report for that time period containing the salary details.",minWidth:100,scope:this,iconCls:getButtonIconCls(Wtf.btype.reportbutton),handler:function(){var E=this.fromdaterep.getValue().format("m/d/Y");var D=this.todaterep.getValue().format("m/d/Y");this.userstore.removeAll();this.userstore.baseParams={type:"ReportPerMonth",stdate:E,enddate:D};calMsgBoxShow(202,4,true);this.userstore.load({scope:this,params:{start:0,limit:this.salusergrid.pag.pageSize}});this.userstore.on("load",function(){WtfGlobal.closeProgressbar()},this)}},"-",this.expBtn=new Wtf.exportButton({obj:this,menuItem:{csv:true,pdf:true,rowPdf:true},get:4,url:"../../export.jsp",filename:WtfGlobal.HTMLStripper(this.title)})]});this.grid=this.salusergrid;this.UsergridPanel2=new Wtf.Panel({border:false,autoLoad:false,paging:false,layout:"fit",items:[this.salusergrid]});this.innerpanel2=new Wtf.Panel({layout:"fit",cls:"backcolor",border:false,items:[this.UsergridPanel2]});this.add(this.innerpanel2)}});function callLink1(){var A=Wtf.getCmp("link1");if(A==null){A=new Wtf.Panel({id:"link1",border:false,layout:"fit",title:"Link 1",closable:true});Wtf.getCmp("as").add(A)}Wtf.getCmp("as").setActiveTab(A);A.doLayout()}function callLink2(){var A=Wtf.getCmp("link2");if(A==null){A=new Wtf.Panel({id:"link2",border:false,layout:"fit",title:"Link 2",closable:true});Wtf.getCmp("as").add(A)}Wtf.getCmp("as").setActiveTab(A);A.doLayout()}Wtf.AddPayrollTemplate=function(A){Wtf.form.Field.prototype.msgTarget="side";A.layout="fit";A.closable=true;Wtf.AddPayrollTemplate.superclass.constructor.call(this,A)};Wtf.extend(Wtf.AddPayrollTemplate,Wtf.Panel,{showhide:function(C,D,E){C.setVisible(D);C.container.up("div.x-form-item").dom.style.display=E;var B=C.el.findParent("div.x-form-item",4,true);var A=B.first("label.x-form-item-label");A.dom.style.display=E},initComponent:function(C){Wtf.AddPayrollTemplate.superclass.initComponent.call(this,C);var D=new Wtf.data.Record.create([{name:"name"},{name:"id"}]);var B=new Wtf.data.ArrayReader({},D);var A=[["Once a month",1],["Twice a month",2],["Once a week",3]];var E=new Wtf.data.Store({reader:B,data:A});this.payintervalCombo=new Wtf.form.ComboBox({fieldLabel:"Payment Interval*",mode:"local",displayField:"name",valueField:"id",allowBlank:false,name:"payinterval",typeAhead:true,hiddenName:"payinterval",triggerAction:"all",store:E,listeners:{scope:this,change:function(){if(this.payintervalCombo.getValue()==1){this.showhide(this.datepicker,true,"block");this.showhide(this.daypicker,false,"none");this.datepicker.setValue("");this.datestore.removeAll();this.datestore.loadData(this.monthlydata)}else{if(this.payintervalCombo.getValue()==3){this.showhide(this.datepicker,false,"none");this.showhide(this.daypicker,true,"block")}else{if(this.payintervalCombo.getValue()==2){this.showhide(this.datepicker,true,"block");this.showhide(this.daypicker,false,"none");this.datepicker.setValue("");this.datestore.removeAll();this.datestore.loadData(this.bimonthlydata)}}}}}});this.payintervalCombo.on("select",function(G,H,F){this.assignedUsersPanel.setpayinterval(H.get("id"))},this);this.monthlydata=[["1","1st"],["2","2nd"],["3","3rd"],["4","4th"],["5","5th"],["6","6th"],["7","7th"],["8","8th"],["9","9th"],["10","10th"],["11","11th"],["12","13th"],["14","15th"],["16","16th"],["17","17th"],["18","18th"],["19","19th"],["20","20th"],["21","21th"],["22","22th"],["23","23th"],["24","24th"],["25","25th"],["26","26th"],["27","27th"],["28","28th"],["29","29th"],["30","30th"],["31","31th"]];this.bimonthlydata=[["1","1st"],["16","16th"]];this.datestore=new Wtf.data.SimpleStore({fields:["id","name"],data:this.monthlydata});this.daystore=new Wtf.data.SimpleStore({fields:["id","name"],data:[["1","Sunday"],["2","Monday"],["3","Tuesday"],["4","Wednesday"],["5","Thursday"],["6","Friday"],["7","Saturday"]]});this.datepicker=new Wtf.form.ComboBox({fieldLabel:"Date*",store:this.datestore,name:"date",displayField:"name",valueField:"id",mode:"local",triggerAction:"all",hidden:true,hideLabel:true});this.datepicker.on("select",function(G,H,F){this.assignedUsersPanel.seteffdate(H.get("id"))},this);this.daypicker=new Wtf.form.ComboBox({fieldLabel:"Day",store:this.daystore,name:"date",displayField:"name",valueField:"id",mode:"local",triggerAction:"all",hidden:true,hideLabel:true});this.daypicker.on("select",function(G,H,F){this.assignedUsersPanel.seteffdate(H.get("id"))},this);this.designcombo=new Wtf.form.FnComboBox({fieldLabel:"Add to Designation*",labelWidth:200,scope:this,allowBlank:false,store:Wtf.desigStore,triggerAction:"all",disabled:(this.edit==1)?true:false,typeAhead:true,emptyText:"Select designation",displayField:"name",valueField:"id",hiddenName:"id",name:"categoryname",mode:"local",forceSelection:true,width:200,addNewFn:this.addDesignation.createDelegate(this),plugins:[new Wtf.common.comboAddNew({handler:function(){if(!this.isDesgDisabled){WtfGlobal.showmasterWindow(1,Wtf.desigStore,"Add");this.designcombo.collapse()}},scope:this})],listeners:{scope:this,select:function(H,F,G){new Wtf.form.Hidden({id:this.id+this.globname+"GlobalGroupId",value:F.get("id"),readOnly:true})}}});this.designcombo.on("disable",function(){this.isDesgDisabled=true},this);this.tempformPanel=new Wtf.form.FormPanel({region:"north",border:false,layout:"column",scope:this,style:"height:12%",bodyStyle:"margin-left:1%;margin-top:1%",defaults:{labelWidth:120},items:[{xtype:"panel",columnWidth:0.25,border:false,layout:"form",items:[this.tempname=new Wtf.form.TextField({fieldLabel:"Template Name*",allowBlank:false,validator:WtfGlobal.noBlankCheck,scope:this,value:this.editMode?this.templatename:"",maxLength:50})]},{xtype:"panel",columnWidth:0.25,border:false,hidden:true,bodyStyle:"padding-left:10px;",layout:"form",items:[this.startrange=new Wtf.form.NumberField({fieldLabel:' Salary Range/Month (<span align="right" style="font-family:Lucida Sans Unicode;">'+WtfGlobal.getCurrencySymbol()+"</span>)",allowBlank:false,allowNegative:false,value:0,id:this.id+"salarystartrange",maxLength:10,scope:this})]},{xtype:"panel",columnWidth:0.15,border:false,hidden:true,layout:"form",items:[this.endrange=new Wtf.form.NumberField({allowBlank:false,maxLength:10,value:0,allowNegative:false,scope:this,vtype:"range",initialPassField:this.id+"salarystartrange",hideLabel:true})]},{xtype:"panel",columnWidth:0.28,border:false,labelWidth:80,bodyStyle:"padding-left:5px;",layout:"form",items:[this.designcombo]},{xtype:"panel",columnWidth:0.28,border:false,labelWidth:105,bodyStyle:"padding-left:5px",layout:"form",items:[this.payintervalCombo]},{xtype:"panel",columnWidth:0.28,border:false,labelWidth:107,bodyStyle:"padding-left:5px",layout:"form",items:[this.datepicker,this.daypicker]}]});this.wageentryform=new Wtf.WageEntryForm({inv:this.endrange.getValue(),paramstore:"0",bodyStyle:"padding:10px;background-color:white",region:"center",parentId:this.id,id:this.id+"addwage"});this.empcontribform=new Wtf.EmployerContributionForm({inv:this.endrange.getValue(),paramstore:"0",bodyStyle:"padding:10px;background-color:white",region:"south",parentId:this.id,height:300,id:this.id+"addempcontrib"});this.taxentryform=new Wtf.WageTaxDeducWin({paramstore:"0",bodyStyle:"padding:10px;background-color:white",region:"south",parentId:this.id,height:300,id:this.id+"addtax"});this.deductionentryform=new Wtf.DeducEntryForm({paramstore:"0",bodyStyle:"padding:10px;background-color:white",region:"center",parentId:this.id,id:this.id+"adddeduc"});this.assignedUsersPanel=new Wtf.userPayCycleGrid({region:"east",width:"33%",bodyStyle:"padding:10px;background-color:white",border:false,templateid:this.templateid});this.SecondPanelA=new Wtf.Panel({layout:"border",region:"center",border:false,scope:this,style:"height:88%",items:[new Wtf.Panel({border:false,split:false,width:"34%",layout:"border",region:"west",items:[this.wageentryform,this.empcontribform]}),new Wtf.Panel({border:false,split:true,width:"33%",layout:"border",region:"center",items:[this.deductionentryform,this.taxentryform]}),this.assignedUsersPanel]});this.designcombo.on("select",function(G,H,F){this.assignedUsersPanel.setDesignationId(H.get("id"))},this);this.MainDataEntryPanelA=new Wtf.Panel({layout:"border",bodyStyle:"background:#FFFFFF",scope:this,border:false,autoScroll:true,items:[this.tempformPanel,this.SecondPanelA],bbar:["->",{text:"Save and Close",scope:this,id:"editTemp1",iconCls:"pwndCommon submitnexitbuttonIcon",minWidth:40,handler:function(){this.saveTemplateA(true)}},"-",{text:"Save",scope:this,id:"editTemp",iconCls:getButtonIconCls(Wtf.btype.submitbutton),minWidth:40,handler:function(){this.saveTemplateA(false)}}]});this.add(this.MainDataEntryPanelA);this.doLayout();this.on("activate",function(G,F){this.doLayout()});if(this.editMode){new Wtf.form.Hidden({id:"GlobalCompanyName1",value:"companyid",readOnly:true});if(this.deductionentryform.storededuc.getCount()>0){this.deductionentryform.storededuc.removeAll()}this.deductionentryform.storededucforgrid.proxy.conn.url="Payroll/Deduction/getDeductionData.py?cname=aa&TempId="+this.templateid;this.deductionentryform.storededucforgrid.load({params:{type:"TDeduction"}});if(this.taxentryform.storetax.getCount()>0){this.taxentryform.storetax.removeAll()}this.taxentryform.storetaxforgrid.proxy.conn.url="Payroll/Tax/getTaxData.py?cname=aa&TempId="+this.templateid;this.taxentryform.storetaxforgrid.load({params:{type:"TTax"}});if(this.wageentryform.storewage.getCount()>0){this.wageentryform.storewage.removeAll()}this.wageentryform.storewageforgrid.proxy.conn.url="Payroll/Wage/getWagesData.py?cname=aa&TempId="+this.templateid;this.wageentryform.storewageforgrid.load({params:{type:"TWages"}});if(this.empcontribform.storewage.getCount()>0){this.empcontribform.storewage.removeAll()}this.empcontribform.storewageforgrid.proxy.conn.url="Payroll/EmpContrib/getEmployerContribData.py?cname=aa&TempId="+this.templateid;this.empcontribform.storewageforgrid.load({params:{type:"TEC"}});this.doLayout();this.wageentryform.grid.on("validateedit",function(F){Wtf.getCmp("editTemp").enable();Wtf.getCmp("editTemp1").enable()},this);this.taxentryform.grid.on("validateedit",function(F){Wtf.getCmp("editTemp").enable();Wtf.getCmp("editTemp1").enable()},this);this.deductionentryform.DeductionGridPanel.on("validateedit",function(F){Wtf.getCmp("editTemp").enable();Wtf.getCmp("editTemp").enable()},this)}this.saveTemplateA=function(N){if(this.payintervalCombo.getValue()==1||this.payintervalCombo.getValue()==2){if(this.datepicker.getValue()==""){calMsgBoxShow(5,0);return }}else{if(this.daypicker.getValue()==""){calMsgBoxShow(5,0);return }}if(this.tempformPanel.form.isValid()){var O=this.assignedUsersPanel.getRecordsJSON();var H=this.wageentryform.grid.getStore().getCount()-1;var J=this.taxentryform.grid.getStore().getCount()-1;var G=this.deductionentryform.DeductionGridPanel.getStore().getCount()-1;var L=this.empcontribform.grid.getStore().getCount()-1;if(H>0){if(parseFloat(this.startrange.getValue())<=parseFloat(this.endrange.getValue())){var M=this.calcTotalAmountA(this.wageentryform.grid.getStore(),"cash","rate",parseFloat(this.endrange.getValue()));var K=this.calcTotalAmountA(this.deductionentryform.DeductionGridPanel.getStore(),"cash","rate",parseFloat(this.endrange.getValue()));var I=this.calcTotalAmountA(this.taxentryform.grid.getStore(),"cash","rate",parseFloat(this.endrange.getValue()));this.frmdta="{TName:'"+this.tempname.getValue()+"',";this.frmdta+="RStart:'"+this.startrange.getValue()+"',";this.frmdta+="REnd:'"+this.endrange.getValue()+"',";this.frmdta+="payInterval:'"+this.payintervalCombo.getValue()+"',";if(this.payintervalCombo.getValue()==1){this.frmdta+="effdate:'"+this.datepicker.getValue()+"',"}else{if(this.payintervalCombo.getValue()==3){this.frmdta+="effdate:'"+this.daypicker.getValue()+"',"}else{if(this.payintervalCombo.getValue()==2){this.frmdta+="effdate:'"+this.datepicker.getValue()+"',"}}}this.frmdta+="GId:'"+this.designcombo.getValue()+"'}";this.saveTemplateData="{TaxDataADD:[";for(i=0;i<J;i++){if(i>0){this.saveTemplateData+=","}this.saveTemplateData+="{TaxId:'"+this.taxentryform.grid.getStore().getAt(i).get("id")+"',TaxRate:'"+this.taxentryform.grid.getStore().getAt(i).get("cash")+"'}"}this.saveTemplateData+="]}";this.saveTemplateData1="{WageDataADD:[";for(i=0;i<H;i++){if(i>0){this.saveTemplateData1+=","}if(this.wageentryform.grid.getStore().getAt(i).get("id")==-1){calMsgBoxShow(28,0);return }this.saveTemplateData1+="{WageId:'"+this.wageentryform.grid.getStore().getAt(i).get("id")+"',WageRate:'"+this.wageentryform.grid.getStore().getAt(i).get("cash")+"'}"}this.saveTemplateData1+="]}";this.saveTemplateData2="{DeducDataADD:[";for(i=0;i<G;i++){if(i>0){this.saveTemplateData2+=","}if(this.deductionentryform.DeductionGridPanel.getStore().getAt(i).get("id")==-1){calMsgBoxShow(28,0);return }this.saveTemplateData2+="{DeducId:'"+this.deductionentryform.DeductionGridPanel.getStore().getAt(i).get("id")+"',DeducRate:'"+this.deductionentryform.DeductionGridPanel.getStore().getAt(i).get("cash")+"'}"}this.saveTemplateData2+="]}";this.saveTemplateData3="{ECDataADD:[";for(i=0;i<L;i++){if(i>0){this.saveTemplateData3+=","}if(this.empcontribform.grid.getStore().getAt(i).get("id")==-1){calMsgBoxShow(28,0);return }this.saveTemplateData3+="{Id:'"+this.empcontribform.grid.getStore().getAt(i).get("id")+"',ECRate:'"+this.empcontribform.grid.getStore().getAt(i).get("cash")+"'}"}this.saveTemplateData3+="]}";var F="";if(this.edit==1){F="Payroll/Template/updateTemplateData.py"}else{F="Payroll/Template/setTemplateData.py"}Wtf.MessageBox.confirm("Confirm","Do you want to save the changes?",function(P){if(P=="yes"){Wtf.Ajax.requestEx({url:F,method:"post",params:{save:"true",saveType:"templatedata",formdata:this.frmdta,taxdata:this.saveTemplateData,wagedata:this.saveTemplateData1,deducdata:this.saveTemplateData2,ecdata:this.saveTemplateData3,assignedEmployees:O,torp:1,tempid:this.templateid,tempname:this.tempname.getValue(),templatename:this.templatename}},this,function(Q){if(Q.value=="success"){msgFlag=0;calMsgBoxShow(1,0);this.groupGridStore.baseParams={PayProc:"get"};this.groupGridStore.load({params:{start:0,limit:15}});if(N){Wtf.getCmp("mainpayrolltab").remove(this.id,true)}}else{if(Q.value=="Exist"){calMsgBoxShow(2,0)}}},function(Q){})}else{return }},this)}else{calMsgBoxShow(3,0)}}else{calMsgBoxShow(["Warning","Please insert earnings"],0)}}else{calMsgBoxShow(5,0)}};this.wageentryform.storewage.on("load",function(){if(!Wtf.StoreMgr.containsKey("desig")){Wtf.desigStore.load();Wtf.StoreMgr.add("desig",Wtf.desigStore);Wtf.desigStore.on("load",function(){this.onloadfunc()},this)}else{this.onloadfunc()}},this)},onloadfunc:function(){if(this.editMode){this.k=0;for(this.k=0;this.k<Wtf.desigStore.getCount();this.k++){if(Wtf.desigStore.getAt(this.k).get("name")==this.group){new Wtf.form.Hidden({id:"GlobalGroupId",value:Wtf.desigStore.getAt(this.k).get("id"),readOnly:true})}}this.designcombo.setValue(this.group);if(this.payinterval!=""){this.payintervalCombo.setValue(this.payinterval);this.payintervalCombo.fireEvent("change");if(this.payintervalCombo.getValue()==1){this.datepicker.setValue(this.effdate)}else{if(this.payintervalCombo.getValue()==3){this.daypicker.setValue(this.effdate)}else{this.datepicker.setValue(this.effdate)}}}this.assignedUsersPanel.setDesignationId(this.group);this.assignedUsersPanel.setpayinterval(this.payinterval);this.assignedUsersPanel.seteffdate(this.effdate)}},calcTotalAmount:function(A,F,E,D){var C=0;for(var B=0;B<A.length;B++){var H=A[B];var G=H.data[F]*1;if(H.data[E]=="1"){G=(D/100)*G}C+=G}return C},calcTotalAmountA:function(A,F,E,D){var C=0;for(var B=0;B<A.getCount();B++){var H=A.getAt(B);var G=H.data[F]*1;if(H.data[E]=="1"){G=(D/100)*G}C+=G}return C},convertToPercent:function(A,F,E,D){var C=0;for(var B=0;B<A.getCount();B++){var H=A.getAt(B);var G=0;if(H.data[E]=="0"){G=(H.data[F]/D)*100;H.data[F]=G}}},addDesignation:function(){WtfGlobal.showmasterWindow(1,Wtf.desigStore,"Add")},setDesignation:function(){if(Wtf.desigStore.getCount()>0){this.designcombo.setValue(Wtf.desigStore.getAt(Wtf.desigStore.getCount()-1).get("id"))}}});Wtf.WageEntryForm=function(A){A.border=false;A.layout="fit";Wtf.WageEntryForm.superclass.constructor.call(this,A);Wtf.apply(this,A)};Wtf.extend(Wtf.WageEntryForm,Wtf.Panel,{initComponent:function(A){Wtf.WageEntryForm.superclass.initComponent.call(this,A);this.earncomp=0;this.deduccomp=0;this.netcomp=0;this.fieldswage=[{name:"type"},{name:"cash"},{name:"code"},{name:"id"},{name:"assigned"},{name:"rate"},{name:"amount"},{name:"depwage"},{name:"depwageid"},{name:"computeon"},{name:"expr"},{name:"comp"}];this.expander=new Wtf.grid.RowExpander({tpl:new Wtf.XTemplate("<p>&nbsp;&nbsp;&nbsp;&nbsp;<b>Compute on:</b> {[this.f(values)]}</p>",{f:function(K){var E=K.computeon;var I=Wtf.getCmp(this.id);if(E=="0"){return"Current Deductions"}else{if(E=="1"){return"Current Earnings"}else{if(E=="2"){return"Net Salary"}else{if(E=="3"){var B="";var M=K.expr.split("(add)");I.storewage.clearFilter(true);for(var F=0;F<M.length;F++){var L=M[F].split("(sub)");for(var G=0;G<L.length;G++){var H=L[G].split("*");var D=1;var J;if(H.length>1){D=H[0];J=H[1]}else{J=H[0]}if(J==-1){if(G==0){B+="+"}else{B+="-"}B+=D+" * <b>Template Basic</b>"}var C=I.storewage.find("id",J);if(C>-1){if(G==0){B+="+"}else{B+="-"}B+=D+" * "+I.storewage.getAt(C).get("type")}}}return B}else{return"N/A"}}}}}},this)});this.wcheckboxselection=new Wtf.grid.CheckboxSelectionModel({scope:this,singleSelect:false});this.fieldswage=Wtf.data.Record.create(this.fieldswage);this.readerwage=new Wtf.data.KwlJsonReader({root:"data",totalProperty:"totalCount"},this.fieldswage);this.storewage=new Wtf.data.Store({url:"Payroll/Wage/getWageMaster.py",method:"GET",reader:this.readerwage});this.storewageforgrid=new Wtf.data.Store({url:"Payroll/Wage/getDefualtWages.py",method:"GET",reader:this.readerwage});this.storewageforgrid.load({params:{type:"getDefualtWages",start:0,grouper:"addpayroll",limit:15}});this.storewageforgrid.on("load",function(){var B=this.storewageforgrid.query("computeon","1");this.earncomp=B.length;this.addemptyrec()},this);this.ratenumberfield=new Wtf.form.NumberField({allowNegative:false,decimalPrecision:2});this.Wtypecombo=new Wtf.form.ComboBox({store:this.storewage,fieldLabel:"Wage Type Name",displayField:"type",mode:"local",valueField:"type",forceSelection:true,scope:this,width:180,height:200,triggerAction:"all",listeners:{scope:this,select:function(C,D,B){this.insertrate=this.grid.getSelectionModel().getSelected();this.insertrateRate=D.get("cash");this.insertrateCode=D.get("code");this.insertrateId=D.get("id");this.insertratetype=D.get("type");this.insertrateratetype=D.get("rate");this.insertratedepwage=D.get("depwage");this.insertratedepwageid=D.get("depwageid");this.insertratecomputeon=D.get("computeon");this.insertrateexpr=D.get("expr")}}});this.Wtypecombo.on("expand",function(B,C){this.storewage.filter("comp","wage")},this);this.cmwage=new Wtf.grid.ColumnModel([this.expander,{header:"Wage Type",dataIndex:"type",editor:this.Wtypecombo,width:200},{header:"Code",dataIndex:"code"},{header:"Value",dataIndex:"cash",renderer:function(F,E,B,G,D,C){if(B.data.rate=="1"){return('<div align="right">'+parseFloat(F).toFixed(2)+" %</div>")}else{return('<div align="right" style="font-family:Lucida Sans Unicode;">'+WtfGlobal.payrollcurrencyRenderer(F)+"</div>")}}},{header:"Percent of",dataIndex:"computeon",align:"center",sortable:true,renderer:this.rendererfun.createDelegate(this)},{header:"Delete",dataIndex:"",width:35,renderer:this.deleteRenderer.createDelegate(this)}]);this.storewage.load({params:{allflag:"true",type:"Wages",cname:"aa",deduc:"true",empcont:"true",grouper:"addpayroll",start:0,limit:15}});this.sm=new Wtf.grid.CheckboxSelectionModel({scope:this});this.gridrowselection=function(){};this.grid=new Wtf.grid.EditorGridPanel({store:this.storewageforgrid,stripeRows:true,id:this.id+"addwagegrid",scope:this,sm:this.wcheckboxselection,height:440,clicksToEdit:1,title:"Earnings",plugins:this.expander,viewConfig:{forceFit:true,emptyText:WtfGlobal.emptyGridRenderer("No wage assigned for current salary template")},cm:this.cmwage});this.grid.on("validateedit",function(D){this.currentedit=D.record;if(this.grid.getStore().find("type",D.value)==-1){if(this.insertratecomputeon=="0"){var C=this.id.split("addwage");if(C.length>0){var B=Wtf.getCmp(C[0]+"adddeduc");if(B!=null){if(B.earncomp>0||B.netcomp>0){Wtf.MessageBox.show({title:"Operation not permitted!!",msg:"As you have included a component in Deduction which is dependent on Wage, you cannot include a Deduction dependent component in Wage ",buttons:Wtf.MessageBox.OK,animEl:"mb9",scope:this,icon:Wtf.MessageBox.INFO});this.cancel=true;return false}else{this.deduccomp++;this.insertcomp(D.column)}}}}else{if(this.insertratecomputeon=="1"){if(this.earncomp>0||this.netcomp>0){Wtf.MessageBox.show({title:"Operation not permitted!!",msg:"You cannot include two components which depends on each other.",buttons:Wtf.MessageBox.OK,animEl:"mb9",scope:this,icon:Wtf.MessageBox.INFO});this.cancel=true;return false}else{this.earncomp++;this.insertcomp(D.column)}}else{if(this.insertratecomputeon=="2"){if(this.earncomp>0||this.netcomp>0){Wtf.MessageBox.show({title:"Operation not permitted!!",msg:"You cannot include two components which depends on each other.",buttons:Wtf.MessageBox.OK,animEl:"mb9",scope:this,icon:Wtf.MessageBox.INFO});this.cancel=true;return false}else{var C=this.id.split("addwage");if(C.length>0){var B=Wtf.getCmp(C[0]+"adddeduc");if(B!=null){if(B.earncomp>0||B.netcomp>0){Wtf.MessageBox.show({title:"Operation not permitted!!",msg:"As you have included a component in Deduction which is dependent on Wage, you cannot include a Deduction dependent component in Wage ",buttons:Wtf.MessageBox.OK,animEl:"mb9",scope:this,icon:Wtf.MessageBox.INFO});this.cancel=true;return false}else{this.netcomp++;this.insertcomp(D.column)}}}}}else{if(this.insertratecomputeon=="3"){Wtf.MessageBox.show({title:"Warning",msg:"The selected component has some dependencies. If you want to use this component the system will also include these dependencies. Do you want to continue?",buttons:Wtf.MessageBox.YESNO,animEl:"mb9",scope:this,icon:Wtf.MessageBox.INFO,fn:function(E,F){if(E=="yes"){this.insertcomp(D.column);this.storewage.clearFilter(true);this.getdep(this.insertrateexpr);this.storewage.filter("comp","wage")}else{this.grid.getStore().remove(D.record);this.cancel=true;return false}}});this.grid.getView().refresh()}else{this.insertcomp(D.column)}}}}}else{this.cancel=true;return false}if(D.record.data.rate=="1"){if(D.record.data.cash>100){return false}}},this);this.grid.on("afteredit",function(B){if(B.row==this.grid.getStore().getCount()-1){this.addemptyrec();this.grid.getSelectionModel().selectAll();this.grid.getSelectionModel().deselectRow(this.grid.getStore().getCount()-1)}},this);this.add(this.grid);this.on("activate",function(C,B){this.doLayout()});this.storewage.on("load",function(){if(this.edittemp=="yes"){for(this.i=0;this.i<this.grid.getStore().getCount()-1;this.i++){this.rec=this.grid.getStore().getAt(this.i);if(this.rec.get("assigned")=="1"){this.wcheckboxselection.selectRow(this.i,true)}}}},this);if(this.edittemp=="yes"){this.storewageforgrid.on("load",function(){var B=this.storewageforgrid.query("computeon","1");var D=this.storewageforgrid.query("computeon","2");var C=this.storewageforgrid.query("computeon","0");this.earncomp=B.length;this.netcomp=D.length;this.deduccomp=C.length;this.grid.getSelectionModel().selectAll();this.grid.getSelectionModel().deselectRow(this.grid.getStore().getCount()-1)},this)}this.grid.on("click",function(F){if(F.target.className=="pwndCommon gridCancel"){var E=this.grid.getSelectionModel().getSelected();if(this.grid.getSelectionModel().getSelections().length>0){if(this.grid.getStore().indexOf(E)!=this.grid.getStore().getCount()-1){for(var G=0;G<this.grid.getStore().data.length-1;G++){var B=this.grid.getStore().getAt(G).data.expr;if(B.indexOf(E.data.id)!=-1){calMsgBoxShow(["Warning","Cannot deleted.Some other components are depends on this wage."],2);return }}var D=(this.edittemp=="yes")?Wtf.getCmp(this.parentId).taxentryform1.storetaxforgrid:Wtf.getCmp(this.parentId).taxentryform.storetaxforgrid;var C=(this.edittemp=="yes")?Wtf.getCmp(this.parentId).deductionentryform1.storededucforgrid:Wtf.getCmp(this.parentId).deductionentryform.storededucforgrid;for(G=0;G<C.data.length;G++){var B=C.getAt(G).data.expr;if(B!=undefined){if(B.indexOf(E.data.id)!=-1){calMsgBoxShow(["Warning","Cannot deleted.Some other components are depends on this wage."],2);return }}}this.grid.getStore().remove(this.grid.getSelectionModel().getSelected());if(E.get("computeon")==0){this.deduccomp--}if(E.get("computeon")==1){this.earncomp--}if(E.get("computeon")==2){this.netcomp--}Wtf.getCmp("editTemp").enable()}}}},this);this.record=new Wtf.data.Record.create([{name:"type"},{name:"cash"},{name:"id"},{name:"code"}]);if(this.paramstore!=1){this.addemptyrec()}},rendererfun:function(F,L,K,P,G,O,I){if(K.get("rate")==0){return"-"}if(F=="0"){return"Current Deductions"}else{if(F=="1"){return"Current Earnings"}else{if(F=="2"){return"Net Salary"}else{if(F=="3"){var A="";var N=K.get("expr").split("(add)");this.storewage.clearFilter(true);for(var E=0;E<N.length;E++){var M=N[E].split("(sub)");for(var D=0;D<M.length;D++){var H=M[D].split("*");var C=1;var J;if(H.length>1){C=H[0];J=H[1]}else{J=H[0]}if(J==-1){if(D==0){A+="+"}else{A+="-"}A+=C+" * <b>Template Basic</b>"}var B=this.storewage.find("id",J);if(B>-1){if(D==0){A+="+"}else{A+="-"}A+=C+" * "+this.storewage.getAt(B).get("type")}}}return A}}}}},insertcomp:function(A){this.insertrate=this.currentedit;if(A==1){this.insertrate.beginEdit();this.insertrate.set("cash",this.insertrateRate);this.insertrate.set("code",this.insertrateCode);this.insertrate.set("id",this.insertrateId);this.insertrate.set("rate",this.insertrateratetype);this.insertrate.set("depwage",this.insertratedepwage);this.insertrate.set("type",this.insertratetype);this.insertrate.set("depwageid",this.insertratedepwageid);this.insertrate.set("computeon",this.insertratecomputeon);this.insertrate.set("expr",this.insertrateexpr);this.insertrate.endEdit()}},getdep:function(M){var L=M.split("(add)");for(var B=0;B<L.length;B++){var K=L[B].split("(sub)");for(var C=0;C<K.length;C++){var E=K[C].split("*");var F;if(E.length>1){F=E[1]}else{F=E[0]}var G=this.grid.getStore().find("id",F);if(G==-1&&K[C]!=""){var A=this.storewage.find("id",F);if(A>-1){var D;var H;var J=this.storewage.getAt(A);if(J.get("comp")=="wage"){this.grid.getStore().insert(0,J)}else{if(J.get("comp")=="empcontrib"){D=this.id.split("addwage");if(D.length>0){var I=Wtf.getCmp(D[0]+"addempcontrib");if(I!=null){H=I.storewageforgrid.find("id",F);if(H==-1){I.addrecord(J)}}}}else{D=this.id.split("addwage");if(D.length>0){var N=Wtf.getCmp(D[0]+"adddeduc");if(N!=null){H=N.storededucforgrid.find("id",F);if(H==-1){N.addrecord(J)}}}}}if(J.get("computeon")=="3"){this.getdep(J.get("expr"))}}}}}},addemptyrec:function(){this.grid.getStore().add(new this.record({type:"",cash:"",id:"-1",code:""}))},deleteRenderer:function(B,A,D,C){if(D.data.id!="-1"){return"<div><div class='pwndCommon gridCancel' style='cursor:pointer' wtf:qtip='Delete Record'></div></div>"}},addrecord:function(A){this.grid.getStore().insert(0,A)}});Wtf.EmployerContributionForm=function(A){A.border=false;A.layout="fit";Wtf.EmployerContributionForm.superclass.constructor.call(this,A);Wtf.apply(this,A)};Wtf.extend(Wtf.EmployerContributionForm,Wtf.Panel,{initComponent:function(A){Wtf.EmployerContributionForm.superclass.initComponent.call(this,A);this.earncomp=0;this.deduccomp=0;this.netcomp=0;this.fieldswage=[{name:"type"},{name:"cash"},{name:"code"},{name:"id"},{name:"assigned"},{name:"rate"},{name:"amount"},{name:"computeon"},{name:"expr"},{name:"comp"}];this.expander=new Wtf.grid.RowExpander({tpl:new Wtf.XTemplate("<p>&nbsp;&nbsp;&nbsp;&nbsp;<b>Compute on:</b> {[this.f(values)]}</p>",{f:function(K){var E=K.computeon;var I=Wtf.getCmp(this.id);if(E=="0"){return"Current Deductions"}else{if(E=="1"){return"Current Earnings"}else{if(E=="2"){return"Net Salary"}else{if(E=="3"){var B="";var M=K.expr.split("(add)");I.storewage.clearFilter(true);for(var F=0;F<M.length;F++){var L=M[F].split("(sub)");for(var G=0;G<L.length;G++){var H=L[G].split("*");var D=1;var J;if(H.length>1){D=H[0];J=H[1]}else{J=H[0]}if(J==-1){if(G==0){B+="+"}else{B+="-"}B+=D+" * <b>Template Basic</b>"}var C=I.storewage.find("id",J);if(C>-1){if(G==0){B+="+"}else{B+="-"}B+=D+" * "+I.storewage.getAt(C).get("type")}}}return B}else{return"N/A"}}}}}},this)});this.wcheckboxselection=new Wtf.grid.CheckboxSelectionModel({scope:this,singleSelect:false});this.fieldswage=Wtf.data.Record.create(this.fieldswage);this.readerwage=new Wtf.data.KwlJsonReader({root:"data",totalProperty:"totalCount"},this.fieldswage);this.storewage=new Wtf.data.Store({url:"Payroll/EmpContrib/getEmpContribMaster.py",method:"GET",reader:this.readerwage});this.storewageforgrid=new Wtf.data.Store({url:"Payroll/EmpContrib/getDefaultEmpContrib.py",method:"GET",reader:this.readerwage});this.storewageforgrid.load({params:{type:"getDefaultEmpContrib",start:0,grouper:"addpayroll",limit:15}});this.storewageforgrid.on("load",function(){var B=this.storewageforgrid.query("computeon","1");this.earncomp=B.length;this.addemptyrec()},this);this.ratenumberfield=new Wtf.form.NumberField({allowNegative:false,decimalPrecision:2});this.Wtypecombo=new Wtf.form.ComboBox({store:this.storewage,fieldLabel:"Emmployer Contribution Type Name",displayField:"type",mode:"local",valueField:"type",forceSelection:true,scope:this,width:180,height:200,triggerAction:"all",listeners:{scope:this,select:function(C,D,B){this.insertrate=this.grid.getSelectionModel().getSelected();this.insertrateRate=D.get("cash");this.insertrateCode=D.get("code");this.insertrateId=D.get("id");this.insertratetype=D.get("type");this.insertrateratetype=D.get("rate");this.insertratecomputeon=D.get("computeon");this.insertrateexpr=D.get("expr")}}});this.Wtypecombo.on("expand",function(B,C){this.storewage.filter("comp","empcontrib")},this);this.cmwage=new Wtf.grid.ColumnModel([this.expander,{header:"Employer Contribution Type",dataIndex:"type",editor:this.Wtypecombo,width:200},{header:"Code",dataIndex:"code"},{header:"Value",dataIndex:"cash",renderer:function(F,E,B,G,D,C){if(B.data.rate=="1"){return('<div align="right">'+parseFloat(F).toFixed(2)+" %</div>")}else{return('<div align="right" style="font-family:Lucida Sans Unicode;">'+WtfGlobal.payrollcurrencyRenderer(F)+"</div>")}}},{header:"Percent of",dataIndex:"computeon",align:"center",sortable:true,renderer:this.rendererfun.createDelegate(this)},{header:"Delete",dataIndex:"",width:35,renderer:this.deleteRenderer.createDelegate(this)}]);this.storewage.load({params:{allflag:"true",type:"EmpContrib",cname:"aa",deduction:"true",wage:"true",grouper:"addpayroll",start:0,limit:15}});this.sm=new Wtf.grid.CheckboxSelectionModel({scope:this});this.gridrowselection=function(){};this.grid=new Wtf.grid.EditorGridPanel({store:this.storewageforgrid,stripeRows:true,id:this.id+"addempcontrigrid",scope:this,sm:this.wcheckboxselection,height:440,clicksToEdit:1,title:"Employer Contribution",plugins:this.expander,viewConfig:{forceFit:true,emptyText:WtfGlobal.emptyGridRenderer("No employer contribution assigned for current salary template")},cm:this.cmwage});this.grid.on("validateedit",function(D){this.currentedit=D.record;if(this.grid.getStore().find("type",D.value)==-1){if(this.insertratecomputeon=="0"){var C=this.id.split("addempcontrib");if(C.length>0){var B=Wtf.getCmp(C[0]+"adddeduc");if(B!=null){if(B.earncomp>0||B.netcomp>0){Wtf.MessageBox.show({title:"Operation not permitted!!",msg:"As you have included a component in Deduction which is dependent on Wage, you cannot include a Deduction dependent component in Wage ",buttons:Wtf.MessageBox.OK,animEl:"mb9",scope:this,icon:Wtf.MessageBox.INFO});this.cancel=true;return false}else{this.deduccomp++;this.insertcomp(D.column)}}}}else{if(this.insertratecomputeon=="1"){if(this.earncomp>0||this.netcomp>0){Wtf.MessageBox.show({title:"Operation not permitted!!",msg:"You cannot include two components which depends on each other.",buttons:Wtf.MessageBox.OK,animEl:"mb9",scope:this,icon:Wtf.MessageBox.INFO});this.cancel=true;return false}else{this.earncomp++;this.insertcomp(D.column)}}else{if(this.insertratecomputeon=="2"){if(this.earncomp>0||this.netcomp>0){Wtf.MessageBox.show({title:"Operation not permitted!!",msg:"You cannot include two components which depends on each other.",buttons:Wtf.MessageBox.OK,animEl:"mb9",scope:this,icon:Wtf.MessageBox.INFO});this.cancel=true;return false}else{var C=this.id.split("addempcontrib");if(C.length>0){var B=Wtf.getCmp(C[0]+"adddeduc");if(B!=null){if(B.earncomp>0||B.netcomp>0){Wtf.MessageBox.show({title:"Operation not permitted!!",msg:"As you have included a component in Deduction which is dependent on Wage, you cannot include a Deduction dependent component in Wage ",buttons:Wtf.MessageBox.OK,animEl:"mb9",scope:this,icon:Wtf.MessageBox.INFO});this.cancel=true;return false}else{this.netcomp++;this.insertcomp(D.column)}}}}}else{if(this.insertratecomputeon=="3"){Wtf.MessageBox.show({title:"Warning",msg:"The selected component has some dependencies. If you want to use this component the system will also include these dependencies. Do you want to continue?",buttons:Wtf.MessageBox.YESNO,animEl:"mb9",scope:this,icon:Wtf.MessageBox.INFO,fn:function(E,F){if(E=="yes"){this.insertcomp(D.column);this.storewage.clearFilter(true);this.getdep(this.insertrateexpr);this.storewage.filter("comp","empcontrib")}else{this.grid.getStore().remove(D.record);this.cancel=true;return false}}});this.grid.getView().refresh()}else{this.insertcomp(D.column)}}}}}else{this.cancel=true;return false}if(D.record.data.rate=="1"){if(D.record.data.cash>100){return false}}},this);this.grid.on("afteredit",function(B){if(B.row==this.grid.getStore().getCount()-1){this.addemptyrec();this.grid.getSelectionModel().selectAll();this.grid.getSelectionModel().deselectRow(this.grid.getStore().getCount()-1)}},this);this.add(this.grid);this.on("activate",function(C,B){this.doLayout()});this.storewage.on("load",function(){if(this.edittemp=="yes"){for(this.i=0;this.i<this.grid.getStore().getCount()-1;this.i++){this.rec=this.grid.getStore().getAt(this.i);if(this.rec.get("assigned")=="1"){this.wcheckboxselection.selectRow(this.i,true)}}}},this);if(this.edittemp=="yes"){this.storewageforgrid.on("load",function(){var B=this.storewageforgrid.query("computeon","1");var D=this.storewageforgrid.query("computeon","2");var C=this.storewageforgrid.query("computeon","0");this.earncomp=B.length;this.netcomp=D.length;this.deduccomp=C.length;this.grid.getSelectionModel().selectAll();this.grid.getSelectionModel().deselectRow(this.grid.getStore().getCount()-1)},this)}this.grid.on("click",function(F){if(F.target.className=="pwndCommon gridCancel"){var E=this.grid.getSelectionModel().getSelected();if(this.grid.getSelectionModel().getSelections().length>0){if(this.grid.getStore().indexOf(E)!=this.grid.getStore().getCount()-1){for(var G=0;G<this.grid.getStore().data.length-1;G++){var B=this.grid.getStore().getAt(G).data.expr;if(B.indexOf(E.data.id)!=-1){calMsgBoxShow(["Warning","Cannot deleted.Some other components are depends on this employer contribution."],2);return }}var D=(this.edittemp=="yes")?Wtf.getCmp(this.parentId).taxentryform1.storetaxforgrid:Wtf.getCmp(this.parentId).taxentryform.storetaxforgrid;var C=(this.edittemp=="yes")?Wtf.getCmp(this.parentId).deductionentryform1.storededucforgrid:Wtf.getCmp(this.parentId).deductionentryform.storededucforgrid;for(G=0;G<C.data.length;G++){var B=C.getAt(G).data.expr;if(B!=undefined){if(B.indexOf(E.data.id)!=-1){calMsgBoxShow(["Warning","Cannot deleted.Some other components are depends on this employer contribution."],2);return }}}this.grid.getStore().remove(this.grid.getSelectionModel().getSelected());if(E.get("computeon")==0){this.deduccomp--}if(E.get("computeon")==1){this.earncomp--}if(E.get("computeon")==2){this.netcomp--}Wtf.getCmp("editTemp").enable()}}}},this);this.record=new Wtf.data.Record.create([{name:"type"},{name:"cash"},{name:"id"},{name:"code"}]);if(this.paramstore!=1){this.addemptyrec()}},rendererfun:function(F,L,K,P,G,O,I){if(K.get("rate")==0){return"-"}if(F=="0"){return"Current Deductions"}else{if(F=="1"){return"Current Earnings"}else{if(F=="2"){return"Net Salary"}else{if(F=="3"){var A="";var N=K.get("expr").split("(add)");this.storewage.clearFilter(true);for(var E=0;E<N.length;E++){var M=N[E].split("(sub)");for(var D=0;D<M.length;D++){var H=M[D].split("*");var C=1;var J;if(H.length>1){C=H[0];J=H[1]}else{J=H[0]}if(J==-1){if(D==0){A+="+"}else{A+="-"}A+=C+" * <b>Template Basic</b>"}var B=this.storewage.find("id",J);if(B>-1){if(D==0){A+="+"}else{A+="-"}A+=C+" * "+this.storewage.getAt(B).get("type")}}}return A}}}}},insertcomp:function(A){this.insertrate=this.currentedit;if(A==1){this.insertrate.beginEdit();this.insertrate.set("cash",this.insertrateRate);this.insertrate.set("code",this.insertrateCode);this.insertrate.set("id",this.insertrateId);this.insertrate.set("rate",this.insertrateratetype);this.insertrate.set("depwage",this.insertratedepwage);this.insertrate.set("type",this.insertratetype);this.insertrate.set("depwageid",this.insertratedepwageid);this.insertrate.set("computeon",this.insertratecomputeon);this.insertrate.set("expr",this.insertrateexpr);this.insertrate.endEdit()}},getdep:function(M){var L=M.split("(add)");for(var B=0;B<L.length;B++){var K=L[B].split("(sub)");for(var C=0;C<K.length;C++){var E=K[C].split("*");var G;if(E.length>1){G=E[1]}else{G=E[0]}var H=this.grid.getStore().find("id",G);if(H==-1&&K[C]!=""){var A=this.storewage.find("id",G);if(A>-1){var D;var I;var J=this.storewage.getAt(A);if(J.get("comp")=="empcontrib"){this.grid.getStore().insert(0,J)}else{if(J.get("comp")=="wage"){D=this.id.split("addempcontrib");if(D.length>0){var F=Wtf.getCmp(D[0]+"addwage");if(F!=null){I=F.storewageforgrid.find("id",G);if(I==-1){F.addrecord(J)}}}}else{D=this.id.split("addempcontrib");if(D.length>0){var N=Wtf.getCmp(D[0]+"adddeduc");if(N!=null){I=N.storededucforgrid.find("id",G);if(I==-1){N.addrecord(J)}}}}}if(J.get("computeon")=="3"){this.getdep(J.get("expr"))}}}}}},addemptyrec:function(){this.grid.getStore().add(new this.record({type:"",cash:"",id:"-1",code:""}))},deleteRenderer:function(B,A,D,C){if(D.data.id!="-1"){return"<div><div class='pwndCommon gridCancel' style='cursor:pointer' wtf:qtip='Delete Record'></div></div>"}},addrecord:function(A){this.grid.getStore().insert(0,A)}});Wtf.PayrollGroupTemplate=function(A){A.border=false;A.activeTab=0;A.id="mainpayrolltab";A.enableTabScroll=true;Wtf.PayrollGroupTemplate.superclass.constructor.call(this,A)};Wtf.extend(Wtf.PayrollGroupTemplate,Wtf.TabPanel,{initComponent:function(A){Wtf.PayrollGroupTemplate.superclass.initComponent.call(this,A);this.xg=Wtf.grid;this.sm=new Wtf.grid.CheckboxSelectionModel({singleSelect:false,scope:this});this.gridfields=[{name:"GroupName"},{name:"NosDeduc"},{name:"NosTax"},{name:"NosWage"},{name:"TempName"},{name:"TempRange"},{name:"TempID"},{name:"GroupId"},{name:"payinterval"},{name:"effdate"},{name:"basic"}];this.cmGroupGrid=new Wtf.grid.ColumnModel([this.sm,new Wtf.grid.RowNumberer(),{id:"GroupName",header:"Designation",sortable:true,hidden:true,dataIndex:"GroupName"},{header:"Payroll Templates",sortable:true,hideable:false,dataIndex:"TempName"},{header:"No. Of Assigned Wages",align:"right",dataIndex:"NosWage",renderer:WtfGlobal.numericRenderer},{header:"No. Of Assigned Taxes ",align:"right",dataIndex:"NosTax",renderer:WtfGlobal.numericRenderer},{header:"No. Of Assigned Deductions ",align:"right",dataIndex:"NosDeduc",renderer:WtfGlobal.numericRenderer},{header:"Pay Interval ",dataIndex:"payinterval",renderer:function(D){var C=" - ";switch(D){case 1:C="Once a month";break;case 2:C="Twice a month";break;case 3:C="Once a week";break}return C}}]);this.reader=new Wtf.data.KwlJsonReader({root:"data",totalProperty:"totalcount"},this.gridfields);this.groupGridStore=new Wtf.data.GroupingStore({reader:this.reader,url:"Payroll/Template/getPayProcessData.py",sortInfo:{field:"TempName",direction:"DSC"},groupField:"GroupName"});this.groupGridStore.baseParams={PayProc:"get"};this.groupGridStore.load({params:{start:0,limit:15}});this.editbtn=new Wtf.Button({text:"Generate Payroll",minWidth:110,tooltip:"Generate payroll for a new employee by selecting a date range and also generate salary, salary details & even download pay slip.",scope:this,iconCls:getButtonIconCls(Wtf.btype.assignbutton),disabled:true,handler:this.generatePayroll});this.assinEmp=new Wtf.Button({text:"Assign Employee",minWidth:110,tooltip:"Assign a template to a particular employee.",scope:this,iconCls:"pwndCommon profile2buttonIcon",disabled:true,handler:this.assignEmp});var B=[];B.push("-",new Wtf.Toolbar.Button({text:"Reset",scope:this,iconCls:"pwndRefresh",handler:function(){this.groupGridStore.load({params:{start:0,limit:this.Payrollgrid.pag.pageSize}});Wtf.getCmp("Quick"+this.Payrollgrid.id).setValue("")}}),"-",this.addpaytemp=new Wtf.Button({text:"Add Payroll Template",scope:this,tooltip:"Add a new payroll template to the existing library by filling in the information related to wages, deductions & taxes.",minWidth:125,iconCls:getButtonIconCls(Wtf.btype.addbutton),handler:this.addtemplate}),"-",this.editviewtempbtn=new Wtf.Button({text:"Template Details",minWidth:110,tooltip:"View the details of a particular designation and its defined salary range, wages, taxes and deductions.",scope:this,iconCls:getButtonIconCls(Wtf.btype.reportbutton),disabled:true,handler:this.tempDetails}),"-",this.deleteTempbtn=new Wtf.Button({text:" Delete ",tooltip:"Select a particular entry to delete it from the list.",minWidth:60,scope:this,iconCls:getButtonIconCls(Wtf.btype.deletebutton),disabled:true,handler:this.deleteTemp}));this.Payrollgrid=new Wtf.KwlGridPanel({border:false,cm:this.cmGroupGrid,store:this.groupGridStore,width:700,height:450,scope:this,loadMask:true,sm:this.sm,searchLabel:" ",searchLabelSeparator:" ",searchEmptyText:"Search by Designation, Template ",searchField:"GroupName",serverSideSearch:true,displayInfo:true,view:new Wtf.grid.GroupingView({forceFit:true,showGroupName:false,groupTextTpl:"{text}"}),tbar:B});this.groupPanel=new Wtf.Panel({title:"Template Management",border:false,layout:"fit",iconCls:getTabIconCls(Wtf.etype.acc),items:[this.Payrollgrid]});this.add(this.groupPanel);this.setActiveTab(this.groupPanel);this.on("activate",function(D,C){this.doLayout()});calMsgBoxShow(202,4,true);this.groupGridStore.on("load",function(){if(this.groupGridStore.getCount()==0){this.Payrollgrid.getView().emptyText=WtfGlobal.emptyGridRenderer("<a class='grid-link-text' href='#' onClick='javascript:addTemplate(\""+this.id+"\")'>Get started by adding a payroll template now...</a>");this.Payrollgrid.getView().refresh()}if(msgFlag==1){WtfGlobal.closeProgressbar()}},this);this.sm.on("selectionchange",function(){WtfGlobal.enableDisableBtnArr(B,this.Payrollgrid,[5],[7])},this)},addtemplate:function(D,C,B,A){if(A==1){this.addpay=Wtf.getCmp("EditPayTemplate"+B.TempID)}else{this.addpay=Wtf.getCmp("AddPayTemplate")}if(!this.addpay){this.addpay=new Wtf.AddPayrollTemplate({scope:this,title:(A==1)?"Edit "+B.TempName+" Template":"Add Template",globname:"addtemp",iconCls:"pwndCommon templatetabIcon",id:(A==1)?"EditPayTemplate"+B.TempID:"AddPayTemplate",groupGridStore:this.groupGridStore,editMode:B?true:false,templateid:B?B.TempID:"",templatename:B?B.TempName:"",range:B?B.TempRange:"",group:B?B.GroupId:"",payinterval:B?B.payinterval:"",effdate:B?B.effdate:"",basicval:B?B.basic:"",edit:A});this.add(this.addpay);this.addpay.on("render",function(){this.addpay.tempname.focus(true,100)},this);this.doLayout()}this.setActiveTab(this.addpay);this.doLayout()},generatePayroll:function(){var recData=this.Payrollgrid.getSelectionModel().getSelected().data;if(this.Payrollgrid.getSelectionModel().getSelected()!=null){Wtf.Ajax.requestEx({url:Wtf.req.base+"PayrollHandler.jsp",scope:this,params:{type:"CPaytemp",TempId:recData.TempID}},this,function(req){if(req.responseText=="fail"){}else{this.resp=eval("("+req.responseText+")");if(this.generatepay==null){this.generatepay=new Wtf.GeneratePayroll({scope:this,border:false,iconCls:"pwndCommon profile2buttonIcon",TempId:recData.TempID,ttotal:req.Tax.TaxTotal,taxcash:req.Tax.cashtotal,wtotal:req.Wages.WageTotal,wagecash:req.Wages.cashtotal,dtotal:req.Deduction.DeducTotal,deduccash:req.Deduction.cashtotal,tempName:recData.TempName,nostax:recData.NosTax,noswage:recData.NosWage,nosdeduc:recData.NosDeduc,currency:req.curval,title:"Payroll of_"+recData.TempName,groupGridStore:this.groupGridStore});this.add(this.generatepay);this.doLayout();this.generatepay.on("beforedestroy",function(comp){this.generatepay=null},this)}this.editbtn.disable();this.editviewtempbtn.disable();this.deleteTempbtn.disable();this.assinEmp.disable();this.Payrollgrid.getSelectionModel().clearSelections();this.setActiveTab(this.generatepay);this.doLayout()}},function(req){})}else{this.editbtn.disable();this.editviewtempbtn.disable();this.deleteTempbtn.disable();this.assinEmp.disable();this.Payrollgrid.getSelectionModel().clearSelections()}},tempDetails:function(C,B){var A=this.Payrollgrid.getSelectionModel().getSelected().data;this.addtemplate(C,B,A,1)},deleteTemp:function(){var A=this.Payrollgrid.getSelectionModel().getSelected().data;Wtf.MessageBox.show({title:"Confirm",msg:deleteMsgBox("record"),buttons:Wtf.MessageBox.YESNO,icon:Wtf.MessageBox.QUESTION,scope:this,buttons:Wtf.MessageBox.YESNO,icon:Wtf.MessageBox.QUESTION,animEl:"elId",fn:function(C){if(C=="yes"){var D=this.Payrollgrid.getSelectionModel().getSelections();var E=[];this.Payrollgrid.getSelectionModel().clearSelections();for(var B=0;B<D.length;B++){E.push(D[B].get("TempID"));var F=this.groupGridStore.indexOf(D[B]);WtfGlobal.highLightRow(this.Payrollgrid,"FF0000",5,F)}calMsgBoxShow(201,4,true);Wtf.Ajax.requestEx({url:"Payroll/Template/deleteTemplateData.py",method:"post",params:{dele:true,delType:"template",tempid:E}},this,function(H,G){if(H.value.toString()=="success"){calMsgBoxShow(22,0);var I={start:0,limit:15};WtfGlobal.delaytasks(this.groupGridStore,I);this.editbtn.disable();this.editviewtempbtn.disable();this.deleteTempbtn.disable();this.assinEmp.disable();this.Payrollgrid.doLayout()}else{if(H.value.toString()=="assign"){Wtf.Msg.show({title:"Warning",msg:"The template can not be deleted as Employee(s) are assigned to <b>("+H.templates.toString()+")</b> Template. ",scope:this,width:260,buttons:Wtf.Msg.OK,animEl:"elId",icon:Wtf.MessageBox.WARNING});this.editbtn.disable();this.editviewtempbtn.disable();this.deleteTempbtn.disable();this.assinEmp.disable()}}},function(H,G){this.groupGridStore.reload();this.Payrollgrid.doLayout()})}}})},assignEmp:function(){var A=this.Payrollgrid.getSelectionModel().getSelected().data;if(this.assEmpTT==null){this.add(this.assEmpTT=new Wtf.AssignEmployeeFT({title:"Assign Employee_"+A.TempName,scope:this,iconCls:getTabIconCls(Wtf.etype.hrmsmygoals),closable:true,TempId:A.TempID,Gname:A.GroupName,Srange:A.TempRange,TempName:A.TempName,groupstore:this.groupGridStore}));this.assEmpTT.on("beforedestroy",function(){this.assEmpTT=null},this)}this.Payrollgrid.getSelectionModel().clearSelections();this.editbtn.disable();this.editviewtempbtn.disable();this.deleteTempbtn.disable();this.assinEmp.disable();this.setActiveTab(this.assEmpTT);this.doLayout()}});function addTemplate(A){Wtf.getCmp(A).addtemplate()}Wtf.DeducEntryForm=function(A){A.border=false;A.layout="fit";Wtf.DeducEntryForm.superclass.constructor.call(this,A)};Wtf.extend(Wtf.DeducEntryForm,Wtf.Panel,{initComponent:function(A){Wtf.DeducEntryForm.superclass.initComponent.call(this,A);this.earncomp=0;this.deduccomp=0;this.netcomp=0;this.amtcomp=0;this.fieldsdeduc=[{name:"type"},{name:"code"},{name:"cash"},{name:"id"},{name:"rate"},{name:"assigned"},{name:"amount"},{name:"depwage"},{name:"depwageid"},{name:"computeon"},{name:"expr"},{name:"comp"}];this.expander=new Wtf.grid.RowExpander({tpl:new Wtf.XTemplate("<p>&nbsp;&nbsp;&nbsp;&nbsp;<b>Compute on:</b> {[this.f(values)]}</p>",{f:function(K){var E=K.computeon;var I=Wtf.getCmp(this.id);if(E=="0"){return"Current Deductions"}else{if(E=="1"){return"Current Earnings"}else{if(E=="2"){return"Net Salary"}else{if(E=="3"){var B="";var M=K.expr.split("(add)");I.storededuc.clearFilter(true);for(var F=0;F<M.length;F++){var L=M[F].split("(sub)");for(var G=0;G<L.length;G++){var H=L[G].split("*");var D=1;var J;if(H.length>1){D=H[0];J=H[1]}else{J=H[0]}if(J==-1){if(G==0){B+="+"}else{B+="-"}B+=D+" * <b>Template Basic</b>"}var C=I.storededuc.find("id",J);if(C>-1){if(G==0){B+="+"}else{B+="-"}B+=D+" * "+I.storededuc.getAt(C).get("type")}}}return B}else{return"N/A"}}}}}},this)});this.fieldsdeduc=Wtf.data.Record.create(this.fieldsdeduc);this.readerdeduc=new Wtf.data.KwlJsonReader({root:"data",totalProperty:"totalCount"},this.fieldsdeduc);this.storededuc=new Wtf.data.Store({url:"Payroll/Deduction/getDeductionMaster.py",method:"GET",reader:this.readerdeduc});this.storededucforgrid=new Wtf.data.Store({url:"Payroll/Deduction/getDefualtDeduction.py",method:"GET",reader:this.readerdeduc});this.storededucforgrid.load({params:{type:"getDefualtDeduction",start:0,grouper:"addpayroll",limit:15}});this.storededucforgrid.on("load",function(){var B=this.storededucforgrid.query("computeon","2");this.deduccomp=B.length;this.addemptyrec()},this);this.Dtypecombo=new Wtf.form.ComboBox({store:this.storededuc,fieldLabel:"Deduction Type Name",displayField:"type",mode:"local",forceSelection:true,valueField:"type",scope:this,width:180,height:200,triggerAction:"all",listeners:{scope:this,select:function(C,D,B){this.insertrate=this.DeductionGridPanel.getSelectionModel().getSelected();this.insertrateRate=D.get("cash");this.insertrateCode=D.get("code");this.insertrateId=D.get("id");this.insertratetype=D.get("type");this.insertrateratetype=D.get("rate");this.insertratedepwage=D.get("depwage");this.insertratedepwageid=D.get("depwageid");this.insertratecomputeon=D.get("computeon");this.insertrateexpr=D.get("expr")}}});this.Dtypecombo.on("expand",function(B,C){this.storededuc.filter("comp","deduc")},this);this.text=new Wtf.form.NumberField({allowNegative:false});this.checkboxselmodel=new Wtf.grid.CheckboxSelectionModel({scope:this});this.cmdeduc=new Wtf.grid.ColumnModel([this.expander,{header:"Deduction Type",dataIndex:"type",width:200,editor:this.Dtypecombo},{header:"Code",dataIndex:"code"},{header:"Value",dataIndex:"cash",renderer:function(F,E,B,G,D,C){if(B.data.rate=="1"){return('<div align="right">'+parseFloat(F).toFixed(2)+" %</div>")}else{return('<div align="right" style="font-family:Lucida Sans Unicode;">'+WtfGlobal.payrollcurrencyRenderer(F)+"</div>")}}},{header:"Percent of",dataIndex:"computeon",align:"center",sortable:true,renderer:this.rendererfun.createDelegate(this)},{header:"Delete",dataIndex:"",width:35,renderer:function(D,C,B){if(B.data.id!="-1"){return"<div><div class='pwndCommon gridCancel' style='cursor:pointer' wtf:qtip='Delete Record'></div></div>"}}}]);this.storededuc1=new Wtf.data.Store({url:Wtf.req.base+"PayrollHandler.jsp",method:"GET"});this.storededuc.load({params:{allflag:"true",type:"Deduction",cname:"aa",empcont:"true",grouper:"addpayroll",wage:"true"}});this.sm=new Wtf.grid.CheckboxSelectionModel({scope:this});this.DeductionGridPanel=new Wtf.grid.EditorGridPanel({scope:this,clicksToEdit:1,displayField:"type",store:this.storededucforgrid,cm:this.cmdeduc,sm:this.checkboxselmodel,stripeRows:true,id:this.id+"adddeducgrid",listeners:{scope:this,cellclick:function(B,C,E,D){if(C==B.getStore().getCount()-1){}}},autoScroll:true,title:"Deductions",plugins:this.expander,height:440,viewConfig:{forceFit:true,emptyText:WtfGlobal.emptyGridRenderer("No wage assigned for current salary template")}});this.add(this.DeductionGridPanel);this.DeductionGridPanel.on("validateedit",function(E){this.currentedit=E.record;var D=this.DeductionGridPanel.getStore().findBy(function(F){if(F.data.type==E.value){return true}},this);if(D==-1){if(this.insertrateratetype=="0"){this.amtcomp++}if(this.insertratecomputeon=="0"){if(this.amtcomp==0){Wtf.MessageBox.show({title:"Operation not permitted!!",msg:"Please select atleast one fixed deduction component first",buttons:Wtf.MessageBox.OK,animEl:"mb9",scope:this,icon:Wtf.MessageBox.INFO});this.cancel=true;return false}else{if(this.deduccomp>0||this.netcomp>0){Wtf.MessageBox.show({title:"Operation not permitted!!",msg:"You cannot include two components on type 'Current Earning'",buttons:Wtf.MessageBox.OK,animEl:"mb9",scope:this,icon:Wtf.MessageBox.INFO});this.cancel=true;return false}else{this.deduccomp++;this.insertcomp(E.column)}}}else{if(this.insertratecomputeon=="1"){var C=this.id.split("adddeduc");if(C.length>0){var B=Wtf.getCmp(C[0]+"addwage");if(B!=null){if(B.deduccomp>0||B.netcomp>0){Wtf.MessageBox.show({title:"Operation not permitted!!",msg:"As you have included a component in Wage which is dependent on Deduction, you cannot include a Wage dependent component in Deduction ",buttons:Wtf.MessageBox.OK,animEl:"mb9",scope:this,icon:Wtf.MessageBox.INFO});this.cancel=true;return false}else{this.earncomp++;this.insertcomp(E.column);this.amtcomp++}}}}else{if(this.insertratecomputeon=="2"){if(this.deduccomp>0||this.netcomp>0){Wtf.MessageBox.show({title:"Operation not permitted!!",msg:"You cannot include two components which depends on each other.",buttons:Wtf.MessageBox.OK,animEl:"mb9",scope:this,icon:Wtf.MessageBox.INFO});this.cancel=true;return false}else{var C=this.id.split("adddeduc");if(C.length>0){var B=Wtf.getCmp(C[0]+"addwage");if(B!=null){if(B.deduccomp>0||B.netcomp>0){Wtf.MessageBox.show({title:"Operation not permitted!!",msg:"As you have included a component in Wage which is dependent on Deduction, you cannot include a Wage dependent component in Deduction ",buttons:Wtf.MessageBox.OK,animEl:"mb9",scope:this,icon:Wtf.MessageBox.INFO});this.cancel=true;return false}else{this.netcomp++;this.insertcomp(E.column)}}}}this.amtcomp++}else{if(this.insertratecomputeon=="3"){Wtf.MessageBox.show({title:"Warning",msg:"The selected component has some dependencies. If you want to use this component the system will also include these dependencies. Do you want to continue?",buttons:Wtf.MessageBox.YESNO,animEl:"mb9",scope:this,icon:Wtf.MessageBox.INFO,fn:function(F,G){if(F=="yes"){this.insertcomp(E.column);this.storededuc.clearFilter(true);this.getdep(this.insertrateexpr);this.storededuc.filter("comp","deduc")}else{this.DeductionGridPanel.getStore().remove(E.record);this.cancel=true;return false}}});this.amtcomp++}else{this.insertcomp(E.column)}}}}}else{this.cancel=true;return false}if(E.record.data.rate=="1"){if(E.record.data.cash>100){return false}}},this);this.DeductionGridPanel.on("afteredit",function(B){if(B.row==this.DeductionGridPanel.getStore().getCount()-1){this.addemptyrec();this.DeductionGridPanel.getSelectionModel().selectAll();this.DeductionGridPanel.getSelectionModel().deselectRow(this.DeductionGridPanel.getStore().getCount()-1)}},this);this.on("activate",function(C,B){this.doLayout()});this.storededuc.on("load",function(){if(this.edittemp=="yes"){for(this.i=0;this.i<this.DeductionGridPanel.getStore().getCount()-1;this.i++){this.rec=this.DeductionGridPanel.getStore().getAt(this.i);if(this.rec.get("assigned")=="1"){this.checkboxselmodel.selectRow(this.i,true)}}}},this);if(this.edittemp=="yes"){this.storededucforgrid.on("load",function(){var B=this.storewageforgrid.query("computeon","1");var D=this.storewageforgrid.query("computeon","2");var C=this.storewageforgrid.query("computeon","0");this.earncomp=B.length;this.netcomp=D.length;this.deduccomp=C.length;this.DeductionGridPanel.getSelectionModel().selectAll();this.DeductionGridPanel.getSelectionModel().deselectRow(this.DeductionGridPanel.getStore().getCount()-1)},this)}this.DeductionGridPanel.on("click",function(F){if(F.target.className=="pwndCommon gridCancel"){var E=this.DeductionGridPanel.getSelectionModel().getSelected();if(this.DeductionGridPanel.getSelectionModel().getSelections().length>0){if(this.DeductionGridPanel.getStore().indexOf(E)!=this.DeductionGridPanel.getStore().getCount()-1){for(var G=0;G<this.DeductionGridPanel.getStore().data.length;G++){var B=this.DeductionGridPanel.getStore().getAt(G).data.expr;if(B!=undefined){if(B.indexOf(E.data.id)!=-1){calMsgBoxShow(["Warning","Cannot deleted.Some other components are depends on this wage."],2);return }}}var D=(this.edittemp=="yes")?Wtf.getCmp(this.parentId).taxentryform1.storetaxforgrid:Wtf.getCmp(this.parentId).taxentryform.storetaxforgrid;var C=(this.edittemp=="yes")?Wtf.getCmp(this.parentId).deductionentryform1.storededuc:Wtf.getCmp(this.parentId).deductionentryform.storededuc;for(G=0;G<C.data.length;G++){var B=C.getAt(G).data.expr;if(B.indexOf(E.data.id)!=-1){calMsgBoxShow(["Warning","Cannot deleted.Some other components are depends on this wage."],2);return }}this.DeductionGridPanel.getStore().remove(this.DeductionGridPanel.getSelectionModel().getSelected());if(E.get("rate")==0){this.amtcomp--}if(E.get("computeon")==0){this.deduccomp--}else{if(E.get("computeon")==1){this.earncomp--;this.amtcomp--}else{if(E.get("computeon")==2){this.netcomp--;this.amtcomp--}else{if(E.get("computeon")==3){this.amtcomp--}else{Wtf.getCmp("editTemp").enable()}}}}}}}},this);this.record=new Wtf.data.Record.create([{name:"type"},{name:"cash"},{name:"id"},{name:"code"}])},addemptyrec:function(){this.DeductionGridPanel.getStore().add(new this.record({type:"",cash:"",id:"-1",code:""}))},rendererfun:function(F,K,J,O,G,N){if(J.get("rate")==0){return"-"}if(F=="0"){return"Current Deductions"}else{if(F=="1"){return"Current Earnings"}else{if(F=="2"){return"Net Salary"}else{if(F=="3"){var A="";var M=J.get("expr").split("(add)");this.storededuc.clearFilter(true);for(var E=0;E<M.length;E++){var L=M[E].split("(sub)");for(var D=0;D<L.length;D++){var H=L[D].split("*");var C=1;var I;if(H.length>1){C=H[0];I=H[1]}else{I=H[0]}if(I==-1){if(D==0){A+="+"}else{A+="-"}A+=C+" * <b>Template Basic</b>"}var B=this.storededuc.find("id",I);if(B>-1){if(D==0){A+="+"}else{A+="-"}A+=C+" * "+this.storededuc.getAt(B).get("type")}}}this.storededuc.filter("comp","deduc");return A}}}}},insertcomp:function(A){this.insertrate=this.currentedit;if(A==1){this.insertrate.beginEdit();this.insertrate.set("cash",this.insertrateRate);this.insertrate.set("code",this.insertrateCode);this.insertrate.set("id",this.insertrateId);this.insertrate.set("rate",this.insertrateratetype);this.insertrate.set("depwage",this.insertratedepwage);this.insertrate.set("type",this.insertratetype);this.insertrate.set("depwageid",this.insertratedepwageid);this.insertrate.set("computeon",this.insertratecomputeon);this.insertrate.set("expr",this.insertrateexpr);this.insertrate.endEdit()}},getdep:function(N){var M=N.split("(add)");for(var B=0;B<M.length;B++){var L=M[B].split("(sub)");for(var C=0;C<L.length;C++){var E=L[C].split("*");var G;if(E.length>1){G=E[1]}else{G=E[0]}var H=this.DeductionGridPanel.getStore().find("id",G);if(H==-1&&L[C]!=""){var A=this.storededuc.find("id",G);if(A>-1){var I;var D;var K=this.storededuc.getAt(A);if(K.get("comp")=="deduc"){this.DeductionGridPanel.getStore().insert(0,K)}else{if(K.get("comp")=="wage"){D=this.id.split("adddeduc");if(D.length>0){var F=Wtf.getCmp(D[0]+"addwage");if(F!=null){I=F.storewageforgrid.find("id",G);if(I==-1){F.addrecord(K)}}}}else{D=this.id.split("adddeduc");if(D.length>0){var J=Wtf.getCmp(D[0]+"addempcontrib");if(J!=null){I=J.storewageforgrid.find("id",G);if(I==-1){J.addrecord(K)}}}}}if(K.get("computeon")=="3"){this.getdep(K.get("expr"))}}}}}},addrecord:function(A){this.DeductionGridPanel.getStore().insert(0,A)}});Wtf.WageTaxDeducWin=function(A){A.border=false;A.layout="fit";A.ren=0;Wtf.WageTaxDeducWin.superclass.constructor.call(this,A)};Wtf.extend(Wtf.WageTaxDeducWin,Wtf.Panel,{initComponent:function(A){Wtf.WageTaxDeducWin.superclass.initComponent.call(this,A);this.text=new Wtf.form.NumberField({});this.netcomp=0;this.amtcomp=0;this.deduccomp=0;this.text1=new Wtf.form.NumberField({});this.sm=new Wtf.grid.CheckboxSelectionModel({scope:this});this.fieldstax=[{name:"type"},{name:"code"},{name:"cash"},{name:"id"},{name:"rate"},{name:"assigned"},{name:"depwage"},{name:"depwageid"},{name:"expr"},{name:"computeon"},{name:"comp"}];this.expander=new Wtf.grid.RowExpander({tpl:new Wtf.XTemplate("<p>&nbsp;&nbsp;&nbsp;&nbsp;<b>Compute on:</b> {[this.f(values)]}</p>",{f:function(K){var E=K.computeon;var I=Wtf.getCmp(this.id);if(E=="0"){return"Current Deductions"}else{if(E=="1"){return"Current Earnings"}else{if(E=="2"){return"Net Salary"}else{if(E=="3"){var B="";var M=K.expr.split("(add)");I.storetax.clearFilter(true);for(var F=0;F<M.length;F++){var L=M[F].split("(sub)");for(var G=0;G<L.length;G++){var H=L[G].split("*");var D=1;var J;if(H.length>1){D=H[0];J=H[1]}else{J=H[0]}var C=I.storetax.find("id",J);if(C>-1){if(G==0){B+="+"}else{B+="-"}B+=D+" * "+I.storetax.getAt(C).get("type")}}}I.storetax.filter("comp","tax");return B}else{return"N/A"}}}}}},this)});this.fieldstax=Wtf.data.Record.create(this.fieldstax);this.readertax=new Wtf.data.KwlJsonReader({root:"data",totalProperty:"totalCount"},this.fieldstax);this.storetax=new Wtf.data.Store({url:"Payroll/Tax/getTaxMaster.py",method:"GET",reader:this.readertax});this.storetaxforgrid=new Wtf.data.Store({url:"Payroll/Tax/getDefualtTax.py",method:"GET",reader:this.readertax});this.storetaxforgrid.load({params:{type:"getDefualtTaxes",start:0,grouper:"addpayroll",limit:15}});this.storetaxforgrid.on("load",function(){this.addemptyrec()},this);this.storetax1=new Wtf.data.Store({url:Wtf.req.base+"PayrollHandler.jsp",method:"GET"});this.Ttypecombo=new Wtf.form.ComboBox({store:this.storetax,fieldLabel:"Tax Type Name",displayField:"type",valueField:"type",mode:"local",forceSelection:true,scope:this,width:180,height:200,triggerAction:"all",listeners:{scope:this,select:function(C,D,B){this.insertrateRate=D.get("cash");this.insertrateCode=D.get("code");this.insertrateId=D.get("id");this.insertrateratetype=D.get("rate");this.insertratedepwage=D.get("depwage");this.insertratedepwageid=D.get("depwageid");this.insertratetype=D.get("type");this.insertratecomputeon=D.get("computeon");this.insertrateexpr=D.get("expr")}}});this.Ttypecombo.on("expand",function(B,C){this.storetax.filter("comp","tax")},this);this.Tratenumberfield=new Wtf.form.NumberField({allowNegative:false});this.checkselmodel=new Wtf.grid.CheckboxSelectionModel({scope:this});this.cmtax=new Wtf.grid.ColumnModel([this.expander,{header:"Tax Type",scope:this,width:200,dataIndex:"type",editor:this.Ttypecombo},{header:"Code",dataIndex:"code"},{header:"Value",dataIndex:"cash",renderer:function(F,E,B,G,D,C){if(B.data.rate=="1"){return('<div align="right">'+parseFloat(F).toFixed(2)+" %</div>")}else{return('<div align="right" style="font-family:Lucida Sans Unicode;">'+WtfGlobal.payrollcurrencyRenderer(F)+"</div>")}}},{header:"Percent of",dataIndex:"computeon",align:"center",sortable:true,renderer:this.rendererfun.createDelegate(this)},{header:"Delete",dataIndex:"",width:35,renderer:function(D,C,B){if(B.data.id!="-1"){return"<div><div class='pwndCommon gridCancel' style='cursor:pointer' wtf:qtip='Delete Record'></div></div>"}}}]);this.storetax.load({params:{allflag:"true",type:"Tax",wage:"true",deduc:"true",grouper:"addpayroll",cname:"aa"}});this.grid=new Wtf.grid.EditorGridPanel({scope:this,stripeRows:true,clicksToEdit:1,id:this.id+"addtaxgrid",store:this.storetaxforgrid,cm:this.cmtax,sm:this.checkselmodel,listeners:{scope:this,cellclick:function(B,C,E,D){}},plugins:this.expander,autoScroll:true,viewConfig:{forceFit:true,emptyText:WtfGlobal.emptyGridRenderer("No wage assigned for current salary template")},title:"Taxes"});this.grPanel=new Wtf.Panel({layout:"fit",border:false,items:[this.grid]});this.grid.on("validateedit",function(C){this.currentedit=C.record;var B=this.grid.getStore().findBy(function(D){if(D.data.type==C.value){return true}},this);if(B==-1){if(this.insertrateratetype=="0"){this.amtcomp++}if(this.insertratecomputeon=="0"){this.deduccomp++;this.insertcomp(C.column)}else{if(this.insertratecomputeon=="1"){this.insertcomp(C.column);this.amtcomp++}else{if(this.insertratecomputeon=="2"){if(this.netcomp>0){Wtf.MessageBox.show({title:"Operation not permitted!!",msg:"You cannot include two components which depends on each other.",buttons:Wtf.MessageBox.OK,animEl:"mb9",scope:this,icon:Wtf.MessageBox.INFO});this.cancel=true;return false}else{this.netcomp++;this.insertcomp(C.column)}this.amtcomp++}else{if(this.insertratecomputeon=="3"){Wtf.MessageBox.show({title:"Warning",msg:"The selected component has some dependencies. If you want to use this component the system will also include these dependencies. Do you want to continue?",buttons:Wtf.MessageBox.YESNO,animEl:"mb9",scope:this,icon:Wtf.MessageBox.INFO,fn:function(D,E){if(D=="yes"){this.insertcomp(C.column);this.storetax.clearFilter(true);this.getdep(this.insertrateexpr);this.storetax.filter("comp","tax")}else{this.grid.getStore().remove(C.record);this.cancel=true;return false}}});this.amtcomp++}else{this.insertcomp(C.column)}}}}}else{this.cancel=true;return false}if(C.record.data.rate=="1"){if(C.record.data.cash>100){return false}}},this);this.grid.on("afteredit",function(B){if(B.row==(this.grid.getStore().getCount()-1)){this.addemptyrec();this.grid.getSelectionModel().selectAll();this.grid.getSelectionModel().deselectRow(this.grid.getStore().getCount()-1)}},this);this.add(this.grPanel);this.on("activate",function(C,B){this.doLayout()});this.storetax.on("load",function(){if(this.edittemp=="yes"){for(this.i=0;this.i<this.grid.getStore().getCount()-1;this.i++){this.rec=this.grid.getStore().getAt(this.i);if(this.rec.get("assigned")=="1"){this.checkselmodel.selectRow(this.i,true)}}}},this);if(this.edittemp=="yes"){this.storetaxforgrid.on("load",function(){this.grid.getSelectionModel().selectAll();this.grid.getSelectionModel().deselectRow(this.grid.getStore().getCount()-1)},this)}this.grid.on("click",function(C){if(C.target.className=="pwndCommon gridCancel"){var B=this.grid.getSelectionModel().getSelected();if(this.grid.getSelectionModel().getSelections().length>0){if(this.grid.getStore().indexOf(this.grid.getSelectionModel().getSelected())!=this.grid.getStore().getCount()-1){this.grid.getStore().remove(this.grid.getSelectionModel().getSelected());Wtf.getCmp("editTemp").enable();if(B.get("computeon")==2){this.netcomp--}}}else{}}},this);this.record=new Wtf.data.Record.create([{name:"type"},{name:"cash"},{name:"id"},{name:"code"}]);if(this.paramstore!=1){this.addemptyrec()}},getdep:function(J){var I=J.split("(add)");for(var A=0;A<I.length;A++){var G=I[A].split("(sub)");for(var C=0;C<G.length;C++){var F=this.grid.getStore().find("id",G[C]);if(F==-1&&G[C]!=""){var B=this.storetax.find("id",G[C]);if(B>-1){var H=this.storetax.getAt(B);if(H.get("comp")=="tax"){this.grid.getStore().insert(0,H)}else{if(H.get("comp")=="wage"){var D=this.id.split("addtax");if(D.length>0){var E=Wtf.getCmp(D[0]+"addwage");if(E!=null){var B=E.storewageforgrid.find("id",G[C]);if(B==-1){E.addrecord(H)}}}}else{if(D.length>0){var E=Wtf.getCmp(D[0]+"adddeduc");if(E!=null){var B=E.storededucforgrid.find("id",G[C]);if(B==-1){E.addrecord(H)}}}}}if(H.get("computeon")=="3"){this.getdep(H.get("expr"))}}}}}},insertcomp:function(A){this.insertrate=this.currentedit;if(A==1){this.insertrate.beginEdit();this.insertrate.set("cash",this.insertrateRate);this.insertrate.set("code",this.insertrateCode);this.insertrate.set("id",this.insertrateId);this.insertrate.set("rate",this.insertrateratetype);this.insertrate.set("depwage",this.insertratedepwage);this.insertrate.set("type",this.insertratetype);this.insertrate.set("depwageid",this.insertratedepwageid);this.insertrate.set("computeon",this.insertratecomputeon);this.insertrate.set("expr",this.insertrateexpr);this.insertrate.endEdit()}},rendererfun:function(F,K,J,O,G,N){if(J.get("rate")==0){return"-"}if(F=="0"){return"Current Deductions"}else{if(F=="1"){return"Current Earnings"}else{if(F=="2"){return"Net Salary"}else{if(F=="3"){var A="";var M=J.get("expr").split("(add)");this.storetax.clearFilter(true);for(var E=0;E<M.length;E++){var L=M[E].split("(sub)");for(var D=0;D<L.length;D++){var H=L[D].split("*");var C=1;var I;if(H.length>1){C=H[0];I=H[1]}else{I=H[0]}if(I==-1){if(D==0){A+="+"}else{A+="-"}A+=C+" * <b>Template Basic</b>"}var B=this.storetax.find("id",L[D]);if(B>-1){if(D==0){A+="+"}else{A+="-"}A+=C+" * "+this.storetax.getAt(B).get("type")}}}this.storetax.filter("comp","tax");return A}}}}},addemptyrec:function(A){this.grid.getStore().add(new this.record({type:"",cash:"",id:"-1",code:""}))}});Wtf.GeneratePayroll=function(A){Wtf.form.Field.prototype.msgTarget="side",A.autoScroll=true;A.layout="fit";A.closable=true;Wtf.GeneratePayroll.superclass.constructor.call(this,A)};Wtf.extend(Wtf.GeneratePayroll,Wtf.Panel,{initComponent:function(A){Wtf.GeneratePayroll.superclass.initComponent.call(this,A);this.fromdateempG=new Wtf.form.DateField({width:135,readOnly:true,emptyText:"From Date",format:"m/d/Y"});this.todateempG=new Wtf.form.DateField({width:135,readOnly:true,emptyText:"To Date",format:"m/d/Y"});this.usersRec=new Wtf.data.Record.create([{name:"empid"},{name:"EName"},{name:"Wage"},{name:"AccNo"},{name:"Tax"},{name:"Deduc"},{name:"Salary"},{name:"FixedSal"},{name:"empid"},{name:"design"}]);this.userds=new Wtf.data.Store({reader:new Wtf.data.KwlJsonReader({root:"data"},this.usersRec),url:Wtf.req.base+"PayrollHandler.jsp"});this.userds.load({params:{start:0,limit:15,taxcash:this.taxcash,wagecash:this.wagecash,deduccash:this.deduccash,TempId:this.TempId,type:"EmpPerTemId",ttotal:this.ttotal,wtotal:this.wtotal,dtotal:this.dtotal}});this.userds.on("load",function(){if(this.userds.getCount()==0){calMsgBoxShow(18,0)}},this);this.selectionModel=new Wtf.grid.CheckboxSelectionModel({scope:this,singleSelect:false});this.gridcm=new Wtf.grid.ColumnModel([this.selectionModel,{header:"Employee Name",dataIndex:"EName",sortable:true,groupable:true},{header:"Earning",dataIndex:"Wage",sortable:true,groupable:true,renderer:function(B){if(B!=null){return(WtfGlobal.currencyRenderer(parseFloat(B).toFixed(2)))}}},{header:"Taxes",dataIndex:"Tax",sortable:true,groupable:true,renderer:function(B){if(B!=null){return(WtfGlobal.currencyRenderer(parseFloat(B).toFixed(2)))}}},{header:"Deductions",dataIndex:"Deduc",sortable:true,groupable:true,renderer:function(B){if(B!=null){return(WtfGlobal.currencyRenderer(parseFloat(B).toFixed(2)))}}},{header:"Net Pay",dataIndex:"Salary",scope:this,sortable:true,groupable:true,renderer:function(B){if(B!=null){return(WtfGlobal.currencyRenderer(parseFloat(B).toFixed(2)))}}}],this);this.sm2=new Wtf.grid.CheckboxSelectionModel({singleSelect:false,scope:this,listeners:{scope:this,rowselect:function(E,C,B){var D=this.usergrid.getSelectionModel().getSelected().data;this.ename=D.EName;this.accno=D.AccNo;this.salary=D.Wage;this.fixedsal=D.FixedSal;this.tax=D.Tax;this.deduc=D.Deduc;this.empid=D.empid;this.design=D.design},rowdeselect:function(D,C,B){}}});this.usergrid=new Wtf.KwlGridPanel({enableColumnHide:false,trackMouseOver:true,stripeRows:true,loadMask:true,searchLabel:"Quick Search",searchEmptyText:"Search by Employee Name",searchField:"EName",viewConfig:{forceFit:true},store:this.userds,cm:this.gridcm,scope:this,width:400,id:"grouplistgridgenpay",border:false,sm:this.sm2,tbar:["-","Start Date",this.fromdateempG,"End Date",this.todateempG,"-",this.gensalbtn=new Wtf.Button({text:"Generate Salary",scope:this,minWidth:100,iconCls:getButtonIconCls(Wtf.btype.assignbutton),handler:function(){if(this.fromdateempG.getRawValue()==""||this.todateempG.getRawValue()==""||this.fromdateempG.getRawValue()>this.todateempG.getRawValue()){calMsgBoxShow(14,0)}else{this.arr=this.usergrid.getSelections();if(this.arr.length==0){calMsgBoxShow(19,0)}else{this.jsondata="";var B=0;this.arr=this.usergrid.getSelections();for(i=0;i<this.arr.length;i++){this.jsondata+="{'EName':'"+this.arr[i].get("EName")+"',";this.jsondata+="'AccNo':'"+this.arr[i].get("AccNo")+"',";this.jsondata+="'Wage':'"+this.arr[i].get("Wage")+"',";this.jsondata+="'FixedSal':'"+this.arr[i].get("FixedSal")+"',";this.jsondata+="'Tax':'"+this.arr[i].get("Tax")+"',";this.jsondata+="'Deduc':'"+this.arr[i].get("Deduc")+"',";this.jsondata+="'empid':'"+this.arr[i].get("empid")+"',";this.jsondata+="'design':'"+this.arr[i].get("design")+"'},";if(this.arr[i].get("Salary")<0){B=1;break}}this.trmLen1=this.jsondata.length-1;this.jsondata=this.jsondata.substr(0,this.trmLen1);if(B==0){Wtf.Ajax.requestEx({url:"Emp/setPayrollforTemp.py",scope:this,method:"post",params:{save:"true",saveType:"PayHistoryforTemp",jsondata:this.jsondata,TempId:this.TempId,stdate:this.fromdateempG.getRawValue(),enddate:this.todateempG.getRawValue()}},this,function(C){var D=C.value.toString();if(D=="success"){calMsgBoxShow(["Success",C.msg.toString()],0);this.empstore.load()}else{if(D=="failure"){calMsgBoxShow(["Warning",C.msg.toString()],0)}}},function(C){})}else{calMsgBoxShow(157,0)}}}}}),{text:"Salary Details",scope:this,minWidth:100,iconCls:getButtonIconCls(Wtf.btype.reportbutton),handler:function(){this.arr=this.usergrid.getSelections();if(this.arr.length>1){calMsgBoxShow(20,0)}else{if(this.usergrid.getSelectionModel().getSelected()!=null){this.mainTabId=Wtf.getCmp("mainpayrolltab");this.payslip=Wtf.getCmp("payslipTabgenpay");if(this.payslip==null){this.payslip=new Wtf.EmpPayslip({layout:"fit",closable:true,iconCls:getTabIconCls(Wtf.etype.hrmsreport),border:false,id:"payslipTabgenpay",TempId:this.TempId,ename:this.ename,accno:this.accno,salary:this.salary,tax:this.tax,empid:this.empid,deduc:this.deduc,cursymbol:this.currency,fixedsal:this.fixedsal,design:this.design});this.mainTabId.add(this.payslip)}this.mainTabId.setActiveTab(this.payslip);this.mainTabId.doLayout()}else{calMsgBoxShow(21,0)}}}},this.mypdf=new Wtf.Button({text:"Download Payslip",scope:this,iconCls:getButtonIconCls(Wtf.btype.downloadbutton),tooltip:"View past payslips",handler:function(){var B=this.sm2.getSelected();this.exportReport(1,"pdf","Leave Card",B.data["empid"],companyName,this.fromdateempG.getRawValue(),this.todateempG.getRawValue());this.empid=null}})]});this.mypdf.disable();this.pan=new Wtf.Panel({layout:"fit",autoHeight:true,columnWidth:1,title:"Employee List",border:false,scope:this,items:[this.usergrid]});this.MainDataEntryPanelG=new Wtf.Panel({layout:"fit",border:false,bodyStyle:"background:white",scope:this,items:[this.usergrid]});this.add(this.MainDataEntryPanelG);this.doLayout();this.on("activate",function(C,B){this.doLayout()})},exportReport:function(J,I,A,E,H,G,D){var F="";var C='{"data": []}';if(J==1){C='{"data": ["No","From", "To", "Duration", "Reason", "Type Of Leave", "Paid", "LPW", "Employee Signature", "Approver Signature", "Balance"]}'}var B="../../exportLeavePdfServlet.jsp?&flag="+J+"&colHeader="+C+"&userIDs="+F+"&reportname="+A+"&exporttype="+I+"&empid="+E+"&cname="+H+"&stdate="+G+"&flagpdf=datewise&enddate="+D;setDldUrl(B)}});Wtf.EmpPayslip=function(A){Wtf.form.Field.prototype.msgTarget="side",A.layout="fit";A.closable=true;this.modifiedflag=0;Wtf.EmpPayslip.superclass.constructor.call(this,A)};Wtf.extend(Wtf.EmpPayslip,Wtf.Panel,{initComponent:function(F){Wtf.EmpPayslip.superclass.initComponent.call(this,F);this.addEvents({"gridload":true});this.jsondata="";var B=this.cursymbol;var I=0;var D=0;var C=0;var A=0;this.salgen=0;var G=WtfGlobal.getCurrencySymbol();this.empform=new Wtf.Panel({height:110,columnWidth:1,border:false,bodyStyle:"margin-left:33%;margin-top:1%",scope:this,items:[{height:100,width:400,scope:this,layout:"form",bodyStyle:"padding-top:20px;padding-left:50px;",items:[{xtype:"textfield",width:"70%",fieldLabel:"Employee Name",value:this.ename,readOnly:true},{xtype:"textfield",width:"70%",fieldLabel:"Account Number",readOnly:true,value:this.accno}]}]});if(this.flag=="employee"){this.storeURL1=Wtf.req.base+"PayrollHandler.jsp?type=HistWages&TempId="+this.TempId+"&histid="+this.histid;this.storeURL3=Wtf.req.base+"PayrollHandler.jsp?type=HistTaxes&TempId="+this.TempId+"&histid="+this.histid;this.storeURL2=Wtf.req.base+"PayrollHandler.jsp?type=HistDeduces&TempId="+this.TempId+"&histid="+this.histid;this.storeURL4="Payroll/EmpContrib/getHistEmpContrib.py?histid="+this.histid}else{this.storeURL1="Payroll/Wage/getwagesPerTempid.py?TempId="+this.TempId+"&salary="+this.fixedsal+"&empid="+this.empid+"&grouper=b";this.storeURL2="Payroll/Deduction/getDeducPerTempid.py?TempId="+this.TempId+"&salary="+this.fixedsal+"&empid="+this.empid+"&stdate="+this.stdate.format("m/d/Y")+"&empid="+this.empid+"&grouper=b";this.storeURL3="Payroll/Tax/getTaxPerTempid.py?TempId="+this.TempId+"&salary="+this.fixedsal+"&empid="+this.empid+"&grouper=b&firequery=1";this.storeURL4="Payroll/EmpContrib/getEmpContribPerTempid.py?TempId="+this.TempId+"&salary="+this.fixedsal+"&empid="+this.empid+"&grouper=b&firequery=1"}this.pan1=new Wtf.Panel({columnWidth:0.8,bodyStyle:"margin-top:1%",border:false,scope:this,items:[this.wages=new Wtf.PayslipGrid({type:"Earning",height:160,scope:this,id:"Earning"+this.id,TempId:this.TempId,empid:this.empid,flag:this.flag,stdate:this.stdate,salary:this.salary,mappingid:this.mappingid,deduc:this.deduc,fixedsal:this.fixedsal,Data:"Wage",total:this.salary,storeURL:this.storeURL1,cursymbol:B,paycyclestart:this.paycyclestart,paycycleend:this.paycycleend,paycycleactualstart:this.stdate.format("m-d-Y"),paycycleactualend:this.enddate.format("m-d-Y"),ischanged:this.ischanged})]});this.wages.on("storeload",function(){this.wagestatus=1;if(this.deducstatus==1&&this.wagestatus==1){this.getdepcomp()}},this);this.wages.on("datamodified",function(){this.modifiedflag=1},this);this.pan3=new Wtf.Panel({columnWidth:0.8,border:false,bodyStyle:"margin-top:1%",scope:this,items:[this.diduces=new Wtf.PayslipGrid({type:"Deduction",id:"Deduction"+this.id,scope:this,height:150,TempId:this.TempId,empid:this.empid,flag:this.flag,stdate:this.stdate,salary:this.salary,Data:"Deduc",fixedsal:this.fixedsal,total:this.deduc,storeURL:this.storeURL2,cursymbol:B,paycycleactualstart:this.stdate.format("m-d-Y"),paycycleactualend:this.enddate.format("m-d-Y"),paycyclestart:this.paycyclestart,paycycleend:this.paycycleend,ischanged:this.ischanged})]});this.diduces.on("storeload",function(){this.deducstatus=1;if(this.deducstatus==1&&this.wagestatus==1){this.getdepcomp()}},this);this.diduces.on("datamodified",function(){this.modifiedflag=1},this);this.pan2=new Wtf.Panel({columnWidth:0.8,bodyStyle:"margin-top:1%",border:false,scope:this,items:[this.taxes=new Wtf.PayslipGrid({type:"Tax",id:"Tax"+this.id,salary:this.salary,empid:this.empid,height:150,scope:this,flag:this.flag,stdate:this.stdate,total:this.tax,TempId:this.TempId,fixedsal:this.fixedsal,dtotal:this.deduc,Data:"Tax",storeURL:this.storeURL3,cursymbol:B,paycyclestart:this.paycyclestart,paycycleend:this.paycycleend,ischanged:this.ischanged})]});this.taxes.on("storeload",function(){this.taxstatus=1},this);this.taxes.on("datamodified",function(){this.modifiedflag=1},this);this.pan5=new Wtf.Panel({columnWidth:0.8,bodyStyle:"margin-top:1%",border:false,scope:this,items:[this.empcontrib=new Wtf.PayslipGrid({type:"Employer Contribution",id:"Newgrid"+this.id,salary:this.salary,empid:this.empid,height:150,scope:this,flag:this.flag,stdate:this.stdate,mappingid:this.mappingid,total:this.tax,TempId:this.TempId,fixedsal:this.fixedsal,dtotal:this.deduc,Data:"EC",storeURL:this.storeURL4,cursymbol:B,paycyclestart:this.paycyclestart,paycycleend:this.paycycleend,ischanged:this.ischanged})]});this.empcontrib.on("storeload",function(){},this);this.empcontrib.on("datamodified",function(){},this);this.pan4=new Wtf.Panel({columnWidth:0.8,layout:"form",border:false,labelWidth:65,bodyStyle:"margin-left:81%;margin-bottom:2%;margin-top:2%",scope:this,items:[this.tot=new Wtf.form.TextField({border:true,scope:this,cls:"textfstyle",readOnly:true,fieldLabel:'<span style="padding-left:-3px;font-family:Lucida Sans Unicode;"><b>TOTAL</b>('+G+")</span>",allowDecimals:true,labelSeparator:"",value:0,height:20,width:120,bodyStyle:"margin-left:10%;background:white;border-right:3px",decimalPrecision:2})]});this.wages.storetax.on("load",function(L,K,J){this.setTotalSal()},this);this.diduces.storetax.on("load",function(L,K,J){this.setTotalSal()},this);this.taxes.storetax.on("load",function(L,K,J){this.setTotalSal()},this);this.cnamedata=[["Weekly","01"],["Monthly","02"],["Quarterly","03"],["Yearly","04"]];this.combostore=new Wtf.data.SimpleStore({fields:[{name:"cname"},{name:"mid"}]});this.combostore.loadData(this.cnamedata);this.TaxName=new Wtf.form.ComboBox({fieldLabel:"Customer Name",store:this.combostore,displayField:"cname",mode:"local",scope:this,emptyText:"Select a salary frequency...",selectOnFocus:true,width:150,value:"Monthly",height:200,triggerAction:"all",listeners:{scope:this,select:function(K,L,J){}}});this.fromdateemp=new Wtf.form.DateField({width:155,readOnly:true,emptyText:"From Date",format:"m/d/Y",disabled:true,value:this.stdate});this.todateemp=new Wtf.form.DateField({width:155,readOnly:true,emptyText:"To Date",disabled:true,format:"m/d/Y",value:this.enddate});this.xbt2=new Wtf.Button({text:"Generate Salary",scope:this,minWidth:110,id:this.id+"GenerateSalary",iconCls:getButtonIconCls(Wtf.btype.assignbutton),handler:function(){if(this.fromdateemp.getRawValue()==""||this.todateemp.getRawValue()==""||this.fromdateemp.getRawValue()>this.todateemp.getRawValue()){calMsgBoxShow(14,1)}else{this.Wagejsondata="";for(var J=0;J<=this.wages.storetax.getCount()-1;J++){this.WStoreTax=this.wages.storetax.getAt(J);this.Wagejsondata+="{'type':'"+this.WStoreTax.get("Type")+"',";this.Wagejsondata+="'amount':'"+parseFloat(this.WStoreTax.get("amount")).toFixed(2)+"',";if(this.WStoreTax.get("ratetype")==0){this.Wagejsondata+="'Rate':'0',"}else{this.Wagejsondata+="'Rate':'"+parseFloat(this.WStoreTax.get("Rate")).toFixed(2)+"',"}this.wagetot=this.wages.total.getValue().replace(/,/g,"");this.Wagejsondata+="'total':'"+this.wagetot+"'},"}this.trmLen1=this.Wagejsondata.length-1;this.WageJson=this.Wagejsondata.substr(0,this.trmLen1);this.Deducjsondata="";for(var J=0;J<=this.diduces.storetax.getCount()-1;J++){this.DStoreTax=this.diduces.storetax.getAt(J);this.Deducjsondata+="{'type':'"+this.DStoreTax.get("Type")+"',";this.Deducjsondata+="'amount':'"+parseFloat(this.DStoreTax.get("amount")).toFixed(2)+"',";if(this.DStoreTax.get("ratetype")==0){this.Deducjsondata+="'Rate':'0',"}else{this.Deducjsondata+="'Rate':'"+parseFloat(this.DStoreTax.get("Rate")).toFixed(2)+"',"}this.deductot=this.diduces.total.getValue().replace(/,/g,"");this.Deducjsondata+="'total':'"+this.deductot+"'},"}this.trmLen2=this.Deducjsondata.length-1;this.DeducJson=this.Deducjsondata.substr(0,this.trmLen2);this.taxesjsondata="";for(var J=0;J<=this.taxes.storetax.getCount()-1;J++){this.TStoreTax=this.taxes.storetax.getAt(J);this.taxesjsondata+="{'type':'"+this.TStoreTax.get("Type")+"',";this.taxesjsondata+="'amount':'"+parseFloat(this.TStoreTax.get("amount")).toFixed(2)+"',";if(this.TStoreTax.get("ratetype")==0){this.taxesjsondata+="'Rate':'0',"}else{this.taxesjsondata+="'Rate':'"+parseFloat(this.TStoreTax.get("Rate")).toFixed(2)+"',"}this.taxtot=this.taxes.total.getValue().replace(/,/g,"");this.taxesjsondata+="'total':'"+this.taxtot+"'},"}this.trmLen3=this.taxesjsondata.length-1;this.taxesJson=this.taxesjsondata.substr(0,this.trmLen3);this.ecjsondata="";for(var J=0;J<=this.empcontrib.storetax.getCount()-1;J++){this.ECStoreTax=this.empcontrib.storetax.getAt(J);this.ecjsondata+="{'type':'"+this.ECStoreTax.get("Type")+"',";this.ecjsondata+="'amount':'"+parseFloat(this.ECStoreTax.get("amount")).toFixed(2)+"',";if(this.ECStoreTax.get("ratetype")==0){this.ecjsondata+="'Rate':'0',"}else{this.ecjsondata+="'Rate':'"+parseFloat(this.ECStoreTax.get("Rate")).toFixed(2)+"',"}this.ectot=this.empcontrib.total.getValue().replace(/,/g,"");this.ecjsondata+="'total':'"+this.ectot+"'},"}this.trmLen4=this.ecjsondata.length-1;this.ecJson=this.ecjsondata.substr(0,this.trmLen4);this.netsal=this.tot.getValue().replace(/,/g,"");this.fixedsal=this.fixedsal.replace(/,/g,"");Wtf.Ajax.requestEx({url:"Emp/setPayrollforTemp.py",method:"post",params:{save:"true",saveType:"PayHistory",empid:this.empid,empname:this.ename,design:this.design,gross:this.fixedsal,net:this.netsal,wagetot:this.wagetot,taxtot:this.taxtot,deductot:this.deductot,ectot:this.ectot,mappingid:this.mappingid,tempid:this.TempId,WageJson:this.WageJson,DeducJson:this.DeducJson,taxesJson:this.taxesJson,ECJson:this.ecJson,stdate:this.fromdateemp.getRawValue(),enddate:this.todateemp.getRawValue()}},this,function(L,K){if(L.value.toString()!="success"){calMsgBoxShow(15,0)}if(L.value.toString()=="success"){calMsgBoxShow(16,0);this.taxes.editrate.disable();this.wages.editrate.disable();this.diduces.editrate.disable();this.empcontrib.editrate.disable();Wtf.getCmp(this.id+"updateslip").disable();Wtf.getCmp(this.id+"GenerateSalary").disable();this.fromdateemp.disable();this.todateemp.disable();this.salgen=1}},function(L,K){})}}});this.xbt1=new Wtf.Button({text:"Update Amount",scope:this,id:this.id+"updateslip",iconCls:"pwndCommon updatebuttonIcon",minWidth:110,handler:function(){Wtf.Msg.show({title:"Warning",scope:this,animEl:"elId",icon:Wtf.MessageBox.QUESTION,msg:"Would you like to update payslip?",buttons:Wtf.Msg.YESNO,fn:function(L,N){if(L=="yes"){var M;var K=0;this.clickflag=0;M=this.wages.total.getValue()-this.diduces.total.getValue();for(var J=0;J<this.taxes.storetax.getCount();J++){this.taxes.storetax.getAt(J).set("amount",parseFloat((this.taxes.storetax.getAt(J).get("Rate")*M)/100))}for(var J=0;J<this.taxes.storetax.getCount();J++){K+=parseFloat(this.taxes.storetax.getAt(J).get("amount"))}this.taxes.total.setValue(parseFloat(K).toFixed(2));D=parseFloat(this.wages.total.getValue());C=parseFloat(this.diduces.total.getValue());A=parseFloat(this.taxes.total.getValue());I=D-C-A;this.tot.setValue(parseFloat(I).toFixed(2));this.clickflag=1;this.wages.storetax.commitChanges();this.diduces.storetax.commitChanges();this.taxes.storetax.commitChanges()}else{this.wages.storetax.load();this.diduces.storetax.load();this.taxes.storetax.load()}}})}});this.dwnldpay=new Wtf.Button({text:"Download Payslip",iconCls:getButtonIconCls(Wtf.btype.downloadbutton),disabled:true,scope:this,handler:function(){var J=this.ename+"_"+this.paycyclestart+"";this.exportReport(1,"pdf",J,this.empid,companyName,this.fromdateemp.getRawValue(),this.todateemp.getRawValue())}});if(this.generated=="1"){this.dwnldpay.enable()}else{this.dwnldpay.disable()}var H=[];H.push("Start date:",this.fromdateemp,"End date",this.todateemp);if(this.flag!="employee"){H.push("-",this.exppayslip=new Wtf.Button({text:"Generate Salary",iconCls:getButtonIconCls(Wtf.btype.assignbutton),scope:this,handler:function(){this.genpayslipchk(1)}}),"-",this.dwnldpay)}var E=[];if(this.flag!="employee"){E.push("->",this.deletepayslip=new Wtf.Button({text:"Delete",iconCls:getButtonIconCls(Wtf.btype.deletebutton),scope:this,handler:function(){this.genpayslipchk(0)}}))}this.MainDataEntryPanel=new Wtf.Panel({id:this.id+"payslip",layout:"column",border:false,bodyStyle:"background:white",scope:this,autoScroll:true,items:[this.empform,this.pan1,this.pan3,this.pan2,this.pan5,this.pan4],tbar:H,buttonAlign:"right",bbar:E});this.add(this.MainDataEntryPanel);this.doLayout();this.on("activate",function(K,J){this.doLayout()})},myfun:function(A){this.finalStr=A;return A},exportReport:function(J,I,A,E,H,G,D){var F="";var C='{"data": []}';if(J==1){C='{"data": ["No","From", "To", "Duration", "Reason", "Type Of Leave", "Paid", "LPW", "Employee Signature", "Approver Signature", "Balance"]}'}var B="../../exportLeavePdfServlet.jsp?&flag="+J+"&colHeader="+C+"&userIDs="+F+"&reportname="+A+"&exporttype="+I+"&empid="+E+"&cname="+H+"&stdate="+this.paycyclestart+"&flagpdf=datewise&enddate="+this.paycycleend;setDldUrl(B)},getdepcomp:function(){Wtf.Ajax.requestEx({url:Wtf.req.base+"../Payroll/Wage/getDepwages.py",method:"post",params:{TempId:this.TempId,earnamount:this.wages.amtot,deducamount:this.diduces.amtot,paycyclestart:this.paycyclestart,paycycleend:this.paycycleend,paycycleactualstart:this.stdate.format("m-d-Y"),paycycleactualend:this.enddate.format("m-d-Y"),empid:this.empid,ischanged:this.ischanged}},this,function(C,B){if(C.Wage!=null&&C.Wage!=undefined){var F=C.Wage;var A=[];for(var E=0;E<F.length;E++){var D=new this.wages.fieldstaxx({Type:F[E].Type,Rate:F[E].Rate,amount:F[E].amount,amtot:F[E].amtot,ratetype:F[E].ratetype,depwage:F[E].depwage,depwageid:F[E].depwageid,computeon:F[E].computeon});this.wages.amtot=this.wages.amtot+F[E].amount;A.push(D)}this.wages.storetax.insert(this.wages.storetax.getTotalCount(),A);this.wages.total.setValue(WtfGlobal.currencyRenderer2(this.wages.amtot));Wtf.getCmp(this.empid+"payslipTab"+this.stdate).setTotalSal()}if(C.Deduc!=null&&C.Deduc!=undefined){var F=C.Deduc;var A=[];for(var E=0;E<F.length;E++){var D=new this.diduces.fieldstaxx({Type:F[E].Type,Rate:F[E].Rate,amount:F[E].amount,amtot:F[E].amtot,ratetype:F[E].ratetype,depwage:F[E].depwage,depwageid:F[E].depwageid,computeon:F[E].computeon});this.diduces.amtot=this.diduces.amtot+F[E].amount;A.push(D)}this.diduces.storetax.insert(this.diduces.storetax.getTotalCount(),A);this.diduces.total.setValue(WtfGlobal.currencyRenderer2(this.diduces.amtot));Wtf.getCmp(this.empid+"payslipTab"+this.stdate).setTotalSal()}if(C.Tax!=null&&C.Tax!=undefined){var F=C.Tax;var A=[];for(var E=0;E<F.length;E++){var D=new this.taxes.fieldstaxx({Type:F[E].Type,Rate:F[E].Rate,amount:F[E].amount,amtot:F[E].amtot,ratetype:F[E].ratetype,depwage:F[E].depwage,depwageid:F[E].depwageid,computeon:F[E].computeon});this.taxes.amtot=this.taxes.amtot+F[E].amount;A.push(D)}this.taxes.storetax.insert(this.taxes.storetax.getTotalCount(),A);this.taxes.total.setValue(WtfGlobal.currencyRenderer2(this.taxes.amtot));Wtf.getCmp(this.empid+"payslipTab"+this.stdate).setTotalSal()}if(C.EC!=null&&C.EC!=undefined){F=C.EC;A=[];for(E=0;E<F.length;E++){D=new this.empcontrib.fieldstaxx({Type:F[E].Type,Rate:F[E].Rate,amount:F[E].amount,amtot:F[E].amtot,ratetype:F[E].ratetype,computeon:F[E].computeon});this.empcontrib.amtot=this.empcontrib.amtot+F[E].amount;A.push(D)}this.empcontrib.storetax.insert(this.empcontrib.storetax.getTotalCount(),A);this.empcontrib.total.setValue(WtfGlobal.currencyRenderer2(this.empcontrib.amtot))}},function(B,A){})},setTotalSal:function(){var C=0;var A=0;var D=0;var B=0;A=parseFloat((this.diduces.total.getValue()).replace(/,/g,""));C=parseFloat((this.wages.total.getValue()).replace(/,/g,""));D=parseFloat((this.taxes.total.getValue()).replace(/,/g,""));B=C-A-D;this.tot.setValue(WtfGlobal.currencyRenderer2(parseFloat(B).toFixed(2)))},genpayslipchk:function(A){if(this.modifiedflag==1&&A!=0){Wtf.MessageBox.show({title:"Confirm",msg:"Data has been modified. Do you wish to continue?",icon:Wtf.MessageBox.QUESTION,buttons:Wtf.MessageBox.YESNO,scope:this,fn:function(B){if(B=="no"){return }else{this.genpayslip()}}})}else{if(A==0){Wtf.MessageBox.show({title:"Confirm",msg:" Are you sure you want to delete the salary details of the employee?",icon:Wtf.MessageBox.QUESTION,buttons:Wtf.MessageBox.YESNO,scope:this,fn:function(B){if(B=="no"){return }else{this.deletePayslip()}}})}else{this.genpayslip()}}},deletePayslip:function(){Wtf.Ajax.requestEx({url:"Emp/deletePayslipDetails.py",method:"post",params:{empid:this.empid,enddate:this.todateemp.getRawValue(),startdate:this.paycyclestart}},this,function(response){var res=eval("("+response+")");Wtf.Msg.show({title:"Success",msg:""+res.msg+"",scope:this,width:300,buttons:Wtf.Msg.OK,fn:function(btn,value){this.dwnldpay.disable();this.fireEvent("gridload",response)},animEl:"elId",icon:Wtf.MessageBox.INFO})},function(req,res){calMsgBoxShow(27,1)})},genpayslip:function(){var A="";var M;var I=this.wages.storetax;for(var O=0;O<I.getCount();O++){M=I.getAt(O).data;A+="{'ctg':'Wages',";A+="'type':'"+M.Type+"',";A+="'amount':'"+M.amount+"',";A+="'Rate':'"+M.Rate+"'},"}var R=A.length-1;var D=A.substr(0,R);var B="";var P;var Q=this.diduces.storetax;for(O=0;O<Q.getCount();O++){P=Q.getAt(O).data;B+="{'ctg':'Deduction',";B+="'type':'"+P.Type+"',";B+="'amount':'"+P.amount+"',";B+="'Rate':'"+P.Rate+"'},"}R=B.length-1;var E=B.substr(0,R);var H="";var G;var C=this.taxes.storetax;for(O=0;O<C.getCount();O++){G=C.getAt(O).data;H+="{'ctg':'Taxes',";H+="'type':'"+G.Type+"',";H+="'amount':'"+G.amount+"',";H+="'Rate':'"+G.Rate+"'},"}R=H.length-1;var F=H.substr(0,R);var J="";var K;var L=this.empcontrib.storetax;for(O=0;O<L.getCount();O++){K=L.getAt(O).data;J+="{'ctg':'Taxes',";J+="'type':'"+K.Type+"',";J+="'amount':'"+K.amount+"',";J+="'Rate':'"+K.Rate+"'},"}R=J.length-1;var N=J.substr(0,R);this.taxtot=this.taxes.total.getValue().replace(/,/g,"");this.netsal=this.tot.getValue().replace(/,/g,"");this.wagetot=this.wages.total.getValue().replace(/,/g,"");this.deductot=this.diduces.total.getValue().replace(/,/g,"");this.ectot=this.empcontrib.total.getValue().replace(/,/g,"");if(parseFloat(this.deductot)>parseFloat(this.wagetot)){calMsgBoxShow(157,1);return }if(parseFloat(this.taxtot)>parseFloat(this.wagetot)){calMsgBoxShow(157,1);return }if((parseFloat(this.taxtot)+parseFloat(this.deductot))>parseFloat(this.wagetot)){calMsgBoxShow(157,1);return }Wtf.Ajax.requestEx({url:"Emp/setPayrollforTemp1.py",method:"post",params:{flag:59,empid:this.empid,gross:this.fixedsal,net:this.netsal,wagetot:this.wagetot,taxtot:this.taxtot,deductot:this.deductot,ectot:this.ectot,mappingid:this.mappingid,tempid:this.TempId,WageJson:D,DeducJson:E,taxesJson:F,ECJson:N,stdate:this.fromdateemp.getRawValue(),enddate:this.todateemp.getRawValue(),paycyclestart:this.paycyclestart,paycycleend:this.paycycleend}},this,function(S){Wtf.Msg.show({title:"Success",msg:""+S.msg.toString()+"",scope:this,width:300,buttons:Wtf.Msg.OK,fn:function(T,U){if(S.value.toString()=="success"){this.dwnldpay.enable();this.fireEvent("gridload",S)}},animEl:"elId",icon:Wtf.MessageBox.INFO})},function(T,S){calMsgBoxShow(27,1)})}});Wtf.analysisWindow=function(config){Wtf.apply(this,config);config.resizable=false;Wtf.analysisWindow.superclass.constructor.call(this,{buttons:[{text:"Save",scope:this,handler:function(){var expr="";for(var ctr in this.mchild){if(this.mchild[ctr].val!=undefined){expr+="("+this.bchild[ctr].val+")";expr+=this.cchild[ctr].val+"*";expr+=this.mchild[ctr].val}}if(!this.AddEditForm.form.isValid()){return }else{if(expr==""&&this.rateunit.getValue()=="%"&&this.computeon.getValue()=="3"){calMsgBoxShow(225,0);return }if(this.radio1.getValue()&&this.radiowage.getValue()){for(var n=0;n<this.userdsT.data.length;n++){if(this.userdsT.getAt(n).data.id==this.componentCombo.getValue()){if(!this.userdsT.getAt(n).data.isdefault){calMsgBoxShow(["Warning","The Selected Payroll Component can not be set as default because dependent Payroll component is not default."],2,false,360);return }}}}if(this.radio1.getValue()){if(this.rateunit.getValue()=="%"){var con=this.computeon.getValue();if(this.tablename!="Taxmaster"){if(con=="1"||con=="2"||con=="0"){for(n=0;n<this.userdsT.data.length;n++){if(this.userdsT.getAt(n).data.isdefault==true){if(this.userdsT.getAt(n).data.computeon==con){calMsgBoxShow(["Warning","You can not set as default two component on same type."],2,false,360);return }}}}}else{if(con=="2"){for(n=0;n<this.userdsT.data.length;n++){if(this.userdsT.getAt(n).data.isdefault==true){if(this.userdsT.getAt(n).data.computeon==con){calMsgBoxShow(["Warning","You can not set as default two component on same type."],2,false,360);return }}}}}}}Wtf.MessageBox.confirm("Confirm","Do you want to save the changes?",function(btn){if(btn!="yes"){}else{if(this.AddEdit=="Edit"){var sm=this.generaltaxgrid.getSelectionModel();var rec=sm.getSelected();var row=this.userdsT.indexOf(rec);sm.clearSelections()}var url;var loadUrl;if(this.type=="Wage"){url="Payroll/Wage/setWagesData.py";loadUrl="Payroll/Wage/getWageMaster.py"}else{if(this.type=="Tax"){url="Payroll/Tax/setTaxData.py";loadUrl="Payroll/Tax/getTaxMaster.py"}else{if(this.type=="Employer Contribution"){url="Payroll/EmpContrib/setEmployerContributionData.py";loadUrl="Payroll/EmpContrib/getEmpContribMaster.py"}else{url="Payroll/Deduction/setDeductionData.py";loadUrl="Payroll/Deduction/getDeductionMaster.py"}}}calMsgBoxShow(200,4,true);this.AddEditForm.getForm().submit({url:url,params:{save:true,saveType:this.type,isChecked:this.radio1.getValue(),Action:this.AddEdit,depwageid:this.componentCombo.getValue(),categoryid:this.categoryid==null?"":this.categoryid,expr:expr,computeon:this.computeon.getValue()},method:"post",scope:this,success:function(a,req){req=eval("("+req.response.responseText+")");if(req.data.value=="exist"){calMsgBoxShow(135,0)}if(req.data.value=="assign"){calMsgBoxShow(138,0)}if(req.data.value=="success"){if(req.data.action=="Added"){calMsgBoxShow(136,0)}if(req.data.action=="Edited"){calMsgBoxShow(137,0)}Wtf.getCmp("addWTDwindow").close();this.userdsT.proxy.conn.url=loadUrl;this.userdsT.baseParams={allflag:false,tablename:this.tablename,type:"getPayComponent"};if(this.AddEdit=="Edit"){var params={start:this.generaltaxgrid.pag.cursor,limit:this.generaltaxgrid.pag.pageSize};WtfGlobal.delaytasks(this.userdsT,params)}else{this.userdsT.load({params:{start:0,limit:this.generaltaxgrid.pag.pageSize}})}this.payrollcombo.setValue(this.tablename);if(this.tablename=="Taxmaster"){this.incometaxgrid.show();Wtf.getCmp("paysettingmainPanel").doLayout()}else{this.incometaxgrid.hide();Wtf.getCmp("paysettingmainPanel").doLayout()}}},failure:function(req,res){}})}},this)}}},{text:"Cancel",handler:function(){Wtf.getCmp("addWTDwindow").close()},scope:this}]})};Wtf.extend(Wtf.analysisWindow,Wtf.Window,{initComponent:function(){Wtf.analysisWindow.superclass.initComponent.call(this);this.GetNorthPanel();this.GetAddEditForm();this.mainPanel=new Wtf.Panel({layout:"border",border:false,items:[this.northPanel,this.AddEditForm]});this.add(this.mainPanel)},afterRender:function(B,A){Wtf.analysisWindow.superclass.afterRender.call(this,B,A);if(this.computeon.getValue()=="3"){this.correct.setVisible(true);this.setHeight(600)}},selectrows:function(L,K,I){var G=[];this.oper=[];this.coeff=[];var D=new this.wageRec({"type":"<b>Template Basic</b>","id":"-1","comp":"<b>Template Basic</b>"});G.push(D);if(I.params.ss==undefined||I.params.ss==""){this.wageds.insert(0,G);this.ArrangeNumberer(0)}G=[];if(this.computeon.getValue()=="3"){if(this.generaltaxgrid.getSelectionModel().getSelected()!=null){var M=this.generaltaxgrid.getSelectionModel().getSelected().get("expr").split("(add)");for(var C=0;C<M.length;C++){var J=M[C].split("(sub)");for(var B=0;B<J.length;B++){var E=J[B].split("*");var A=1;var F;if(E.length>1){A=E[0];F=E[1]}else{F=E[0]}var H=this.wageds.find("id",F);if(H>-1){if(B==0){this.oper[H]="+"}else{this.oper[H]="-"}G.push(this.wageds.getAt(H));this.coeff[H]=A}}}if(G.length>0){this.sm.selectRecords(G)}}}},GetNorthPanel:function(){var C=this.AddEdit=="Edit"?"Edit Component":"Add Component";var A=this.AddEdit=="Edit"?"Fill up the information to edit component":"Fill up the information to add component";var B=this.typeimage;this.northPanel=new Wtf.Panel({region:"north",height:90,border:false,bodyStyle:"backgroubodyStylend-color:white;padding:8px;border-bottom:1px solid #bfbfbf;background-color: white",html:getTopHtml(C,A,B)})},GetAddEditForm:function(){this.combodata=[["Wage","Wagemaster"],["Tax","Taxmaster"],["Deduction","Deductionmaster"],["Employer Contribution","EmpContribmaster"]];this.combostore1=new Wtf.data.SimpleStore({fields:[{name:"type"},{name:"code"}],data:this.combodata});this.fieldswage=[{name:"type"},{name:"cash"},{name:"code"},{name:"id"},{name:"assigned"},{name:"rate"},{name:"amount"}];this.fieldswage=Wtf.data.Record.create(this.fieldswage);this.readerwage=new Wtf.data.KwlJsonReader({root:"data",totalProperty:"totalCount"},this.fieldswage);this.wagestore1=new Wtf.data.Store({url:"Payroll/Wage/getWageMasterForComponent.py",method:"GET",reader:this.readerwage});this.percent=[["Percent","%"],["Amount","$"]];this.percentstore=new Wtf.data.SimpleStore({fields:[{name:"type"},{name:"code"}],data:this.percent});this.taxrateinamount=new Wtf.Panel({width:400,frame:false,border:false,layout:"column",items:[{columnWidth:0.52,frame:false,border:false,layout:"form",items:[this.rangefrom=new Wtf.form.NumberField({fieldLabel:"Income Slab ("+WtfGlobal.getCurrencySymbol()+")",editable:false,name:"rangefrom",width:100,labelWidth:100,emptyText:"Min value",regex:/^[0-9]{0,10}$/})]},{columnWidth:0.48,frame:false,border:false,items:[this.rangeto=new Wtf.form.NumberField({width:95,name:"rangeto",emptyText:"Max value",regex:/^[0-9]{0,10}$/})]}]});this.ctgrycombo=new Wtf.form.FnComboBox({fieldLabel:"Category",store:Wtf.catgStore,displayField:"name",valueField:"id",name:"categoryname",typeAhead:true,width:200,listWidth:200,labelWidth:100,mode:"local",triggerAction:"all",emptyText:"Select Category",addNewFn:this.addCategory.createDelegate(this),listeners:{scope:this,Select:function(D,B,C){this.categoryid=B.get("id")}}});this.editloadflag=0;if(!Wtf.StoreMgr.containsKey("catg")){Wtf.catgStore.on("load",this.setCategary,this);Wtf.catgStore.load();Wtf.StoreMgr.add("catg",Wtf.catgStore)}else{this.setCategary();this.editloadflag=1}this.taxpanel=new Wtf.Panel({width:400,height:60,layout:"form",border:false,hidden:true,items:[this.taxrateinamount,this.ctgrycombo]});this.combo1=new Wtf.form.ComboBox({fieldLabel:"Add Type*",store:this.combostore1,displayField:"type",typeAhead:true,valueField:"code",allowBlank:false,name:"type",width:200,mode:"local",value:this.tablename,triggerAction:"all",emptyText:"Select component",selectOnFocus:true,listeners:{scope:this,Select:function(D,B,C){this.tablename=B.get("code");this.type=B.get("type");if(this.type=="Tax"){this.ctgrycombo.allowBlank=false;this.rangefrom.allowBlank=false;this.rangeto.allowBlank=false;this.AddEditForm.doLayout()}else{this.ctgrycombo.allowBlank=true;this.rangefrom.allowBlank=true;this.rangeto.allowBlank=true;this.AddEditForm.doLayout()}}}});this.componentCombo=new Wtf.form.ComboBox({fieldLabel:"Wage Component",store:this.wagestore1,displayField:"type",disabled:true,typeAhead:true,valueField:"id",allowBlank:false,name:"type",width:200,mode:"local",triggerAction:"all",emptyText:"Select Wage Component",selectOnFocus:true});this.text1=new Wtf.form.TextField({fieldLabel:"Name*",width:200,allowBlank:false,validator:WtfGlobal.noBlankCheck,maxLength:35,scope:this,name:"name"});this.text2=new Wtf.form.TextField({fieldLabel:"Code*",width:200,name:"code",maxLength:50,allowBlank:false,validator:WtfGlobal.noBlankCheck,displayField:"cname"});this.radio=new Wtf.Panel({width:400,layout:"form",height:30,border:false,items:[this.radio1=new Wtf.form.Checkbox({name:"linkasdefault",id:"checkisdefault",fieldLabel:"Add as default",style:"padding-top:15px;"})]});this.radiosal=new Wtf.Panel({width:400,layout:"form",labelWidth:200,border:false,items:[this.radiosalary=new Wtf.form.Radio({name:"percentof",id:"percentofsal",disabled:true,boxLabel:"Percent Of Salary",style:"padding-top:15px;padding-left:30px;",hideLabel:true})]});this.radiocomp=new Wtf.Panel({width:400,layout:"form",labelWidth:200,border:false,items:[this.radiowage=new Wtf.form.Radio({name:"percentof",id:"percentofcomp",disabled:true,boxLabel:"Percent Of Wage Component",style:"padding-top:15px;padding-left:30px;",hideLabel:true})]});this.rateunit=new Wtf.form.ComboBox({fieldLabel:"Unit*",store:this.percentstore,displayField:"type",typeAhead:true,valueField:"code",allowBlank:false,width:200,labelWidth:100,scope:this,name:"option",mode:"local",value:"%",triggerAction:"all",emptyText:"Select Percent or Amount",selectOnFocus:true,minValue:0,listeners:{scope:this,Select:function(D,B,C){if(B.get("type")=="Percent"){this.myratetax.maxValue=100;this.myratetax.setValue(0);Wtf.getCmp("percentofsal").enable();Wtf.getCmp("percentofcomp").enable();this.computeon.setDisabled(false);this.computeon.setVisible(true);this.computeon.container.up("div.x-form-item").dom.style.display="block";this.computeon.allowBlank=false;if(this.computeon.getValue()=="3"){this.correct.setVisible(true);this.setHeight(600);this.doLayout()}}if(B.get("type")=="Amount"){this.myratetax.maxValue=Number.MAX_VALUE;this.myratetax.setValue(0);Wtf.getCmp("percentofsal").disable();Wtf.getCmp("percentofcomp").disable();this.componentCombo.disable();this.componentCombo.setValue("");this.computeon.setVisible(false);this.computeon.container.up("div.x-form-item").dom.style.display="none";this.computeon.allowBlank=true;if(this.computeon.getValue()=="3"){this.correct.setVisible(false);this.setHeight(450);this.doLayout()}}}}});this.cm=new Wtf.grid.ColumnModel([new Wtf.grid.CheckboxSelectionModel(),new Wtf.grid.RowNumberer(),{header:"Component",dataIndex:"type",sortable:true},{header:"Type",dataIndex:"comp",sortable:true}]);this.wageRec=new Wtf.data.Record.create([{name:"type"},{name:"id"},{name:"comp"}]);this.wageds=new Wtf.data.Store({scope:this,reader:new Wtf.data.KwlJsonReader({root:"data",totalProperty:"totalcount"},this.wageRec),baseParams:{tablename:"Wagemaster",type:"getPayComponent",allflag:"true",isedit:this.AddEdit,wageno:(this.AddEdit)?this.editWageId:"",earningtype:this.type,computeon:"3",deduc:"true",empcont:"true"},url:"Payroll/Wage/getWageMaster.py"});this.wageds.load({params:{start:0,limit:15}});this.wageds.on("load",this.selectrows,this);this.computedata=[["0","Current Deduction"],["1","Current Earnings"],["2","Net Salary"],["3","Specified formula"]];this.computestore=new Wtf.data.SimpleStore({fields:[{name:"id"},{name:"value"}],data:this.computedata});this.computeon=new Wtf.form.ComboBox({fieldLabel:"Compute on*",store:this.computestore,displayField:"value",typeAhead:true,valueField:"id",allowBlank:false,name:"type",width:200,mode:"local",triggerAction:"all",emptyText:"Select component",selectOnFocus:true,listeners:{scope:this,Select:function(D,B,C){if(B.get("id")=="3"){this.correct.setVisible(true);this.setHeight(600);this.doLayout()}else{this.correct.setVisible(false);this.setHeight(450);this.doLayout()}}}});this.child1=[];this.bchild=[];this.mchild=[];this.cchild=[];this.achild=[];this.conContainer=document.createElement("div");this.conContainer.className="conContainer";this.conContainer.id="parentCon";this.child1[this.i]=document.createElement("div");this.child1[this.i].className="child1";this.conContainer.appendChild(this.child1[this.i]);this.sm=new Wtf.grid.CheckboxSelectionModel();this.sm.on("rowselect",this.onRowSelect,this);this.sm.on("rowdeselect",this.onRowDeselect,this);this.correct=new Wtf.Panel({id:"feed",layout:"fit",border:false,hidden:true,items:[{layout:"border",height:(Wtf.isIE7||Wtf.isIE8)?210:200,bodyStyle:"margin-top:10px; background:transparent",border:false,layoutConfig:{labelSeparator:""},items:[new Wtf.form.FieldSet({height:(Wtf.isIE7||Wtf.isIE8)?100:140,region:"north",layout:"fit",id:"rules",title:"1.Select Wage components",items:[this.grid=new Wtf.KwlGridPanel({id:"rulegrid",store:this.wageds,serverSideSearch:true,cm:this.cm,searchLabel:" ",searchLabelSeparator:" ",searchEmptyText:"Search by Component",searchField:"type",paging:false,sm:this.sm,viewConfig:{forceFit:true}})]}),new Wtf.form.FieldSet({region:"center",id:"subrules",bodyStyle:"overflow-y:scroll;",height:100,title:"2. Your Formula",items:[new Wtf.Panel({id:"addCon",border:false,contentEl:this.conContainer})]})]}]});this.myratetax=new Wtf.form.NumberField({width:200,labelWidth:100,fieldLabel:"Value*",name:"rate",maxLength:10,scope:this,allowNegative:false,value:0,id:"myratetext",allowBlank:false,listeners:{scope:this,focus:function(){if(this.rateunit.getValue()=="%"){this.myratetax.maxValue=100}if(this.rateunit.getValue()=="$"){this.myratetax.maxValue=Number.MAX_VALUE}}}});this.typeid=new Wtf.form.Hidden({name:"typeid",scope:this,allowBlank:true,hideLabel:true,hidden:true});this.typeid.hide();this.AddEditForm=new Wtf.form.FormPanel({region:"center",border:false,scope:this,labelWidth:200,bodyStyle:"background-color:#f1f1f1;padding:15px",items:[this.combo1,this.text1,this.text2,this.rateunit,this.computeon,this.correct,this.myratetax,this.radio,this.typeid]});if(this.type=="Tax"){this.ctgrycombo.allowBlank=false;this.rangefrom.allowBlank=false;this.rangeto.allowBlank=false}if(this.AddEdit=="Edit"){var A=this.generaltaxgrid.getSelectionModel().getSelected().data;if(this.type=="Tax"){this.ctgrycombo.allowBlank=false;this.rangefrom.allowBlank=false;this.rangeto.allowBlank=false;this.AddEditForm.doLayout();this.rangefrom.setValue(A.rangefrom);this.rangeto.setValue(A.rangeto);Wtf.catgStore.on("load",function(){this.ctgrycombo.setValue(A.category)},this);if(this.editloadflag==1){this.ctgrycombo.setValue(A.category)}}else{this.ctgrycombo.allowBlank=true;this.rangefrom.allowBlank=true;this.rangeto.allowBlank=true}this.text1.setValue(A.type);this.text2.setValue(A.code);this.typeid.setValue(A.id);if(A.rate==0){this.ratecash=A.cash;this.rateunit.setValue("$");this.computeon.setDisabled(true)}else{if(A.depwage==""){Wtf.getCmp("percentofsal").enable();Wtf.getCmp("percentofcomp").enable();Wtf.getCmp("percentofsal").checked=true}else{Wtf.getCmp("percentofcomp").enable();Wtf.getCmp("percentofsal").enable();Wtf.getCmp("percentofcomp").checked=true}this.ratecash=A.cash;this.rateunit.setValue("%")}this.myratetax.setValue(this.ratecash);this.combo1.setValue(this.tablename);this.combo1.disable();this.radio1.setValue(A.isdefault);this.computeon.setValue(A.computeon);this.myratetax.on("change",this.validatePercent,this)}Wtf.getCmp("percentofcomp").on("check",function(C,B){this.componentCombo.setDisabled(!B)},this);Wtf.getCmp("percentofsal").on("check",function(C,B){this.componentCombo.setValue("")},this);Wtf.getCmp("percentofsal").on("check",function(C,B){if(Wtf.getCmp("percentofsal").rendered&&Wtf.getCmp("percentofcomp").rendered){Wtf.getCmp("percentofsal").onClick();Wtf.getCmp("percentofcomp").onClick()}},this);Wtf.getCmp("percentofcomp").on("check",function(C,B){if(Wtf.getCmp("percentofsal").rendered&&Wtf.getCmp("percentofcomp").rendered){Wtf.getCmp("percentofsal").onClick();Wtf.getCmp("percentofcomp").onClick()}},this)},ArrangeNumberer:function(B){var A=this.grid.getView();var D=this.wageds.getCount();for(var C=B;C<D;C++){A.getCell(C,1).firstChild.innerHTML=C+1}},onRowDeselect:function(A,C,B){document.getElementById("parentCon").removeChild(document.getElementById("con"+C));this.mchild.splice(C,1);this.cchild.splice(C,1);this.bchild.splice(C,1);this.child1[C]=undefined},onRowSelect:function(A,C,B){if(this.child1[C]==undefined){this.child1[C]=document.createElement("div");this.child1[C].id="con"+C;this.mchild[C]=document.createElement("div");this.mchild[C].className="mchild";if(Wtf.isIE7||Wtf.isIE8){this.mchild[C].style.display="inline"}else{this.mchild[C].style.cssFloat="left"}this.mchild[C].val=B.get("id");this.mchild[C].id="mchild"+C;this.cchild[C]=document.createElement("div");this.cchild[C].id="coeff"+C;this.cchild[C].className="x-form-item";if(Wtf.isIE7||Wtf.isIE8){this.cchild[C].style.display="inline"}else{this.cchild[C].style.cssFloat="left"}if(this.coeff!=null&&this.coeff!=undefined&&this.coeff.length>0){this.cchild[C].innerHTML="&nbsp;<a href=javascript:void(0)>("+this.coeff[C]+")</a>&nbsp;";this.cchild[C].val=this.coeff[C]}else{this.cchild[C].innerHTML="&nbsp;<a href=javascript:void(0)>("+1+")</a>&nbsp;";this.cchild[C].val=1}this.bchild[C]=document.createElement("div");this.bchild[C].id="addsub"+C;this.bchild[C].className="x-form-item";if(Wtf.isIE7||Wtf.isIE8){this.bchild[C].style.display="inline"}else{this.bchild[C].style.cssFloat="left"}if(this.oper!=null&&this.oper!=undefined&&this.oper.length>0){if(this.oper[C]=="+"){this.bchild[C].val="add"}else{if(this.oper[C]=="-"){this.bchild[C].val="sub"}else{this.bchild[C].val="add";this.oper[C]="+"}}this.bchild[C].innerHTML="&nbsp;<a href=javascript:void(0)>("+this.oper[C]+")</a>&nbsp;"}else{this.bchild[C].val="add";this.bchild[C].innerHTML="&nbsp;<a href=javascript:void(0)>(+)</a>&nbsp;"}this.mchild[C].innerHTML=B.get("type");this.mchild[C].className="x-form-item";if(Wtf.isIE7||Wtf.isIE8){this.bchild[C].onclick=this.showRuleWin.createDelegate(this,[this.bchild[C]],false);this.cchild[C].onclick=this.showCoeffWin.createDelegate(this,[this.cchild[C]],false)}else{this.bchild[C].onclick=this.showRuleWin.createDelegate(this);this.cchild[C].onclick=this.showCoeffWin.createDelegate(this)}this.child1[C].appendChild(this.bchild[C]);this.child1[C].appendChild(this.cchild[C]);this.child1[C].appendChild(this.mchild[C]);this.conContainer.appendChild(this.child1[C])}},invRadiobttn:function(B,A){if(B.id=="add"){Wtf.getCmp("sub").checked=false}if(B.id=="sub"){Wtf.getCmp("add").checked=false}},showCoeffWin:function(C){if(Wtf.isIE7||Wtf.isIE8){this.updateelement=C}else{this.updateelement=C.currentTarget}var B=new Wtf.Panel({frame:true,items:[{layout:"form",items:[{layout:"column",items:[{html:"Coefficient:<br><br>"}]},{layout:"column",fieldWidth:0,items:[new Wtf.form.NumberField({name:"coeff",id:"coefffield",value:this.updateelement.val,allowNegative:false,minValue:0,maxValue:100,decimalPrecision:4})]}]},{layout:"column",items:[{layout:"form",buttons:[{text:"OK",scope:this,handler:function(){var D=Wtf.getCmp("coefffield").value;if(!Wtf.getCmp("coefffield").validateValue(D)){return }this.updateelement.innerHTML="&nbsp;<a href=javascript:void(0)>"+D+"</a>&nbsp;";this.updateelement.val=D;A.close()}},{text:"Cancel",handler:function(){A.close()}}]}]}]});var A=new Wtf.Window({title:"Coefficient",closable:true,width:200,iconCls:"winicon",resizable:false,autoDestroy:true,modal:true,border:false,id:"coefficientWindow",items:[B]});A.show()},showRuleWin:function(C){if(Wtf.isIE7||Wtf.isIE8){this.updateelement=C}else{this.updateelement=C.currentTarget}var B=new Wtf.Panel({frame:true,items:[{layout:"form",items:[{layout:"column",items:[{html:"Apply Rule If:<br><br>"}]},{layout:"column",fieldWidth:0,items:[new Wtf.form.Radio({name:"cond",id:"add",checked:(this.updateelement.val=="add")?true:false,boxLabel:"Addition"})]},{layout:"column",fieldWidth:0,items:[new Wtf.form.Radio({name:"cond",id:"sub",checked:(this.updateelement.val=="sub")?true:false,boxLabel:"Subtraction"})]}]},{layout:"column",items:[{layout:"form",buttons:[{text:"OK",scope:this,handler:function(){if(Wtf.getCmp("add").checked==true){this.rad=0}else{if(Wtf.getCmp("sub").checked==true){this.rad=1}}if(this.rad==1){this.updateelement.innerHTML="&nbsp;<a href=javascript:void(0)>(-)</a>&nbsp;";this.updateelement.val="sub"}else{this.updateelement.innerHTML="&nbsp;<a href=javascript:void(0)>(+)</a>&nbsp;";this.updateelement.val="add"}A.close()}},{text:"Cancel",handler:function(){A.close()}}]}]}]});Wtf.getCmp("add").on("check",this.invRadiobttn,this);Wtf.getCmp("sub").on("check",this.invRadiobttn,this);var A=new Wtf.Window({title:"And/Or",closable:true,width:200,iconCls:"winicon",resizable:false,autoDestroy:true,modal:true,border:false,id:"conditionWindow",items:[B]});A.show()},addCategory:function(){WtfGlobal.showmasterWindow(14,Wtf.catgStore,"Add")},setCategary:function(){if(Wtf.catgStore.getCount()>0){this.ctgrycombo.setValue(Wtf.catgStore.getAt(Wtf.catgStore.getCount()-1).get("id"))}},validatePercent:function(){if(this.rateunit.getRawValue()=="Percent"&&this.myratetax.getValue()>100){this.myratetax.setValue("");calMsgBoxShow(166,3)}}});Wtf.addpayCmpWin=function(A){Wtf.apply(this,{buttonAlign:"right",width:430,height:325,buttons:[{text:"Save",handler:this.saveRequest,scope:this},{text:"Cancel",handler:function(){this.close()},scope:this}]},A);Wtf.addpayCmpWin.superclass.constructor.call(this,A)};Wtf.extend(Wtf.addpayCmpWin,Wtf.Window,{initComponent:function(){Wtf.addpayCmpWin.superclass.initComponent.call(this)},iconCls:getButtonIconCls(Wtf.btype.winicon),onRender:function(A){Wtf.addpayCmpWin.superclass.onRender.call(this,A);this.perValue=[["Percent","%"],["Amount","$"]];this.percentSt=new Wtf.data.SimpleStore({fields:[{name:"type"},{name:"code"}],data:this.perValue});this.text1=new Wtf.form.TextField({fieldLabel:"Name*",width:200,allowBlank:false,validator:WtfGlobal.noBlankCheck,maxLength:35,scope:this,name:"name"});this.text2=new Wtf.form.TextField({fieldLabel:"Code*",width:200,name:"code",validator:WtfGlobal.noBlankCheck,maxLength:50,allowBlank:false,displayField:"cname"});this.rateunit=new Wtf.form.ComboBox({fieldLabel:"Unit*",store:this.percentSt,displayField:"type",typeAhead:true,valueField:"code",allowBlank:false,disabled:true,width:200,labelWidth:100,scope:this,name:"option",mode:"local",triggerAction:"all",emptyText:"Select Percent or Amount",selectOnFocus:true,listeners:{scope:this,Select:function(D,B,C){if(B.get("type")=="Percent"){this.phoneNumberExpr=/^(100(?:\.0{1,2})?|0*?\.\d{1,2}|\d{1,2}(?:\.\d{1,2})?)$/;Wtf.getCmp(this.id+"myratetext").regex=this.phoneNumberExpr;Wtf.getCmp(this.id+"myratetext").setValue(0)}if(B.get("type")=="Amount"){this.phoneNumberExpr=/^[0-9]*$/;Wtf.getCmp(this.id+"myratetext").regex=this.phoneNumberExpr;Wtf.getCmp(this.id+"myratetext").setValue(0)}}}});this.myratetax=new Wtf.form.NumberField({width:200,labelWidth:100,fieldLabel:"Value*",name:"rate",value:0,maxLength:10,allowNegative:false,scope:this,id:this.id+"myratetext",allowBlank:false,listeners:{scope:this,focus:function(){if(this.rateunit.getValue()=="%"){this.phoneNumberExpr=/^(100(?:\.0{1,2})?|0*?\.\d{1,2}|\d{1,2}(?:\.\d{1,2})?)$/;Wtf.getCmp(this.id+"myratetext").regex=this.phoneNumberExpr}if(this.rateunit.getValue()=="$"){this.phoneNumberExpr=/^[0-9]*$/;Wtf.getCmp(this.id+"myratetext").regex=this.phoneNumberExpr}}}});this.chk1=new Wtf.form.Checkbox({name:"linkasdefault",fieldLabel:"Add to Payroll Master",style:"padding-top:15px;"});this.typeid=new Wtf.form.Hidden({name:"typeid",value:this.type});this.addpayform=new Wtf.form.FormPanel({waitMsgTarget:true,border:false,cls:"x-panel-body x-panel-body-noheader x-panel-body-noborder",style:"background: transparent;padding-left:20px;padding-top: 20px;padding-right: 0px;",autoScroll:false,labelWidth:119,layoutConfig:{deferredRender:false},items:[this.text1,this.text2,this.rateunit,this.myratetax,this.typeid]});this.addpaypanel=new Wtf.Panel({border:false,layout:"fit",autoScroll:false,items:[{border:false,region:"center",layout:"border",items:[{region:"north",height:80,border:false,cls:"panelstyleClass1",html:getTopHtml("Add "+this.type+"","Fill up the following details","../../images/payroll.gif")},{border:false,region:"center",cls:"formstyleClass2",layout:"fit",items:[this.addpayform]}]}]});this.rateunit.setValue("$");this.add(this.addpaypanel)},saveRequest:function(){if(!this.addpayform.form.isValid()){return }else{var F=0;var C="-";var B="";if(this.rateunit.getValue()=="%"){F=parseFloat(this.myratetax.getValue())*(parseFloat(this.salary)/100);C=this.myratetax.getValue();B=1}else{F=parseFloat(this.myratetax.getValue());B=0}var E=new this.gridrec({Type:this.text1.getValue(),Rate:C,computeon:"-",amount:F,amtot:"",ratetype:B});this.gridst.insert(this.gridst.getCount(),E);var D=0;for(var A=0;A<this.gridst.getCount();A++){D+=parseFloat(this.gridst.getAt(A).get("amount"))}this.grid.total.setValue(WtfGlobal.currencyRenderer2(D));Wtf.getCmp(this.empid+"payslipTab"+this.stdate).setTotalSal();this.close()}}});Wtf.PayslipGrid=function(A){Wtf.form.Field.prototype.msgTarget="side",A.border=false;Wtf.apply(Wtf.form.VTypes,{"percentage":function(C){var B=/^(100(?:\.0{1,2})?|0*?\.\d{1,2}|\d{1,2}(?:\.\d{1,2})?)$/;return B.test(C)},"percentageMask":/[0-9.]/,"percentageText":"This field must be a percentage between 0.00 and 99.99"});Wtf.PayslipGrid.superclass.constructor.call(this,A)};Wtf.extend(Wtf.PayslipGrid,Wtf.Panel,{initComponent:function(A){this.addEvents({"storeload":true});Wtf.PayslipGrid.superclass.initComponent.call(this,A);var D=this.salary;var F=this.Data;var E=this.dtotal;var B=this.fixedsal;var G=this.cursymbol;this.addEvents({"datamodified":true});this.rateEditor=new Wtf.form.TextField();this.amountEditor=new Wtf.form.TextField();this.cmtax=new Wtf.grid.ColumnModel([{header:this.type,dataIndex:"Type",sortable:true,autoWidth:true},{header:"Rate",dataIndex:"Rate",align:"center",sortable:true,hidden:true,autoWidth:true,renderer:function(J,I,H){if(H.get("ratetype")==1){return WtfGlobal.percentageRenderer(J)}else{return"<div align='center'>-</div>"}}},{header:"Percent of",dataIndex:"computeon",align:"center",sortable:true,hidden:(this.flag!="employee")?false:true,sortable:true},{header:"Amount",dataIndex:"amount",autoWidth:true,scope:this,sortable:true,align:"right",renderer:function(H){if(H!=null){return('<div align="right" style="font-family:Lucida Sans Unicode;">'+WtfGlobal.currencyRenderer(parseFloat(H).toFixed(2))+"</div>")}}},{header:"Delete",dataIndex:"",width:30,hidden:(this.flag!="employee")?false:true,renderer:function(J,I,H){if(H.data.DeducId!="-1"){return"<div><div class='pwndCommon gridCancel' style='cursor:pointer' wtf:qtip='Delete Record'></div></div>"}}}]);this.fieldstax=[{name:"Type"},{name:"Rate"},{name:"amount",type:"float"},{name:"amtot"},{name:"ratetype"},{name:"computeon"}];this.fieldstaxx=Wtf.data.Record.create(this.fieldstax);this.readertax=new Wtf.data.KwlJsonReader({root:this.Data,totalProperty:"totalCount"},this.fieldstaxx);this.storetax=new Wtf.data.Store({scope:this,url:this.storeURL,method:"GET",reader:this.readertax});this.addbtn=new Wtf.Toolbar.Button({text:"Add "+this.type+"",iconCls:getButtonIconCls(Wtf.btype.addbutton),tooltip:"Add new "+this.type+" in current salary ",scope:this,handler:this.addnew});this.storetax.load({params:{paycyclestart:this.paycyclestart,paycycleend:this.paycycleend,paycycleactualstart:this.paycycleactualstart,paycycleactualend:this.paycycleactualend,ischanged:this.ischanged,mappingid:this.mappingid}});var C=[];if(this.flag!="employee"){C.push(this.addbtn)}C.push("->",'TOTAL<span align="right" style="font-family:Lucida Sans Unicode;">('+WtfGlobal.getCurrencySymbol()+")</span>",this.total=new Wtf.form.TextField({border:false,scope:this,cls:"textfstyle",width:100,value:0,fieldLabel:"TOTAL",readOnly:true,id:this.id+"gridtotal",height:16,bodyStyle:"background:white"}));this.grid=new Wtf.grid.EditorGridPanel({scope:this,bodyStyle:"width:99.7%",cm:this.cmtax,sm:new Wtf.grid.RowSelectionModel({singleSelect:true}),store:this.storetax,autoScroll:true,viewConfig:{forceFit:true},height:this.height,clicksToEdit:1,stripeRows:true,bbar:C});this.grid.on("click",function(I){if(I.target.className=="pwndCommon gridCancel"){if(this.grid.getSelectionModel().getSelections().length>0){this.grid.getStore().remove(this.grid.getSelectionModel().getSelected());var H=0;for(i=0;i<this.storetax.getCount();i++){H=H+this.storetax.getAt(i).get("amount")}this.total.setValue(WtfGlobal.currencyRenderer2(H));Wtf.getCmp(this.empid+"payslipTab"+this.stdate).setTotalSal();this.fireEvent("datamodified")}}},this);this.storetax.on("load",function(){this.amtot=0;for(i=0;i<this.storetax.getCount();i++){this.amtot=this.amtot+this.storetax.getAt(i).get("amount")}this.total.setValue(WtfGlobal.currencyRenderer2(this.amtot));this.fireEvent("storeload")},this);this.pan1=new Wtf.Panel({height:this.height,border:false,bodyStyle:"margin-left:25%",scope:this,items:[this.grid]});this.add(this.pan1);this.doLayout();this.pan1.doLayout();this.on("activate",function(I,H){this.doLayout()});this.grid.on("afteredit",this.fillGridValue,this);this.grid.on("beforeedit",this.chkEditorValue,this)},chkEditorValue:function(B){var A=1;if(B.record.get("ratetype")==0&&B.column==2){B.cancel=true}},fillGridValue:function(B){var C=0;if(B.column==2){this.storetax.getAt(B.row).set("amount",(this.fixedsal*this.storetax.getAt(B.row).get("Rate"))/100);for(var A=0;A<this.storetax.getCount();A++){C+=parseFloat(this.storetax.getAt(A).get("amount"))}}else{if(B.column==4){this.storetax.getAt(B.row).set("Rate",(100*this.storetax.getAt(B.row).get("amount"))/this.fixedsal);for(var A=0;A<this.storetax.getCount();A++){C+=parseFloat(this.storetax.getAt(A).get("amount"))}}}this.total.setValue(WtfGlobal.currencyRenderer2(C));Wtf.getCmp(this.empid+"payslipTab"+this.stdate).setTotalSal();this.fireEvent("datamodified")},addnew:function(){var A=Wtf.getCmp(this.id);var D=A.grid.getStore();var C=D.getCount();var B=new Wtf.addpayCmpWin({iconCls:getButtonIconCls(Wtf.btype.winicon),layout:"fit",type:this.type,closable:true,resizable:false,stdate:this.stdate,gridst:D,gridrec:this.fieldstaxx,title:"Add Component ",border:false,id:this.id+"paywindow",modal:true,scope:this,empid:this.empid,grid:A,salary:this.fixedsal,plain:true});B.show()}});Wtf.EditViewTemplate=function(A){Wtf.form.Field.prototype.msgTarget="side",A.layout="fit";A.closable=true;Wtf.EditViewTemplate.superclass.constructor.call(this,A)};Wtf.extend(Wtf.EditViewTemplate,Wtf.Panel,{initComponent:function(A){Wtf.EditViewTemplate.superclass.initComponent.call(this,A);this.storeURL="null";this.stran=String(this.range).substring(0,String(this.range).indexOf("-",0)-1);this.endran=String(this.range).substring(String(this.range).indexOf("-",0)+1,String(this.range).length);this.PayAreaForm12=new Wtf.form.FormPanel({columnWidth:0.25,height:200,labelWidth:100,border:false,bodyBorder:"true",scope:this,frame:false,items:[this.tempname=new Wtf.form.TextField({fieldLabel:"Template Name",allowBlank:false,validator:WtfGlobal.noBlankCheck,id:"tempName"+this.id,scope:this,width:200,maxLength:40,value:this.templatename})]});this.PayAreaForm13=new Wtf.form.FormPanel({columnWidth:0.25,height:200,labelWidth:150,border:false,hidden:true,bodyBorder:"true",scope:this,frame:false,items:[this.newLimitStart=new Wtf.form.NumberField({fieldLabel:' Salary Range/Month (<span align="right" style="font-family:Lucida Sans Unicode;">'+WtfGlobal.getCurrencySymbol()+"</span>)",width:150,labelWidth:60,allowBlank:false,allowNegative:false,maxLength:15,id:this.id+"editsalarystartrange",scope:this,value:this.stran})]});this.PayAreaForm14=new Wtf.form.FormPanel({columnWidth:0.18,height:200,border:false,hidden:true,bodyBorder:"true",scope:this,frame:false,items:[this.newLimitEnd=new Wtf.form.NumberField({hideLabel:true,scope:this,maxLength:15,allowBlank:false,allowNegative:false,initialPassField:this.id+"editsalarystartrange",value:this.endran,vtype:"range",width:150})]});this.PayAreaForm15=new Wtf.form.FormPanel({columnWidth:0.24,height:200,labelWidth:120,border:false,bodyBorder:"true",scope:this,frame:false,items:[this.addgroupCombo=new Wtf.form.FnComboBox({fieldLabel:"Add to Designation",scope:this,allowBlank:false,triggerAction:"none",readOnly:true,mode:"local",selectOnFocus:true,typeAhead:true,disabled:true,width:200,store:Wtf.desigStore,addNewFn:this.addDesignation.createDelegate(this),plugins:[new Wtf.common.comboAddNew({handler:function(){WtfGlobal.showmasterWindow(1,Wtf.desigStore,"Add")},scope:this})],listeners:{scope:this,select:function(D,B,C){new Wtf.form.Hidden({id:"GlobalGroupId1",value:B.get("id"),readOnly:true})}},displayField:"name",valueField:"id"})]});this.wageentryform1=new Wtf.WageEntryForm({edittemp:"yes",paramstore:"1",region:"west",parentId:this.id,id:this.id+"editwagegrid",width:"33%",bodyStyle:"padding:15px;background-color:white"});this.taxentryform1=new Wtf.WageTaxDeducWin({edittemp:"yes",paramstore:"1",parentId:this.id,id:this.id+"edittaxgrid",region:"east",width:"33%",bodyStyle:"padding:15px;background-color:white"});this.deductionentryform1=new Wtf.DeducEntryForm({edittemp:"yes",id:this.id+"editdeducgrid",paramstore:"1",parentId:this.id,region:"center",bodyStyle:"padding:15px;background-color:white"});this.TemplateViewForm=new Wtf.Panel({region:"north",border:false,layout:"column",scope:this,style:"height:12%",bodyStyle:"margin-left:1%;margin-top:2%",items:[this.PayAreaForm12,this.PayAreaForm13,this.PayAreaForm14,this.PayAreaForm15]});this.SecondPanel=new Wtf.Panel({layout:"border",region:"center",border:false,scope:this,style:"height:88%",items:[this.wageentryform1,this.deductionentryform1,this.taxentryform1]});this.MainDataEntryPanelE=new Wtf.Panel({layout:"border",bodyStyle:"background:#FFFFFF",scope:this,border:false,autoScroll:true,items:[this.TemplateViewForm,this.SecondPanel],bbar:["->",{text:"Save",scope:this,id:"editTemp",disabled:true,iconCls:getButtonIconCls(Wtf.btype.submitbutton),minWidth:50,handler:function(){if(this.PayAreaForm12.form.isValid()&&this.PayAreaForm13.form.isValid()&&this.PayAreaForm14.form.isValid()&&this.PayAreaForm15.form.isValid()){var C=this.calcTotalAmountA(this.wageentryform1.grid.getStore(),"cash","rate",parseFloat(this.newLimitEnd.getValue()));var B=this.calcTotalAmountA(this.deductionentryform1.DeductionGridPanel.getStore(),"cash","rate",parseFloat(this.newLimitEnd.getValue()));var D=this.calcTotalAmountA(this.taxentryform1.grid.getStore(),"cash","rate",parseFloat(this.newLimitEnd.getValue()));Wtf.MessageBox.confirm("Confirm","Do you want to save selected component?",function(E){if(E=="yes"){this.saveTemplate()}else{return }},this)}else{calMsgBoxShow(5,0)}}}]});this.add(this.MainDataEntryPanelE);this.doLayout();this.on("activate",function(C,B){this.doLayout()});this.saveTemplate=function(){this.mywin=new Wtf.Window({height:150,width:340,ckf:this,scope:this,title:"Confirm",resizable:false,border:false,html:"<br/><center><font size=2px>Do you want to change the template permanently or temporary ?<br/><br><b>Note: This data cannot be retrieved later.<br/></b></font></center>",layout:"Column",items:[{columnWidth:0.5,border:false,bodyStyle:"padding-left:50%;",items:[{text:"Permanent",xtype:"button",scope:this,handler:function(){this.permanentortempSave(1);Wtf.destroy(this.mywin);this.groupStore.reload();this.mywin.hide()}}]},{columnWidth:0.5,border:false,bodyStyle:"padding-left:3%;",items:[{text:"Temporary",xtype:"button",scope:this,handler:function(){if(this.group==this.addgroupCombo.getValue()){this.permanentortempSave(2);Wtf.destroy(this.mywin);this.groupStore.reload();this.mywin.hide()}else{Wtf.Msg.show({msg:"Edited template can't proceed towards saving as You can't change group for Temporary Template.",scope:this,title:"Message",width:260,buttons:Wtf.Msg.OK,animEl:"elId",fn:function(B,C){if(B=="ok"){Wtf.destroy(this.mywin);this.mywin.hide();this.addgroupCombo.focus(true)}}})}}}]}]});this.mywin.show()};this.permanentortempSave=function(B){if(this.PayAreaForm12.getComponent(0).getRawValue().trim().length>0&&this.PayAreaForm13.getComponent(0).getRawValue().trim().length>0&&this.PayAreaForm14.getComponent(0).getRawValue().trim().length>0&&this.PayAreaForm15.getComponent(0).getRawValue().trim().length>0){if(this.wageentryform1.grid.getStore().getCount()-1>0){if(parseFloat(this.PayAreaForm13.getComponent(0).getRawValue())<=parseFloat(this.PayAreaForm14.getComponent(0).getRawValue())){this.frmdta="{TName:'"+this.PayAreaForm12.getComponent(0).getRawValue().trim()+"',";this.frmdta+="RStart:'"+this.PayAreaForm13.getComponent(0).getRawValue()+"',";this.frmdta+="GId:'"+this.addgroupCombo.getValue()+"',";this.frmdta+="REnd:'"+this.PayAreaForm14.getComponent(0).getRawValue()+"'}";this.saveTemplateData="{TaxDataADD:[";for(i=0;i<this.taxentryform1.grid.getStore().getCount()-1;i++){if(i>0){this.saveTemplateData+=","}this.saveTemplateData+="{TaxId:'"+this.taxentryform1.grid.getStore().getAt(i).get("id")+"',TaxRate:'"+this.taxentryform1.grid.getStore().getAt(i).get("cash")+"'}"}this.saveTemplateData+="]}";this.saveTemplateData1="{WageDataADD:[";for(i=0;i<this.wageentryform1.grid.getStore().getCount()-1;i++){if(i>0){this.saveTemplateData1+=","}this.saveTemplateData1+="{WageId:'"+this.wageentryform1.grid.getStore().getAt(i).get("id")+"',WageRate:'"+this.wageentryform1.grid.getStore().getAt(i).get("cash")+"'}"}this.saveTemplateData1+="]}";this.saveTemplateData2="{DeducDataADD:[";for(i=0;i<this.deductionentryform1.DeductionGridPanel.getStore().getCount()-1;i++){if(i>0){this.saveTemplateData2+=","}this.saveTemplateData2+="{DeducId:'"+this.deductionentryform1.DeductionGridPanel.getStore().getAt(i).get("id")+"',DeducRate:'"+this.deductionentryform1.DeductionGridPanel.getStore().getAt(i).get("cash")+"'}"}this.saveTemplateData2+="]}";Wtf.Ajax.requestEx({url:"Payroll/Template/updateTemplateData.py",method:"post",params:{save:"true",saveType:"updatetemplatedata",formdata:this.frmdta,taxdata:this.saveTemplateData,wagedata:this.saveTemplateData1,deducdata:this.saveTemplateData2,tempid:this.templateid,torp:B,templatename:this.templatename}},this,function(D,C){msgFlag=0;if(D.value.toString()=="success"){calMsgBoxShow(1,0)}else{calMsgBoxShow(13,0)}},function(D,C){})}else{calMsgBoxShow(3,0)}}else{calMsgBoxShow(4,0)}}else{calMsgBoxShow(5,0)}};new Wtf.form.Hidden({id:"GlobalCompanyName1",value:"companyid",readOnly:true});if(this.deductionentryform1.storededuc.getCount()>0){this.deductionentryform1.storededuc.removeAll()}this.deductionentryform1.storededucforgrid.proxy.conn.url="Payroll/Deduction/getDeductionData.py";this.deductionentryform1.storededucforgrid.load({params:"type=TDeduction&cname=aa&TempId="+this.templateid});if(this.taxentryform1.storetax.getCount()>0){this.taxentryform1.storetax.removeAll()}this.taxentryform1.storetaxforgrid.proxy.conn.url="Payroll/Tax/getTaxData.py";this.taxentryform1.storetaxforgrid.load({params:"type=TTax&cname=aa&TempId="+this.templateid});if(this.wageentryform1.storewage.getCount()>0){this.wageentryform1.storewage.removeAll()}this.wageentryform1.storewageforgrid.proxy.conn.url="Payroll/Wage/getWagesData.py";this.wageentryform1.storewageforgrid.load({params:"type=TWages&cname=aa&TempId="+this.templateid});this.doLayout();if(!Wtf.StoreMgr.containsKey("desig")){Wtf.desigStore.load();Wtf.StoreMgr.add("desig",Wtf.desigStore);Wtf.desigStore.on("load",this.onloadfunc,this)}else{this.onloadfunc()}this.wageentryform1.grid.on("validateedit",function(B){Wtf.getCmp("editTemp").enable()},this);this.taxentryform1.grid.on("validateedit",function(B){Wtf.getCmp("editTemp").enable()},this);this.deductionentryform1.DeductionGridPanel.on("validateedit",function(B){Wtf.getCmp("editTemp").enable()},this);Wtf.getCmp("tempName"+this.id).on("change",function(B){Wtf.getCmp("editTemp").enable()},this)},onloadfunc:function(){this.k=0;for(this.k=0;this.k<Wtf.desigStore.getCount();this.k++){if(Wtf.desigStore.getAt(this.k).get("name")==this.group){new Wtf.form.Hidden({id:"GlobalGroupId1",value:Wtf.desigStore.getAt(this.k).get("id"),readOnly:true})}this.addgroupCombo.setValue(this.group)}},addDesignation:function(){WtfGlobal.showmasterWindow(1,Wtf.desigStore,"Add")},calcTotalAmount:function(A,F,E,D){var C=0;for(var B=0;B<A.length;B++){var H=A[B];var G=H.data[F]*1;if(H.data[E]=="1"){G=D/100*G}C+=G}return C},calcTotalAmountA:function(A,F,E,D){var C=0;for(var B=0;B<A.getCount();B++){var H=A.getAt(B);var G=H.data[F]*1;if(H.data[E]=="1"){G=D/100*G}C+=G}return C}});Wtf.AssignEmployeeFT=function(A){A.border=false;A.layout="border";A.monitorResize=true;A.coun=0;A.frame=false;A.autoScroll=true;A.tbar=[{text:"Assign Template",scope:this,minWidth:110,iconCls:getButtonIconCls(Wtf.btype.assignbutton),handler:function(){Wtf.Msg.show({title:"Warning",msg:"Would you like to save changes?",buttons:Wtf.Msg.YESNO,fn:function(B,C){if(B=="yes"){this.saveEdited()}},scope:this,animEl:"elId",icon:Wtf.MessageBox.QUESTION})}}];Wtf.AssignEmployeeFT.superclass.constructor.call(this,A)};Wtf.extend(Wtf.AssignEmployeeFT,Wtf.Panel,{initComponent:function(A){Wtf.AssignEmployeeFT.superclass.initComponent.call(this,A);this.emplistfields=[{name:"uname"},{name:"design"},{name:"salary"}];this.EmployeeListIndex=0;this.unassSelMod=new Wtf.grid.CheckboxSelectionModel({scope:this,singleSelect:false});this.unassColMod=new Wtf.grid.ColumnModel([this.unassSelMod,{header:"Employee Name",sortable:true,dataIndex:"empname",renderer:function(D,C,B){if(D!=null){if(B.get("status")=="2"){return('<div style="color:blue;" align="left">'+D+"</div>")}else{return('<div align="left">'+D+"</div>")}}}},{header:"Designation",sortable:true,dataIndex:"design",renderer:function(D,C,B){if(D!=null){if(B.get("status")=="2"){return('<div style="color:blue;" align="left">'+D+"</div>")}else{return('<div align="left">'+D+"</div>")}}}},{header:"Salary",sortable:true,dataIndex:"salary",renderer:function(D,C,B){if(D!=null){if(B.get("status")=="2"){return('<div style="color:blue;" align="left">'+WtfGlobal.currencyRenderer(D)+"</div>")}else{return('<div align="left">'+WtfGlobal.currencyRenderer(D)+"</div>")}}}}]);this.EmployeeListGrid=new Wtf.grid.GridPanel({autoScroll:true,frame:false,scope:this,border:true,store:this.gridStore=new Wtf.data.Store({url:Wtf.req.base+"PayrollHandler.jsp",method:"GET",scope:this,id:this.id+"gridStore",reader:new Wtf.data.KwlJsonReader({root:"data",totalProperty:"totalCount"},[{name:"empname"},{name:"design"},{name:"salary"},{name:"empid"},{name:"index"},{name:"status"},{name:"lname"}])}),forceFit:true,viewConfig:{forceFit:true},cm:this.unassColMod,sm:this.unassSelMod});this.EmployeeListGrid.on("beforerender",function(B){this.i=0;while(this.i<B.getStore().getCount()){this.recor=B.getStore().getAt(i);this.recor.beginEdit();this.recor.set("index",this.EmployeeListIndex);this.recor.endEdit();this.recor.commit();B.commitChanges();this.EmployeeListIndex++;this.i++}B.getStore().sort("index","ASC")});this.assSelModel=new Wtf.grid.CheckboxSelectionModel({scope:this,singleSelect:false,listeners:{scope:this,rowselect:function(D,C,B){this.a1=C;this.arr=this.EmployeeListGrid.getSelections();this.arr2=new Array();for(i=0;i<this.arr.length;i++){this.arr2.push(this.arr[i].get("empid"))}},rowdeselect:function(D,C,B){if(this.EmployeeListGrid.getSelections().length<1){this.arr2=null}}}});this.assColModel=new Wtf.grid.ColumnModel([this.assSelModel,{header:"Employee Name",sortable:true,dataIndex:"empname",renderer:function(D,C,B){if(D!=null){return('<div style="color:green;" align="left">'+D+"</div>")}}},{header:"Designation",sortable:true,dataIndex:"design",renderer:function(D,C,B){if(D!=null){return('<div style="color:green;" align="left">'+D+"</div>")}}},{header:"Salary",sortable:true,dataIndex:"salary",renderer:function(D,C,B){if(D!=null){return('<div style="color:green;" align="left">'+WtfGlobal.currencyRenderer(D)+"</div>")}}}]);this.AssignEmployeeListGrid=new Wtf.grid.GridPanel({autoScroll:true,frame:false,id:"AssignEmployeeListGrid",border:true,scope:this,store:this.gridStore1=new Wtf.data.Store({url:Wtf.req.base+"PayrollHandler.jsp",method:"GET",scope:this,reader:new Wtf.data.KwlJsonReader({root:"data",totalProperty:"totalCount"},[{name:"empname"},{name:"design"},{name:"salary"},{name:"empid"},{name:"index"},{name:"status"}])}),forceFit:true,viewConfig:{forceFit:true},cm:this.assColModel,sm:this.assSelModel});this.movetoright=document.createElement("img");this.movetoright.src="../../images/arrowright.gif";this.movetoright.style.width="24px";this.movetoright.style.height="24px";this.movetoright.style.margin="5px 0px 5px 0px";this.movetoright.onclick=this.insert_Item.createDelegate(this,[this.EmployeeListGrid,this.AssignEmployeeListGrid,1]);this.movetoleft=document.createElement("img");this.movetoleft.src="../../images/arrowleft.gif";this.movetoleft.style.width="24px";this.movetoleft.style.height="24px";this.movetoleft.style.margin="5px 0px 5px 0px";this.movetoleft.onclick=this.insert_Item.createDelegate(this,[this.AssignEmployeeListGrid,this.EmployeeListGrid,0]);this.centerdiv=document.createElement("div");this.centerdiv.appendChild(this.movetoright);this.centerdiv.appendChild(this.movetoleft);this.centerdiv.style.padding="165px 10px 165px 10px";this.transferbtnPanel=new Wtf.Panel({region:"center",border:false,frame:false,bodyStyle:"background:white",contentEl:this.centerdiv});this.EmployeeListIndex=0;this.AssignEmployeeListGrid.on("beforerender",function(B){this.i=0;while(this.i<B.getStore().getCount()){this.recor=B.getStore().getAt(i);this.recor.beginEdit();this.recor.set("index",this.EmployeeListIndex);this.recor.endEdit();this.recor.commit();B.commitChanges();this.EmployeeListIndex++;this.i++}B.getStore().sort("index","ASC")});this.SelectSubGridContainerPanel=new Wtf.Panel({layout:"fit"});this.SelectSubData=[["Newly Joined Trainee","12000-14000",5,3,2],["Trainee Level 1","15000-17000",5,2,2],["Trainee Level 2","17000-19000",5,1,3],["Experinced Trainee","20000-22000",6,5,5],["Half Time Trainee","2000-7000",3,2,9]];this.SelectSubStore=new Wtf.data.SimpleStore({fields:[{name:"PAGName"},{name:"GrossEarning"},{name:"TFTArea"},{name:"DFTArea"},{name:"NetEarning"}]});this.SelectSubStore.loadData(this.SelectSubData);this.sm=new Wtf.grid.CheckboxSelectionModel({singleSelect:true,listeners:{scope:this,selectRow:function(D,C,B){}}});this.firstgridpanel=new Wtf.Panel({layout:"fit",style:"background:#FFFFFF",border:false,scope:this,region:"west",width:"48%",items:[this.EmployeeListGrid]});this.secondgridpanel=new Wtf.Panel({layout:"fit",style:"background:#FFFFFF",border:false,scope:this,region:"east",width:"48%",items:[this.AssignEmployeeListGrid]});this.colorcodepan=new Wtf.Panel({border:false,region:"north",width:200,layout:"column",height:30,bodyStyle:"background-color:white",items:[{xtype:"panel",border:false,columnWidth:0.5,bodyStyle:"margin-left:20%;margin-top:1.5%",html:"<div style='height:14px;width:14px;background-color:blue;float:left'></div>&nbsp; :Employee assigned to other template"},{xtype:"panel",border:false,bodyStyle:"margin-left:20%;margin-top:1.5%",columnWidth:0.5,html:"<div style='height:14px;width:14px;background-color:green;float:left'></div>&nbsp; :Employee assigned to current template"}]});this.AssignmainPanel=new Wtf.Panel({layout:"border",style:"background:#FFFFFF",border:false,frame:false,region:"center",id:"mainPanelAssigned",scope:this,items:[this.firstgridpanel,this.transferbtnPanel,this.secondgridpanel]});this.add(this.colorcodepan,this.AssignmainPanel);this.on("activate",function(C,B){this.doLayout()});this.gridStore.removeAll();this.gridStore.load({scope:this,params:"type=Users&cname=aa&Gname="+this.Gname+"&tid="+this.TempId});this.gridStore1.removeAll();this.gridStore1.load({scope:this,params:"type=AUsers&cname=aa&Tid="+this.TempId})},insert_Item:function(C,B,A){this.recSize=C.getSelectionModel().getSelections().length;for(i=0;i<this.recSize;i++){if(C.getStore().indexOf(Rowselected=C.getSelectionModel().getSelected())!=-1){if(B.getStore().find("empid",Rowselected.get("empid"))==-1){this.EmpSal=parseFloat(Rowselected.get("salary"));this.Temprange=this.Srange;this.TSRange=0;this.TSRange=parseFloat(this.Srange.substring(0,this.Srange.indexOf("-")));this.TERange=0;this.TERange=parseFloat(this.Srange.substring(this.Srange.indexOf("-")+1,this.Srange.length));if(this.EmpSal>=this.TSRange&&this.EmpSal<this.TERange){if(Rowselected.get("status")=="2"&&A==1){Wtf.Msg.show({title:"Warning",msg:"Employee assigned to some other group,\nWould you like to reassign this employee?",scope:this,icon:Wtf.MessageBox.QUESTION,buttons:Wtf.Msg.YESNO,animEl:"elId",fn:function(D){if(D=="yes"){B.getStore().add(Rowselected);B.getStore().commitChanges();C.getStore().remove(Rowselected);C.getStore().commitChanges()}}})}else{B.getStore().add(Rowselected);B.getStore().commitChanges();C.getStore().remove(Rowselected);C.getStore().commitChanges()}}else{calMsgBoxShow(12,0);C.getSelectionModel().deselectRow(C.getStore().indexOf(C.getSelectionModel().getSelected()));this.recSize=C.getSelectionModel().getSelections().length;i=0}}else{C.getStore().remove(Rowselected);C.getStore().commitChanges()}}}},saveEdited:function(){if(this.gridStore1.getCount()>0){this.arr2=null;this.arr2=new Array();for(i=0;i<this.gridStore1.getCount();i++){this.arr2.push(this.gridStore1.getAt(i).get("empid"))}calMsgBoxShow(200,4,true);Wtf.Ajax.requestEx({url:Wtf.req.base+"PayrollHandler.jsp",method:"post",params:{empidarr:this.arr2,save:"true",saveType:"AssignTemp",tid:this.TempId,TempName:this.TempName}},this,function(B,A){this.gridStore.removeAll();this.gridStore.reload();calMsgBoxShow(11,0);this.gridStore1.removeAll();this.gridStore1.reload();this.groupstore.reload()},function(B,A){})}else{Wtf.Msg.show({msg:"Would you like to unassign all the employees?",width:260,scope:this,buttons:Wtf.Msg.YESNO,animEl:"elId",fn:function(A){if(A=="yes"){Wtf.Ajax.requestEx({url:Wtf.req.base+"PayrollHandler.jsp",method:"post",params:{save:"true",saveType:"AssignTemp",tid:this.TempId}},this,function(C,B){calMsgBoxShow(11,0);this.gridStore.removeAll();this.gridStore.reload();this.gridStore1.removeAll();this.gridStore1.reload()},function(C,B){})}}})}}});Wtf.viewmypayslip=function(A){Wtf.viewmypayslip.superclass.constructor.call(this,A);A.title="viewmypayslip2"};Wtf.extend(Wtf.viewmypayslip,Wtf.Panel,{onRender:function(A){Wtf.viewmypayslip.superclass.onRender.call(this,A);this.maxUsers=0;this.costPerUser=0;this.count=0;this.usersRecMS=new Wtf.data.Record.create([{name:"EName"},{name:"Wage"},{name:"AccNo"},{name:"month"},{name:"Tax"},{name:"Deduc"},{name:"Salary"},{name:"FixedSal"},{name:"empid"},{name:"design"},{name:"tempid"},{name:"stdate",type:"date"},{name:"enddate",type:"date"},{name:"histid"}]);var B="";if(this.profile){B=this.userid}this.userstoreMS=new Wtf.data.Store({reader:new Wtf.data.KwlJsonReader({root:"data",totalProperty:"totalcount"},this.usersRecMS),baseParams:{type:"viewmypayslip",empid:B},url:Wtf.req.base+"PayrollHandler.jsp?"});calMsgBoxShow(202,4,true);this.userstoreMS.load({scope:this,params:{start:0,limit:15}});this.userstoreMS.on("load",function(){if(msgFlag==1){WtfGlobal.closeProgressbar()}},this);this.selectionModel=new Wtf.grid.CheckboxSelectionModel();this.rowNo=new Wtf.grid.RowNumberer();this.selectionModel=new Wtf.grid.CheckboxSelectionModel();this.gridcmodel=new Wtf.grid.ColumnModel([this.selectionModel,this.rowNo,{header:"Month",dataIndex:"month",sortable:true,groupable:true},{header:"Start date",dataIndex:"stdate",align:"center",renderer:WtfGlobal.dateonlyRenderer,sortable:true,groupable:true},{header:"End date",dataIndex:"enddate",align:"center",renderer:WtfGlobal.dateonlyRenderer,sortable:true,groupable:true},{header:"Earnings",dataIndex:"Wage",sortable:true,align:"right",groupable:true,renderer:function(D){if(D!=null){return('<div align="right" style="font-family:Lucida Sans Unicode;">'+WtfGlobal.currencyRenderer(parseFloat(D).toFixed(2))+"</div>")}}},{header:"Deductions",dataIndex:"Deduc",sortable:true,align:"right",groupable:true,renderer:function(D){if(D!=null){return('<div align="right" style="font-family:Lucida Sans Unicode;">'+WtfGlobal.currencyRenderer(parseFloat(D).toFixed(2))+"</div>")}}},{header:"Taxes",dataIndex:"Tax",sortable:true,align:"right",groupable:true,renderer:function(D){if(D!=null){return('<div align="right" style="font-family:Lucida Sans Unicode;">'+WtfGlobal.currencyRenderer(parseFloat(D).toFixed(2))+"</div>")}}},{header:"Net Pay",dataIndex:"Salary",scope:this,sortable:true,align:"right",groupable:true,renderer:function(D){if(D!=null){return'<div align="right" style="font-family:Lucida Sans Unicode;">'+WtfGlobal.currencyRenderer(parseFloat(D).toFixed(2))+"</div>"}}}],this);var C=[];C.push("-",new Wtf.Toolbar.Button({text:"Reset",scope:this,iconCls:"pwndRefresh",handler:function(){this.userstoreMS.load({params:{start:0,limit:this.salusergridMS.pag.pageSize}});Wtf.getCmp("Quick"+this.salusergridMS.id).setValue("")}}));if(!this.profile){C.push("-",new Wtf.Toolbar.Button({text:"Salary Details",tooltip:"Click on a row and generate salary details mentioning earning, deduction and tax details.",scope:this,minWidth:100,disabled:true,iconCls:getButtonIconCls(Wtf.btype.reportbutton),handler:function(){var E=this.salusergridMS.getSelectionModel().getSelections();var D=E[0].get("stdate").format("F");if(E.length>0){this.mainTabId=Wtf.getCmp("as");this.payslip=Wtf.getCmp(this.id+"payslipTab"+E[0].get("stdate"));if(this.payslip==null){this.payslip=new Wtf.EmpPayslip({layout:"fit",scope:this,closable:true,iconCls:getTabIconCls(Wtf.etype.hrmsreport),border:false,id:this.id+"payslipTab"+E[0].get("stdate"),TempId:this.TempId,title:"Salary Details of "+D,ename:this.ename,accno:this.accno,salary:this.salary,tax:this.tax,empid:this.empid,deduc:this.deduc,cursymbol:this.currency,fixedsal:this.fixedsal,design:this.design,flag:"employee",histid:this.histid,stdate:E[0].get("stdate"),enddate:E[0].get("enddate")});this.mainTabId.add(this.payslip)}this.mainTabId.setActiveTab(this.payslip);this.mainTabId.doLayout()}else{calMsgBoxShow(42,0)}}}))}C.push("-",new Wtf.Toolbar.Button({text:"Download Payslip",scope:this,disabled:true,iconCls:getButtonIconCls(Wtf.btype.downloadbutton),minWidth:110,tooltip:"Download the payslip in PDF format and view it as and when required.",handler:function(){var G=this.salusergridMS.getSelectionModel().getSelections();var F=G[0].get("stdate").format("m/d/Y");var E=G[0].get("enddate").format("m/d/Y");var D=G[0].get("EName")+"_"+G[0].get("stdate").format("FY")+"";this.exportReport(1,"pdf",D,G[0].get("empid"),companyName,F,E);this.empid=null;this.salusergridMS.getSelectionModel().clearSelections()}}));this.summary=new Wtf.ux.grid.GridSummary();this.salusergridMS=new Wtf.KwlGridPanel({enableColumnHide:false,trackMouseOver:true,stripeRows:true,border:false,loadMask:true,searchLabel:" ",searchLabelSeparator:" ",searchEmptyText:"Search by Month",searchField:"month",serverSideSearch:true,viewConfig:{forceFit:true,emptyText:WtfGlobal.emptyGridRenderer("No Payslip to download")},store:this.userstoreMS,displayInfo:true,cm:this.gridcmodel,region:"west",scope:this,width:400,id:"salusergridMS",sm:new Wtf.grid.CheckboxSelectionModel({singleSelect:true,scope:this,listeners:{scope:this,rowselect:function(F,E,D){this.ename=this.salusergridMS.getSelectionModel().getSelected().get("EName");this.accno=this.salusergridMS.getSelectionModel().getSelected().get("AccNo");this.salary=this.salusergridMS.getSelectionModel().getSelected().get("Wage");this.fixedsal=this.salusergridMS.getSelectionModel().getSelected().get("FixedSal");this.tax=this.salusergridMS.getSelectionModel().getSelected().get("Tax");this.deduc=this.salusergridMS.getSelectionModel().getSelected().get("Deduc");this.empid=this.salusergridMS.getSelectionModel().getSelected().get("empid");this.design=this.salusergridMS.getSelectionModel().getSelected().get("design");this.TempId=this.salusergridMS.getSelectionModel().getSelected().get("tempid");this.fromdateemp=this.salusergridMS.getSelectionModel().getSelected().get("stdate");this.todateemp=this.salusergridMS.getSelectionModel().getSelected().get("enddate");this.histid=this.salusergridMS.getSelectionModel().getSelected().get("histid")}}}),tbar:C});this.UsergridPanel2=new Wtf.Panel({border:false,autoLoad:false,paging:false,layout:"fit",items:[this.salusergridMS]});this.innerpanel2=new Wtf.Panel({layout:"fit",cls:"backcolor",border:false,items:[this.UsergridPanel2]});this.add(this.innerpanel2);this.salusergridMS.getSelectionModel().on("selectionchange",function(){if(this.profile){WtfGlobal.enableDisableBtnArr(C,this.salusergridMS,[3],[])}else{WtfGlobal.enableDisableBtnArr(C,this.salusergridMS,[3,5],[])}},this)},exportReport:function(J,I,A,E,H,G,D){var F="";var C='{"data": []}';if(J==1){C='{"data": ["No","From", "To", "Duration", "Reason", "Type Of Leave", "Paid", "LPW", "Employee Signature", "Approver Signature", "Balance"]}'}var B="../../exportLeavePdfServlet.jsp?&flag="+J+"&colHeader="+C+"&userIDs="+F+"&reportname="+A+"&exporttype="+I+"&empid="+E+"&cname="+H+"&stdate="+G+"&flagpdf=datewise&enddate="+D;setDldUrl(B)}});Wtf.AddIncometaxWin=function(config){Wtf.apply(this,config);config.resizable=false;Wtf.AddIncometaxWin.superclass.constructor.call(this,{buttons:[{text:"Save",scope:this,handler:function(){if(!this.AddEditForm.form.isValid()){return }else{Wtf.MessageBox.confirm("Save Data","Do you want to save the changes?",function(btn){if(btn!="yes"){this.close()}else{calMsgBoxShow(200,4,true);this.AddEditForm.getForm().submit({url:"Payroll/Tax/setNewIncometax.py",params:{save:true,saveType:"AddIncometax",catgryid:this.ctgrycombo.getValue()},method:"post",scope:this,success:function(a,req){req=eval("("+req.response.responseText+")");if(req.data.value=="exist"){calMsgBoxShow(135,0)}if(req.data.value=="success"){Wtf.getCmp("incometaxwin").close();calMsgBoxShow(136,0);this.incometaxstore.load({params:{type:"GetTaxperCatgry",categoryid:this.ctgrycombo.getValue(),start:0,limit:this.gridp.pag.pageSize}})}},failure:function(req,res){}})}},this)}}},{text:"Cancel",handler:function(){this.close()},scope:this}]})};Wtf.extend(Wtf.AddIncometaxWin,Wtf.Window,{initComponent:function(){Wtf.AddIncometaxWin.superclass.initComponent.call(this);this.GetNorthPanel();this.GetAddEditForm();this.mainPanel=new Wtf.Panel({layout:"border",border:false,items:[this.northPanel,this.AddEditForm]});this.add(this.mainPanel)},GetNorthPanel:function(){var C="Add Income Tax";var A="Fill up the information to add income tax";var B=this.typeimage;this.northPanel=new Wtf.Panel({region:"north",height:90,border:false,bodyStyle:"backgroubodyStylend-color:white;padding:8px;border-bottom:1px solid #bfbfbf;background-color: white",html:getTopHtml(C,A,B)})},GetAddEditForm:function(){this.percent=[["Percent","%"],["Amount","$"]];this.percentstore=new Wtf.data.SimpleStore({fields:[{name:"type"},{name:"code"}],data:this.percent});this.taxrateinamount=new Wtf.Panel({width:400,frame:false,border:false,layout:"column",items:[{columnWidth:0.52,frame:false,border:false,layout:"form",items:[{xtype:"numberfield",fieldLabel:"Income slab",allowBlank:false,maxLength:10,editable:false,name:"rangefrom",width:100,labelWidth:100}]},{columnWidth:0.48,frame:false,border:false,items:[this.myrate=new Wtf.form.NumberField({width:95,maxLength:10,name:"rangeto"})]}]});this.ctgrycombo=new Wtf.form.FnComboBox({fieldLabel:"Category*",store:Wtf.catgStore,id:"catgorycombo3",displayField:"name",typeAhead:true,valueField:"id",name:"categoryname",allowBlank:false,width:200,labelWidth:200,mode:"local",triggerAction:"all",emptyText:"Select Category",selectOnFocus:true,addNewFn:this.addCategory.createDelegate(this),listeners:{scope:this,Select:function(C,A,B){this.categoryid=A.get("id")}}});if(!Wtf.StoreMgr.containsKey("catg")){Wtf.catgStore.on("load",this.setCategary,this);Wtf.catgStore.load();Wtf.StoreMgr.add("catg",Wtf.catgStore)}else{this.setCategary()}this.AddEditForm=new Wtf.form.FormPanel({region:"center",border:false,scope:this,defaults:{xtype:"numberfield",width:200,allowBlank:false},bodyStyle:"background-color:#f1f1f1;padding:15px",items:[this.ctgrycombo,{fieldLabel:"Rate*",scope:this,name:"rate",regex:/^(100(?:\.0{1,2})?|0*?\.\d{1,2}|\d{1,2}(?:\.\d{1,2})?)$/},{fieldLabel:"Salary(min)*",name:"rangefrom",id:"incometaxmin",displayField:"cname",regex:/^\d{0,10}$/},{labelWidth:100,fieldLabel:"Salary(max)*",name:"rangeto",scope:this,vtype:"range",regex:/^\d{0,10}$/,initialPassField:"incometaxmin"}]})},addCategory:function(){WtfGlobal.showmasterWindow(14,Wtf.catgStore,"Add")},setCategary:function(){if(Wtf.catgStore.getCount()>0){this.ctgrycombo.setValue(Wtf.catgStore.getAt(Wtf.catgStore.getCount()-1).get("id"))}}});Wtf.PayCompoSetting=function(A){A.autoScroll="true";A.layout="fit";Wtf.PayCompoSetting.superclass.constructor.call(this,A)};Wtf.extend(Wtf.PayCompoSetting,Wtf.Panel,{initComponent:function(A){Wtf.PayCompoSetting.superclass.initComponent.call(this,A);this.cm=new Wtf.grid.ColumnModel([new Wtf.grid.CheckboxSelectionModel(),new Wtf.grid.RowNumberer(),{header:"Code ID",dataIndex:"code",sortable:true},{header:"Type",dataIndex:"type",sortable:true},{header:"Added as Default",dataIndex:"isdefault",sortable:true,renderer:function(D,C,B){if(D){return("Yes")}else{return("No")}}},{header:'<div align="right">Rate In (%)</div>',dataIndex:"rate",sortable:true,renderer:function(D,C,B){if(D==1){return('<div align="right">'+parseFloat(B.get("cash")).toFixed(2)+" %</div>")}else{return('<div align="right">-</div>')}}},{header:'<div align="right">Amount In ('+WtfGlobal.getCurrencySymbol()+")</div>",dataIndex:"cash",sortable:true,renderer:function(D,C,B){if(B.get("rate")==0){return('<div align="right" style="font-family:Lucida Sans Unicode;">'+WtfGlobal.currencyRenderer(parseFloat(D).toFixed(2))+"</div>")}else{return('<div align="right">-</div>')}}},{header:"Percent of",dataIndex:"computeon",align:"center",sortable:true,renderer:this.rendererfun.createDelegate(this)}]);this.usersRecT=new Wtf.data.Record.create([{name:"type"},{name:"cash"},{name:"rate"},{name:"code"},{name:"id"},{name:"isdefault"},{name:"rangefrom"},{name:"rangeto"},{name:"category"},{name:"depwage"},{name:"depwageid"},{name:"computeon"},{name:"expr"},{name:"comp"}]);this.userdsT=new Wtf.data.Store({scope:this,reader:new Wtf.data.KwlJsonReader({root:"data",totalProperty:"totalcount"},this.usersRecT),baseParams:{tablename:"Wagemaster",type:"getPayComponent",allflag:"false"},url:"Payroll/Wage/getWageMaster.py"});this.userdsT.load({params:{start:0,limit:15,grouper:"payrollcomp"}});this.userdsT.on("load",function(){if(this.payrollcombo.getValue()=="Wage"){this.userdsT.filter("comp","wage")}else{if(this.payrollcombo.getValue()=="Deduction"){this.userdsT.filter("comp","deduc")}else{if(this.payrollcombo.getValue()=="Employer Contribution"){this.userdsT.filter("comp","empcontrib")}}}if(this.userdsT.getCount()==0){this.generaltaxgrid.getView().emptyText=WtfGlobal.emptyGridRenderer("<a class='grid-link-text' href='#' onClick='javascript:addcompo(\""+this.id+"\")'>Get started by adding a payroll components now...</a>");this.generaltaxgrid.getView().refresh()}},this);this.combodata=[["Wage","Wagemaster"],["Tax","Taxmaster"],["Deduction","Deductionmaster"],["Employer Contribution","EmpContribmaster"]];this.combostore1=new Wtf.data.SimpleStore({fields:[{name:"type"},{name:"table"}],data:this.combodata});this.type="Wage";this.tablename="Wagemaster";this.payrollcombo=new Wtf.form.ComboBox({store:this.combostore1,width:200,displayField:"type",forceSelection:true,typeAhead:true,valueField:"table",scope:this,mode:"local",triggerAction:"all",emptyText:"Select component",selectOnFocus:true,listeners:{scope:this,select:function(D,B,C){this.userdsT.removeAll();this.tablename=B.get("table");this.type=B.get("type");if(this.tablename=="Wagemaster"){this.userdsT.proxy.conn.url="Payroll/Wage/getWageMaster.py"}else{if(this.tablename=="Taxmaster"){this.userdsT.proxy.conn.url="Payroll/Tax/getTaxMaster.py"}else{if(this.tablename=="Deductionmaster"){this.userdsT.proxy.conn.url="Payroll/Deduction/getDeductionMaster.py"}else{if(this.tablename=="EmpContribmaster"){this.userdsT.proxy.conn.url="Payroll/EmpContrib/getEmpContribMaster.py"}}}}this.userdsT.load({params:{start:0,limit:this.generaltaxgrid.pag.pageSize}});var E=Wtf.getCmp("paysettingmainPanel");if(this.type=="Tax"){this.incometaxgrid.show();E.doLayout();Wtf.getCmp("as").doLayout()}else{this.incometaxgrid.hide();E.doLayout()}}}});this.payrollcombo.setValue("Wage");this.tablename="Wagemaster";this.generaltaxgrid=new Wtf.KwlGridPanel({enableColumnHide:false,trackMouseOver:true,stripeRows:true,region:"center",height:350,loadMask:true,displayInfo:true,searchLabel:" ",searchLabelSeparator:" ",searchEmptyText:"Search by Type",searchField:"type",serverSideSearch:true,viewConfig:{forceFit:true},store:this.userdsT,cm:this.cm,border:false,sm:new Wtf.grid.RowSelectionModel({singleSelect:true}),tbar:["-",new Wtf.Toolbar.Button({text:"Reset",scope:this,iconCls:"pwndRefresh",handler:function(){this.userdsT.load({params:{start:0,limit:this.generaltaxgrid.pag.pageSize}});Wtf.getCmp("Quick"+this.generaltaxgrid.id).setValue("")}}),"-","Select Component :",this.payrollcombo,"-",{text:"Add New",scope:this,tooltip:"Add new payroll component settings and save them for future use.",minWidth:60,iconCls:getButtonIconCls(Wtf.btype.addbutton),handler:this.addcomponent},"-",this.editcomponent=new Wtf.Button({text:"Edit",scope:this,tooltip:"Carry out changes in the name, code, unit or value of the component.",minWidth:60,iconCls:getButtonIconCls(Wtf.btype.editbutton),handler:function(){if(this.generaltaxgrid.getSelectionModel().hasSelection()==false){calMsgBoxShow(42,0)}else{var B=this.generaltaxgrid.getSelectionModel().getSelected();this.wageDeduWinEdit=new Wtf.analysisWindow({layout:"fit",modal:true,title:"Edit Component",closable:true,id:"addWTDwindow",closeAction:"close",width:500,typeimage:"../../images/payroll.gif",height:450,payrollcombo:this.payrollcombo,iconCls:getButtonIconCls(Wtf.btype.winicon),scope:this,editWageId:B.data["id"],AddEdit:"Edit",generaltaxgrid:this.generaltaxgrid,type:this.type,userdsT:this.userdsT,incometaxgrid:this.incometaxgrid,tablename:this.tablename});this.wageDeduWinEdit.on("show",function(){this.wageDeduWinEdit.text1.focus(true,100)},this);this.wageDeduWinEdit.show()}}}),"-",this.deladdwtdform=new Wtf.Button({text:"Delete",scope:this,tooltip:"Delete the component which is not required anymore.",minWidth:70,iconCls:getButtonIconCls(Wtf.btype.deletebutton),handler:function(){if(!this.generaltaxgrid.getSelectionModel().hasSelection()){calMsgBoxShow(42,0)}else{var B=this.generaltaxgrid.getSelectionModel().getSelected();for(var C=0;C<this.userdsT.data.length;C++){if(this.userdsT.getAt(C).data.depwageid==B.data["id"]){calMsgBoxShow(207,2);return }}Wtf.MessageBox.show({title:"Confirm",msg:deleteMsgBox("component"),buttons:Wtf.MessageBox.YESNO,icon:Wtf.MessageBox.QUESTION,scope:this,fn:function(E){if(E=="yes"){var G=this.generaltaxgrid.getSelectionModel().getSelected();var F=this.userdsT.indexOf(G);this.generaltaxgrid.getSelectionModel().clearSelections();WtfGlobal.highLightRow(this.generaltaxgrid,"FF0000",5,F);calMsgBoxShow(201,4,true);var D;if(this.type=="Deduction"){D="Payroll/Deduction/deleteMasterDeduc.py"}else{if(this.type=="Wage"){D="Payroll/Wage/deleteMasterWage.py"}else{if(this.type=="Employer Contribution"){D="Payroll/EmpContrib/deleteMasterEmpContrib.py"}else{D="Payroll/Tax/deleteMasterTax.py"}}}Wtf.Ajax.requestEx({url:D,method:"post",params:{dele:"true",delType:this.type,typeid:G.data["id"]}},this,function(I){var H=I.value.toString();if(H=="success"){calMsgBoxShow(9,0);var J={start:0,limit:this.generaltaxgrid.pag.pageSize};WtfGlobal.delaytasks(this.userdsT,J);this.generaltaxgrid.doLayout()}else{if(H=="assign"){calMsgBoxShow(10,0)}else{if(H=="depend"){calMsgBoxShow(226,0)}}}},function(H){this.userdsT.reload();this.generaltaxgrid.doLayout();calMsgBoxShow(27,2)})}}})}}}),"-",{text:"Define CPF Rules",scope:this,hidden:true,tooltip:"Add new payroll component settings and save them for future use.",minWidth:60,iconCls:getButtonIconCls(Wtf.btype.addbutton),handler:this.CPFRules}]});this.cm1=new Wtf.grid.ColumnModel([new Wtf.grid.CheckboxSelectionModel(),new Wtf.grid.RowNumberer(),{header:"Category",dataIndex:"category",sortable:true},{header:'<div align="right">Rate In (%)</div>',dataIndex:"rate",sortable:true,renderer:function(B){if(B!=null){return('<div align="right">'+parseFloat(B).toFixed(2)+"</div>")}}},{header:'<div align="right">Salary (min)</div>',dataIndex:"rangefrom",sortable:true,renderer:function(B){if(B!=null){return('<div align="right" style="font-family:Lucida Sans Unicode;">'+WtfGlobal.currencyRenderer(parseFloat(B).toFixed(2))+"</div>")}}},{header:'<div align="right">Salary (max)</div>',dataIndex:"rangeto",sortable:true,renderer:function(B){if(B!=null){return('<div align="right" style="font-family:Lucida Sans Unicode;">'+WtfGlobal.currencyRenderer(parseFloat(B).toFixed(2))+"</div>")}}}]);this.incomeRec=new Wtf.data.Record.create([{name:"rate"},{name:"category"},{name:"rangefrom"},{name:"rangeto"},{name:"id"}]);this.incometaxstore=new Wtf.data.Store({scope:this,reader:new Wtf.data.KwlJsonReader({root:"data",totalProperty:"totalcount"},this.incomeRec),url:"Payroll/Tax/GetTaxperCatgry.py"});this.catgrec=new Wtf.data.Record.create([{name:"id"},{name:"name"}]);this.catgStore=new Wtf.data.Store({url:"Common/getMasterDataField.common",baseParams:{configid:14,flag:203,common:"1"},reader:new Wtf.data.KwlJsonReader1({root:"data"},this.catgrec),autoLoad:false});this.catgStore.load();this.catgStore.on("load",function(){if(this.catgStore.getCount()>0){var B=new this.catgrec({id:"0",name:"All"});var C=this.catgStore.getCount();this.catgStore.insert(C,B);this.ctgrycombo1.setValue(this.catgStore.getAt(C).get("id"));this.incometaxstore.baseParams={type:"GetTaxperCatgry",categoryid:this.ctgrycombo1.getValue()};this.incometaxstore.load({params:{start:0,limit:15}})}},this);this.ctgrycombo1=new Wtf.form.FnComboBox({fieldLabel:"Category",store:this.catgStore,id:"catgorycombo2",displayField:"name",typeAhead:true,valueField:"id",name:"categoryname",allowBlank:false,width:200,labelWidth:200,mode:"local",triggerAction:"all",emptyText:"Select Category",selectOnFocus:true,addNewFn:this.addCategory.createDelegate(this),listeners:{scope:this,Select:function(D,B,C){this.categoryid=B.get("id");this.incometaxstore.removeAll();this.incometaxstore.baseParams={type:"GetTaxperCatgry",categoryid:this.ctgrycombo1.getValue()};this.incometaxstore.load({params:{start:0,limit:this.incometaxgrid.pag.pageSize}})}}});this.incometaxgrid=new Wtf.KwlGridPanel({enableColumnHide:false,trackMouseOver:true,stripeRows:true,id:"incometaxgridpanel",region:"south",height:250,loadMask:true,displayInfo:true,searchLabel:" ",searchLabelSeparator:" ",searchEmptyText:"Search by Rate",searchField:"rate",viewConfig:{forceFit:true,emptyText:WtfGlobal.emptyGridRenderer("No income tax added till now")},store:this.incometaxstore,cm:this.cm1,border:true,sm:new Wtf.grid.RowSelectionModel({singleSelect:true}),tbar:["-","Select Category:",this.ctgrycombo1,"-",{text:"Add New Income Tax",scope:this,minWidth:70,iconCls:getButtonIconCls(Wtf.btype.addbutton),handler:function(){this.usertask=new Wtf.AddIncometaxWin({layout:"fit",modal:true,title:"Add Component",configid:"configid",parentid:"parentid",closable:true,id:"incometaxwin",width:500,typeimage:"../../images/tax.gif",height:450,incometaxstore:this.incometaxstore,ctgrycombo1:this.ctgrycombo1,iconCls:"WinIcon",gridp:this.incometaxgrid});this.usertask.show()}},"-",this.delincometax=new Wtf.Button({text:"Delete",scope:this,minWidth:60,iconCls:getButtonIconCls(Wtf.btype.deletebutton),handler:function(){if(!this.incometaxgrid.getSelectionModel().hasSelection()){calMsgBoxShow(42,0)}else{Wtf.MessageBox.show({title:"Confirm",msg:deleteMsgBox("record"),buttons:Wtf.MessageBox.YESNO,icon:Wtf.MessageBox.QUESTION,scope:this,fn:function(B){if(B=="yes"){calMsgBoxShow(201,4,true);Wtf.Ajax.requestEx({url:"Payroll/Tax/deleteincomeTax.py",method:"post",params:{dele:"true",delType:"IncomeTax",typeid:this.incometaxgrid.getSelectionModel().getSelected().get("id")}},this,function(C){var D=C.value;if(D=="success"){calMsgBoxShow(9,0);this.incometaxstore.baseParams={type:"GetTaxperCatgry",categoryid:this.ctgrycombo1.getValue()};this.incometaxstore.load({params:{start:0,limit:this.incometaxgrid.pag.pageSize}})}else{if(D=="assign"){calMsgBoxShow(10,0)}}},function(C){this.incometaxstore.reload()})}}})}}})]});this.paysettingmainPanel=new Wtf.Panel({style:"background:#FFFFFF",border:false,autoScroll:true,id:"paysettingmainPanel",scope:this,layout:"border",items:[this.generaltaxgrid,this.incometaxgrid]});this.incometaxgrid.hide();this.add(this.paysettingmainPanel);this.doLayout();this.on("activate",function(C,B){this.doLayout()})},addcomponent:function(){var A=new Wtf.analysisWindow({layout:"fit",modal:true,title:"Add Component",configid:"configid",parentid:"parentid",closable:true,id:"addWTDwindow",closeAction:"close",width:500,typeimage:"../../images/payroll.gif",height:450,payrollcombo:this.payrollcombo,iconCls:getButtonIconCls(Wtf.btype.winicon),scope:this,userdsT:this.userdsT,incometaxgrid:this.incometaxgrid,type:this.type,AddEdit:"Add",generaltaxgrid:this.generaltaxgrid,tablename:this.tablename});A.on("show",function(){A.text1.focus(true,100)},this);A.show()},addCategory:function(){WtfGlobal.showmasterWindow(14,this.catgStore,"Add")},CPFRules:function(){var B=Wtf.getCmp("as");var A=Wtf.getCmp("CPFSetting");if(A==null){A=new Wtf.CPFSetting({layout:"fit",title:"<div wtf:qtip='Settings related to payroll components - CPF. '>CPF Rules</div>",closable:true,border:false,iconCls:getTabIconCls(Wtf.etype.master),id:"CPFSetting"});B.add(A)}B.setActiveTab(A);B.doLayout()},rendererfun:function(G,B,A,F,D,C,E){if(A.get("rate")==0){return"-"}if(G=="0"){return"Current Deductions"}else{if(G=="1"){return"Current Earnings"}else{if(G=="2"){return"Net Salary"}else{if(G=="3"){return"Specified formula"}}}}}});function addcompo(A){Wtf.getCmp(A).addcomponent()}Wtf.CPFSetting=function(A){A.autoScroll="true";A.layout="fit";Wtf.CPFSetting.superclass.constructor.call(this,A)};Wtf.extend(Wtf.CPFSetting,Wtf.Panel,{initComponent:function(A){this.fixedAmt="";Wtf.CPFSetting.superclass.initComponent.call(this,A)},onRender:function(A){Wtf.CPFSetting.superclass.onRender.call(this,A);this.gridfields=[{name:"Country"},{name:"Fixamount"},{name:"percentofsalary"},{name:"AgeRange"},{name:"SalRange"}];this.cmGroupGrid=new Wtf.grid.ColumnModel([new Wtf.grid.RowNumberer(),{id:"country",header:"Nationality",sortable:true,dataIndex:"Country"},{header:"Amount",sortable:true,dataIndex:"Fixamount"},{header:"Percentage Of Salary",sortable:true,align:"right"},{header:"Age Range",sortable:true,align:"right",dataIndex:"AgeRange"},{header:"Salary Range",sortable:true,align:"right",dataIndex:"SalRange",renderer:function(E){var D=WtfGlobal.getCurrencySymbol();var B=new Array(2);B=E.split("-");var C=D+" "+WtfGlobal.currencyRenderer2(B[0])+" - "+D+" "+WtfGlobal.currencyRenderer2(B[1]);if(E!=null){return('<div class="currency" style="font-family:Lucida Sans Unicode;">'+C+"</div>")}}}]);this.reader=new Wtf.data.KwlJsonReader({root:"data",totalProperty:"totalcount"},this.gridfields);this.child1=[];this.bchild=[];this.mchild=[];this.achild=[];this.conContainer=document.createElement("div");this.conContainer.className="conContainer";this.conContainer.id="parentCon";this.child1[this.i]=document.createElement("div");this.child1[this.i].className="child1";this.conContainer.appendChild(this.child1[this.i]);this.sm=new Wtf.grid.CheckboxSelectionModel();this.sm.on("rowselect",this.onRowSelect,this);this.sm.on("rowdeselect",this.onRowDeselect,this);this.cm=new Wtf.grid.ColumnModel([this.sm,{header:"Component",dataIndex:"cmptname",width:300},{header:"Value",dataIndex:"cmptvalue",align:"right",renderer:WtfGlobal.numericRenderer,editor:new Wtf.form.NumberField({allowBlank:false,allowDecimals:false,allowNegative:false,maxValue:100,minValue:1,validator:WtfGlobal.noBlankCheck})}]);this.selectedRec=new Wtf.data.Record.create([{name:"cmptname"},{name:"cmptvalue"},{name:"cmptprintvalue"}]);this.data1={"data":[{cmptname:"Fixed Amount",cmptvalue:"0",cmptprintvalue:"$"},{cmptname:"Percent of Salary",cmptvalue:"0",cmptprintvalue:"% of Salary"},{cmptname:"Percent of ( Diff. between Salary and Fixed Amount )",cmptvalue:"0",cmptprintvalue:"% of Diff. between Salary and $"}]};this.componentds=new Wtf.data.Store({reader:new Wtf.data.JsonReader({root:"data"},this.selectedRec)});this.groupGridStore=new Wtf.data.Store({reader:new Wtf.data.JsonReader({root:"data"},this.selectedRec)});this.componentds.loadData(this.data1);this.form=new Wtf.form.FormPanel({url:Wtf.req.tmjsp+"travelManager.jsp?flag=5",waitMsgTarget:true,method:"POST",autoScroll:true,scope:this,frame:false,fileUpload:true,border:false,style:"padding-top:10px;padding-bottom:0px;",bodyStyle:"margin-left:20px;margin-right:20px;",items:[{border:false,id:"formattach",layout:"column",autoWidth:true,bodyStyle:"padding:0px;font-size:11px;margin-top:1px;",items:[{border:false,columnWidth:0.2,layout:"form",items:[{xtype:"fieldset",title:"Nationality",scope:this,height:70,anchor:"93%",items:[{border:false,layout:"form",items:[this.ExpenseCmb=new Wtf.form.ComboBox({hideLabel:true,store:Wtf.countryStore,mode:"local",border:false,editable:true,readOnly:true,typeAhead:true,forceSelection:true,hiddenName:"expensetypeid",valueField:"id",allowBlank:false,width:150,anchor:"93%",displayField:"name",triggerAction:"all",emptyText:"Select Country",scope:this})]}]}]},{border:false,columnWidth:0.38,bodyStyle:"margin-left:10px;padding-right:10px;",layout:"form",items:[{xtype:"fieldset",title:"Age Range",scope:this,height:70,bodyStyle:"padding-left:30px;",items:[{border:false,layout:"column",items:[{xtype:"panel",columnWidth:0.45,border:false,layout:"form",items:[this.startrange=new Wtf.form.NumberField({allowBlank:false,hideLabel:true,allowNegative:false,value:0,maxLength:10,scope:this})]},{xtype:"panel",columnWidth:0.45,border:false,layout:"form",items:[this.endrange=new Wtf.form.NumberField({allowBlank:false,maxLength:10,hideLabel:true,value:0,allowNegative:false,scope:this,initialPassField:this.id+"salarystartrange"})]}]}]}]},{border:false,columnWidth:0.38,bodyStyle:"padding-left:10px;",layout:"form",items:[{xtype:"fieldset",title:' Salary Range/Month (<span align="right" style="font-family:Lucida Sans Unicode;">'+WtfGlobal.getCurrencySymbol()+"</span>)",scope:this,height:70,bodyStyle:"padding-left:30px;",items:[{border:false,layout:"column",items:[{xtype:"panel",columnWidth:0.45,border:false,layout:"form",items:[this.startrange=new Wtf.form.NumberField({allowBlank:false,hideLabel:true,allowNegative:false,value:0,maxLength:10,scope:this})]},{xtype:"panel",columnWidth:0.45,border:false,layout:"form",items:[this.endrange=new Wtf.form.NumberField({allowBlank:false,maxLength:10,hideLabel:true,value:0,allowNegative:false,scope:this,initialPassField:this.id+"salarystartrange"})]}]}]}]}]},{border:false,layout:"column",items:[{border:false,bodyStyle:"padding-right:10px;",layout:"form",columnWidth:0.48,items:[{xtype:"fieldset",title:"Components",scope:this,height:150,items:[{border:false,layout:"fit",items:[this.grid=new Wtf.grid.EditorGridPanel({id:"rulegrid",width:400,height:80,store:this.componentds,clicksToEdit:1,cm:this.cm,sm:this.sm,viewConfig:{forceFit:true}})]},{xtype:"panel",border:false,html:'<div style="color:SeaGreen;font-size:11px;padding-left:25px;">* Select the components to generate the CPF rules</div>'}]}]},{border:false,bodyStyle:"padding-left:10px;",layout:"form",columnWidth:0.48,items:[{xtype:"fieldset",title:"Generated Rule",scope:this,height:150,items:[new Wtf.Panel({id:"addCon",border:false,contentEl:this.conContainer})]}]}]}]});this.grid1=new Wtf.grid.GridPanel({border:false,layout:"fit",clicksToEdit:1,store:this.groupGridStore,height:350,frame:false,autoScroll:true,cm:this.cmGroupGrid,viewConfig:{forceFit:true}});this.cpfFormGridPanel=new Wtf.Panel({layout:"border",border:true,frame:false,bodyStyle:"background:rgb(241,241,241);",items:[{region:"north",height:300,border:true,layout:"fit",frame:false,split:true,autoScroll:true,style:"padding:3px 25px 3px 25px;background:rgb(241,241,241);",items:[this.form],bbar:[this.submitBtn=new Wtf.Button({anchor:"90%",iconCls:"pwnd showSaveAsDraftIcon",text:"Submit",handler:this.addToGrid,scope:this})]},{region:"center",border:true,frame:false,layout:"fit",autoScroll:true,title:"Predefined Rules",style:"padding:0px 25px 0px 25px;background:rgb(241,241,241);",items:[this.grid1]}]});this.cpfFormGridPanelRender=new Wtf.Panel({layout:"fit",border:false,frame:false,bodyStyle:"background:rgb(241,241,241);",items:this.cpfFormGridPanel});if(!Wtf.StoreMgr.containsKey("country")){Wtf.countryStore.load();Wtf.StoreMgr.add("country",Wtf.countryStore)}this.grid1.doLayout();this.cpfFormGridPanel.doLayout();this.add(this.cpfFormGridPanelRender)},openNewRoleWindow:function(A,C,B){this.roleNameField=new Wtf.form.NumberField({fieldLabel:"Enter Fixed Amount to calculate difference ($)*",allowBlank:false,allowDecimals:false,allowNegative:false,maxValue:100,minValue:1,validator:WtfGlobal.noBlankCheck});this.groupForm=new Wtf.FormPanel({labelWidth:300,labelAlign:"left",border:false,bodyStyle:"padding:15px 5px 0",layout:"form",anchor:"95%",defaultType:"textfield",buttonAlign:"right",items:[this.roleNameField]});this.win=new Wtf.Window({iconCls:getButtonIconCls(Wtf.btype.winicon),title:"Role",height:120,width:500,id:"roleWin",modal:true,resizable:false,scope:this,items:[this.groupForm],buttonAlign:"right",buttons:[{text:"Save",scope:this,handler:function(){if(!this.roleNameField.isValid()){return }this.fixedAmt=this.roleNameField.getValue();Wtf.getCmp("roleWin").close();this.onRowSelectFun(A,C,B)}},{text:"Cancel",handler:function(){Wtf.getCmp("roleWin").close()}}]});this.win.show()},onRowSelect:function(A,C,B){if(C==2){this.openNewRoleWindow(A,C,B)}else{this.onRowSelectFun(A,C,B)}},onRowSelectFun:function(A,C,B){this.child1[C]=document.createElement("div");this.child1[C].id="con"+C;this.mchild[C]=document.createElement("div");this.mchild[C].className="mchild";this.mchild[C].style.cssFloat="left";this.mchild[C].val=B.get("id");this.mchild[C].id="mchild"+C;this.bchild[C]=document.createElement("div");this.bchild[C].id="addsub"+C;this.bchild[C].className="x-form-item";this.bchild[C].style.cssFloat="left";if(this.oper!=null&&this.oper!=undefined&&this.oper.length>0){if(this.oper[C]=="+"){this.bchild[C].val="add"}else{if(this.oper[C]=="-"){this.bchild[C].val="sub"}else{this.bchild[C].val="add";this.oper[C]="+"}}this.bchild[C].innerHTML="&nbsp;<a href=javascript:void(0)>("+this.oper[C]+")</a>&nbsp;"}else{this.bchild[C].val="add";this.bchild[C].innerHTML="&nbsp;<a href=javascript:void(0)>(+)</a>&nbsp;"}if(C==2){this.mchild[C].innerHTML=B.get("cmptvalue")+" "+B.get("cmptprintvalue")+" "+this.fixedAmt}else{this.mchild[C].innerHTML=B.get("cmptvalue")+" "+B.get("cmptprintvalue")}this.mchild[C].className="x-form-item";this.bchild[C].onclick=this.showRuleWin.createDelegate(this);this.child1[C].appendChild(this.bchild[C]);this.child1[C].appendChild(this.mchild[C]);this.conContainer.appendChild(this.child1[C])},onRowDeselect:function(A,C,B){document.getElementById("parentCon").removeChild(document.getElementById("con"+C));this.mchild.splice(C,1);this.bchild.splice(C,1)},showRuleWin:function(C){this.updateelement=C.currentTarget;var B=new Wtf.Panel({frame:true,items:[{layout:"form",items:[{layout:"column",items:[{html:"Apply Rule If:<br><br>"}]},{layout:"column",fieldWidth:0,items:[new Wtf.form.Radio({name:"cond",id:"add",checked:(this.updateelement.val=="add")?true:false,boxLabel:"Addition"})]},{layout:"column",fieldWidth:0,items:[new Wtf.form.Radio({name:"cond",id:"sub",checked:(this.updateelement.val=="sub")?true:false,boxLabel:"Subtration"})]}]},{layout:"column",items:[{layout:"form",buttons:[{text:"OK",scope:this,handler:function(){if(Wtf.getCmp("add").checked==true){this.rad=0}else{if(Wtf.getCmp("sub").checked==true){this.rad=1}}if(this.rad==1){this.updateelement.innerHTML="&nbsp;<a href=javascript:void(0)>(-)</a>&nbsp;";this.updateelement.val="sub"}else{this.updateelement.innerHTML="&nbsp;<a href=javascript:void(0)>(+)</a>&nbsp;";this.updateelement.val="add"}A.close()}},{text:"Cancel",handler:function(){A.close()}}]}]}]});Wtf.getCmp("add").on("check",this.invRadiobttn,this);Wtf.getCmp("sub").on("check",this.invRadiobttn,this);var A=new Wtf.Window({title:"And/Or",closable:true,width:200,iconCls:"winicon",resizable:false,autoDestroy:true,modal:true,border:false,id:"conditionWindow",items:[B]});A.show()},getCalculationDetailTemplate:function(A){var D=['<div style="color: DarkSlateGray;">','<table style="margin:7px">',"<tr><td>{percentamt}% of the employee's total wages for the month and</td></tr>","<tr><td>{curr}{fixamt} and</td></tr>","<tr><td>{mixpercent}% of the difference between the employee's total wages for the month and {curr}{minusamt}</td></tr>","</table>","</div>"];var C=new Wtf.Template(D);var B={percentamt:this.percent.getValue(),curr:WtfGlobal.getCurrencySymbol(),fixamt:this.fixamt.getValue(),mixpercent:this.mixpercent.getValue(),minusamt:this.minusamt.getValue()};C.overwrite(this.calculationTemplatePanel.body,B)}});Wtf.configRecruitment=function(A){Wtf.form.Field.prototype.msgTarget="qtip",Wtf.apply(this,A);this.typeStore=new Wtf.data.SimpleStore({fields:["id","name"],data:[[0,"Text Field"],[2,"Date Field"],[3,"Dropdown"],[4,"Text Area"],[5,"File Upload"],[6,"Number Field"],[7,"Email Field"]]});this.typeStore1=new Wtf.data.SimpleStore({fields:["id","name"],data:[["Personal","Personal Information"],["Contact","Contact Information"],["Academic","Academic Information"],["Work","Work Experience"],["other","Other Details"]]});this.groupingView=new Wtf.grid.GroupingView({forceFit:true,showGroupName:false,hideGroupedColumn:true,enableGroupingMenu:false});this.reader=new Wtf.data.KwlJsonReader1({root:"data",totalProperty:"count"},[{name:"configid"},{name:"configtype"},{name:"formtype"},{name:"fieldname",type:"string"},{name:"allownull"},{name:"position"},{name:"issystemproperty"},{name:"visible"},{name:"allownull"}]);this.ds=new Wtf.data.GroupingStore({url:"Rec/Job/getConfigRecruitment.rec",reader:this.reader});this.ds.baseParams={flag:212};this.sm=new Wtf.grid.CheckboxSelectionModel();this.cm=new Wtf.grid.ColumnModel([new Wtf.grid.RowNumberer({}),this.sm,{header:"Config Type",dataIndex:"configtype",width:150,renderer:function(B){if(B==0){return"Text Field"}else{if(B==1){return"Check Box"}else{if(B==2){return"Date Field"}else{if(B==3){return"Drop Down"}else{if(B==4){return"Text Area"}else{if(B==5){return"File Upload"}else{if(B==6){return"Number Field"}else{if(B==7){return"Email Field"}}}}}}}}}},{header:"Fieldname",dataIndex:"fieldname",sortable:true,width:150},{header:"Form Type",dataIndex:"formtype",width:150},{header:"Position",dataIndex:"position",width:150}]);this.cm.defaultSortable=true;this.cloneRecord=Wtf.data.Record.create([{name:"name",type:"string"},{name:"displayname",type:"string"},{name:"configid",type:"string"}]);this.cloneReader=new Wtf.data.KwlJsonReader1({root:"data"},this.cloneRecord);this.cloneStore=new Wtf.data.Store({proxy:new Wtf.data.HttpProxy({url:Wtf.req.base+"hrms.jsp"}),reader:this.cloneReader});this.addC=new Wtf.Toolbar.Button({text:"Add Config",scope:this,iconCls:getButtonIconCls(Wtf.btype.addbutton),handler:function(){this.addConfig(true)},scope:this});this.editC=new Wtf.Toolbar.Button({text:"Edit Config",scope:this,iconCls:getButtonIconCls(Wtf.btype.editbutton),disabled:true,handler:function(){this.addConfig(false)}});this.up=new Wtf.Toolbar.Button({text:"Up",scope:this,disabled:true,iconCls:getButtonIconCls(Wtf.btype.upbutton),handler:function(){this.updown(true)}});this.down=new Wtf.Toolbar.Button({text:"Down",scope:this,disabled:true,iconCls:getButtonIconCls(Wtf.btype.downbutton),handler:function(){this.updown(false)}});this.delC=new Wtf.Toolbar.Button({text:"Delete Config",scope:this,disabled:true,iconCls:getButtonIconCls(Wtf.btype.deletebutton),handler:function(){this.delConfig(true)},scope:this});this.setM=new Wtf.Toolbar.Button({text:"Set Master",scope:this,iconCls:getButtonIconCls(Wtf.btype.setmasterbutton),handler:this.masterwin});this.cloneBttn=new Wtf.Toolbar.Button({text:"Clone Master",scope:this,handler:function(){this.addconfig1()}});Wtf.configRecruitment.superclass.constructor.call(this,{layout:"fit",items:[{layout:"fit",border:false,items:[this.grid=new Wtf.grid.GridPanel({border:false,region:"center",store:this.ds,sm:this.sm,cm:this.cm,viewConfig:{autoFill:true,forceFit:true},loadMask:{msg:"Loading..."},tbar:["Quick Search: ",this.quickPanelSearch1=new Wtf.KWLTagSearch({width:200,emptyText:"Search by Field name",field:"fieldname"})],bbar:["-",this.addC,this.editC,this.delC,this.up,this.down,this.setM]})]}]});this.ds.load();this.sm.on("selectionchange",this.disableBttns,this);this.ds.on("load",function(B){this.quickPanelSearch1.StorageChanged(B)},this)};Wtf.extend(Wtf.configRecruitment,Wtf.Panel,{addconfig1:function(){this.win1=new Wtf.Window({title:"Clone",layout:"fit",iconCls:"winicon",modal:true,height:355,width:450,scope:this,buttons:[{text:"Add",handler:function(){Wtf.Ajax.requestEx({method:"POST",url:"Rec/Job/addConfigRecruitmentType.rec",params:{flag:214,configid:"clone",formtype:this.qType1.getValue(),fieldname:this.quesField.getValue()}},this,function(){msgBoxShow(["Success","Config option added successfully."],Wtf.MessageBox.INFO);this.win1.close();this.ds.load();this.cloneStore.load({params:{flag:213}})},function(){msgBoxShow(["Error","Error connecting to server."],Wtf.MessageBox.ERROR)})},scope:this},{text:"Cancel",scope:this,handler:function(){this.win1.close()}}],items:[this.pPanel=new Wtf.Panel({layout:"fit",border:false,items:this.inP=new Wtf.Panel({layout:"border",border:false,items:[{region:"north",border:false,height:90,bodyStyle:"background:white;border-bottom:1px solid #bfbfbf;",html:getHeader("images/createuser.gif"," Config","Select a config type.")},{region:"center",layout:"fit",bodyStyle:"background:#f1f1f1;",border:false,items:[this.addForm=new Wtf.form.FormPanel({url:"jspfiles/admin/feedback.jsp",region:"center",bodyStyle:"padding: 10px;",border:false,labelWidth:160,height:100,buttonAlign:"right",items:[this.qType1=new Wtf.form.ComboBox({valueField:"id",displayField:"name",store:this.typeStore1,fieldLabel:"Apply to",editable:false,allowBlank:false,anchor:"95%",mode:"local",triggerAction:"all",selectOnFocus:true,emptyText:"Apply Config..."}),this.quesField=new Wtf.form.TextField({fieldLabel:"Fieldname",scope:this,allowBlank:false,name:"question",maxLength:256})]})]}]})})]});this.win1.show()},masterwin:function(){this.attributeRecord=Wtf.data.Record.create([{name:"displayname",type:"string"},{name:"configid",type:"string"}]);this.attributeReader=new Wtf.data.KwlJsonReader1({root:"data"},this.attributeRecord);this.attributeStore=new Wtf.data.Store({proxy:new Wtf.data.HttpProxy({url:"Rec/Job/getConfigRecruitment.rec"}),reader:this.attributeReader});this.attributeStore.load({params:{configtype:"3,1"}});this.attributeCombo=new Wtf.form.ComboBox({triggerAction:"all",store:this.attributeStore,mode:"local",width:240,forceSelection:true,typeAhead:true,displayField:"displayname",fieldLabel:"Attribute",hiddenName:"configid",allowBlank:false,valueField:"configid",emptyText:"Select an Attribute"});this.mastersm=new Wtf.grid.CheckboxSelectionModel();this.mastercm=new Wtf.grid.ColumnModel([new Wtf.grid.RowNumberer(),this.sm,{header:"Master Record",dataIndex:"masterdata",editor:new Wtf.form.TextField({allowBlank:false,maxLength:100,items:[{text:"Delete",tooltip:{title:"Delete",text:"Click to delete record"}}]})},{header:"Status",dataIndex:"status",renderer:function(F,C,A,E,D,B){if(F=="1"){return"Active"}else{return"Inactive"}},hidden:true}]);this.masterReader=new Wtf.data.Record.create([{name:"masterid"},{name:"masterdata"},{name:"status"}]);this.masterds=new Wtf.data.Store({url:"Rec/Job/getConfigMaster.rec",reader:new Wtf.data.KwlJsonReader1({root:"data"},this.masterReader)});this.addrec=new Wtf.Toolbar.Button({text:"Add",iconCls:getButtonIconCls(Wtf.btype.addbutton),disabled:true,tooltip:{title:"Add",text:"Click to add new record"},handler:function(){if(this.masterText.getValue()!=""){var B=false;for(var A=0;A<this.masterds.getCount();A++){if(this.masterds.getAt(A).get("masterdata")==this.masterText.getValue()){B=true;break}}if(!B){Wtf.Ajax.request({url:"Rec/Job/addConfigMaster.rec",method:"POST",params:{flag:215,configid:this.attributeCombo.getValue(),masterdata:this.masterText.getValue()},success:function(C,D){this.masterText.setValue("");this.masterds.reload();calMsgBoxShow(219,0)},scope:this})}else{calMsgBoxShow(["Warning","Master record '"+this.masterText.getValue()+"' already present."],2)}}else{calMsgBoxShow(218,2)}},scope:this});this.masterWin=new Wtf.Window({id:"master"+this.id,title:"Master Record",layout:"fit",iconCls:getButtonIconCls(Wtf.btype.winicon),modal:true,height:400,width:650,scope:this,items:[this.poppanel=new Wtf.Panel({id:"masterpanel"+this.id,layout:"fit",cls:"backcolor",border:false,tbar:[this.attributeCombo,"-","New Record: ",this.masterText=new Wtf.form.TextField({fieldLabel:"New Master Record",anchor:"95%",maxLength:60,id:this.id+"masterText"}),"-",this.addrec,"-",this.delmaster=new Wtf.Toolbar.Button({text:"Delete",disabled:true,iconCls:getButtonIconCls(Wtf.btype.deletebutton),tooltip:{title:"Delete",text:"Click to delete record"},handler:function(){this.delConfig(false)},scope:this})],items:[this.addmaster=new Wtf.Panel({id:"addmaster"+this.id,layout:"fit",border:false,items:[this.masterGrid=new Wtf.grid.EditorGridPanel({id:"mastergrid"+this.id,store:this.masterds,sm:this.mastersm,cm:this.mastercm,border:false,clicksToEdit:1,viewConfig:{forceFit:true}})]})]})]});this.mastersm.on("selectionchange",this.handleBttns,this);this.masterWin.show();this.attributeCombo.on("select",this.masterload,this);this.masterGrid.on("afteredit",this.roleAfterEdit,this);this.masterds.on("loadException",this.masteronload,this)},handleBttns:function(A){this.delmaster.disable();if(A.getCount()>0){this.delmaster.enable()}else{this.delmaster.disable()}},addConfig:function(A){this.win1=new Wtf.Window({title:"Config",iconCls:getButtonIconCls(Wtf.btype.winicon),layout:"fit",modal:true,height:355,width:450,scope:this,buttons:[{text:A?"Add":"Update",handler:function(){if(this.quesField.getValue().trim()!=""){Wtf.Ajax.requestEx({method:"POST",url:"Rec/Job/addConfigRecruitmentType.rec",params:{flag:214,configid:A?"config":this.sm.getSelected().get("configid"),formtype:this.qType1.getValue(),configtype:this.qType.getValue(),fieldname:this.quesField.getValue(),visible:this.visible.checked,issystemproperty:this.issystemproperty.checked,allownull:this.nullchk.checked}},this,function(B,C){if(B.success=="msg"){var E=B.title;var D=B.msg;msgBoxShow([E,D],Wtf.MessageBox.INFO)}else{msgBoxShow(["Success","Config option "+(A?"added":"edited")+" successfully."],Wtf.MessageBox.INFO)}this.win1.close();this.ds.load()},function(){msgBoxShow(["Error","Error connecting to server."],Wtf.MessageBox.ERROR)})}else{this.quesField.setValue("")}},scope:this},{text:"Cancel",scope:this,handler:function(){this.win1.close()}}],items:[this.pPanel=new Wtf.Panel({layout:"fit",border:false,items:this.inP=new Wtf.Panel({layout:"border",border:false,items:[{region:"north",border:false,height:90,bodyStyle:"background:white;border-bottom:1px solid #bfbfbf;",html:getHeader(A?"../../images/add-config.jpg":"../../images/edit-config.jpg"," Config","Select a config type.")},{region:"center",layout:"fit",bodyStyle:"background:#f1f1f1;",border:false,items:[this.addForm=new Wtf.form.FormPanel({url:"jspfiles/admin/feedback.jsp",region:"center",bodyStyle:"padding: 10px;",border:false,labelWidth:150,height:100,buttonAlign:"right",items:[this.qType=new Wtf.form.ComboBox({valueField:"id",displayField:"name",store:this.typeStore,fieldLabel:"Config Type",editable:false,value:A?null:(this.sm.getSelected().get("configtype")),allowBlank:false,anchor:"80%",mode:"local",triggerAction:"all",selectOnFocus:true,emptyText:"Select config type..."}),this.qType1=new Wtf.form.ComboBox({valueField:"id",displayField:"name",store:this.typeStore1,fieldLabel:"Apply to",editable:false,value:A?null:(this.sm.getSelected().get("formtype")),allowBlank:false,anchor:"80%",mode:"local",triggerAction:"all",selectOnFocus:true,emptyText:"Apply Config..."}),this.quesField=new Wtf.form.TextField({fieldLabel:"Fieldname",scope:this,allowBlank:false,name:"question",anchor:"80%",value:A?null:(this.sm.getSelected().get("fieldname")),maxLength:256}),this.issystemproperty=new Wtf.form.Checkbox({fieldLabel:"Systemproperty",checked:A?false:(this.sm.getSelected().get("issystemproperty")==1?true:false)}),this.visible=new Wtf.form.Checkbox({fieldLabel:"Visible",checked:A?false:(this.sm.getSelected().get("visible")==1?true:false)}),this.nullchk=new Wtf.form.Checkbox({fieldLabel:"Allow Null",checked:A?false:(this.sm.getSelected().get("allownull")==1?true:false)})]})]}]})})]});this.win1.show();this.qType.clearInvalid();this.qType1.clearInvalid();this.quesField.clearInvalid()},delConfig:function(A){Wtf.Msg.show({title:(A==true)?"Confirm":"Delete Master?",msg:"Selected data will be deleted! Do you want to continue?",buttons:Wtf.Msg.YESNO,fn:(A==true)?this.confirmDelete:this.deletemaster,scope:this,icon:Wtf.MessageBox.QUESTION})},deletemaster:function(D){if(D=="yes"){var C=[];var E=this.mastersm.getSelections();for(var A=0;A<this.mastersm.getSelections().length;A++){C.push(this.masterGrid.getSelections()[A].data["masterid"])}var B=Wtf.encode(C);Wtf.Ajax.requestEx({url:"Rec/Job/deleteConfigMaster.rec",params:{delid:B},method:"POST"},this,function(F,G){if(F.success!=null){if(F.success=="msg"){var I=F.title;var H=F.msg;calMsgBoxShow([I,H],Wtf.MessageBox.INFO)}else{calMsgBoxShow(["Success","Record deleted successfully."],Wtf.MessageBox.INFO)}}else{calMsgBoxShow(["Success","Record deleted successfully."],Wtf.MessageBox.INFO)}this.masterds.reload()},function(){calMsgBoxShow(["Error","Error connecting to server."],Wtf.MessageBox.ERROR)})}},confirmDelete:function(D){if(D=="yes"){var C=[];for(var A=0;A<this.sm.getSelections().length;A++){C.push(this.grid.getSelections()[A].data["configid"])}var B=Wtf.encode(C);Wtf.Ajax.requestEx({url:"Rec/Job/deleteConfigRecruitment.rec",params:{delid:B,mode:"config",flag:217},method:"POST"},this,function(E,F){this.ds.reload();if(E.success!=null){if(E.success=="msg"){var H=E.title;var G=E.msg;msgBoxShow([H,G],Wtf.MessageBox.INFO)}else{msgBoxShow(["Success","Config option deleted successfully."],Wtf.MessageBox.INFO)}}else{msgBoxShow(["Success","Config option deleted successfully."],Wtf.MessageBox.INFO)}},function(){msgBoxShow(["Error","Error connecting to server."],Wtf.MessageBox.ERROR)})}},updown:function(A){if(this.sm.getSelected().get("position")>1||(this.sm.getSelected().get("position")==1&&!A)){Wtf.Ajax.requestEx({url:"Rec/Job/updownConfigRecruitment.rec",params:{configid:this.sm.getSelected().get("configid"),position:this.sm.getSelected().get("position"),formtype:this.sm.getSelected().get("formtype"),positioninc:A?-1:1},method:"POST"},this,function(B,C){if(B.success!=null){if(B.success=="msg"){var E=B.title;var D=B.msg;msgBoxShow([E,D],Wtf.MessageBox.INFO)}}else{msgBoxShow(["Success","Config option position changed successfully."],Wtf.MessageBox.INFO)}this.ds.reload();this.up.disable();this.down.disable()},function(){msgBoxShow(["Error","Error connecting to server."],Wtf.MessageBox.ERROR)})}},disableBttns:function(A){if(A.getCount()>1){this.delC.enable();this.editC.disable();this.up.disable();this.down.disable()}else{if(A.getCount()==1){this.editC.enable();if(this.sm.getSelected().get("position")==1){this.up.disable()}else{this.up.enable()}if(this.sm.getSelected().get("issystemproperty")){this.delC.disable()}else{this.delC.enable()}this.down.enable()}else{this.delC.disable();this.editC.disable();this.down.disable();this.up.disable()}}},roleAfterEdit:function(C){var B=false;for(var A=0;A<this.masterds.getCount();A++){if(this.masterds.getAt(A).get("masterdata")==C.value&&!this.mastersm.isSelected(A)){B=true;break}}if(!B){Wtf.Ajax.requestEx({url:"Rec/Job/addConfigMaster.rec",method:"POST",params:{flag:215,masterid:C.record.data.masterid,configid:this.attributeCombo.getValue(),masterdata:C.value}},this,function(D,E){if(D.success!=null){if(D.success=="msg"){var G=D.title;var F=D.msg;this.masterds.commitChanges();this.masterds.reload()}}},function(){})}else{this.masterds.reload();calMsgBoxShow(["Warning","Master record '"+C.value+"' already present."],2);return }},masteronload:function(){this.masterds.removeAll()},masterload:function(){this.addrec.enable();if(this.attributeCombo.getValue()=="coursetrainmode"){this.mastercm.setHidden(3,false)}else{this.mastercm.setHidden(3,true)}this.masterds.load({params:{flag:216,configid:this.attributeCombo.getValue()}})},onRender:function(A){Wtf.configRecruitment.superclass.onRender.call(this,A)}});Wtf.importMenuArray=function(obj,moduleName,store,contactmapid,targetlistPagingLimit){var archArray=[];var importButton=new Wtf.Action({text:"Import CSV File",id:"importcsvfile"+obj.id,tooltip:{text:"Click to import CSV file."},iconCls:"pwnd importTabIcon",scope:obj,handler:function(){if(moduleName=="Lead"){obj.ImportLeads("csv")}else{if(moduleName=="Contact"){obj.ImportContacts("csv")}else{if(moduleName=="Target"){obj.ImportTargets("csv")}else{if(moduleName=="Target List"){obj.importCSVfile("TargetList")}else{if(moduleName=="Account"){obj.ImportAccounts("csv")}}}}}}});archArray.push(importButton);var importXLS=new Wtf.Action({text:"Import XLS File",tooltip:{text:"Click to import XLS file."},iconCls:"pwnd importTabIcon",scope:obj,handler:function(){this.form=new Wtf.form.FormPanel({url:"fileUploadXLS",fileUpload:true,autoHeight:true,border:false,bodyStyle:"background:#f1f1f1;font-size:10px;padding:11px 15px 0",autoWidth:true,defaultType:"textfield",items:[{fieldLabel:"File to Upload",inputType:"file",id:"browsexlsBttn"}]});this.win1=new Wtf.Window({resizable:false,scope:this,layout:"border",modal:true,width:420,height:185,iconCls:"pwnd favwinIcon",id:"importwindow",title:"Import XLS File",items:[{region:"north",height:70,border:false,bodyStyle:"background:white;border-bottom:1px solid #bfbfbf;",html:getTopHtml("Import XLS File","Import XLS File ","../../images/import.png")},{region:"center",layout:"fit",border:false,bodyStyle:"background:#f1f1f1;font-size:10px;",items:[this.form]}],buttons:[{text:"Upload",handler:function(){var parsedObject=document.getElementById("browsexlsBttn").value;var extension=parsedObject.substr(parsedObject.lastIndexOf(".")+1);var patt1=new RegExp("xls","i");if(patt1.test(extension)){this.form.getForm().submit({waitMsg:"Uploading File...",scope:this,success:function(f,a){this.win1.close();genUploadResponse(a.request,true,a.response,moduleName,store,contactmapid,targetlistPagingLimit,obj)},failure:function(f,a){this.win1.close();genUploadResponse(a.request,false,a.response,moduleName,store,contactmapid,targetlistPagingLimit,obj)}})}else{ResponseAlert(83)}},scope:this}]});this.win1.show()}});archArray.push(importXLS);if(moduleName!="Target List"&&moduleName!="Account"){var importGoogleContacts=new Wtf.Action({text:"Import "+moduleName+"s from Google Account",tooltip:{text:"Click to import "+moduleName+"s from Google Account."},iconCls:"pwnd importTabIcon",scope:obj,handler:function(){Wtf.commonAuthenticationWindow(obj,store,moduleName,contactmapid)}});archArray.push(importGoogleContacts)}return archArray;function genUploadResponse(req,succeed,res,moduleName,store,contactmapid,targetlistPagingLimit,obj){var msg="Failed to make connection with Web Server";var response=eval("("+res.responseText+")");if(succeed){succeed=response.lsuccess;if(succeed){this.win=new Wtf.SheetViewer1({title:"Available Sheets",iconCls:"pwnd favwinIcon",closable:true,autoScroll:true,width:600,height:600,plain:true,modal:true,id:"importxls",data:response,layout:"border",moduleName:moduleName,store:store,contactmapid:contactmapid,targetlistPagingLimit:targetlistPagingLimit,obj:obj});this.win.show()}else{msg=response.msg;Wtf.Msg.alert("File Upload",msg)}}}};Wtf.importMenuButtonA=function(A,D,C){var B=new Wtf.Toolbar.Button({iconCls:"pwnd importicon",tooltip:{text:"Click to import "+C+"s."},scope:D,text:"Import",menu:A});return B};Wtf.commonAuthenticationWindow=function(D,B,C,A){if(C=="Lead"){this.form1=new Wtf.form.FormPanel({border:false,items:[{fieldLabel:"Email Id",id:"authentication_username"+D.id,width:200,allowBlank:false,validator:WtfGlobal.noBlankCheck,msgTarget:"side",vtype:"email",xtype:"striptextfield"},password=new Wtf.form.TextField({fieldLabel:"Password",id:"authentication_password"+D.id,allowBlank:false,validator:WtfGlobal.noBlankCheck,msgTarget:"side",inputType:"password",width:200}),{fieldLabel:"Company",id:"authentication_company"+D.id,allowBlank:false,validator:WtfGlobal.noBlankCheck,msgTarget:"side",maxLength:250,width:200,xtype:"striptextfield"}]})}else{if(C=="Contact"){this.accStore=new Wtf.data.Store({url:Wtf.req.base+"crm.jsp?flag=5",reader:new Wtf.data.KwlJsonReader({root:"data"},Wtf.ComboReader),autoLoad:true});this.form1=new Wtf.form.FormPanel({border:false,items:[{fieldLabel:"Email Id",id:"authentication_username"+D.id,width:200,allowBlank:false,validator:WtfGlobal.noBlankCheck,msgTarget:"side",vtype:"email",xtype:"striptextfield"},password=new Wtf.form.TextField({fieldLabel:"Password",id:"authentication_password"+D.id,allowBlank:false,validator:WtfGlobal.noBlankCheck,msgTarget:"side",inputType:"password",width:200}),this.accCombo=new Wtf.form.ComboBox({fieldLabel:"Account",id:"authentication_account"+D.id,selectOnFocus:true,triggerAction:"all",mode:"local",store:this.accStore,displayField:"name",emptyText:"-- Please Select --",typeAhead:true,allowBlank:false,valueField:"id",msgTarget:"side",anchor:"100%",width:200})]})}else{this.form1=new Wtf.form.FormPanel({border:false,items:[{fieldLabel:"Email Id",id:"authentication_username"+D.id,width:200,allowBlank:false,msgTarget:"side",vtype:"email",xtype:"striptextfield"},password=new Wtf.form.TextField({fieldLabel:"Password",id:"authentication_password"+D.id,allowBlank:false,validator:WtfGlobal.noBlankCheck,msgTarget:"side",inputType:"password",width:200})]})}}this.selectAllAuthentication=new Wtf.form.Checkbox({boxLabel:"Import All",inputType:"radio",name:"rectype",checked:true,inputValue:"false",id:"selectAllAuthentication"+D.id,width:100});this.selectSomeAuthentication=new Wtf.form.Checkbox({boxLabel:"Select Some",width:100,inputType:"radio",id:"selectSomeAuthentication"+D.id,inputValue:"true",name:"rectype"});this.TypeFormAuthentication=new Wtf.form.FormPanel({autoScroll:true,border:false,labelWidth:100,style:"background: #f1f1f1;padding-left: 35px;padding-top: 0px;padding-right: 30px;",layout:"column",items:[{border:false,columnWidth:0.5,items:this.selectAllAuthentication},{border:false,columnWidth:0.5,items:this.selectSomeAuthentication}]});this.authwin=new Wtf.Window({height:C=="Target"?260:290,width:400,id:"authentication_window"+D.id,iconCls:"pwnd favwinIcon",title:"Authentication",modal:true,shadow:true,scope:this,resizable:false,buttonAlign:"right",buttons:[{text:"Submit",scope:this,handler:function(){var L=Wtf.getCmp("authentication_username"+D.id).getValue();var G=Wtf.getCmp("authentication_password"+D.id).getValue();var F=Wtf.getCmp("selectAllAuthentication"+D.id).getValue();var E="";var I="";if(L==""){WtfComMsgBox(1054,0);return }if(G==""){WtfComMsgBox(1055,0);return }if(C=="Lead"){E=Wtf.getCmp("authentication_company"+D.id).getValue();if(E==""){WtfComMsgBox(1052,0);return }}else{if(C=="Contact"){I=Wtf.getCmp("authentication_account"+D.id).getValue();if(I==""){WtfComMsgBox(1053,0);return }}}var K="";Wtf.commonWaitMsgBox("Fetching Google Contacts...");K+="{'username':'"+L+"',";K+="'password':'"+G+"'},";var J=K.length-1;var H=K.substr(0,J);Wtf.Ajax.requestEx({url:Wtf.req.base+"crm.jsp",params:{jsondata:H,importAll:F,account:I,company:E,moduleName:C,flag:800,mapid:A}},this,function(M){Wtf.updateProgress();if(M.importAll){this.authwin.close();B.load();ResponseAlert(353)}else{if(M.data!=undefined){this.authwin.close();var O=M.data;var N=Wtf.data.Record.create([{name:"firstName",mapping:0},{name:"lastName",mapping:1},{name:"email",mapping:2}]);this.listds=new Wtf.ux.data.JsonPagingStore({lastOptions:{params:{start:0,limit:20}},totalRecords:"records",successProperty:"success",reader:new Wtf.data.ArrayReader({},N),fields:[{name:"firstName"},{name:"lastName"},{name:"email"}]});this.listds.loadData(M.data);this.listds.load({params:{start:0,limit:20}});var P=new Wtf.grid.CheckboxSelectionModel({width:25});this.googleCM=new Wtf.grid.ColumnModel([new Wtf.grid.CheckboxSelectionModel,{header:"First Name",width:50,dataIndex:"firstName"},{header:"Last Name",width:50,dataIndex:"lastName"},{header:"Email Id",dataIndex:"email"}]);this.contactGrid=new Wtf.grid.GridPanel({id:"google_contact_grid"+D.id,store:this.listds,scope:this,cm:this.googleCM,sm:P,border:false,viewConfig:{forceFit:true},bbar:new Wtf.PagingToolbar({pageSize:20,store:this.listds,displayInfo:true,displayMsg:"Displaying messages {0} - {1} of {2}",emptyMsg:"No messages to display"})});this.gContactWin=new Wtf.Window({resizable:false,scope:this,layout:"border",modal:true,width:600,height:500,iconCls:"pwnd favwinIcon",id:"import_window_gContacts"+D.id,title:"Google Contacts",items:[{region:"north",height:70,border:false,id:"googleContacts_North_panel"+D.id,bodyStyle:"background:white;border-bottom:1px solid #bfbfbf;",html:getTopHtml("Google Contacts","Google Contact list of "+L,"../../images/leads.gif")},{region:"center",layout:"fit",items:[this.contactGrid]}],buttons:[{text:"Import",id:"importBttn_googleContact"+D.id,type:"submit",scope:this,handler:function(){var Q=this.contactGrid.getSelectionModel().getSelections();if(Q.length>0){Wtf.saveGoogleContact(Q,B,this.gContactWin,C,E,I,L,this.listds,A)}else{WtfComMsgBox(1051,0);return }}},{text:"Cancel",id:"canbttn_googleContact"+D.id,scope:this,handler:function(){this.gContactWin.close()}}]});this.gContactWin.show()}else{WtfComMsgBox(1050,0);Wtf.getCmp("authentication_username"+D.id).setValue("");Wtf.getCmp("authentication_password"+D.id).setValue("")}}},function(M){Wtf.updateProgress();ResponseAlert(352)})}},{text:"Cancel",scope:this,handler:function(){this.authwin.close()}}],layout:"border",items:[{region:"north",height:75,border:false,bodyStyle:"background:white;border-bottom:1px solid #bfbfbf;",html:getTopHtml("Authentication","Please provide your Google Account details. ","../../images/import.png")},{region:"center",border:false,bodyStyle:"background:#f1f1f1;font-size:10px;padding:20px 10px 10px 30px",layout:"fit",items:[this.form1]},{region:"south",height:40,border:false,bodyStyle:"background:white;border-bottom:1px solid #bfbfbf;",layout:"fit",items:this.TypeFormAuthentication}]});this.authwin.show();this.selectSomeAuthentication.on("check",function(){this.selectAllAuthentication=false},this);this.selectAllAuthentication.on("check",function(){this.selectSomeAuthentication=false},this)};Wtf.saveGoogleContact=function(M,L,D,B,I,H,G,A,K){var C="";for(var F=0;F<M.length;F++){C+="{'firstName':'"+M[F].data.firstName+"',";C+="'lastName':'"+M[F].data.lastName+"',";C+="'email':'"+M[F].data.email+"'},"}for(var E=0;E<M.length;E++){A.remove(M[E])}A.load({params:{start:0,limit:20}});var J=C.substring(0,(C.length-1));Wtf.commonWaitMsgBox("Importing Google Contacts...");Wtf.Ajax.requestEx({url:Wtf.req.base+"crm.jsp",params:{jsondata:J,flag:801,moduleName:B,company:I,account:H,username:G,mapid:K}},this,function(N){Wtf.updateProgress();if(N.success){ResponseAlert(351)}else{ResponseAlert(352)}Wtf.MessageBox.show({title:"Google Contacts",msg:M.length+" records imported successfully. Do you want to continue importing more records?",buttons:Wtf.MessageBox.YESNO,animEl:"mb9",scope:this,icon:Wtf.MessageBox.INFO,fn:function(O,P){if(O=="yes"){L.reload()}else{D.close();L.reload()}}})},function(){Wtf.updateProgress();ResponseAlert(352)})};Wtf.SheetViewer1=function(A){Wtf.SheetViewer1.superclass.constructor.call(this,A)};Wtf.extend(Wtf.SheetViewer1,Wtf.Window,{initComponent:function(A){Wtf.SheetViewer1.superclass.initComponent.call(this,A);this.addButton({text:"Next",disabled:true,id:"nextButton"+this.id},this.getCSVMappingInterface,this);this.addButton("Cancel",function(){this.close()},this)},onRender:function(E){Wtf.SheetViewer1.superclass.onRender.call(this,E);this.xlsfilename=this.data.file;for(var C=0;C<this.data.data.length;C++){this.data.data[C].srow="1"}var F=new Wtf.data.Record.create([{name:"name"},{name:"index"},{name:"srow"}]);var D=new Wtf.data.Store({reader:new Wtf.data.JsonReader({root:"data"},F),data:this.data});this.shgrid=new Wtf.grid.GridPanel({viewConfig:{forceFit:true},columns:[{header:"Sheet Name",dataIndex:"name"},{header:"Starting Row",dataIndex:"srow"}],store:D});this.shgrid.on("rowclick",this.showDetail,this);var B=new Wtf.data.Record.create([{name:"name"}]);var A=new Wtf.data.Store({reader:new Wtf.data.JsonReader({root:"fields"},B)});this.shdgrid=new Wtf.grid.GridPanel({columns:[],store:A});this.shdgrid.on("rowclick",this.updateStartRow,this);this.add({region:"north",height:80,border:false,bodyStyle:"background:white;border-bottom:1px solid #bfbfbf;",html:getTopHtml("Available Sheets","Step 1 : Select a sheet to see its sample data.<br/><br/> Step 2 : Click 'Next' button to import selected sheet.","../../images/import.png")});this.add({region:"center",layout:"fit",autoScroll:true,items:this.shgrid});this.add({region:"south",height:220,layout:"fit",autoScroll:true,items:this.shdgrid})},updateStartRow:function(B,A,C){var D=this.shgrid.getSelectionModel().getSelected();D.set("srow",A+1)},genUploadResponse12:function(req,succeed,res){var msg="Failed to make connection with Web Server";var response=eval("("+res.responseText+")");if(succeed){msg=response.msg;succeed=response.lsuccess;this.Header=response.Header;this.xlsParserResponse=response;if(succeed){this.cursheet=response.index;var cm=this.createColumnModel1(response.maxcol);var store=this.createStore1(response,cm);this.shdgrid.reconfigure(store,cm);var rowno=this.shgrid.getStore().getAt(this.shgrid.getStore().find("index",this.cursheet)).get("srow");if(rowno){this.shdgrid.getSelectionModel().selectRow(rowno-1)}}else{Wtf.Msg.alert("File Import",msg)}}this.shdgrid.enable()},createColumnModel1:function(E){var A=[new Wtf.grid.RowNumberer()];for(var C=1;C<=E;C++){var B=C;var D="";while(B>0){B--;D=String.fromCharCode(Math.floor(B%26)+"A".charCodeAt(0))+D;B=Math.floor(B/26)}A.push({header:D,dataIndex:D})}return new Wtf.grid.ColumnModel(A)},createStore1:function(E,C){var B=[];for(var A=0;A<C.getColumnCount();A++){B.push({name:C.getDataIndex(A)})}var F=new Wtf.data.Record.create(B);var D=new Wtf.data.Store({reader:new Wtf.data.JsonReader({root:"data"},F),data:E});return D},showDetail:function(B,A,C){Wtf.getCmp("nextButton"+this.id).enable();var D=this.shgrid.getStore().getAt(A);if(this.cursheet&&this.cursheet==D.get("index")){return }this.shdgrid.disable();Wtf.Ajax.request({method:"GET",url:"XLSDataExtractor",params:{filename:this.xlsfilename,index:D.get("index")},scope:this,success:function(E,F){this.genUploadResponse12(F,true,E)},failure:function(E,F){this.genUploadResponse12(F,false,E)}})},getCSVMappingInterface:function(B,A,C){var D=this.shgrid.getSelectionModel().getSelected();Wtf.getCmp("importxls").hide();this.mapCSV=new Wtf.csvMappingInterface({csvheaders:this.Header,modName:this.moduleName+"s",typeXLSFile:true,impWin1:Wtf.getCmp("importxls"),delimiterType:"",index:D.get("index"),moduleName:this.moduleName,store:this.store,contactmapid:this.contactmapid,targetlistPagingLimit:this.targetlistPagingLimit,scopeobj:this.obj,cm:this.obj.EditorColumnArray}).show();Wtf.getCmp("csvMappingInterface").on("importfn",this.importCSVfunc,this)},importCSVfunc:function(C,E,D,B,F,A,G){Wtf.saveXLS(this,C,E,D,B,F,A,G);this.on("importTargetListRecs",this.insertIntoGrid,this)},insertIntoGrid:function(C,B,A,D){if(C[0].TLID!==undefined){D.TLID=C[0].TLID}B.baseParams.listID=D.TLID;B.baseParams.start=0;B.baseParams.limit=A;B.load()}});Wtf.saveXLS=function(F,D,C,B,J,H,I,E){var G=B=="Target List"?("&tlid="+E.TLID):"";var A=B=="Target List"?"Target":B;Wtf.Ajax.timeout=900000;Wtf.Ajax.requestEx({url:"../../exportimportcontacts.jsp?type=submit&do=xlsImport&resjson="+D+"&mapid="+H+G,waitMsg:"importing...",scope:this,params:({filepath:F.xlsfilename,sheetindex:C,moduleName:B})},this,function(L,K){Wtf.MessageBox.show({title:"Success",msg:A+"s imported successfully",buttons:Wtf.MessageBox.OK,animEl:"mb9",icon:Wtf.MessageBox.INFO});if(L.data.importedRecords.data!=undefined){F.addEvents({"importTargetListRecs":true});F.fireEvent("importTargetListRecs",L.data.importedRecords.data,J,I,E)}J.load();Wtf.Ajax.timeout=30000},function(L,K){Wtf.MessageBox.show({title:"Error",msg:"Sorry! "+A+"s could not be imported. Please try again.",buttons:Wtf.MessageBox.OK,animEl:"mb9",icon:Wtf.MessageBox.ERROR});Wtf.Ajax.timeout=30000})};Wtf.ns("Wtf.ux.grid");Wtf.ux.grid.BufferView=Wtf.extend(Wtf.grid.GridView,{rowHeight:19,borderHeight:2,scrollDelay:100,cacheSize:20,cleanDelay:500,initTemplates:function(){Wtf.ux.grid.BufferView.superclass.initTemplates.call(this);var A=this.templates;A.rowHolder=new Wtf.Template('<div class="x-grid3-row {alt}" style="{tstyle}"></div>');A.rowHolder.disableFormats=true;A.rowHolder.compile();A.rowBody=new Wtf.Template('<table class="x-grid3-row-table" border="0" cellspacing="0" cellpadding="0" style="{tstyle}">',"<tbody><tr>{cells}</tr>",(this.enableRowBody?'<tr class="x-grid3-row-body-tr" style="{bodyStyle}"><td colspan="{cols}" class="x-grid3-body-cell" tabIndex="0" hidefocus="on"><div class="x-grid3-row-body">{body}</div></td></tr>':""),"</tbody></table>");A.rowBody.disableFormats=true;A.rowBody.compile()},getStyleRowHeight:function(){return Wtf.isBorderBox?(this.rowHeight+this.borderHeight):this.rowHeight},getCalculatedRowHeight:function(){return this.rowHeight+this.borderHeight},getVisibleRowCount:function(){var B=this.getCalculatedRowHeight();var A=this.scroller.dom.clientHeight;return(A<1)?0:Math.ceil(A/B)},getVisibleRows:function(){var A=this.getVisibleRowCount();var B=this.scroller.dom.scrollTop;var C=(B==0?0:Math.floor(B/this.getCalculatedRowHeight())-1);return{first:Math.max(C,0),last:Math.min(C+A+2,this.ds.getCount()-1)}},doRender:function(F,H,P,A,N,V,I){var B=this.templates,E=B.cell,G=B.row,S=B.rowBody,K=N-1;var O=this.getStyleRowHeight();var U=this.getVisibleRows();var C="width:"+this.getTotalWidth()+";height:"+O+"px;";var Y=[],R,Z,Q={},J={tstyle:C},M;for(var T=0,X=H.length;T<X;T++){M=H[T];R=[];var L=(T+A);var D=L>=U.first&&L<=U.last;if(D){for(var W=0;W<N;W++){Z=F[W];Q.id=Z.id;Q.css=W==0?"x-grid3-cell-first ":(W==K?"x-grid3-cell-last ":"");Q.attr=Q.cellAttr="";Q.value=Z.renderer(M.data[Z.name],Q,M,L,W,P);Q.style=Z.style;if(Q.value==undefined||Q.value===""){Q.value="&#160;"}if(M.dirty&&typeof M.modified[Z.name]!=="undefined"){Q.css+=" x-grid3-dirty-cell"}R[R.length]=E.apply(Q)}}var a=[];if(V&&((L+1)%2==0)){a[0]="x-grid3-row-alt"}if(M.dirty){a[1]=" x-grid3-dirty-row"}J.cols=N;if(this.getRowClass){a[2]=this.getRowClass(M,L,J,P)}J.alt=a.join(" ");J.cells=R.join("");Y[Y.length]=!D?B.rowHolder.apply(J):(I?S.apply(J):G.apply(J))}return Y.join("")},isRowRendered:function(A){var B=this.getRow(A);return B&&B.childNodes.length>0},syncScroll:function(){Wtf.ux.grid.BufferView.superclass.syncScroll.apply(this,arguments);this.update()},update:function(){if(this.scrollDelay){if(!this.renderTask){this.renderTask=new Wtf.util.DelayedTask(this.doUpdate,this)}this.renderTask.delay(this.scrollDelay)}else{this.doUpdate()}},doUpdate:function(){if(this.getVisibleRowCount()>0){var F=this.grid,B=F.colModel,G=F.store;var E=this.getColumnData();var A=this.getVisibleRows();for(var D=A.first;D<=A.last;D++){if(!this.isRowRendered(D)){var C=this.doRender(E,[G.getAt(D)],G,D,B.getColumnCount(),F.stripeRows,true);this.getRow(D).innerHTML=C}}this.clean()}},clean:function(){if(!this.cleanTask){this.cleanTask=new Wtf.util.DelayedTask(this.doClean,this)}this.cleanTask.delay(this.cleanDelay)},doClean:function(){if(this.getVisibleRowCount()>0){var B=this.getVisibleRows();B.first-=this.cacheSize;B.last+=this.cacheSize;var C=0,D=this.getRows();if(B.first<=0){C=B.last+1}for(var A=this.ds.getCount();C<A;C++){if((C<B.first||C>B.last)&&D[C].innerHTML){D[C].innerHTML=""}}}},layout:function(){Wtf.ux.grid.BufferView.superclass.layout.call(this);this.update()}});Wtf.ux.TextField=function(A){Wtf.apply(this,A);Wtf.ux.TextField.superclass.constructor.call(this)};Wtf.extend(Wtf.ux.TextField,Wtf.form.TextField,{initComponent:function(A){Wtf.ux.TextField.superclass.initComponent.call(this,A);this.on("change",this.mychange,this)},mychange:function(C,A){var B=Wtf.util.Format.stripTags(A).trim();C.setValue(B);return B}});Wtf.reg("striptextfield",Wtf.ux.TextField);Wtf.namespace("Wtf.ux");Wtf.namespace("Wtf.ux.Wiz");Wtf.namespace("Wtf.ux.layout");Wtf.ux.Wiz=Wtf.extend(Wtf.Panel,{loadMaskConfig:{"default":"Saving..."},cards:null,previousButtonText:"&lt;&lt; Previous",nextButtonText:"Next &gt;&gt;",cancelButtonText:"Cancel",finishButtonText:"Finish",headerConfig:{},cardPanelConfig:{},previousButton:null,nextButton:null,cancelButton:null,cardPanel:null,currentCard:-1,headPanel:null,cardCount:0,initComponent:function(){this.initButtons();this.initPanels();var A=this.title||this.headerConfig.title;A=A||"";Wtf.apply(this,{title:A,layout:"border",cardCount:this.cards.length,tbar:[this.previousButton,this.nextButton],items:[this.headPanel,this.cardPanel]});this.addEvents("cancel","finish","beforefinish","beforeNextcard");Wtf.ux.Wiz.superclass.initComponent.call(this)},getWizardData:function(){var D={};var C=this.cards;for(var B=0,A=C.length;B<A;B++){if(C[B].form){D[C[B].id]=C[B].form.getValues(false)}else{D[C[B].id]={}}}return D},switchDialogState:function(A,C){this.showLoadMask(!A,C);this.previousButton.setDisabled(!A);this.nextButton.setDisabled(!A);this.cancelButton.setDisabled(true);if(this.closable){var B=this.tools["close"];switch(A){case true:this.tools["close"].unmask();break;default:this.tools["close"].mask();break}}},showLoadMask:function(A,B){if(!B){B="default"}if(A){if(this.loadMask==null){this.loadMask=new Wtf.LoadMask(this.body)}this.loadMask.msg=this.loadMaskConfig["type"];this.loadMask.show()}else{if(this.loadMask){this.loadMask.hide()}}},initEvents:function(){Wtf.ux.Wiz.superclass.initEvents.call(this);var C=this.cards;for(var B=0,A=C.length;B<A;B++){C[B].on("show",this.onCardShow,this);C[B].on("hide",this.onCardHide,this);C[B].on("clientvalidation",this.onClientValidation,this)}},initPanels:function(){var B=this.cards;var A=this.cardPanelConfig;Wtf.apply(this.headerConfig,{steps:B.length});this.headPanel=new Wtf.ux.Wiz.Header(this.headerConfig);Wtf.apply(A,{layout:new Wtf.ux.layout.CardLayout(),items:B});Wtf.applyIf(A,{region:"center",border:false,activeItem:0});this.cardPanel=new Wtf.Panel(A)},initButtons:function(){this.previousButton=new Wtf.Button({text:this.previousButtonText,disabled:true,minWidth:75,handler:this.onPreviousClick,scope:this});this.nextButton=new Wtf.Button({text:this.nextButtonText,minWidth:75,handler:this.onNextClick,scope:this})},onClientValidation:function(A,B){if(!B){this.nextButton.setDisabled(true)}else{this.nextButton.setDisabled(false)}},onCardHide:function(A){if(this.cardPanel.layout.activeItem.id===A.id){this.nextButton.setDisabled(true)}},onCardShow:function(C){var E=C.ownerCt;var B=E.items;for(var D=0,A=B.length;D<A;D++){if(B.get(D).id==C.id){break}}this.currentCard=D;this.headPanel.updateStep(D,C.title);if(D==A-1){this.nextButton.setText(this.finishButtonText)}else{this.nextButton.setText(this.nextButtonText)}if(C.isValid()){this.nextButton.setDisabled(false)}if(D==0){this.previousButton.setDisabled(true)}else{this.previousButton.setDisabled(false)}},onCancelClick:function(){if(this.fireEvent("cancel",this)!==false){this.close()}},onFinish:function(){if(this.fireEvent("beforefinish",this,this.cards[this.currentCard])!==false){}},closePanel:function(){for(var A=0;A<this.cards.length;A++){this.cards[A].destroy();this.cards[A].ownerCt.remove(this.cards[A],true)}this.ownerCt.remove(this,true)},onPreviousClick:function(){if(this.currentCard>0){this.cardPanel.getLayout().setActiveItem(this.currentCard-1)}},onNextClick:function(){if(this.fireEvent("beforeNextcard",this,this.currentCard)){if(this.currentCard==this.cardCount-1){this.onFinish()}else{this.cardPanel.getLayout().setActiveItem(this.currentCard+1)}}}});Wtf.ux.Wiz.Header=Wtf.extend(Wtf.BoxComponent,{height:55,region:"north",title:"Wizard",steps:0,stepText:"Step {0} of {1}: {2}",autoEl:{tag:"div",cls:"wtf-ux-wiz-Header",children:[{tag:"div",cls:"wtf-ux-wiz-Header-title"},{tag:"div",children:[{tag:"div",cls:"wtf-ux-wiz-Header-step"},{tag:"div",cls:"wtf-ux-wiz-Header-stepIndicator-container"}]}]},titleEl:null,stepEl:null,imageContainer:null,indicators:null,stepTemplate:null,lastActiveStep:-1,updateStep:function(B,C){var A=this.stepTemplate.apply({0:B+1,1:this.steps,2:C});this.stepEl.update(A);if(this.lastActiveStep!=-1){this.indicators[this.lastActiveStep].removeClass("wtf-ux-wiz-Header-stepIndicator-active")}this.indicators[B].addClass("wtf-ux-wiz-Header-stepIndicator-active");this.lastActiveStep=B},onRender:function(D,B){Wtf.ux.Wiz.Header.superclass.onRender.call(this,D,B);this.indicators=[];this.stepTemplate=new Wtf.Template(this.stepText),this.stepTemplate.compile();var F=this.el.dom.firstChild;var E=F.nextSibling;this.titleEl=new Wtf.Element(F);this.stepEl=new Wtf.Element(E.firstChild);this.imageContainer=new Wtf.Element(E.lastChild);this.titleEl.update(this.title);var G=null;for(var C=0,A=this.steps;C<A;C++){G=document.createElement("div");G.innerHTML="&#160;";G.className="wtf-ux-wiz-Header-stepIndicator";this.indicators[C]=new Wtf.Element(G);this.imageContainer.appendChild(G)}}});Wtf.ux.Wiz.Card=Wtf.extend(Wtf.Panel,{header:false,hideMode:"display",initComponent:function(){this.addEvents("beforecardhide");Wtf.ux.Wiz.Card.superclass.initComponent.call(this)},isValid:function(){if(this.monitorValid){return this.bindHandler()}return true},bindHandler:function(){this.form.items.each(function(A){if(!A.isValid){A.isValid=Wtf.emptyFn}});Wtf.ux.Wiz.Card.superclass.bindHandler.call(this)},initEvents:function(){var A=this.monitorValid;this.monitorValid=false;Wtf.ux.Wiz.Card.superclass.initEvents.call(this);this.monitorValid=A;this.on("beforehide",this.bubbleBeforeHideEvent,this);this.on("beforecardhide",this.isValid,this);this.on("show",this.onCardShow,this);this.on("hide",this.onCardHide,this)},bubbleBeforeHideEvent:function(){var A=this.ownerCt.layout;var B=A.activeItem;if(B&&B.id===this.id){return this.fireEvent("beforecardhide",this)}return true},onCardHide:function(){if(this.monitorValid){this.stopMonitoring()}},onCardShow:function(){if(this.monitorValid){this.startMonitoring()}}});Wtf.ux.layout.CardLayout=Wtf.extend(Wtf.layout.CardLayout,{setActiveItem:function(A){A=this.container.getComponent(A);if(this.activeItem!=A){if(this.activeItem){this.activeItem.hide()}if(this.activeItem&&!this.activeItem.hidden){return }this.activeItem=A;A.show();this.layout()}}});Wtf.campaignMailTemplate=function(A){Wtf.apply(this,A);Wtf.campaignMailTemplate.superclass.constructor.call(this,{layout:"fit",border:false})};Wtf.extend(Wtf.campaignMailTemplate,Wtf.Panel,{onRender:function(A){Wtf.campaignMailTemplate.superclass.onRender.call(this,A);var B=Wtf.data.Record.create([{name:"templateid"},{name:"templatename"},{name:"description"},{name:"subject"},{name:"thumbnail"},{name:"craetedon"}]);var C=new Wtf.data.Store({url:Wtf.req.base+"campaign.jsp",baseParams:{flag:1,templateList:true},reader:new Wtf.data.KwlJsonReader({root:"data"},B)});C.on("load",function(I,H){var G=this.templateSelector.body.dom.childNodes;while(G.length>0){Wtf.get(G[0].id).remove()}for(var F=0;F<H.length;F++){var D=false;if(this.selectedTemplate!==null&&H[F].data["templateid"]==this.selectedTemplate){D=true}var J="../../images/"+H[F].data["thumbnail"];if(H[F].data["thumbnail"]==""){J="../../images/template-default-img.gif"}var E=new Wtf.emailTemplateThumbnail({height:120,width:100,cssStyle:"margin:5px 10px 0px 10px;",imgWidth:70,imgHeight:90,tqtip:H[F].data["description"],id:"thumbnail_"+H[F].data["templateid"],tName:H[F].data["templatename"],thumbnail:J,tempRec:H[F],scope:this,selected:D,listeners:{"templateSelected":this.selectTemplate},renderTo:this.templateSelector.body.dom});this.templateSelector.childArr.push(E);if(D){this.selectedTemplate=E}}},this);this.crateNewTemplate=new Wtf.Toolbar.Button({text:"New Email Template",scope:this,tooltip:{text:"Click to create a new Email Template."},iconCls:"pwndCRM templateEmailMarketing",handler:function(){var D=Wtf.getCmp("template_wiz_win"+this.templateid);var E="New Template";var F=Wtf.util.Format.ellipsis(E,18);if(D==null){D=new Wtf.newEmailTemplate({title:'<div wtf:qtip="'+E+"\"wtf:qtitle='Email Template'>"+F+"</div>",tipTitle:E,mailTemplate:C});this.mainTab.add(D)}this.mainTab.setActiveTab(D);this.mainTab.doLayout()}});this.templateSelector=new Wtf.Panel({border:false,bodyStyle:"background-color: white;",childArr:[],layout:"fit",tbar:["-",this.crateNewTemplate,"-"]});C.load();this.templateCont=this.add(this.templateSelector)},getSelectedTemplate:function(){return this.selectedTemplate},selectTemplate:function(A){var C=this.scope.templateSelector.childArr;for(var B=0;B<C.length;B++){C[B].deselectTemplate()}A.selectTemplate();this.scope.selectedTemplate=A}});Wtf.addEmailMarketCmp=function(A){Wtf.apply(this,A);Wtf.addEmailMarketCmp.superclass.constructor.call(this,{border:false,layout:"fit"})};Wtf.extend(Wtf.addEmailMarketCmp,Wtf.Panel,{onRender:function(B){Wtf.addEmailMarketCmp.superclass.onRender.call(this,B);this.targetRecord=new Wtf.data.Record.create([{name:"listid"},{name:"listname"}]);var A=new Wtf.data.KwlJsonReader({root:"data",totalProperty:"totalCount"},this.targetRecord);this.targetStore=new Wtf.data.Store({url:Wtf.req.base+"campaign.jsp",baseParams:{flag:21,campID:this.campaignid,emailmarkid:this.mode==1?this.emailmarkid:""},method:"post",reader:A});this.targetStore.load();this.createTargetListBtn=new Wtf.Toolbar.Button({text:"New Target List",scope:this,iconCls:"targetlistIcon",tooltip:{text:"Click to create a Target list for Campaign : "+this.campaignname+"."},handler:function(){var E="campaigntargetdetail"+this.campaignid;var C=this.campaignname+"'s Targets";var F=Wtf.util.Format.ellipsis(C,17);var D=Wtf.getCmp(E);if(D==null){D=new Wtf.campaignTargetList({title:'<div wtf:qtip="'+C+"\"wtf:qtitle='Campaign Targets'>"+F+"</div>",id:E,campaignid:this.campaignid,newFlag:3,arcFlag:1,archivedFlag:1,mainTab:this.mainTab,storeTarget:this.targetStore});this.mainTab.add(D)}this.mainTab.setActiveTab(D);this.doLayout()}});this.activityform=new Wtf.form.FormPanel({autoScroll:true,border:false,items:[{border:false,defaults:{border:false,xtype:"fieldset",autoHeight:true},items:[{cls:"marketingFieldset",title:"Marketing campaign setup",layout:"column",items:[{columnWidth:0.48,layout:"form",border:false,cls:"mailMarketingForm",defaults:{width:430,allowBlank:false,labelStyle:"width: 100%;",ctCls:"newTicketField"},items:[this.name=new Wtf.form.TextField({fieldLabel:"Email Marketing Name*"}),this.userMailCombo=new Wtf.form.TextField({fieldLabel:"Sender Mail*",vtype:"email"})]},{columnWidth:0.49,cls:"marketingFieldsetRight",layout:"form",border:false,defaults:{width:430,allowBlank:false,labelStyle:"width: 100%;",ctCls:"newTicketField"},items:[this.fromname=new Wtf.form.TextField({fieldLabel:"From Name*"}),this.replayMail=new Wtf.form.TextField({fieldLabel:"Reply Mail*",vtype:"email"})]}]}]}]});this.campTargetStore=new Wtf.data.Store({url:Wtf.req.base+"campaign.jsp",baseParams:{flag:5,emailmarkid:this.mode==1?this.emailmarkid:""},method:"post",reader:A});if(this.mode==1){this.fromname.setValue(this.recData.fromname);this.userMailCombo.setValue(this.recData.fromaddress);this.name.setValue(this.recData.name);this.replayMail.setValue(this.recData.replymail)}else{if(this.mode==0){this.fromname.setValue("Newsletters");this.userMailCombo.setValue("newsletters@deskera.com");this.name.setValue("");this.replayMail.setValue("newsletters@deskera.com")}}this.campTargetStore.load();this.targetColumn=new Wtf.grid.ColumnModel([new Wtf.grid.CheckboxSelectionModel(),{header:"Target List",dataIndex:"listname",renderer:function(C){return"<a href = '#' class='listofTargets'> "+C+"</a>"}}]);this.targetGrid=new Wtf.grid.GridPanel({store:this.targetStore,cm:this.targetColumn,sm:new Wtf.grid.CheckboxSelectionModel(),border:false,loadMask:true,viewConfig:{forceFit:true},tbar:["-",this.createTargetListBtn,"-"]});this.add({region:"center",border:false,layout:"fit",items:[{layout:"border",border:false,defaults:{border:false,layout:"fit"},items:[{region:"north",cls:"panelCls",bodyStyle:"background:#f1f1f1;font-size:10px;padding:40px 10px 10px 25px;",items:this.activityform},{region:"center",bodyStyle:"background:#f1f1f1;padding:0px 10px 10px 20px;",items:this.targetGrid}]}]});this.targetGrid.on("cellclick",this.listofTargets,this);this.campTargetStore.load();this.targetStore.on("load",function(){for(var D=0;D<this.targetStore.getCount();D++){for(var C=0;C<this.campTargetStore.getCount();C++){if(this.targetStore.data.items[D].data.listid==this.campTargetStore.data.items[C].data.listid){this.targetGrid.getSelectionModel().selectRow(D,true)}}}},this);this.campTargetStore.on("load",function(){this.targetStore.load()},this)},listofTargets:function(E,I,H,G){var B=G;if(B.getTarget("a[class='listofTargets']")){var C=this.targetStore.data.items[I].data.listid;var K=this.targetStore.data.items[I].data.listname;var D=K+"'s Targets";var J=Wtf.util.Format.ellipsis(D,19);var F="targetListsTargets"+this.id+C;var A=Wtf.getCmp(F);if(A==null){A=new Wtf.targetListTargets({id:"targetListsTargets"+this.id+C,closable:true,title:'<div wtf:qtip="'+D+"\"wtf:qtitle='Target List'>"+J+"</div>",layout:"fit",border:false,targetlistId:C,iconCls:"pwndnewCRM targetlistTabicon"});this.mainTab.add(A)}this.mainTab.setActiveTab(A);this.mainTab.doLayout()}},getList:function(){var A=this.targetGrid.getSelectionModel().getSelections();return A},getName:function(){return this.name.getValue().trim()},getSenderMail:function(){return this.userMailCombo.getValue().trim()},getFromName:function(){return this.fromname.getValue().trim()},getReplyMail:function(){return this.replayMail.getValue().trim()}});Wtf.campaignMailEditor=function(A){Wtf.apply(this,A);Wtf.campaignMailEditor.superclass.constructor.call(this,A)};Wtf.extend(Wtf.campaignMailEditor,Wtf.Panel,{layout:"fit",bodyStyle:"background-color: white;",border:false,onRender:function(A){Wtf.campaignMailEditor.superclass.onRender.call(this,A);this.templateEditor=new Wtf.Panel({region:"center",baseCls:"bodytest",split:true,tbar:[{text:"Send Test Mail",iconCls:"pwnd pmsgbtnicon",handler:this.previewTemplate,scope:this}],collapsible:false});this.themePanel=new Wtf.colorThemePanel({region:"east",layout:"fit",plugins:new Wtf.ux.collapsedPanelTitlePlugin(),title:"Design Themes",maxWidth:300,width:300,split:true,collapsible:true});this.themePanel.on("colorThemeSelect",this.applyColorTheme,this);this.editorCont=new Wtf.Panel({bodyStyle:"background-color: white",autoScroll:true,layout:"border",items:[this.templateEditor,this.themePanel],border:false});this.templateEditor.on("render",function(){var B="";this.editorHtmlComp=new Wtf.emailTemplatePanel({renderTo:this.templateEditor.body.dom,bodyHtml:B});if(this.mode!=1){this.getTemplateContent()}else{this.getEmailMarketingContent()}},this);this.add(this.editorCont)},getEmailMarketingContent:function(){Wtf.Ajax.requestEx({url:Wtf.req.base+"campaign.jsp",params:{flag:26,marketid:this.marketRec.id}},this,function(B,A){if(B.success){this.editorHtmlComp.setBodyHtml(unescape(B.data.html));if(B.data.theme){this.themePanel.getThemeFromId(B.data.theme)}}},function(){ResponseAlert(["Failure","Failed to Email Marketing content."])})},getTemplateContent:function(){Wtf.Ajax.requestEx({url:Wtf.req.base+"campaign.jsp",params:{flag:27,templateid:this.templateid}},this,function(B,A){if(B.success){this.editorHtmlComp.setBodyHtml(unescape(B.data.html))}},function(){ResponseAlert(["Failure","Failed to get Template content."])})},getColorTheme:function(){return this.colortheme},getPlainMessage:function(){return this.editorHtmlComp.getPlainText()},applyColorTheme:function(B,A){this.colortheme=A.data["id"];this.editorHtmlComp.applyNewColorTheme(A)},expandThemePanel:function(){var A=this.themePanel.getSize();A.width=300;this.themePanel.setSize(A)},previewTemplate:function(){Wtf.Ajax.requestEx({url:Wtf.req.base+"sendMail.jsp",params:{tid:this.templateid,bodyhtml:this.editorHtmlComp.getPreviewHtml()}},this,function(B,A){ResponseAlert(["Success","Mail sent successfully."])},function(B,A){ResponseAlert(["Failure","Failed to send mail."])})},changeTemplate:function(A){if(A!==undefined){this.templateid=A.data.templateid;this.templateRec=A;this.getTemplateContent()}},getTemplateHtml:function(){return this.editorHtmlComp.getPreviewHtml()},setTemplateHtml:function(A){this.editorHtmlComp.setBodyHtml(A)}});Wtf.colorThemePanel=function(A){Wtf.apply(this,A);this.addEvents({"colorThemeSelect":true});Wtf.colorThemePanel.superclass.constructor.call(this,{layout:"column",autoHeight:true,border:false})};Wtf.extend(Wtf.colorThemePanel,Wtf.Panel,{onRender:function(A){Wtf.colorThemePanel.superclass.onRender.call(this,A);this.addCategoryGrid();this.addColorThemeGrid()},addColorThemeGrid:function(){this.ctRec=Wtf.data.Record.create([{name:"id"},{name:"theme"},{name:"background"},{name:"headerbackground"},{name:"headertext"},{name:"footerbackground"},{name:"footertext"},{name:"bodybackground"},{name:"bodytext"},{name:"groupid"}]);this.ctStore=new Wtf.data.Store({url:Wtf.req.base+"campaign.jsp",baseParams:{flag:24},reader:new Wtf.data.KwlJsonReader({root:"data"},this.ctRec)});this.ctStore.on("load",function(){this.themeLoaded=true},this);this.ctStore.load();var A=new Wtf.grid.ColumnModel([{header:"Name",dataIndex:"theme",renderer:function(D,B,C){return"<div class='themeImage'><div class='themeImgBox' style='background-color:#"+C.data.background+"'></div><div class='themeImgBox' style='background-color:#"+C.data.headerbackground+"'></div><div class='themeImgBox' style='background-color:#"+C.data.headertext+"'></div><div class='themeImgBox' style='background-color:#"+C.data.footerbackground+"'></div><div class='themeImgBox' style='background-color:#"+C.data.bodybackground+"'></div></div><span style='margin-left: 8px;'>"+D+"</span>"}}]);this.colorSM=new Wtf.grid.RowSelectionModel({singleSelect:true});this.themeGrid=new Wtf.grid.GridPanel({cm:A,cls:"noborderGrid themeGrid",title:"Themes",ds:this.ctStore,autoScroll:true,sm:this.colorSM,columnWidth:1,height:250,viewConfig:{forceFit:true}});this.colorSM.on("rowselect",this.changeColorTheme,this);this.add(this.themeGrid)},getThemeFromId:function(A){if(this.themeLoaded){this.getTheme()}else{this.thm=A;this.ctStore.on("load",this.getTheme,this)}},getTheme:function(){var A=this.ctStore.findBy(function(B){if(B.data.id==this.thm){return true}else{return false}},this);if(A!=-1){this.colorSM.selectRow(A)}},addCategoryGrid:function(){var B=Wtf.data.Record.create([{name:"id"},{name:"groupname"}]);this.categoryStore=new Wtf.data.Store({url:Wtf.req.base+"campaign.jsp",baseParams:{flag:25},reader:new Wtf.data.KwlJsonReader({root:"data"},B)});this.categoryStore.load();var A=new Wtf.grid.ColumnModel([{header:"Name",dataIndex:"groupname"}]);this.categorySM=new Wtf.grid.RowSelectionModel({singleSelect:true});this.categoryGrid=new Wtf.grid.GridPanel({cm:A,cls:"noborderGrid themeGrid",ds:this.categoryStore,columnWidth:1,sm:this.categorySM,height:150,title:"Categories",viewConfig:{forceFit:true}});this.categorySM.on("rowselect",this.filterColorTheme,this);this.categorySM.on("rowdeselect",this.shoAllColorTheme,this);this.add(this.categoryGrid)},changeColorTheme:function(B,A,C){this.fireEvent("colorThemeSelect",this,C)},useDefaultColorTheme:function(B,A,C){ResponseAlert(["Alert","Change to default color theme"])},filterColorTheme:function(B,A,C){this.ctStore.filter("groupid",C.data["id"])},shoAllColorTheme:function(B,A,C){}});Wtf.emailTemplatePanel=function(A){Wtf.apply(this,A);Wtf.emailTemplatePanel.superclass.constructor.call(this,A)};Wtf.extend(Wtf.emailTemplatePanel,Wtf.Component,{onRender:function(D){Wtf.emailTemplatePanel.superclass.onRender.call(this,D);this.elDom=Wtf.get(this.renderTo).createChild({tag:"div",cls:"templateCompCont"});this.table1=document.createElement("table");this.table1.setAttribute("cellspacing",0);this.table1.setAttribute("width","100%");this.table1.style.backgroundColor="#FFFFCC";var F=document.createElement("tbody");var G=document.createElement("tr");var C=document.createElement("td");C.setAttribute("align","center");G.appendChild(C);F.appendChild(G);this.table1.appendChild(F);var B=document.createElement("table");B.setAttribute("cellspacing",0);B.setAttribute("cellpadding",0);B.setAttribute("width","600");var A=document.createElement("tbody");var E=document.createElement("tr");this.contentHolder=document.createElement("td");E.appendChild(this.contentHolder);A.appendChild(E);B.appendChild(A);C.appendChild(B);this.contentHolder.innerHTML=this.bodyHtml;Wtf.get(this.contentHolder).addListener("click",this.contentClicked);this.elDom.appendChild(this.table1)},setBodyHtml:function(A){this.table1.style.backgroundColor="#FFFFCC";this.contentHolder.innerHTML=A},getPreviewHtml:function(){return this.elDom.dom.innerHTML},contentClicked:function(C){var A=C.target;if(A.className.indexOf("tpl-content")!=-1||A.className.indexOf("tpl-content-image")!=-1){var B=new Wtf.editorWindow({headerImage:(A.className=="tpl-content-image"),val:A.innerHTML,parentCont:A});B.on("okClicked",function(E){var D=E.getEditorVal();E.parentCont.innerHTML=D.textVal;if(D.imageRec){E.parentCont.parentNode.style.height=D.imageRec.data["height"]+"px";E.parentCont.parentNode.style.background="url("+D.imageRec.data["url"]+") no-repeat"}},this);B.show()}},getPlainText:function(){var A=this.elDom.dom.innerHTML;A=A.replace(/<p>/g,"");A=A.replace(/<\p>/g,"");A=A.replace(/<P>/g,"");A=A.replace(/<\P>/g,"");A=A.replace(/&nbsp;/g,"");A=Wtf.util.Format.stripTags(A);return A},applyNewColorTheme:function(C){if(C){this.table1.style.backgroundColor="#"+C.data.background;var E=Wtf.select(".headerTop",true,this.table1);if(E.elements.length>0){E=E.elements[0].dom;E.style.backgroundColor="#"+C.data.headerbackground;E.style.color="#"+C.data.headertext}var D=Wtf.select(".footerRow",true,this.table1);if(D.elements.length>0){D=D.elements[0].dom;D.style.backgroundColor="#"+C.data.footerbackground;var B=Wtf.select(".footerText",true,D);if(B.elements.length!=0){B.elements[0].dom.style.color="#"+C.data.footertext}}var A=Wtf.select(".defaultText",true,this.table1);if(A.elements.length>0){A=A.elements[0].dom;A.style.backgroundColor="#"+C.data.bodybackground;A.style.color="#"+C.data.bodytext}}}});Wtf.editorWindow=function(A){Wtf.apply(this,A);this.addEvents({"okClicked":true});Wtf.editorWindow.superclass.constructor.call(this,{width:820,height:580,resizable:false,layout:"fit",title:(this.title&&this.title!="")?this.title:"Edit Your Content",modal:true,buttons:[{text:"Ok",scope:this,handler:this.okClicked},{text:"Cancel",scope:this,handler:this.cancelClicked}]})};Wtf.extend(Wtf.editorWindow,Wtf.Window,{onRender:function(C){Wtf.editorWindow.superclass.onRender.call(this,C);var E=[];this.careteEditor();if(this.headerImage){var D=Wtf.data.Record.create([{name:"id"},{name:"name"},{name:"url"},{name:"height"}]);var B=new Wtf.data.Store({url:Wtf.req.base+"getFiles.jsp",baseParams:{action:3},reader:new Wtf.data.KwlJsonReader({root:"data"},D)});B.load();var A=new Wtf.grid.ColumnModel([{header:"Name",dataIndex:"name"}]);var F=new Wtf.grid.RowSelectionModel({singleSelect:true});F.on("rowSelect",function(H,G,I){document.getElementById("email_campaign_header_image").src=I.data.url},this);this.imageGrid=new Wtf.grid.GridPanel({store:B,cm:A,height:200,cls:"noborderGrid",layout:"fit",sm:F,border:false,viewConfig:{forceFit:true}});E[E.length]=new Wtf.Panel({layout:"column",region:"north",border:false,height:200,items:[{border:false,height:200,columnWidth:0.2,items:this.imageGrid},{columnWidth:0.79,autoScroll:true,border:false,height:200,bodyStyle:"text-align: center",html:"<img id='email_campaign_header_image' style='margin-top: 5px' src='' />"}]})}E[E.length]=new Wtf.Panel({layout:"fit",region:"center",items:[this.mce]});this.add(new Wtf.Panel({layout:"border",items:E}))},careteEditor:function(){this.mce=new Wtf.form.HtmlEditor({value:this.val,plugins:[new Wtf.ux.form.HtmlEditor.insertImage({imageStoreURL:Wtf.req.base+"getFiles.jsp?action=1&type=img",imageUploadURL:Wtf.req.base+"getFiles.jsp?action=2&type=img"}),new Wtf.ux.form.HtmlEditor.HR({}),new Wtf.ux.form.HtmlEditor.SpecialCharacters({})]})},showTagList:function(){var D=new Wtf.data.SimpleStore({fields:["id","value","notation"],data:[["0","Email Address","{emailid}"],["1","First Name","{firstname}"],["2","Last Name","{lastname}"]]});var C=new Wtf.grid.ColumnModel([{header:"To Insert",dataIndex:"value"},{header:"Use This",dataIndex:"notation"}]);var B=new Wtf.grid.GridPanel({layout:"fit",cm:C,store:D,viewConfig:{forceFit:true}});var A=new Wtf.Window({title:"Tag list",layout:"fit",modal:true,resizable:false,height:250,width:440,buttons:[{text:"Close",handler:function(){A.close()}}],items:B});A.show()},okClicked:function(A){if(this.fireEvent("okClicked",this)){this.close()}},cancelClicked:function(A){this.close()},getEditorVal:function(){var A={};A["textVal"]=this.mce.getValue();if(this.headerImage){A["imageRec"]=this.imageGrid.getSelectionModel().getSelected()}return A}});Wtf.ns("Wtf.ux.form.HtmlEditor");Wtf.ux.form.HtmlEditor.MidasCommand=Wtf.extend(Wtf.util.Observable,{init:function(A){this.cmp=A;this.btns=[];this.cmp.on("render",this.onRender,this);this.cmp.on("initialize",this.onInit,this,{delay:100,single:true})},onInit:function(){Wtf.EventManager.on(this.cmp.getDoc(),{"mousedown":this.onEditorEvent,"dblclick":this.onEditorEvent,"click":this.onEditorEvent,"keyup":this.onEditorEvent,buffer:100,scope:this})},onRender:function(){var C,A=this.cmp.getToolbar(),B;Wtf.each(this.midasBtns,function(D){if(Wtf.isObject(D)){C={iconCls:"x-edit-"+D.cmd,handler:function(){this.cmp.relayCmd(D.cmd)},scope:this,tooltip:D.tooltip||{title:D.title},overflowText:D.overflowText||D.title}}else{C=new Wtf.Toolbar.Separator()}B=A.addButton(C);if(D.enableOnSelection){B.disable()}this.btns.push(B)},this)},onEditorEvent:function(){var A=this.cmp.getDoc();Wtf.each(this.btns,function(B,C){if(this.midasBtns[C].enableOnSelection||this.midasBtns[C].disableOnSelection){if(A.getSelection){if((this.midasBtns[C].enableOnSelection&&A.getSelection()!=="")||(this.midasBtns[C].disableOnSelection&&A.getSelection()==="")){B.enable()}else{B.disable()}}else{if(A.selection){if((this.midasBtns[C].enableOnSelection&&A.selection.createRange().text!=="")||(this.midasBtns[C].disableOnSelection&&A.selection.createRange().text==="")){B.enable()}else{B.disable()}}}}if(this.midasBtns[C].monitorCmdState){B.toggle(A.queryCommandState(this.midasBtns[C].cmd))}},this)}});Wtf.ux.form.HtmlEditor.Divider=Wtf.extend(Wtf.util.Observable,{init:function(A){this.cmp=A;this.cmp.on("render",this.onRender,this)},onRender:function(){this.cmp.getToolbar().addButton([new Wtf.Toolbar.Separator()])}});Wtf.ux.form.HtmlEditor.IndentOutdent=Wtf.extend(Wtf.ux.form.HtmlEditor.MidasCommand,{midasBtns:["|",{cmd:"indent",tooltip:{title:"Indent Text"},overflowText:"Indent Text"},{cmd:"outdent",tooltip:{title:"Outdent Text"},overflowText:"Outdent Text"}]});Wtf.ux.form.HtmlEditor.RemoveFormat=Wtf.extend(Wtf.ux.form.HtmlEditor.MidasCommand,{midasBtns:["|",{enableOnSelection:true,cmd:"removeFormat",tooltip:{title:"Remove Formatting"},overflowText:"Remove Formatting"}]});Wtf.ux.form.HtmlEditor.SubSuperScript=Wtf.extend(Wtf.ux.form.HtmlEditor.MidasCommand,{midasBtns:["|",{enableOnSelection:true,cmd:"subscript",tooltip:{title:"Subscript"},overflowText:"Subscript"},{enableOnSelection:true,cmd:"superscript",tooltip:{title:"Superscript"},overflowText:"Superscript"}]});Wtf.ux.form.HtmlEditor.SpecialCharacters=Wtf.extend(Wtf.util.Observable,{specialChars:[],charRange:[160,256],init:function(A){this.cmp=A;this.cmp.on("render",this.onRender,this)},onRender:function(){var B=this.cmp;var A=this.cmp.getToolbar().addButton({iconCls:"x-edit-char",handler:function(){if(this.specialChars.length==0){Wtf.each(this.specialChars,function(E,D){this.specialChars[D]=["&#"+E+";"]},this);for(i=this.charRange[0];i<this.charRange[1];i++){this.specialChars.push(["&#"+i+";"])}}var C=new Wtf.data.SimpleStore({fields:["char"],data:this.specialChars});this.charWindow=new Wtf.Window({title:"Insert Special Character",iconCls:getButtonIconCls(Wtf.btype.winicon),width:436,resizable:false,modal:true,autoHeight:true,layout:"fit",items:[this.charView=new Wtf.DataView({style:"background-color:white;",store:C,autoHeight:true,multiSelect:true,tpl:new Wtf.XTemplate('<tpl for="."><div class="char-item">{char}</div></tpl><div class="x-clear"></div>'),overClass:"char-over",itemSelector:"div.char-item",listeners:{dblclick:function(E,D,G,F){this.insertChar(E.getStore().getAt(D).get("char"));this.charWindow.close()},scope:this}})],buttons:[{text:"Insert",handler:function(){Wtf.each(this.charView.getSelectedRecords(),function(D){var E=D.get("char");this.insertChar(E)},this);this.charWindow.close()},scope:this},{text:"Cancel",handler:function(){this.charWindow.close()},scope:this}]});this.charWindow.show()},scope:this,tooltip:{title:"Insert Special Character"},overflowText:"Special Characters"})},insertChar:function(A){if(A){this.cmp.insertAtCursor(A)}}});Wtf.ux.form.HtmlEditor.customButton=function(A){Wtf.apply(this,A)};Wtf.ux.form.HtmlEditor.customButton=Wtf.extend(Wtf.ux.form.HtmlEditor.customButton,Wtf.util.Observable,{init:function(A){this.cmp=A;this.cmp.on("render",this.onRender,this)},onRender:function(){if(!this.buttonConf.scope){this.buttonConf.scope=this}this.btn=this.cmp.getToolbar().addButton(this.buttonConf)}});Wtf.ux.form.HtmlEditor.Table=Wtf.extend(Wtf.util.Observable,{cmd:"table",tableBorderOptions:[["none","None"],["1px solid #000","Sold Thin"],["2px solid #000","Solid Thick"],["1px dashed #000","Dashed"],["1px dotted #000","Dotted"]],init:function(A){this.cmp=A;this.cmp.on("render",this.onRender,this)},onRender:function(){var A=this.cmp.getToolbar().addButton({iconCls:"x-edit-table",handler:function(){if(!this.tableWindow){this.tableWindow=new Wtf.Window({title:"Insert Table",closeAction:"hide",items:[{itemId:"insert-table",xtype:"form",border:false,plain:true,bodyStyle:"padding: 10px;",labelWidth:60,labelAlign:"right",items:[{xtype:"numberfield",allowBlank:false,allowDecimals:false,fieldLabel:"Rows",name:"row",width:60},{xtype:"numberfield",allowBlank:false,allowDecimals:false,fieldLabel:"Columns",name:"col",width:60},{xtype:"combo",fieldLabel:"Border",name:"border",forceSelection:true,mode:"local",store:new Wtf.data.ArrayStore({autoDestroy:true,fields:["spec","val"],data:this.tableBorderOptions}),triggerAction:"all",value:"none",displayField:"val",valueField:"spec",width:90}]}],buttons:[{text:"Insert",handler:function(){var F=this.tableWindow.getComponent("insert-table").getForm();if(F.isValid()){var D=F.findField("border").getValue();var B=[F.findField("row").getValue(),F.findField("col").getValue()];if(B.length==2&&B[0]>0&&B[0]<10&&B[1]>0&&B[1]<10){var E="<table>";for(var G=0;G<B[0];G++){E+="<tr>";for(var C=0;C<B[1];C++){E+="<td width='20%' style='border: "+D+";'>"+G+"-"+C+"</td>"}E+="</tr>"}E+="</table>";this.cmp.insertAtCursor(E)}this.tableWindow.hide()}else{if(!F.findField("row").isValid()){F.findField("row").getEl().frame()}else{if(!F.findField("col").isValid()){F.findField("col").getEl().frame()}}}},scope:this},{text:"Cancel",handler:function(){this.tableWindow.hide()},scope:this}]})}else{this.tableWindow.getEl().frame()}this.tableWindow.show()},scope:this,tooltip:{title:"Insert Table"},overflowText:"Table"})}});Wtf.ux.form.HtmlEditor.Word=Wtf.extend(Wtf.util.Observable,{curLength:0,lastLength:0,lastValue:"",wordPasteEnabled:true,init:function(A){this.cmp=A;this.cmp.on("render",this.onRender,this);this.cmp.on("initialize",this.onInit,this,{delay:100,single:true})},onInit:function(){Wtf.EventManager.on(this.cmp.getDoc(),{"keyup":this.checkIfPaste,scope:this});this.lastValue=this.cmp.getValue();this.curLength=this.lastValue.length;this.lastLength=this.lastValue.length},checkIfPaste:function(C){var A=0;this.curLength=this.cmp.getValue().length;if(C.V==C.getKey()&&C.ctrlKey&&this.wordPasteEnabled){this.cmp.suspendEvents();A=this.findValueDiffAt(this.cmp.getValue());var B=[this.cmp.getValue().substr(0,A),this.fixWordPaste(this.cmp.getValue().substr(A,(this.curLength-this.lastLength))),this.cmp.getValue().substr((this.curLength-this.lastLength)+A,this.curLength)];this.cmp.setValue(B.join(""));this.cmp.resumeEvents()}this.lastLength=this.cmp.getValue().length;this.lastValue=this.cmp.getValue()},findValueDiffAt:function(A){for(i=0;i<this.curLength;i++){if(this.lastValue[i]!=A[i]){return i}}},fixWordPaste:function(A){var B=[/&nbsp;/ig,/[\r\n]/g,/<(xml|style)[^>]*>.*?<\/\1>/ig,/<\/?(meta|object|span)[^>]*>/ig,/<\/?[A-Z0-9]*:[A-Z]*[^>]*>/ig,/(lang|class|type|href|name|title|id|clear)=\"[^\"]*\"/ig,/style=(\'\'|\"\")/ig,/<![\[-].*?-*>/g,/MsoNormal/g,/<\\?\?xml[^>]*>/g,/<\/?o:p[^>]*>/g,/<\/?v:[^>]*>/g,/<\/?o:[^>]*>/g,/<\/?st1:[^>]*>/g,/&nbsp;/g,/<\/?SPAN[^>]*>/g,/<\/?FONT[^>]*>/g,/<\/?STRONG[^>]*>/g,/<\/?H1[^>]*>/g,/<\/?H2[^>]*>/g,/<\/?H3[^>]*>/g,/<\/?H4[^>]*>/g,/<\/?H5[^>]*>/g,/<\/?H6[^>]*>/g,/<\/?P[^>]*><\/P>/g,/<!--(.*)-->/g,/<!--(.*)>/g,/<!(.*)-->/g,/<\\?\?xml[^>]*>/g,/<\/?o:p[^>]*>/g,/<\/?v:[^>]*>/g,/<\/?o:[^>]*>/g,/<\/?st1:[^>]*>/g,/style=\"[^\"]*\"/g,/style=\'[^\"]*\'/g,/lang=\"[^\"]*\"/g,/lang=\'[^\"]*\'/g,/class=\"[^\"]*\"/g,/class=\'[^\"]*\'/g,/type=\"[^\"]*\"/g,/type=\'[^\"]*\'/g,/href=\'#[^\"]*\'/g,/href=\"#[^\"]*\"/g,/name=\"[^\"]*\"/g,/name=\'[^\"]*\'/g,/ clear=\"all\"/g,/id=\"[^\"]*\"/g,/title=\"[^\"]*\"/g,/<span[^>]*>/g,/<\/?span[^>]*>/g,/class=/g];Wtf.each(B,function(C){A=A.replace(C,"")});A=A.replace(/<div[^>]*>/g,"<p>");A=A.replace(/<\/?div[^>]*>/g,"</p>");return A},onRender:function(){this.cmp.getToolbar().add({iconCls:"x-edit-wordpaste",pressed:true,handler:function(A){A.toggle(!A.pressed);this.wordPasteEnabled=!this.wordPasteEnabled},scope:this,tooltip:{text:"Cleanse text pasted from Word or other Rich Text applications"}})}});Wtf.ux.form.HtmlEditor.HR=Wtf.extend(Wtf.util.Observable,{cmd:"hr",init:function(A){this.cmp=A;this.cmp.on("render",this.onRender,this)},onRender:function(){var B=this.cmp;var A=this.cmp.getToolbar().addButton({iconCls:"x-edit-hr",handler:function(){if(!this.hrWindow){this.hrWindow=new Wtf.Window({width:200,title:"Insert Rule",closeAction:"hide",iconCls:getButtonIconCls(Wtf.btype.winicon),items:[{itemId:"insert-hr",xtype:"form",border:false,plain:true,bodyStyle:"padding: 10px;",labelWidth:60,labelAlign:"right",items:[{xtype:"textfield",maskRe:/[0-9]|%/,regex:/^[1-9][0-9%]{1,3}/,fieldLabel:"Width",name:"hrwidth",width:60,listeners:{specialkey:function(C,D){if((D.getKey()==D.ENTER||D.getKey()==D.RETURN)&&C.isValid()){this.doInsertHR()}else{C.getEl().frame()}},scope:this}}]}],buttons:[{text:"Insert",handler:function(){var C=this.hrWindow.getComponent("insert-hr").getForm();if(C.isValid()){this.doInsertHR()}else{C.findField("hrwidth").getEl().frame()}},scope:this},{text:"Cancel",handler:function(){this.hrWindow.hide()},scope:this}]})}else{this.hrWindow.getEl().frame()}this.hrWindow.show()},scope:this,tooltip:{title:"Insert Horizontal Rule"},overflowText:"Horizontal Rule"})},doInsertHR:function(){var B=this.hrWindow.getComponent("insert-hr").getForm();if(B.isValid()){var A=B.findField("hrwidth").getValue();if(A){this.insertHR(A)}else{this.insertHR("100%")}B.reset();this.hrWindow.hide()}},insertHR:function(A){this.cmp.insertAtCursor('<hr width="'+A+'">')}});Wtf.ux.form.HtmlEditor.insertImage=Wtf.extend(function(A){Wtf.apply(this,A)},Wtf.util.Observable,{init:function(A){this.cmp=A;this.uType="upload";this.cmp.on("render",this.onRender,this)},onRender:function(){var A=this.cmp.getToolbar().addButton({iconCls:"x-edit-image",handler:this.uploadImage,scope:this,tooltip:{title:"Insert image"}})},uploadImage:function(){var imgRec=new Wtf.data.Record.create([{name:"id"},{name:"description"},{name:"imgname"},{name:"url"}]);this.imageStore=new Wtf.data.Store({url:this.imageStoreURL,reader:new Wtf.data.KwlJsonReader({root:"data"},imgRec)});this.imageStore.on("load",function(obj,recs){var _cobj=this.imageGrid.body.dom.childNodes;while(_cobj.length>0){Wtf.get(_cobj[0].id).remove()}for(var cnt=0;cnt<recs.length;cnt++){new Wtf.emailTemplateThumbnail({height:75,width:72,imgWidth:40,imgHeight:40,tqtip:recs[cnt].data["description"],tName:recs[cnt].data["imgname"],thumbnail:recs[cnt].data["url"],tempRec:recs[cnt],scope:this,listeners:{"templateSelected":this.selectTemplate},renderTo:this.imageGrid.body.dom})}},this);this.imageStore.load();this.imageGrid=new Wtf.Panel({autoScroll:true,height:200,style:"margin-bottom: 10px;",layout:"fit"});this.uploadFieldSet=new Wtf.Panel({disabledClass:"fieldsetDisabled",cls:"uploadImagePanel",bodyStyle:"border: 1px solid #B5B8C8; padding: 10px 10px 6px 10px;",layout:"form",autoHeight:true,items:[new Wtf.Button({text:"Delete File",scope:this,style:"margin-bottom:10px;",handler:function(){if(this.selectedTemplate){var selectImg=this.selectedTemplate.tempRec.data.id;Wtf.Ajax.requestEx({url:Wtf.req.base+"getFiles.jsp?action=4&type=img",params:{tempid:selectImg}},this,function(action,response){var resultobj=eval("("+action.data+")");if(resultobj.success==false){calMsgBoxShow(["Warning","Please select image."],2)}else{this.imageStore.reload()}},function(){ResponseAlert(["Failure","Failed to Delete file"])})}else{calMsgBoxShow(["Warning","Please select image."],2)}}}),this.imageGrid,this.uploadForm=new Wtf.form.FormPanel({border:false,cls:"upploadForm",fileUpload:true,layout:"column",url:this.imageUploadURL,labelWidth:50,items:[{columnWidth:0.83,border:false,layout:"form",items:[{xtype:"textfield",width:180,allowBlank:false,id:"imageField",fieldLabel:"Image",inputType:"file",validator:WtfGlobal.validateImageFile,invalidText:"File format must be .jpg/.jpeg/.gif/.bmp/.png etc."}]},{columnWidth:0.17,border:false,items:[new Wtf.Button({text:"Upload",scope:this,handler:function(){if(!Wtf.getCmp("imageField").isValid()){calMsgBoxShow(["Warning","Please upload valid image file."],2);return }this.uploadForm.form.submit({scope:this,success:function(action,response){this.imageStore.reload();Wtf.getCmp("imageField").reset()},failure:function(action,response){ResponseAlert(["Failure","Failed to upload file"])}})}})]}]})]});this.newImage=new Wtf.Panel({border:false,items:[{xtype:"fieldset",layout:"column",autoHeight:true,items:[new Wtf.Panel({columnWidth:0.5,layout:"form",labelWidth:110,border:false,items:[{xtype:"radio",scope:this,uType:"upload",listeners:{"check":this.radioChanged},checked:true,id:"uploadlocal",cls:"uploadTypeRadio",name:"uploadtype",fieldLabel:"Upload new Image"}]}),new Wtf.Panel({columnWidth:0.45,layout:"form",labelWidth:90,border:false,items:[{xtype:"radio",uType:"url",scope:this,listeners:{"check":this.radioChanged},cls:"uploadTypeRadio",id:"uploadremote",name:"uploadtype",fieldLabel:"Use Web URL"}]})]},this.uploadFieldSet,this.urlFieldSet=new Wtf.Panel({cls:"uploadImagePanel",bodyStyle:"border: 1px solid #B5B8C8; padding: 10px 10px 6px 10px;",layout:"form",labelWidth:70,disabledClass:"fieldsetDisabled",autoHeight:true,items:[this.urlField=new Wtf.form.TextField({width:280,fieldLabel:"Image URL"})]})]});this.uploadImg=new Wtf.Window({title:"Upload Image",bodyStyle:"background-color:#FFFFFF; padding:12px;",iconCls:getButtonIconCls(Wtf.btype.winicon),modal:true,resizable:false,height:478,width:450,items:this.newImage,buttons:[{text:"OK",scope:this,handler:this.uploadNewImage},{text:"Cancel",scope:this,handler:function(){this.uploadImg.close()}}]});this.selectedTemplate=null;this.uploadImg.show()},selectTemplate:function(A){if(this.scope.selectedTemplate){this.scope.selectedTemplate.deselectTemplate()}A.selectTemplate();this.scope.selectedTemplate=A},radioChanged:function(A,B){if(B){if(Wtf.getCmp("uploadremote").rendered&&Wtf.getCmp("uploadlocal").rendered){Wtf.getCmp("uploadremote").onClick();Wtf.getCmp("uploadlocal").onClick()}if(A.uType=="upload"){this.scope.uType="upload";this.scope.uploadFieldSet.setVisible(true);this.scope.urlFieldSet.setVisible(false)}else{this.scope.uType="url";this.scope.uploadFieldSet.setVisible(false);this.scope.urlFieldSet.setVisible(true)}}},uploadNewImage:function(){var A=false;if(this.uType=="upload"){if(this.selectedTemplate){this.insertImage(this.selectedTemplate.thumbnail);A=true}}else{if(this.urlField.getValue().trim()!=""){this.insertImage(this.urlField.getValue().trim());A=true}}if(A){this.uploadImg.close()}},insertImage:function(A){if(A){this.cmp.insertAtCursor("<img src='"+A+"' />")}}});Wtf.letterSenderWindow=function(A){Wtf.apply(this,A);A.resizable=false;Wtf.letterSenderWindow.superclass.constructor.call(this,{buttons:[{text:"Send",scope:this,handler:function(){if(!this.AddEditForm.form.isValid()){return }else{Wtf.MessageBox.confirm("Confirm","Do you want to send this letter?",function(B){if(B!="yes"){this.close()}else{if(this.AddEdit=="Edit"){var C=this.generaltaxgrid.getSelectionModel();C.clearSelections()}Wtf.Ajax.requestEx({url:"Rec/Job/sendLetters.rec",params:{save:true,templateid:this.letter.getValue(),userlist:this.userlist}},this,function(D){if(D.msg=="null"){Wtf.Msg.alert("Message"," Error occoured at server side.")}else{if(D.value=="failed"){calMsgBoxShow(["Warning",""+D.msg.substr(D.msg.indexOf(":")+1,D.msg.length)+""],2)}else{calMsgBoxShow(["Success",""+D.msg+""],0)}}Wtf.getCmp("letterSenderListWindow_id").close()},function(){Wtf.Msg.alert("Message"," Some error occoured.")})}},this)}}},{text:"Cancel",handler:function(){Wtf.getCmp("letterSenderListWindow_id").close()},scope:this}]})};Wtf.extend(Wtf.letterSenderWindow,Wtf.Window,{initComponent:function(){Wtf.letterSenderWindow.superclass.initComponent.call(this);this.GetNorthPanel();this.GetAddEditForm();this.mainPanel=new Wtf.Panel({layout:"border",border:false,items:[this.northPanel,this.AddEditForm]});this.add(this.mainPanel)},GetNorthPanel:function(){var C=this.AddEdit=="Edit"?"Edit Letter List":"Send Letter";var A=this.AddEdit=="Edit"?"Fill up the information to edit letter list":"Select the letter to send";var B=this.typeimage;this.northPanel=new Wtf.Panel({region:"north",height:90,border:false,bodyStyle:"backgroubodyStylend-color:white;padding:8px;border-bottom:1px solid #bfbfbf;background-color: white",html:getTopHtml(C,A,B)})},GetAddEditForm:function(){this.templateListRecord=Wtf.data.Record.create([{name:"id"},{name:"name"}]);this.templateListStore=new Wtf.data.Store({url:"Common/Template/getBriefTemplateList.common",reader:new Wtf.data.KwlJsonReader({root:"data"},this.templateListRecord),baseParams:{type:"gettemplateList"}});this.templateListStore.load();this.letter=new Wtf.form.ComboBox({fieldLabel:"Letter Type*",editable:false,name:"selectletter",width:200,labelWidth:100,emptyText:"Select Letter",allowBlank:false,store:this.templateListStore,displayField:"name",valueField:"id",typeAhead:true,mode:"local",triggerAction:"all"});this.AddEditForm=new Wtf.form.FormPanel({region:"center",border:false,scope:this,bodyStyle:"background-color:#f1f1f1;padding:15px",items:[this.letter]})}});Wtf.highLightGlobal=function(B,C,D,A){if(B!=undefined){this.row=Wtf.highLightSearch(B,D,A);if(this.row!=null){if(A!="activityid"){Wtf.highLightRow(C,"FFFF00",2,this.row)}else{Wtf.highLightText(C,"FFFF00",2,this.row)}}}};Wtf.highLightSearch=function(B,D,A){var C=D.findBy(function(E){if(E.get(A)==B){return true}else{return false}});if(C==-1){return null}return C};Wtf.deleteGlobal=function(C,G,K,L,A,M,J,I,H,F){var N=C.getSelectionModel().getSelections();var E=60;C.getSelectionModel().clearSelections();if(N.length>0){var D=Wtf.getCmp("tree");var B=D.getNodeById(F);Wtf.onlyhighLightRecordLoop(C,"FF0000",E,N,K);Wtf.highLightTreeNodeLoop("FF0000",E,N,D,B,A);Wtf.MessageBox.show({title:"Confirm",msg:"Are you sure you want to delete selected "+K+"(s)?<br><br><b>Note: This data cannot be retrieved later.",buttons:Wtf.MessageBox.OKCANCEL,animEl:"upbtn",icon:Wtf.MessageBox.QUESTION,scope:this,fn:function(P){if(P=="ok"){var U="";for(var Q=0;Q<N.length;Q++){if(N[Q].get("validflag")!=-1){U+="{'"+L+"':'"+N[Q].get(A)+"'},"}}var T=U.length-1;var R=U.substr(0,T);Wtf.commonWaitMsgBox("Deleting data...");Wtf.Ajax.requestEx({url:Wtf.req.base+"crm.jsp",params:{jsondata:R,table:M,flag:41}},this,function(V){this.delayFunction=new Wtf.util.DelayedTask(function(){Wtf.removeSelectedTreeNode(D,B,A,N);Wtf.removeSelectedRows(C,N);G.load({params:{start:0,limit:C.getBottomToolbar().pageSize}})},this);Wtf.onlyhighLightRecordLoop(C,"ffffff",E,N,K,true);Wtf.highLightTreeNodeLoop("ffffff",E,N,D,B,A);Wtf.onlyhighLightRecordLoop(C,"FF0000",3,N,K);Wtf.highLightTreeNodeLoop("FF0000",3,N,D,B,A);this.delayFunction.delay(1800);if(K=="Lead"||K=="Opportunity"||K=="Account"||K=="Activity"){bHasChanged=true}Wtf.updateProgress();ResponseAlert(J)},function(){Wtf.updateProgress();ResponseAlert(I)})}else{var S=[];Wtf.highLightTreeNodeLoop("ffffff",E+5,N,D,B,A);Wtf.onlyhighLightRecordLoop(C,"ffffff",E+1,N,K,true);for(var Q=0;Q<N.length;Q++){var O=G.indexOf(N[Q]);S.push(O)}C.getSelectionModel().selectRows(S)}}})}else{Wtf.updateProgress();ResponseAlert(H)}};Wtf.commonWaitMsgBox=function(A){Wtf.MessageBox.show({msg:A,width:290,wait:true,title:"Processing your request. Please wait...",waitConfig:{interval:200}})};Wtf.updateProgress=function(){Wtf.MessageBox.hide()};Wtf.notify=function(){var B;function A(C,D){return['<div class="msg">','<div class="x-box-tl"><div class="x-box-tr"><div class="x-box-tc"></div></div></div>','<div class="x-box-ml"><div class="x-box-mr"><div class="x-box-mc"><h3>',C,"</h3>",D,"</div></div></div>",'<div class="x-box-bl"><div class="x-box-br"><div class="x-box-bc"></div></div></div>',"</div>"].join("")}return{msg:function(F,E){if(!B){B=Wtf.DomHelper.insertFirst(document.body,{id:"msg-div"},true)}B.alignTo(document,"t-t");var D=String.format.apply(String,Array.prototype.slice.call(arguments,1));var C=Wtf.DomHelper.append(B,{html:A(F,D)},true);C.slideIn("t").pause(2).ghost("t",{remove:true})},init:function(){var C=Wtf.get("exttheme");if(!C){return }var E=Cookies.get("exttheme")||"aero";if(E){C.dom.value=E;Wtf.getBody().addClass("x-"+E)}C.on("change",function(){Cookies.set("exttheme",C.getValue());setTimeout(function(){window.location.reload()},250)});var D=Wtf.get("lib-bar");if(D){D.show()}}}}();Wtf.campaignDetails=function(A){Wtf.campaignDetails.superclass.constructor.call(this,A)};Wtf.extend(Wtf.campaignDetails,Wtf.Panel,{closable:true,layout:"fit",border:false,iconCls:"pwndnewCRM emailmarketingTabicon",initComponent:function(C){Wtf.campaignDetails.superclass.initComponent.call(this,C);var B=getHelpButton(this,35);this.addEmailMarketing=new Wtf.Toolbar.Button({text:"Add Email Marketing",scope:this,id:"addemailmarketing35",tooltip:{text:"Build effective e-mail campaigns by using pre-defined email templates and target lists."},iconCls:"pwnd addEmailMarketing",handler:function(){this.emailMarketing(0)}});this.editEmailMarketing=new Wtf.Toolbar.Button({text:"Edit Email Marketing",scope:this,disabled:true,iconCls:"pwnd editEmailMarketing",tooltip:{text:"Select an e-mail marketing campaign to edit."},handler:function(){if(this.Grid.getSelectionModel().getSelections().length==1){this.emailMarketing(1)}else{ResponseAlert(72)}}});this.scheduleEmailMarketing=new Wtf.Toolbar.Button({text:"Schedule Email Marketing",scope:this,disabled:true,iconCls:"pwnd scheduleEmailMarketing",tooltip:{text:"Select an e-mail marketing campaign to schedule the delivery."},handler:function(){var F=this.Grid.getSelectionModel().getSelections();if(F.length==1){this.showScheduleWindow(F[0])}else{ResponseAlert(102)}}});this.emailTempBtn=new Wtf.Toolbar.Button({text:"Email Templates",scope:this,id:"emailtemplate35",tooltip:{text:"Build e-mail templates for e-mail marketing of your campaigns. Add rich text formatting,pictures, videos, links and more."},iconCls:"pwndCRM templateEmailMarketing",handler:function(){var F=Wtf.getCmp("emailTemplate");if(F==null){F=new Wtf.emailTemplate({mainTab:this.mainTab});this.mainTab.add(F)}this.mainTab.setActiveTab(F);this.mainTab.doLayout()}});this.TargetListBtn=new Wtf.Toolbar.Button({text:"Target List",scope:this,id:"targetlist35",tooltip:{text:"Define the list of recipients for your email-marketing campaigns. Import e-mail addresses from leads, contacts or targets easily."},iconCls:"pwnd targetListEmailMarketing",handler:this.targetListHandler});var D=new Wtf.data.Record.create([{name:"id"},{name:"name"},{name:"templatename"},{name:"templateid"},{name:"fromname"},{name:"fromaddress"},{name:"replymail"},{name:"unsub"},{name:"fwdfriend"},{name:"archive"},{name:"updatelink"},{name:"targetcount",type:"int"},{name:"createdon"},{name:"campaignlog"}]);var E=new Wtf.grid.RowExpander({tpl:new Wtf.XTemplate('<div style="display:block;width:100%;" />','<tpl for=".">{[this.f(values)]}</tpl></div>',{f:function(I){var H=I.campaignlog;var F="<table style='padding-left:10px;margin-top:7px;width:60%;border:1px solid grey'>  <caption style='margin-top:5px;'>Activity History</caption><thead><tr><td style='color:#15428B;border-bottom:1px solid black'>Date</td><td style='color:#15428B;border-bottom:1px solid black'>Sent</td><td style='color:#15428B;border-bottom:1px solid black'>Viewed</td><td style='color:#15428B;border-bottom:1px solid black'>Failed</td></tr></thead><tbody>";if(H.campaignLogData!=undefined){for(var G=0;G<H.campaignLogData.length;G++){F+="<tr><td>"+new Date(H.campaignLogData[G].activitydate).format(WtfGlobal.getDateFormat());+"</td>";F+="<td>"+H.campaignLogData[G].totalsent+"</td>";F+="<td>"+H.campaignLogData[G].viewed+"</td>";F+="<td>"+H.campaignLogData[G].failed+"</td></tr>"}}F+="</tbody></table>";return F}})});var A=new Wtf.data.KwlJsonReader({root:"data",totalProperty:"totalCount"},D);this.EditorStore=new Wtf.data.Store({url:Wtf.req.base+"campaign.jsp",baseParams:{flag:9,campid:this.campaignid},reader:A});this.EditorStore.load();this.EditorColumn=new Wtf.grid.ColumnModel([E,new Wtf.grid.RowNumberer(),{header:"Name",dataIndex:"name",renderer:function(F){return"<a href = '#' class='campAddMarketing'> "+F+"</a>"}},{header:"Email Template",dataIndex:"templatename"},{header:"Created On",dataIndex:"createdon"},{header:"Send Test Email",dataIndex:"targetcount",renderer:function(F){var G="";if(F>0){G="<a href = '#' class='sendTestMail' wtf:qtip='Send e-mail marketing campaigns to login User.'> Send Test Email </a>"}return G}},{header:"Send Email",dataIndex:"targetcount",renderer:function(F){var G="";if(F>0){G="<a href = '#' class='campdetails' wtf:qtip='Send e-mail marketing campaigns to the chosen target lists.'> Send Email </a>"}return G}},{header:"View Status",dataIndex:"targetcount",renderer:function(F){var G="";if(F>0){G="<a href = '#' class='campchart' wtf:qtip='View the status of the selected email campaign i.e. number of mails sent, number of actual views and number of people unsuscribed.'> View Status </a>"}return G}},{header:"Bounce Report",dataIndex:"id",renderer:function(G){var F="";if(G!=""){F="<a href = '#' class='bouncereport' wtf:qtip='View Bounce report for this campaign and remove bounced targets from targetlist' style='color:#15428B;text-decoration:none;' >Bounce Report</a>"}return F}}]);this.deleteCon=new Wtf.Toolbar.Button({text:"Delete",scope:this,iconCls:getTabIconCls(Wtf.etype.delet),handler:this.campDelete});this.selectionModel=new Wtf.grid.CheckboxSelectionModel();this.Grid=new Wtf.KwlGridPanel({layout:"fit",store:this.EditorStore,cm:this.EditorColumn,sm:this.selectionModel,border:false,loadMask:true,viewConfig:{forceFit:true},searchEmptyText:"Search by Name",plugins:E,searchField:"name",tbar:["-",this.addEmailMarketing,this.editEmailMarketing,this.emailTempBtn,this.scheduleEmailMarketing,"->",B]});this.Grid.on("cellclick",this.afterGridCellClick,this);this.campaignpan=new Wtf.Panel({layout:"fit",border:false,items:this.Grid});this.add(this.campaignpan)},loadBounceReport:function(B){this.createBounceReportGrid(B);var A=new Wtf.Panel({layout:"fit",id:"bounceReportPanel",title:"Bounce Report",closable:true,items:[this.bounceReportGrid]});this.mainTab.add(A);this.mainTab.activate(Wtf.getCmp("bounceReportPanel"));this.bounceReportStore.load({params:{start:0,limit:30}})},createBounceReportGrid:function(A){var B=new Wtf.data.Record.create([{name:"email"},{name:"fname"},{name:"lname"},{name:"status"},{name:"description"},{name:"targetid"}]);this.bounceReportColumn=new Wtf.grid.ColumnModel([new Wtf.grid.CheckboxSelectionModel({}),new Wtf.grid.RowNumberer(),{header:"Email Address",dataIndex:"email"},{header:"First Name",dataIndex:"fname"},{header:"Last Name",dataIndex:"lname"},{header:"Reason",dataIndex:"status",renderer:function(F,E,C){var D="";if(F!=""){D="<span wtf:qtip='"+C.get("description")+"'>"+F+"</span><img src=\"images/information.png\" style='vertical-align:middle;margin-left:5px;'wtf:qtip='"+C.get("description")+"'>"}return D}}]);this.bounceReportStore=new Wtf.data.Store({url:Wtf.req.base+"crm.jsp",baseParams:{flag:827,emailmarketingid:A},reader:new Wtf.data.KwlJsonReader({root:"data",totalProperty:"totalCount"},B)});this.bounceReportGrid=new Wtf.KwlGridPanel({store:this.bounceReportStore,cm:this.bounceReportColumn,border:false,loadMask:true,viewConfig:{forceFit:true,emptyText:"Looks like there are no bounced emails in this email marketing campaign or the bounced targets are already been removed"},tbar:[new Wtf.Button({text:"Remove From Target List",handler:function(){selModel=this.bounceReportGrid.getSelectionModel();var D=selModel.getSelections();var C="";for(var E=0;E<D.length;E++){if(E>0){C+=","}C+=D[E].get("targetid")}if(C!=""){Wtf.Ajax.requestEx({url:"../../jspfiles/crm.jsp",params:{flag:828,targets:C}},this,function(G,F){Wtf.MessageBox.show({title:"Success",msg:"Selected target(s) deleted successfully",icon:Wtf.MessageBox.INFO,buttons:Wtf.MessageBox.OK});this.bounceReportStore.load({params:{start:0,limit:25}})},function(G,F){Wtf.MessageBox.show({title:"Error",msg:"Error while deleting selected target(s) please reload and try again",icon:Wtf.MessageBox.ERROR,buttons:Wtf.MessageBox.OK})})}else{Wtf.MessageBox.show({title:"Selection Error",msg:"Please select atleast one target from the list",icon:Wtf.MessageBox.ERROR,buttons:Wtf.MessageBox.OK})}},scope:this})],bbar:new Wtf.PagingSearchToolbar({pageSize:30,displayInfo:true,displayMsg:"Displaying records {0} - {1} of {2}",store:this.bounceReportStore,plugins:this.pP=new Wtf.common.pPageSize({})})})},showScheduleWindow:function(E){var A=new Wtf.data.SimpleStore({fields:["id","value"],data:[["0","00:00"],["1","00:30"],["2","01:00"],["3","01:30"],["4","02:00"],["5","02:30"],["6","03:00"],["7","03:30"],["8","04:00"],["9","04:30"],["10","05:00"],["11","05:30"],["12","06:00"],["13","06:30"],["14","07:00"],["15","07:30"],["16","08:00"],["17","08:30"],["18","09:00"],["19","09:30"],["20","10:00"],["21","10:30"],["22","11:00"],["23","11:30"],["24","12:00"],["25","12:30"],["26","13:00"],["27","13:30"],["28","14:00"],["29","14:30"],["30","15:00"],["31","15:30"],["32","16:00"],["33","16:30"],["34","17:00"],["35","17:30"],["36","18:00"],["37","18:30"],["38","19:00"],["39","19:30"],["40","20:00"],["41","20:30"],["42","21:00"],["43","21:30"],["44","22:00"],["45","22:30"],["46","23:00"],["47","23:30"]]});var G=new Wtf.form.ComboBox({fieldLabel:"Schedule Time",store:A,displayField:"value",valueField:"id",width:200,allowBlank:false,mode:"local",triggerAction:"all"});var C=new Date();C.setDate(C.getDate()+1);var B=new Wtf.form.DateField({fieldLabel:"Delivery Date",border:false,minValue:C,width:200,allowBlank:false});var D=new Wtf.form.FormPanel({region:"center",border:false,bodyStyle:"background:#f1f1f1;font-size:10px;padding:10px 10px 10px 30px;",items:[B,G]});var F=new Wtf.Window({title:"Schedule delivery",modal:true,height:210,iconCls:"pwnd favwinIcon",width:380,resizable:false,layout:"border",items:[{region:"north",bodyStyle:"background-color: white",border:false,height:65,html:getTopHtml("Schedule","Schedule campaign mail delivery","../../images/activity1.gif")},D],buttons:[{text:"Schedule",scope:this,handler:function(){if(D.form.isValid()){var H=G.getValue();var I=G.store.find("id",H);if(I!=-1){H=G.store.getAt(I).data["value"]}else{H="00:00"}var J=B.getValue().format("Y-m-d");Wtf.Ajax.requestEx({url:"../../jspfiles/campaign.jsp",params:{flag:28,emailmarketingid:E.data["id"],scheduledate:J,scheduletime:H}},this,function(L,K){F.close()},function(L,K){F.close()})}else{ResponseAlert(103)}}},{text:"Cancel",scope:this,handler:function(){F.close()}}]});F.show()},afterGridCellClick:function(Grid,rowIndex,columnIndex,e){var event=e;if(event.getTarget("a[class='campdetails']")){Wtf.Ajax.timeout=1200000;Wtf.commonWaitMsgBox("Sending mail...");Wtf.Ajax.request({url:Wtf.req.base+"campaign.jsp",params:{emailmarkid:Grid.store.getAt(rowIndex).data.id,campid:this.campaignid,flag:11},scope:this,success:function(res,req){var obj=eval("("+res.responseText.trim()+")");Wtf.updateProgress();Wtf.Ajax.timeout=30000;Wtf.MessageBox.show({title:"Sending E-mails for your Marketing Campaign...",msg:obj.data.msg,icon:Wtf.MessageBox.INFO,buttons:Wtf.MessageBox.OK})},failure:function(){Wtf.updateProgress();Wtf.Ajax.timeout=30000}})}if(event.getTarget("a[class='campchart']")){var chartid="CampaignMailStatus"+Grid.store.getAt(rowIndex).data.id;var id=this.id+"graph";var swf="../../scripts/graph/krwcolumn/krwcolumn/krwcolumn.swf";var dataflag="22&campID="+this.campaignid+"&mailMarID="+Grid.store.getAt(rowIndex).data.id+"";var mainID=this.mainTab.id;var xmlpath="../../scripts/graph/krwcolumn/examples/CampaignMailStatus/CampaignMailStatus_settings.xml";var param="mailMarID="+Grid.store.getAt(rowIndex).data.id+"&campID="+this.campaignid;var tipTitle=Grid.store.getAt(rowIndex).data.name;var maintitle=Wtf.util.Format.ellipsis(tipTitle,20);var title='<div wtf:qtip="'+tipTitle+"\"wtf:qtitle='Chart View'>"+maintitle+"</div>";var showHtml="false";globalChart(chartid,id,swf,dataflag,mainID,xmlpath,Wtf.id(),showHtml,"","",tipTitle)}var panel=Wtf.getCmp("comEmailMarket"+this.campaignid+"_"+this.mode+"_"+this.emailMarkId);if(panel!=null){this.editEmailMarketing.disable();this.scheduleEmailMarketing.disable();this.addEmailMarketing.disable()}else{this.editEmailMarketing.enable();this.scheduleEmailMarketing.enable()}if(event.getTarget("a[class='campAddMarketing']")){this.emailMarketing(1)}if(event.getTarget("a[class='sendTestMail']")){Wtf.commonWaitMsgBox("Sending test mail...");Wtf.Ajax.requestEx({url:Wtf.req.base+"campaign.jsp",params:{emailmarkid:Grid.store.getAt(rowIndex).data.id,campid:this.campaignid,flag:12}},this,function(){Wtf.updateProgress();ResponseAlert(400)},function(){Wtf.updateProgress();ResponseAlert(401)})}if(event.getTarget("a[class='bouncereport']")){var emailmarketingid=Grid.store.getAt(rowIndex).data.id;this.loadBounceReport(emailmarketingid)}},emailMarketing:function(E){this.mode=E;var C="Add Email Marketing ";var B="pwnd addEmailMarketingTab";this.emailMarkId="0";if(E==1){this.recData=this.Grid.getSelectionModel().getSelected().data;C="Edit Email Marketing : "+this.recData.name;B="pwnd editEmailMarketingTab";this.emailMarkId=this.recData.id}var A=Wtf.getCmp("comEmailMarket"+this.campaignid+"_"+this.mode+"_"+this.emailMarkId);var D=Wtf.util.Format.ellipsis(C,19);if(A==null){this.addEmailMarketing.disable();this.editEmailMarketing.disable();this.scheduleEmailMarketing.disable();this.setupRec=Wtf.data.Record.create([{name:"id"},{name:"title"},{name:"description"},{name:"licls"}]);this.campaignSetup=new Wtf.data.SimpleStore({fields:["id","title","description","licls"]});this.addEmailMarketFun();this.card1=new Wtf.ux.Wiz.Card({title:"Set Email Details",layout:"fit",border:false,items:this.addEmailMarketCmp});this.card2=new Wtf.ux.Wiz.Card({border:false,title:"Choose an Email Template",layout:"fit"});this.card2.on("show",this.showTemplateSelector,this);this.card3=new Wtf.ux.Wiz.Card({border:false,title:"Edit Email Template",layout:"fit"});this.card3.on("show",this.showTemplateEditor,this);this.card4=new Wtf.ux.Wiz.Card({border:false,title:"Enter your Plain-Text Message",layout:"fit"});this.card4.on("show",this.showPlainMessageEditor,this);this.card5=new Wtf.ux.Wiz.Card({layout:"fit",border:false,title:"Final Campaign Setup"});this.card5.on("show",this.showFinalSetup,this);A=new Wtf.ux.Wiz({closable:true,iconCls:B,id:"comEmailMarket"+this.campaignid+"_"+this.mode+"_"+this.emailMarkId,title:'<div wtf:qtip="'+C+"\"wtf:qtitle='Email Marketing'>"+D+"</div>",headerConfig:{title:'<div wtf:qtip="'+C+"\"wtf:qtitle='Email Marketing'>"+C+"</div>"},cards:[this.card1,this.card2,this.card3,this.card4,this.card5]});A.on("beforeNextcard",this.beforeNext,this);A.on("beforefinish",this.beforeFinish,this);this.mainTab.add(A)}this.mainTab.setActiveTab(A);this.mainTab.doLayout();this.mainTab.on("remove",function(G,F){if(F.id=="comEmailMarket"+this.campaignid+"_"+this.mode+"_"+this.emailMarkId){this.addEmailMarketing.enable();this.Grid.getSelectionModel().clearSelections()}},this)},showFinalSetup:function(){var A=Wtf.getCmp("final_setup_card");if(!A){this.finalSetupView=new Wtf.DataView({store:this.campaignSetup,itemSelector:"final_setup_card",tpl:new Wtf.XTemplate('<ul class="finalList"><tpl for=".">{[this.f(values)]}</tpl></div>',{f:function(B){return"<li class='"+B.licls+"'><label>"+B.title+"</label>"+B.description+"</li>"},scope:this})});A=new Wtf.Panel({id:"final_setup_card",bodyStyle:"background-color: white",autoScroll:true,html:"<span >sdf sdf </span>",items:this.finalSetupView});this.card5.add(A)}this.card5.doLayout()},showTemplateEditor:function(){var B=Wtf.getCmp("wizardTemplateEditor_"+this.id);if(B==null){var A=this.selEmailTempCmp.selectedTemplate;if(A){B=new Wtf.campaignMailEditor({mode:this.mode,marketRec:this.recData,id:"wizardTemplateEditor_"+this.id,templateRec:A.tempRec,templateid:A.tempRec.data["templateid"]});this.card3.add(B);this.card3.doLayout()}}},showPlainMessageEditor:function(){var B=Wtf.getCmp("Plaintext_textarea_form");if(!B){var A=Wtf.getCmp("wizardTemplateEditor_"+this.id).getPlainMessage();B=new Wtf.form.FormPanel({cls:"plainTextForm",id:"Plaintext_textarea_form",defaults:{labelStyle:"width: 100%; margin-bottom: 7px;",ctCls:"newTicketField"},items:[{value:A.trim(),id:"mail_plaintext_textfield",fieldLabel:"This plain-text email is displayed if recipients can't (or won't) display your HTML email",xtype:"textarea",height:"95%",width:"98%"}]});this.card4.add(B)}},addEmailMarketFun:function(){var B="";if(this.mode==1){B=this.recData.id}var A=Wtf.getCmp("addEmailMarketCmp_"+this.id+this.mode+B);if(!A){this.addEmailMarketCmp=new Wtf.addEmailMarketCmp({id:"addEmailMarketCmp_"+this.id+this.mode+B,emailmarkid:this.mode==1?this.recData.id:"",campaignid:this.campaignid,templateid:this.mode==1?this.recData.templateid:"",recData:this.recData,mode:this.mode,campaignname:this.campaignname,mainTab:this.mainTab})}},showTemplateSelector:function(){var A=Wtf.getCmp("selEmailTempCmp_"+this.templateid);if(A==null){this.selEmailTempCmp=new Wtf.campaignMailTemplate({id:"selEmailTempCmp_"+this.templateid,selectedTemplate:(this.mode==1)?this.recData.templateid:null,border:false,mainTab:this.mainTab});this.card2.add(this.selEmailTempCmp);this.card2.doLayout()}},storeSetupInformation:function(B,A){switch(A){case 0:this.campaignSetup.add(this.getInitialSetup());break;case 1:this.campaignSetup.add(this.getTemplateSetup());break;case 3:this.campaignSetup.add(this.getPlainTextSetup());break}},getInitialSetup:function(){var C=this.addEmailMarketCmp;var B=[];var E=C.getList();var F="Deskera CRM will deliver this to the ";var G="";for(var D=0;D<E.length;D++){G+=E[D].data["listname"]+","}var A;if(G!=""){F+=G.substring(0,(G.length-1));A="success"}else{F="No list selected to send this campaign to.";A="error"}this.removeSetupRec("list");B[B.length]=new this.setupRec({id:"list",title:"List",licls:A,description:F});F=C.getReplyMail();this.removeSetupRec("reply");B[B.length]=new this.setupRec({id:"reply",title:"Replies",licls:(F!="")?"success":"error",description:(F!="")?F:"No reply email specifed."});F=C.getSenderMail();this.removeSetupRec("sender");B[B.length]=new this.setupRec({id:"sender",title:"Sender email",licls:(F!="")?"success":"error",description:(F!="")?F:"No sender email specified."});return B},getTemplateSetup:function(){var A=[];var B=this.selEmailTempCmp.getSelectedTemplate();if(B){B=B.tempRec;this.removeSetupRec("subject");A[A.length]=new this.setupRec({id:"subject",title:"Subject line",licls:"success",description:B.data["subject"]});this.removeSetupRec("html");A[A.length]=new this.setupRec({id:"html",title:"HTML email",licls:"success",description:"You're sending an HTML email from the <span class='boldtext'>"+B.data["templatename"]+"</span> template"})}return A},getPlainTextSetup:function(){var A=[];var C=Wtf.getCmp("mail_plaintext_textfield").getValue().trim();var B="error";if(C!=""){C="You included a plain-text version.";B="success"}else{C="You included a plain-text version."}this.removeSetupRec("plainmsg");A[A.length]=new this.setupRec({id:"plainmsg",title:"Plain-text email",licls:B,description:C});return A},removeSetupRec:function(C){if(C!=""){var B=this.campaignSetup.query("id",C,false,true);B=B.items;if(B.length>0){for(var A=0;A<B.length;A++){this.campaignSetup.remove(B[A])}}}},beforeNext:function(F,D){var A=true;if(D==0){A=this.addEmailMarketCmp.activityform.form.isValid();if(A){var E=this.addEmailMarketCmp.getList();if(E.length>0){A=true}else{A=false;WtfComMsgBox(956,0)}}}else{if(D==1){var C=this.selEmailTempCmp.getSelectedTemplate();if(C!==null){var B=Wtf.getCmp("wizardTemplateEditor_"+this.id);if(B){B.changeTemplate(C.tempRec)}A=true;this.tempID=C.tempRec.data["templateid"]}else{ResponseAlert(600);A=false}}}if(A){this.storeSetupInformation(F,D)}return A},beforeFinish:function(F){var C=this.addEmailMarketCmp;var A=Wtf.getCmp("wizardTemplateEditor_"+this.id);var G=C.getSenderMail();var B="[";var E=C.getList();for(var D=0;D<E.length;D++){B+='{"listid" : "'+E[D].data.listid+'"},'}B=B.substring(0,(B.length-1))+"]";Wtf.Ajax.requestEx({url:Wtf.req.base+"campaign.jsp",params:{name:C.getName(),unsub:"",fwdfriend:"",archive:"",updatelink:"",fromaddress:G,replyaddress:C.getReplyMail(),fromname:C.getFromName(),inboundemail:G,templateid:this.tempID,campid:this.campaignid,targetlist:B,colortheme:A.getColorTheme(),htmlcont:A.getTemplateHtml(),plaincont:Wtf.getCmp("mail_plaintext_textfield").getValue().trim(),emailmarkid:this.mode==1?this.recData.id:"",mode:this.mode,flag:10}},this,function(){WtfComMsgBox(953,0);if(this.mode==0){this.EditorStore.load()}Wtf.getCmp("comEmailMarket"+this.campaignid+"_"+this.mode+"_"+this.emailMarkId).closePanel();this.addEmailMarketing.enable();this.Grid.getSelectionModel().clearSelections()},function(){WtfComMsgBox(954,1)})},targetListHandler:function(){var A="targetlistgrid";var B=Wtf.getCmp(A);if(B==null){B=new Wtf.targetListDetails({title:"Target Lists",id:A,mainTab:this.mainTab});this.mainTab.add(B)}this.mainTab.setActiveTab(B);this.mainTab.doLayout()}});Wtf.emailTemplate=function(A){Wtf.emailTemplate.superclass.constructor.call(this,A)};Wtf.extend(Wtf.emailTemplate,Wtf.Panel,{closable:true,layout:"fit",title:"Email Templates",id:this.id!="emailTemplatedashboard"?"emailTemplate":this.id,border:false,iconCls:getTabIconCls(Wtf.etype.acc),initComponent:function(A){Wtf.campaignDetails.superclass.initComponent.call(this,A);this.getEditorGrid()},getEditorGrid:function(){var B=new Wtf.data.Record.create([{name:"templateid"},{name:"templatename"},{name:"description"},{name:"subject"},{name:"bodyhtml"},{name:"createdon"},{name:"modifiedon"}]);var A=new Wtf.data.KwlJsonReader({root:"data",totalProperty:"totalcount"},B);this.EditorStore=new Wtf.data.Store({url:"Common/Template/getTemplates.common",pruneModifiedRecords:true,baseParams:{flag:1},method:"post",reader:A});this.EditorStore.load();this.EditorColumn=new Wtf.grid.ColumnModel([new Wtf.grid.RowNumberer(),{header:"Template Name",dataIndex:"templatename",sortable:true,renderer:function(C){return"<a href = '#' class='campdetails'> "+C+"</a>"}},{header:"Description",dataIndex:"description",sortable:true},{header:"Created On",dataIndex:"createdon",sortable:true},{header:"Modified On",dataIndex:"modifiedon",sortable:true}]);this.deleteCon=new Wtf.Toolbar.Button({text:"Delete",scope:this,iconCls:getTabIconCls(Wtf.etype.delet),handler:this.campDelete});this.selectionModel=new Wtf.grid.CheckboxSelectionModel();this.Grid=new Wtf.KwlGridPanel({layout:"fit",store:this.EditorStore,cm:this.EditorColumn,sm:this.selectionModel,border:false,height:400,loadMask:true,displayInfo:true,viewConfig:{forceFit:true,emptyText:WtfGlobal.emptyGridRenderer("<a class='grid-link-text' href='#' onClick='javascript:addemltem(\""+this.id+"\")'>Get started by adding a email template now...</a>")},searchEmptyText:"Search by Template Name",searchField:"templatename",searchLabel:" ",searchLabelSeparator:" ",tbar:["-",new Wtf.Toolbar.Button({text:"Reset",scope:this,iconCls:"pwndRefresh",handler:function(){this.EditorStore.load({params:{start:0,limit:this.Grid.pag.pageSize}});Wtf.getCmp("Quick"+this.Grid.id).setValue("")}}),"-",{text:"New Template",scope:this,tooltip:{text:"Add New E-mail template including rich text formatting."},iconCls:"pwndCommon addbuttonIcon",handler:this.addemltem},"-",{text:"Delete Template",scope:this,tooltip:{text:"Select an e-mail template to delete."},iconCls:"pwndCommon deletebuttonIcon",handler:this.delTemplate}]});if(this.id=="emailTemplatedashboard"){this.templatePanel=new Wtf.Panel({title:"Email Templates",iconCls:getTabIconCls(Wtf.etype.acc),border:false,id:this.id+"emailtemplatepan",layout:"fit",items:[{layout:"fit",border:false,items:[this.Grid]}]});this.mainTab=new Wtf.TabPanel({id:this.id+"emailtemplatetabPanel",scope:this,border:false,resizeTabs:true,minTabWidth:155,enableTabScroll:true,items:[this.templatePanel]});this.add(this.mainTab);this.mainTab.setActiveTab(this.templatePanel)}else{this.add(this.Grid)}this.doLayout();this.Grid.on("cellclick",this.gridCellClick,this)},addemltem:function(){var B="New Template";var C=Wtf.util.Format.ellipsis(B,18);var A="";if(this.id=="emailTemplatedashboard"){A=Wtf.getCmp("template_dash_win"+this.templateid)}else{A=Wtf.getCmp("template_wiz_win"+this.templateid)}if(A==null){A=new Wtf.newEmailTemplate({store:this.EditorStore,title:'<div wtf:qtip="'+B+"\"wtf:qtitle='Email Template'>"+C+"</div>",tipTitle:B,mailTemplate:this.mailTemplate,dashboardCall:this.id=="emailTemplatedashboard"?true:false});A.on("render",function(){A.tempname.focus(true,100)},this);this.mainTab.add(A)}this.mainTab.setActiveTab(A);this.mainTab.doLayout()},gridCellClick:function(D,H,F,E){var B=E;if(B.getTarget("a[class='campdetails']")){var G=D.getSelectionModel().getSelected().data;var A=Wtf.getCmp("template_wiz_win"+G.templateid);var C=G.templatename+" : Edit Template";var I=Wtf.util.Format.ellipsis(C,18);if(A==null){A=new Wtf.newEmailTemplate({templateid:G.templateid,tname:G.templatename,tdesc:G.description,tsubject:G.subject,tbody:G.bodyhtml,store:this.EditorStore,title:'<div wtf:qtip="'+C+"\"wtf:qtitle='Email Template'>"+I+"</div>",tipTitle:C});A.on("render",function(){A.tempname.focus(true,100)},this);this.mainTab.add(A)}this.mainTab.setActiveTab(A);this.mainTab.doLayout()}},delTemplate:function(){if(this.Grid.getSelectionModel().getCount()>0){Wtf.MessageBox.confirm("Confirm","Do you want to delete this template?",function(A){if(A!="yes"){this.close()}else{var B=this.Grid.getSelectionModel().getSelected().data;Wtf.Ajax.requestEx({url:"Common/Template/delTemplate.common",params:{tempid:B.templateid}},this,function(C){calMsgBoxShow(["Success","Template deleted successfully."],0);this.EditorStore.reload()},function(){Wtf.Msg.alert("Message"," Some error occoured.")})}},this)}else{calMsgBoxShow(42,1)}}});function addemltem(A){Wtf.getCmp(A).addemltem()}Wtf.targetListDetails=function(A){Wtf.targetListDetails.superclass.constructor.call(this,A)};Wtf.extend(Wtf.targetListDetails,Wtf.Panel,{closable:true,layout:"fit",border:false,iconCls:"pwndnewCRM targetlistTabicon",initComponent:function(B){Wtf.targetListDetails.superclass.initComponent.call(this,B);var C=new Wtf.data.Record.create([{name:"listid"},{name:"listname"},{name:"description"},{name:"createdon"}]);var A=new Wtf.data.KwlJsonReader({root:"data",totalProperty:"totalCount"},C);this.EditorStore=new Wtf.data.Store({url:Wtf.req.base+"campaign.jsp",baseParams:{flag:4},method:"post",reader:A});this.EditorStore.load();this.EditorColumn=new Wtf.grid.ColumnModel([new Wtf.grid.RowNumberer(),new Wtf.grid.CheckboxSelectionModel(),{header:"Target List",dataIndex:"listname",renderer:function(E){return"<a href = '#' class='campTargetList'> "+E+"</a>"}},{header:"Description",dataIndex:"description"},{header:"Created On",dataIndex:"createdon"}]);var D=false;if(this.id=="campaigntargetdetail"){D=true}this.newTargetsBtn=new Wtf.Toolbar.Button({text:"New",tooltip:{text:"Add New Target List."},scope:this,iconCls:"pwnd newTargetListEmailMarketing",handler:function(){this.targetsHandler(0,D)}});this.editTargetsBtn=new Wtf.Toolbar.Button({text:"Edit",tooltip:{text:"Edit Target List."},scope:this,iconCls:"pwnd editTargetListEmailMarketing",handler:function(){if(this.Grid.getSelectionModel().getSelections().length==1){this.targetsHandler(1,D)}else{ResponseAlert(67)}}});this.deleteTargetsBtn=new Wtf.Toolbar.Button({text:"Delete",tooltip:{text:"Delete the selected Target Lists."},scope:this,iconCls:getTabIconCls(Wtf.etype.delet),handler:function(){Wtf.deleteGlobal(this.Grid,this.EditorStore,"Target List","listid","listid","TargetList",64,65,66)}});this.selectionModel=new Wtf.grid.CheckboxSelectionModel();this.Grid=new Wtf.KwlGridPanel({store:this.EditorStore,cm:this.EditorColumn,sm:this.selectionModel,border:false,loadMask:true,viewConfig:{forceFit:true,emptyText:"Looks like you have not added any Target List. Create a new list by clicking 'New' button."},tbar:["-",this.newTargetsBtn,this.editTargetsBtn,this.deleteTargetsBtn],searchEmptyText:"Search by Target List",displayInfo:true,searchField:"listname"});this.targetList=new Wtf.Panel({layout:"fit",border:false,height:400,items:this.Grid});if(this.id=="campaigntargetdetail"){this.targetPanel=new Wtf.Panel({title:"Target Lists",iconCls:"pwndnewCRM targetlistTabicon",border:false,layout:"fit",id:this.id+"targetpan",items:[{layout:"fit",border:false,items:[this.targetList]}]});this.mainTab=new Wtf.TabPanel({id:this.id+"targetTabPanel",scope:this,border:false,resizeTabs:true,minTabWidth:155,enableTabScroll:true,items:[this.targetPanel]});this.add(this.mainTab);this.mainTab.setActiveTab(this.targetPanel)}else{this.add(this.targetList)}this.doLayout();this.Grid.on("cellclick",this.targetGridCellClick,this)},targetGridCellClick:function(D,J,I,H){var B=H;if(B.getTarget("a[class='campTargetList']")){var G=1;var F=this.Grid.getSelectionModel().getSelected();var K=F.get("listid");var C=F.get("listname")+" ";var E="targetListTabnewedit_dash"+G+K;var A=Wtf.getCmp(E);if(A==null){A=new Wtf.targetListWin({mode:G,record:F,id:E,listID:K,TLID:K,store:this.EditorStore,listname:C,iconCls:"pwnd editTargetListEmailMarketingWin",mainTab:this.mainTab});this.mainTab.add(A)}this.mainTab.setActiveTab(A);this.mainTab.doLayout()}},targetsHandler:function(G,F){var B;var A="";var D="New ";if(G==1){B=this.Grid.getSelectionModel().getSelected();A=B.get("listid");D=B.get("listname")+" "}var C="targetListTabnewedit"+G+A;if(F){C="targetListTabnewedit_dash"+G+A}var E=Wtf.getCmp(C);if(E==null){E=new Wtf.targetListWin({mode:G,record:B,id:C,listID:A,TLID:A,store:this.EditorStore,listname:D,iconCls:(G==0?"pwnd newTargetListEmailMarketingWin":"pwnd editTargetListEmailMarketingWin"),mainTab:this.mainTab});this.mainTab.add(E)}this.mainTab.setActiveTab(E);this.mainTab.doLayout()}});Wtf.targetListWin=function(A){A.title=A.listname+"Target List";Wtf.apply(this,A);Wtf.targetListWin.superclass.constructor.call(this,A)};Wtf.extend(Wtf.targetListWin,Wtf.ux.ClosableTabPanel,{iconCls:"pwnd favwinIcon",closable:true,layout:"fit",onRender:function(E){this.toolItems=[];var G=new Wtf.Toolbar.Button({text:"Save",tooltip:{text:"Save the target list."},scope:this,iconCls:"pwnd saveBtn",handler:this.saveTargetList_Targets});this.toolItems.push(G);var I=[];var L=new Wtf.Action({text:"Open Targets",scope:this,flag:0,listid:this.listID,handler:this.addNewTargetHandler});var H=new Wtf.Action({text:'<span wtf:qtip="Import e-mail addresses from leads.">Leads</span>',scope:this,flag:1,iconCls:"pwndCRM leadSearch",listid:this.listID,handler:this.importHandler});var J=new Wtf.Action({text:'<span wtf:qtip="Import e-mail addresses from contacts.">Contacts</span>',scope:this,flag:2,iconCls:"pwndCRM contactsTabIconSearch",listid:this.listID,handler:this.importHandler});var C=new Wtf.Action({text:'<span wtf:qtip="Import e-mail addresses from your user list.">Users</span>',scope:this,flag:3,iconCls:"pwndCRM author",listid:this.listID,handler:this.importHandler});var D=new Wtf.Action({text:'<span wtf:qtip=" Import e-mail addresses from target list.">Target Lists</span>',scope:this,flag:4,iconCls:"pwndCRM targetlistButtonicon",listid:this.listID,handler:this.importHandler});if(!WtfGlobal.EnableDisable(Wtf.UPerm.Lead,Wtf.Perm.Lead.exportt)){I.push(H)}if(!WtfGlobal.EnableDisable(Wtf.UPerm.Contact,Wtf.Perm.Contact.exportt)){I.push(J)}I.push(C);I.push(D);var F=new Wtf.Toolbar.Button({tooltip:{text:" Import e-mail addresses from leads, contacts or targets easily."},scope:this,text:"Import",iconCls:"pwnd importicon",menu:I});this.toolItems.push(F);var B=[];var N=new Wtf.Action({text:'<span wtf:qtip="Add a new Lead.">Leads</span>',scope:this,iconCls:"pwndCRM leadSearch",handler:function(){this.createNewTarget(1)}});var K=new Wtf.Action({text:'<span wtf:qtip="Add a new Contact.">Contacts</span>',scope:this,iconCls:"pwndCRM contactsTabIconSearch",handler:function(){this.createNewTarget(2)}});var A=new Wtf.Action({text:'<span wtf:qtip=" Add a new Target.">Targets</span>',scope:this,iconCls:"pwndCRM targetlistButtonicon",handler:function(){this.createNewTarget(4)}});if(!WtfGlobal.EnableDisable(Wtf.UPerm.Lead,Wtf.Perm.Lead.exportt)){B.push(N)}if(!WtfGlobal.EnableDisable(Wtf.UPerm.Contact,Wtf.Perm.Contact.exportt)){B.push(K)}B.push(A);var M=new Wtf.Toolbar.Button({tooltip:{text:" Add Leads, Contacts or Targets easily."},scope:this,text:"Add",iconCls:"pwnd addIcon",menu:B});this.toolItems.push(M);Wtf.targetListWin.superclass.onRender.call(this,E);this.activityform=new Wtf.form.FormPanel({autoScroll:true,border:false,height:100,items:{layout:"column",border:false,defaults:{border:false},items:[{columnWidth:1,items:[{layout:"form",border:false,defaultType:"textfield",labelWidth:150,defaults:{width:250},items:[this.name=new Wtf.ux.TextField({fieldLabel:"Name*",allowBlank:false,maxLength:255,value:this.mode==1?this.record.data.listname:""}),this.desc=new Wtf.form.TextArea({fieldLabel:"Description",maxLength:1024,value:this.mode==1?this.record.data.description:""})]}]}]}});this.targetRecord=new Wtf.data.Record.create([{name:"id"},{name:"name"},{name:"emailid"},{name:"relatedto"},{name:"relatedid"},{name:"company"},{name:"targetscount"},{name:"targetlistDescription"}]);this.targetReader=new Wtf.data.KwlJsonReader({root:"data",totalProperty:"totalCount"},this.targetRecord);this.campTargetStore=new Wtf.data.Store({url:Wtf.req.base+"campaign.jsp",baseParams:{listID:this.TLID,flag:7},method:"post",reader:this.targetReader});this.targetColumn=new Wtf.grid.ColumnModel([new Wtf.grid.RowNumberer(),{header:"Name",dataIndex:"name"},{header:"Email",dataIndex:"emailid"},{header:"Remove",dataIndex:"remove",renderer:function(S,O,R,T,P,Q){return"<div class='pwnd deleteButton' > </div>"}}]);this.campTargetStore.load({params:{start:0,limit:50}});this.targetGrid=new Wtf.grid.GridPanel({store:this.campTargetStore,cm:this.targetColumn,tbar:[],clicksToEdit:1,border:false,loadMask:true,searchEmptyText:"Search by Name",searchField:"name",view:new Wtf.ux.grid.BufferView({scrollDelay:false,autoFill:true,forceFit:true,emptyText:"You have not imported any targets. Import targets from \n                            Lead List, Contact List, User List, Target List by clicking on 'Import' button.\n                            You can also add Leads, Contacts and Targets by clicking on 'Add' button or by import using a CSV file.."}),bbar:new Wtf.PagingSearchToolbar({pageSize:50,displayInfo:true,displayMsg:"Displaying records {0} - {1} of {2}",store:this.campTargetStore,plugins:this.pP=new Wtf.common.pPageSize({id:"pPageSize_"+this.id})})});this.targetGrid.on("cellclick",this.deleteTarget,this);this.targetGrid.on("render",this.gridAfterRender,this);this.mainPanel=new Wtf.Panel({layout:"border",border:false,items:[{layout:"fit",region:"north",height:150,bodyStyle:"background:#f1f1f1;font-size:10px;padding:10px 10px 10px 30px;",items:this.activityform},{layout:"fit",region:"center",items:this.targetGrid}]});this.add(this.mainPanel)},gridAfterRender:function(){this.importTargetListA=Wtf.importMenuArray(this,"Target List",this.campTargetStore,"undefined",this.pP.combo.value);this.importTargetList=Wtf.importMenuButtonA(this.importTargetListA,this,"Target");this.toolItems.push(this.importTargetList);this.targetGrid.getTopToolbar().addButton(this.toolItems)},deleteTarget:function(C,A,B,E){var D=E;if(D.target.className=="pwnd deleteButton"){this.isClosable=false;Wtf.Ajax.requestEx({url:Wtf.req.base+"campaign.jsp",params:{listid:this.TLID,relatedid:C.selModel.selections.items[0].data.relatedid,flag:35}},this,function(F,G){ResponseAlert(52);C.store.load({params:{start:0,limit:this.pP.combo.value}})},function(){ResponseAlert(53)})}},importHandler:function(D,A){var B="ImportEmails";var C=Wtf.getCmp(B);if(C==null){C=new Wtf.importTargetWindow({id:B,TLID:this.TLID,scope:this,butObj:D})}C.show()},importCSVfile:function(A){this.impWin1=Wtf.commonUploadWindow(this,A);this.impWin1.show()},displayName:function(D,A,C,F,E){var B=(C.json.username).trim();return B},CreateNewTarget:function(){var A=this.grid.getSelectionModel().getSelected();this.addExtTargetfunction(0,A,1)},mappingCSV:function(D,B,C,A){this.filename=B.FileName;this.mapCSV=new Wtf.csvMappingInterface({csvheaders:D,modName:"Targets",impWin1:C,delimiterType:A}).show();Wtf.getCmp("csvMappingInterface").on("importfn",this.importCSVfunc,this)},mapImportedRes:function(I,E,K){var G=0;var A="";var F=this.listds.getCount();var J="{userdata:[";for(var C=0;C<F;C++){var L=this.listds.getAt(C);var B=this.userds.find("cusername",L.data.cusername,0,true);if(E==true){var D=L.json.username.trim();B=this.userds.find("cusername",D,0,true)}if(B!=-1){G++;var H=this.userds.getAt(B);J+=A+'{user:"'+H.data.cusername+'",email:"'+H.json.cemailid+'",targetModuleid:"'+H.json.cuserid+'",userid:"'+L.json.userid+'",username:"'+L.json.username+'",emailid:"'+L.json.emailid+'",address:"'+L.json.address+'",contactno:"'+L.json.contactno+'"}';A=","}}J+="]}";if(G>0){Wtf.Ajax.requestEx({url:Wtf.req.base+"contact.jsp",params:({type:"repTarget",val:J}),method:"POST"},this,function(M,O){if(M!=null&&M!=""){for(var N=0;N<M.rec.length;N++){var P=new this.targetRecord({id:"",name:M.rec[N].username,emailid:M.rec[N].emailid,relatedto:"4",relatedid:""});this.campTargetStore.add(P)}}WtfComMsgBox(458,0);I.close()},function(){I.close()})}else{WtfComMsgBox(470,0);I.close()}},importCSVfunc:function(A,B){Wtf.commonConflictWindow(this,A,"Target",this.filename,this.EditorStore,this.listds,this.grid,469,451,"../../images/leads.gif","Null","Null",this.grid1,470,B,this.TLID);this.on("importrecs",this.insertIntoGrid,this)},insertIntoGrid:function(A,B){if(A[0].TLID!==undefined){this.TLID=A[0].TLID}this.campTargetStore.baseParams.listID=this.TLID;this.campTargetStore.load({params:{start:0,limit:this.pP.combo.value}})},addExtTargetfunction:function(D,B,A){var C=D==0?"Add Target":"Edit Target";var E=D==0?"Enter new Target details":"Edit existing Target details";this.addExtTargetWindow=new Wtf.Window({title:D==0?"Add Target":"Edit Target",closable:true,modal:true,iconCls:"pwnd favwinIcon",width:430,height:370,resizable:false,buttons:[{text:D==0?"Add":"Edit",id:"createUserButton",scope:this,handler:function(){if(this.createuserForm.form.isValid()){Wtf.Ajax.requestEx({url:Wtf.req.base+"contact.jsp",params:({type:"newTargetAddress",userid:Wtf.getCmp("tempContIdField").getValue(),username:Wtf.getCmp("tempNameField").getValue(),emailid:Wtf.getCmp("tempEmailField").getValue(),address:Wtf.getCmp("tempAddField").getValue(),contactno:Wtf.getCmp("tempPhoneField").getValue()}),method:"POST"},this,function(F,G){if(F!=null&&F!=""){WtfComMsgBox(453,0)}this.listds.remove(B);var H=new this.targetRecord({id:"",name:Wtf.getCmp("tempNameField").getValue(),emailid:Wtf.getCmp("tempEmailField").getValue(),relatedto:"4",relatedid:""});this.campTargetStore.add(H);this.addExtTargetWindow.close()},function(){this.addExtTargetWindow.close()})}}},{text:"Cancel",id:"cancelCreateUserButton",scope:this,handler:function(){this.addExtTargetWindow.close()}}],layout:"border",items:[{region:"north",id:"userwinnorth",height:75,border:false,bodyStyle:"background:white;border-bottom:1px solid #bfbfbf;",html:getTopHtml(C,E)},{region:"center",border:false,id:"userwincenter",bodyStyle:"background:#f1f1f1;font-size:10px;",layout:"fit",items:[this.createuserForm=new Wtf.form.FormPanel({border:false,labelWidth:120,bodyStyle:"margin-top:20px;margin-left:35px;font-size:10px;",defaults:{width:200},defaultType:"textfield",items:[{fieldLabel:"Name*",id:"tempNameField",name:"name",validator:WtfGlobal.validateUserName,allowBlank:false},{fieldLabel:"Email Id*",id:"tempEmailField",name:"emailid",validator:WtfGlobal.validateEmail,allowBlank:false,renderer:WtfGlobal.renderEmailTo},{fieldLabel:"Phone*",allowBlank:false,id:"tempPhoneField",name:"phone"},{xtype:"textarea",fieldLabel:"Address",id:"tempAddField",name:"address"},{xtype:"hidden",id:"tempContIdField",name:"id"}]})]}]});Wtf.getCmp("tempPhoneField").on("change",function(){Wtf.getCmp("tempPhoneField").setValue(WtfGlobal.HTMLStripper(Wtf.getCmp("tempPhoneField").getValue()))},this);Wtf.getCmp("tempAddField").on("change",function(){Wtf.getCmp("tempAddField").setValue(WtfGlobal.HTMLStripper(Wtf.getCmp("tempAddField").getValue()))},this);this.addExtTargetWindow.show();if(B!=null){Wtf.getCmp("tempNameField").setValue(B.json.username);Wtf.getCmp("tempEmailField").setValue(B.json.emailid);Wtf.getCmp("tempPhoneField").setValue(B.json.contactno);Wtf.getCmp("tempAddField").setValue(B.json.address);Wtf.getCmp("tempContIdField").setValue(B.json.userid)}},addNewTargetHandler:function(){addTargetModuleTab()},saveTargetList_Targets:function(){var A="";if(this.campTargetStore.getCount()<1){ResponseAlert(73);return }if(this.name.getValue()==""){ResponseAlert(63);return }Wtf.Ajax.requestEx({url:Wtf.req.base+"campaign.jsp",params:{targets:A,listid:this.TLID,mode:this.mode,name:this.name.getValue(),desc:this.desc.getValue(),flag:8}},this,function(){this.isClosable=true;this.fireEvent("close");WtfComMsgBox(["Target","Target list saved successfully"],0)},function(){WtfComMsgBox(["Target","Failed to save Target list."],1)});var B=Wtf.getCmp(this.id);if(this.addNewDashboardCall){mainPanel.remove(B);mainPanel.doLayout()}else{this.mainTab.remove(B);this.mainTab.doLayout()}if(this.store){this.store.load()}},createNewTarget:function(A){this.relatedToMod="";var D="";var C="";var B="";if(A==1){this.relatedToMod="1";C="Add a New Lead";D="Provide required information to add Lead.";B="../../images/leads.gif"}else{if(A==2){this.relatedToMod="2";C="Add a New Contact";D="Provide required information to add Contact.";B="../../images/contacts3.gif"}else{if(A==4){this.relatedToMod="4";C="Add a New Target";D="Provide required information to add Target.";B="../../images/createuser.png"}}}if(A==2){this.form1=new Wtf.form.FormPanel({border:false,items:[new Wtf.form.TextField({fieldLabel:"Name",id:"target_name"+this.id,allowBlank:false,msgTarget:"side",width:200}),{fieldLabel:"Email Id",id:"target_email_id"+this.id,width:200,allowBlank:false,msgTarget:"side",vtype:"email",xtype:"striptextfield"}]})}else{this.form1=new Wtf.form.FormPanel({border:false,items:[new Wtf.form.TextField({fieldLabel:"Name",id:"target_name"+this.id,allowBlank:false,msgTarget:"side",width:200}),{fieldLabel:"Email Id",id:"target_email_id"+this.id,width:200,allowBlank:false,msgTarget:"side",vtype:"email",xtype:"striptextfield"},new Wtf.form.TextField({fieldLabel:"Company",id:"target_company"+this.id,allowBlank:false,msgTarget:"side",width:200})]})}this.impWin1=new Wtf.Window({resizable:false,scope:this,layout:"border",modal:true,width:380,height:A==2?250:280,iconCls:"pwnd favwinIcon",id:"create_new_target_window",title:"New Target",items:[{region:"north",height:80,border:false,bodyStyle:"background:white;border-bottom:1px solid #bfbfbf;",html:getTopHtml(""+C+"",""+D+"",""+B+"")},{region:"center",layout:"fit",border:false,bodyStyle:"background:#f1f1f1;font-size:10px;padding:20px 10px 10px 30px",items:this.form1}],buttons:[{text:"Submit",type:"submit",scope:this,handler:function(){var G=Wtf.getCmp("target_name"+this.id).getValue();var F=Wtf.getCmp("target_email_id"+this.id).getValue();var E="";if(A==2){if(F.trim()==""||G.trim()==""){ResponseAlert(152);return }this.saveContact(G,F)}else{E=Wtf.getCmp("target_company"+this.id).getValue();if(F.trim()==""||G.trim()==""||E.trim()==""){ResponseAlert(152);return }if(A==1){this.saveLead(G,F,E)}else{this.saveTarget(G,F,E)}}this.impWin1.close()}},{text:"Cancel",scope:this,handler:function(){this.impWin1.close()}}]});this.impWin1.show()},saveLead:function(R,J,K){var M=R.split(" ");var I="";var O="";if(M.length==1){I=R}else{O=M[0];I=M[1]}var N="0";var B=loginid;var P="";var C=1;var Q="";var D="";var E="";var A="";var G="";var S="";var F="";P+="{'leadid':'"+N+"',";P+="'leadownerid':'"+B+"',";P+="'firstname':'"+O+"',";P+="'lastname':'"+I+"',";P+="'validflag':'"+C+"',";P+="'title':'"+Q+"',";P+="'phone':'"+E+"',";P+="'leadstatusid':'"+D+"',";P+="'email':'"+J+"',";P+="'street':'"+F+"',";P+="'ratingid':'"+A+"',";P+="'industryid':'"+S+"',";P+="'leadsourceid':'"+G+"',";P+="'activities':'',";P+="'productid': '', ";P+="'price': '', ";P+="'revenue': '', ";P+="'moredetails': '', ";P+="'company':'"+K+"'},";var L=P.length-1;var H=P.substr(0,L);this.saveRecordReq(H,{flag:20,auditEntry:1},1)},saveContact:function(A,G){var K=A.split(" ");var H="";var D="";if(K.length==1){H=A}else{D=K[0];H=K[1]}var C="0";var B=loginid;var E="";var I=1;E+="{'contactid':'"+C+"',";E+="'contactownerid':'"+B+"',";E+="'firstname':'"+D+"',";E+="'lastname':'"+H+"',";E+="'accountid':'',";E+="'phone':'',";E+="'mobile':'',";E+="'email':'"+G+"',";E+="'industryid':'',";E+="'leadsourceid':'',";E+="'title':'',";E+="'street':'',";E+="'createdon':'',";E+="'validflag':'"+I+"',";E+="'activities':'',";E+="'description':''},";var J=E.length-1;var F=E.substr(0,J);this.saveRecordReq(F,{flag:22,auditEntry:1},2)},saveTarget:function(A,F,G){var L=A.split(" ");var H="";var B="";if(L.length==1){H=A}else{B=L[0];H=L[1]}var J="0";var C=loginid;var D="";var I=1;D+='{"targetModuleid":"'+J+'",';D+='"targetModuleownerid":"'+C+'",';D+='"firstname":"'+B+'",';D+='"lastname":"'+H+'",';D+='"company":"'+G+'",';D+='"auditstr":"",';D+='"phone":"",';D+='"mobile":"",';D+='"email":"'+F+'",';D+='"address":"",';D+='"validflag":"'+I+'",';D+='"description":""},';var K=D.length-1;var E=D.substr(0,K);this.saveRecordReq(E,{flag:301,auditEntry:1},3)},saveRecordReq:function(jsondata,paramObj,actionCode){Wtf.commonWaitMsgBox("Saving data...");var jsonData=eval("("+jsondata+")");paramObj["jsondata"]=jsondata;paramObj["type"]=1;paramObj["TLID"]=this.TLID;var recID="";Wtf.Ajax.requestEx({url:Wtf.req.base+"crm.jsp",params:paramObj},this,function(res){if(res.TLID){this.TLID=res.TLID}Wtf.updateProgress();this.campTargetStore.baseParams.listID=this.TLID;this.campTargetStore.load({params:{start:0,limit:this.pP.combo.value}})},function(res){WtfComMsgBox(152,1)})}});Wtf.importTargetWindow=function(A){A.title="Import "+A.butObj.text;Wtf.apply(this,A);Wtf.importTargetWindow.superclass.constructor.call(this,A)};Wtf.extend(Wtf.importTargetWindow,Wtf.Window,{iconCls:"pwnd favwinIcon",layout:"fit",modal:true,resizable:false,height:500,width:600,onRender:function(A){Wtf.importTargetWindow.superclass.onRender.call(this,A);this.importTargetStore=new Wtf.data.Store({url:Wtf.req.base+"campaign.jsp",baseParams:{importID:this.butObj.flag,tlid:this.TLID,flag:20},method:"post",reader:this.scope.targetReader});var B=new Wtf.grid.CheckboxSelectionModel({singleSelect:this.butObj.flag=="4"?true:false});this.colModel=new Wtf.grid.ColumnModel([new Wtf.grid.RowNumberer(),B,{header:"Name",sortable:true,dataIndex:"name"},{header:"Email",sortable:true,hidden:this.butObj.flag=="4"?true:false,dataIndex:"emailid"},{header:"No of Targets",sortable:true,width:50,hidden:this.butObj.flag=="4"?false:true,dataIndex:"targetscount"},{header:"Description",sortable:true,hidden:this.butObj.flag=="4"?false:true,dataIndex:"targetlistDescription",renderer:function(C){return'<div wtf:qtip="'+C+"\"wtf:qtitle='Description'>"+C+"</div>"}}]);this.quickPanelSearch=new Wtf.KWLTagSearch({width:150,emptyText:"Search by Name ",Store:this.importTargetStore});this.pg=new Wtf.PagingSearchToolbar({pageSize:15,searchField:this.quickPanelSearch,store:this.importTargetStore,displayInfo:true,displayMsg:"Displaying records {0} - {1} of {2}",emptyMsg:"No results to display",plugins:this.pP=new Wtf.common.pPageSize()});this.importGrid=new Wtf.grid.GridPanel({store:this.importTargetStore,cm:this.colModel,sm:B,border:false,loadMask:true,viewConfig:{forceFit:true},tbar:["-",this.quickPanelSearch,"-"],bbar:this.pg});this.importTargetStore.load({params:{start:0,limit:this.importGrid.getBottomToolbar().pageSize}});this.importTargetStore.on("load",function(C){this.quickPanelSearch.StorageChanged(C)},this);this.importTargetStore.on("datachanged",function(){var C=this.pP.combo.value;this.quickPanelSearch.setPage(C)},this);this.mainPanel=new Wtf.Panel({layout:"border",border:false,buttons:[{text:"Submit",scope:this,handler:this.addEmailsToGrid},{text:"Close",scope:this,handler:function(){this.close()}}],items:[{region:"north",height:75,border:false,bodyStyle:"background:white;border-bottom:1px solid #bfbfbf;",html:getTopHtml("Import "+this.butObj.text,"Select "+this.butObj.text+" and click on submit button","../../images/import.png")},{layout:"fit",region:"center",items:this.importGrid}]});this.add(this.mainPanel)},addEmailsToGrid:function(){if(this.butObj.flag=="4"){var F=this.importGrid.getSelectionModel().getSelected().data;Wtf.Ajax.requestEx({url:Wtf.req.base+"campaign.jsp",params:{importtl:F.relatedid,listid:this.scope.TLID,flag:30}},this,function(H,I){if(H.TLID){this.scope.TLID=H.TLID}Wtf.updateProgress();this.scope.isClosable=false;var G=this.scope.targetGrid.getStore();G.baseParams.listID=this.scope.TLID;G.load({params:{start:0,limit:this.scope.pP.combo.value}});Wtf.MessageBox.show({title:"Import",msg:"Selected Target list imported successfully. Do you want to continue importing more Target list?",buttons:Wtf.MessageBox.YESNO,animEl:"mb9",scope:this,icon:Wtf.MessageBox.INFO,fn:function(J,K){if(J=="yes"){}else{this.close()}}})},function(){})}else{if(this.importGrid.getSelectionModel().hasSelection()){var D="[";var C="";var E=this.importGrid.getSelectionModel().getSelections();for(var B=0;B<E.length;B++){var A=E[B].get("relatedid");D+='{"rid":"'+A+'"},';if(B==0){C=E[B].get("relatedto")}}D=D.substr(0,D.length-1);D+="]";Wtf.commonWaitMsgBox("Importing Data...");Wtf.Ajax.requestEx({url:Wtf.req.base+"campaign.jsp",params:{data:D,listid:this.scope.TLID,relatedto:C,flag:29}},this,function(H,I){if(H.TLID){this.scope.TLID=H.TLID}Wtf.updateProgress();this.scope.isClosable=false;var G=this.scope.targetGrid.getStore();G.baseParams.listID=this.scope.TLID;G.load({params:{start:0,limit:this.scope.pP.combo.value}});Wtf.MessageBox.show({title:"Import",msg:E.length+" records imported successfully. Do you want to continue importing more records?",buttons:Wtf.MessageBox.YESNO,animEl:"mb9",scope:this,icon:Wtf.MessageBox.INFO,fn:function(J,K){if(J=="yes"){}else{this.close()}}})},function(){})}}}});Wtf.userPayCycleGrid=function(A){A.border=false;A.layout="fit";this.addEvents("assignemployee");Wtf.userPayCycleGrid.superclass.constructor.call(this,A);Wtf.apply(this,A)};Wtf.extend(Wtf.userPayCycleGrid,Wtf.Panel,{initComponent:function(A){this.grid=this.getGrid();this.designationId="";this.add(this.grid);this.grid.on("rowclick",function(C,B,D){if(D.getTarget("div[class='pwndCommon gridCancel']")){var E=C.store.getAt(B);if(E.get("salaryflag")=="1"){calMsgBoxShow(["Warning","Salary is already generated using this template so you can not unassign employee."],2)}else{C.store.remove(E)}}});this.on("activate",function(C,B){this.doLayout()});this.assignedempstore.load({params:{templateid:this.templateid,grouper:"addpayroll",firequery:"1"}})},setDesignationId:function(A){this.designationId=A},setpayinterval:function(A){this.payinterval=A},seteffdate:function(B){this.effdate=B;this.datearr=[];if(this.payinterval==1){}else{if(this.payinterval==3){for(var A=0;A<7;A++){if(B-1!=A){this.datearr.push(A)}}}}},deleteRenderer:function(B,A,D,C){if(D.data.id!="-1"){return"<div><div class='pwndCommon gridCancel' style='cursor:pointer' wtf:qtip='Delete Record'></div></div>"}},addBlankRow:function(){this.assignedempstore.add(new Wtf.data.Record(["",""]))},getAllEmployeeGrid:function(){var B=new Wtf.grid.CheckboxSelectionModel({});var A=new Wtf.grid.ColumnModel([B,{header:"Employee",dataIndex:"fullname"},{header:"Basic",dataIndex:"basic",minValue:1,allowNegative:false,allowBlank:false,editor:new Wtf.form.NumberField({width:155,maxLength:10})},{header:"Effective From",dataIndex:"effectivedate",editor:new Wtf.form.DateField({width:155,readOnly:true,emptyText:"From Date",disabledDaysText:"Please select another day",format:"m/d/Y",disabledDays:this.datearr}),renderer:WtfGlobal.onlyDateRenderer}]);this.employeeSelectionGrid=new Wtf.grid.EditorGridPanel({store:this.allEmpStore,cm:A,sm:B,clicksToEdit:1,viewConfig:{forceFit:true,emptyText:WtfGlobal.emptyGridRenderer("No Employee is assigned to this Designation"),autoFill:true},border:false});return this.employeeSelectionGrid},getToolbar:function(){this.assignEmployeeWin="";this.assignEmpBtn=new Wtf.Button({text:"Assign Employee",iconCls:"pwndCommon profilebuttonIcon",tooltip:"Please select a designation first and then assign employee",handler:function(){if(this.designationId!=null&&this.designationId!=""){var B='{"root":[{ "iscustom":false,"column":"ua.designationid.id","searchText":"'+this.designationId+'","columnheader":"Designation","search":"'+this.designationId+'","combosearch":"undefined","xtype":"combo"}]}';this.allEmpStore.on("load",function(){this.quickSearchEMP.StorageChanged(this.allEmpStore);this.allEmpStore.filterBy(function(C,D){C.set("effectivedate",new Date());return true},this)},this);this.allEmpStore.load({params:{"searchJson":B,mode:114}});this.quickSearchEMP=new Wtf.wtfQuickSearch({width:200,field:"fullname",emptyText:"Search by Employee Name "});this.assignEmployeeWin=new Wtf.Window({width:400,height:400,id:"assignEmplyeeWin",iconCls:getButtonIconCls(Wtf.btype.winicon),modal:true,title:"Select Employees",layout:"border",items:[{region:"north",height:75,border:false,bodyStyle:"background:white;border-bottom:1px solid #bfbfbf;",html:getTopHtml("Assign Employee","Set effective date and select employees to be assigned to the template.","../../images/new-plan.png")},{border:false,region:"center",layout:"fit",height:300,tbar:["Quick Search: ",this.quickSearchEMP],items:[this.getAllEmployeeGrid()]}],buttons:[{text:"Assign",handler:function(){var F=this.employeeSelectionGrid.getSelectionModel().getSelections();var C="[";var I="";for(var J=0;J<F.length;J++){var E=F[J].get("joindate");if(E==null||E==undefined||E==""){I+=F[J].get("fullname")+"<br/>"}if(F[J].get("basic")==""||F[J].get("basic")<0){calMsgBoxShow(["Warning","Basic is invalid."],2);return }if(J>0){C+=","}C+="{userid:'"+F[J].get("userid")+"',effectiveDate:'"+F[J].get("effectivedate").format("Y-m-d")+"',basic:'"+F[J].get("basic")+"'}"}if(I!=""){calMsgBoxShow(["Warning","Please set the joining date for following employee(s) before assigning template : "+I],2);return }var D="";for(var J=0;J<F.length;J++){var E=F[J].get("joindate");if(new Date(E).format("Y-m-d")>F[J].get("effectivedate").format("Y-m-d")){D+="<br/>"+F[J].get("fullname")}}if(D!=""){calMsgBoxShow(["Warning","Please check the joining date for following employee(s) before assigning template : "+D],2);return }C+="]";var H="One of the templates is already assigned for selected Effective Date.<br/>Please select another date.<br/>For the following employee(s) :<br/><br/>";var G=false;Wtf.Ajax.requestEx({url:"Payroll/Template/getAssignedTemplateForEmponDate.py",method:"GET",params:{records:C}},this,function(L){var K=L.data;var O=1;if(K!=null&&K!=undefined){for(var N=0;N<K.length;N++){var P=-1;for(var M=0;M<F.length;M++){if(F[M].get("userid")==K[N].userid&&K[N].effectivedate==F[M].get("effectivedate").format("Y-m-d")){P=M}}if(P!=-1){G=true;H+="<b>"+O+")"+F[P].get("fullname")+"</b><br/>";F.splice(P,1);O++}}}if(G){Wtf.MessageBox.alert("Error assigning users",H)}this.assignedempstore.add(F);Wtf.getCmp("assignEmplyeeWin").close()},function(){})},scope:this},{text:"Cancel",handler:function(){Wtf.getCmp("assignEmplyeeWin").close()}}]}).show()}else{calMsgBoxShow(223,0)}},scope:this});var A=new Wtf.Toolbar([this.assignEmpBtn]);return A},getRecordsJSON:function(){var B=this.assignedempgrid.store.getRange(0,this.assignedempgrid.store.getCount());var A="[";for(var C=0;C<B.length;C++){if(C>0){A+=","}A+="{userid:'"+B[C].get("userid")+"',effectiveDate:'"+B[C].get("effectivedate").format("Y-m-d")+"',basic:'"+B[C].get("basic")+"'}"}A+="]";return A},getGrid:function(){this.fieldsrec=Wtf.data.Record.create([{name:"fullname"},{name:"userid"},{name:"basic"},{name:"salaryflag"},{name:"effectivedate",type:"date",dateFormat:"Y-m-d"},{name:"joindate"}]);this.employeedatareader=new Wtf.data.KwlJsonReader({root:"data"},this.fieldsrec);this.allEmpStore=new Wtf.data.Store({url:"Common/getAllUserDetailsHrms.common",method:"GET",reader:this.employeedatareader});this.assignedempstore=new Wtf.data.Store({url:"Payroll/Template/getAssignedEmpForTemplate.py",method:"GET",reader:this.employeedatareader});this.cm=new Wtf.grid.ColumnModel([{header:"Employee",dataIndex:"fullname",width:150},{header:"Basic",dataIndex:"basic",width:150},{header:"Effective Date",dataIndex:"effectivedate",renderer:WtfGlobal.onlyDateRenderer,width:200},{header:"",renderer:this.deleteRenderer.createDelegate(this)}]);this.assignedempgrid=new Wtf.grid.EditorGridPanel({store:this.assignedempstore,stripeRows:true,tbar:this.getToolbar(),id:this.id+"assignedemp",scope:this,height:440,clicksToEdit:1,title:"Assigned Employees",viewConfig:{forceFit:true,emptyText:WtfGlobal.emptyGridRenderer("No Employees are assigned to this Salary Template. Please click on Assign Employee to select from the list")},cm:this.cm});return this.assignedempgrid}});function ResponseAlert(A){var B=[];switch(A){case 59:B=["","E-mail Template has been created successfully"];break;case 60:B=["","E-mail Template has been updated successfully"];break;default:B=[A[0],A[1]];break}Wtf.notify.msg(B[0],B[1])}function WtfComMsgBox(B,C){var D=[];switch(B){case 152:D=["Error","Sorry! The information could not be saved. Please try again."];break;case 453:D=["Success","Contact has been added successfully."];break;case 457:D=["Alert","Please specify an e-mail sender."];break;case 458:D=["Success","New Contacts have been imported successfully and updated to the Contact List."];break;case 470:D=["Success","Targets imported successfully. Conflict targets have been skipped."];break;case 605:D=["Alert","Please select a Target list."];break;case 606:D=["Alert","You have already added all Target lists. Create a new Target list to add here."];break;case 607:D=["Alert","No Target list has been created. Please create a Target list to add here."];break;case 900:D=["Alert","No records have been modified."];break;case 902:D=["Error","Sorry! The information could not be saved. Please try again."];break;case 950:D=["Alert","Please enter all Parameter Configuration details."];break;break;case 953:D=["Success","Email marketing has been saved successfully."];break;case 955:D=["Alert","Please fill all the essential fields (marked with an asterisk *)."];break;case 956:D=["Email Template","Please select atleast one target list."];break;case 1050:D=["Alert","Credentials provided by you are invaild. Please try again."];break;case 1051:D=["Alert","Please select contacts to import."];break;case 1052:D=["Alert","Please enter company name for which you want to import Leads."];break;case 1053:D=["Alert","Please select an Account for which you want to import Contacts."];break;case 1054:D=["Alert","Please enter a valid email id for your Google Account."];break;case 1055:D=["Alert","Please enter a valid password for your Google Account."];break;break;default:D=[B[0],B[1]];break}var A=Wtf.MessageBox.INFO;if(C==0){A=Wtf.MessageBox.INFO}if(C==1){A=Wtf.MessageBox.ERROR}else{if(C==2){A=Wtf.MessageBox.WARNING}else{if(C==3){A=Wtf.MessageBox.INFO}}}Wtf.MessageBox.show({title:D[0],msg:D[1],buttons:Wtf.MessageBox.OK,animEl:"mb9",icon:A})}